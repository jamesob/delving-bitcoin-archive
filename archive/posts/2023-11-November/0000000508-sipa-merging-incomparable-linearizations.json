{
  "id": 508,
  "name": "Pieter Wuille",
  "username": "sipa",
  "avatar_template": "/user_avatar/delvingbitcoin.org/sipa/{size}/102_2.png",
  "created_at": "2023-11-29T02:40:54.550Z",
  "cooked": "<p>New attempt, with a fully \u201cgeometric\u201d approach to show the new diagram is above the old one, but largely using insights about sets from <a class=\"mention\" href=\"/u/ajtowns\">@ajtowns</a>\u2019s proof sketch above.</p>\n<h3><a name=\"theorem-1\" class=\"anchor\" href=\"#theorem-1\"></a>Theorem</h3>\n<p>Given:</p>\n<ul>\n<li>A linearization <span class=\"math\">L</span></li>\n<li>A topologically valid subset <span class=\"math\">G</span> of the transactions in <span class=\"math\">L</span> (\u201cG\u201d for \u201cgood\u201d transactions).</li>\n<li>Let <span class=\"math\">L_G</span> be the linearization of the transactions <span class=\"math\">G</span>, in the order they appear in <span class=\"math\">L</span>.</li>\n<li>Let <span class=\"math\">L_B</span> be the linearization of the transactions <em>not</em> in <span class=\"math\">G</span> (\u201cbad\u201d), in the order they appear in <span class=\"math\">L</span>.</li>\n<li>Let <span class=\"math\">f</span> be the highest chunk feerate of <span class=\"math\">L</span>.</li>\n<li><span class=\"math\">L_G</span> (considered in isolation) must form a single chunk, with feerate <span class=\"math\">\\geq f</span>.</li>\n</ul>\n<p>Then:</p>\n<ul>\n<li><span class=\"math\">L_G + L_B</span> is at least as good as <span class=\"math\">L</span> (better or equal feerate diagram, never worse or incomparable).</li>\n</ul>\n<p>Let\u2019s call this the <strong>gathering theorem</strong> (it matches what the <code>VGATHER*</code> AVX2 x86 CPU instructions do to bitsets).</p>\n<h3><a name=\"proof-2\" class=\"anchor\" href=\"#proof-2\"></a>Proof</h3>\n<ul>\n<li>Let <span class=\"math\">S(x), F(x), R(x)</span> respectively denote the size, fee, and feerate of the set <span class=\"math\">x</span>.</li>\n<li>Let <span class=\"math\">(c_1, c_2, \\ldots, c_n)</span> be the chunking of <span class=\"math\">L</span> (the <span class=\"math\">c_i</span> are transaction sets).</li>\n<li>We know <span class=\"math\">R(c_i) \\leq f</span> for <span class=\"math\">i=1 \\ldots n</span>, because of input assumptions.</li>\n<li>Let <span class=\"math\">\\gamma_j = \\cup_{i=1}^{j} c_i</span> (union of all chunks up to <span class=\"math\">j</span>).</li>\n<li>Let <span class=\"math\">e_i = c_i \\cap G</span> for all <span class=\"math\">i=0 \\ldots n</span> (the good transactions from each chunk).</li>\n<li>Let <span class=\"math\">\\zeta_j = \\cup_{i=j+1}^{n} e_i</span> (union of all good transactions in chunks after <span class=\"math\">j</span>).</li>\n<li>Because <span class=\"math\">\\zeta_j</span> is a suffix of <span class=\"math\">L_G</span>, which is a single chunk with feerate <span class=\"math\">\\geq f</span>, we know <span class=\"math\">R(\\zeta_j) \\geq f</span> for all <span class=\"math\">j=0 \\ldots n-1</span>.</li>\n<li>Let <span class=\"math\">P(x) = (S(x), F(x))</span> be the point in 2D space corresponding to the size and fee of set <span class=\"math\">x</span>.</li>\n<li>Let <span class=\"math\">D</span> be the diagram connecting the points <span class=\"math\">(P(\\gamma_j))_{j=0}^{n}</span>, corresponding to the prefixes of chunks of <span class=\"math\">L</span>. This is the diagram of <span class=\"math\">L</span>.</li>\n<li>Let <span class=\"math\">N</span> be the diagram connecting the points <span class=\"math\">(0,0)</span> followed by <span class=\"math\">(P(\\gamma_j \\cup \\zeta_j))_{j=0}^n</span>, corresponding to the prefixes of <span class=\"math\">L_G + L_B</span> consisting of all good transactions and the bad transactions up to chunk <span class=\"math\">j</span>.</li>\n<li><span class=\"math\">N</span> is <em>not</em> the diagram of <span class=\"math\">L_G + L_B</span> because that requires rechunking that linearization. However, rechunking can only improve the diagram, so <span class=\"math\">N</span> <em>is</em> an underestimate for the diagram of <span class=\"math\">L_G + L_B</span>.</li>\n<li><span class=\"math\">D</span> is a concave function. A point lies strictly under a concave function iff it lies under every line segment that makes up <span class=\"math\">D</span>, extended to infinity. Thus, a point lies on or above <span class=\"math\">D</span> iff it lies on or above at least a single line that makes up <span class=\"math\">D</span>.</li>\n</ul>\n<p>In what follows, we will show that every point on <span class=\"math\">N</span> lies on or above a line making up <span class=\"math\">D</span>. If that holds, it follows that <span class=\"math\">N</span> in its entirety lies on or above <span class=\"math\">D</span>:</p>\n<ul>\n<li>The first diagram segment of <span class=\"math\">N</span>, from <span class=\"math\">(0,0)</span> to <span class=\"math\">P(\\gamma_0 \\cup \\zeta_0)</span>, is easy: it corresponds to <span class=\"math\">L_G</span> itself, which has feerate (slope) <span class=\"math\">\\geq f</span>. All of these points lie on or above the first line of <span class=\"math\">D</span>, from <span class=\"math\">P(\\gamma_0)</span> (<span class=\"math\">= (0,0)</span>) to <span class=\"math\">P(\\gamma_1)</span>, which has feerate (slope) <span class=\"math\">f</span>.</li>\n<li>For all other diagram segments of <span class=\"math\">N</span>, we will compare line segments with those in <span class=\"math\">D</span> with the same <span class=\"math\">j = 0 \\ldots n-1</span>. In other words, we want to show that the line segment from <span class=\"math\">P(\\gamma_j \\cup \\zeta_j)</span> to <span class=\"math\">P(\\gamma_{j+1} \\cup \\zeta_{j+1})</span> lies on or above the line through <span class=\"math\">P(\\gamma_j)</span> and <span class=\"math\">P(\\gamma_{j+1})</span>.\n<ul>\n<li><span class=\"math\">P(\\gamma_j \\cup \\zeta_j)</span> lies on or above the line through <span class=\"math\">P(\\gamma_j)</span> and <span class=\"math\">P(\\gamma_{j+1})</span> iff <span class=\"math\">R(\\zeta_j) \\geq R(c_{j+1})</span>. This follows from <span class=\"math\">R(\\zeta_j) \\geq f</span> and <span class=\"math\">R(c_{j+1}) \\leq f</span>.</li>\n<li><span class=\"math\">P(\\gamma_{j+1} \\cup \\zeta_{j+1})</span> lies on or above the line through <span class=\"math\">P(\\gamma_j)</span> and <span class=\"math\">P(\\gamma_{j+1})</span> iff <span class=\"math\">R(c_{j+1} \\cup \\zeta_{j+1}) \\geq R(c_{j+1})</span>. This follows from the <span class=\"math\">f</span> relations too, except for <span class=\"math\">j=n-1</span>, but there the endpoints of the two graphs just coincide.</li>\n<li>All points between <span class=\"math\">P(\\gamma_j \\cup \\zeta_j)</span> and <span class=\"math\">P(\\gamma_{j+1} \\cup \\zeta_{j+1})</span> lie on or above the line through <span class=\"math\">P(\\gamma_j)</span> and <span class=\"math\">P(\\gamma_{j+1})</span>, given that the endpoints of the segment do.</li>\n</ul>\n</li>\n</ul>\n<p>Thus, all points on an <em>underestimate</em> of the diagram of <span class=\"math\">L_G + L_B</span> lie on or above the diagram of <span class=\"math\">L</span>, and we conclude that <span class=\"math\">L_G + L_B</span> is a better or equal linearization than <span class=\"math\">L</span>.</p>\n<h3><a name=\"generalization-3\" class=\"anchor\" href=\"#generalization-3\"></a>Generalization</h3>\n<p>It is easy to relax the requirement that <span class=\"math\">L_G</span> forms a single chunk. We can instead require that only the <em>lowest</em> chunk feerate of <span class=\"math\">L_G</span> is <span class=\"math\">\\geq f</span>. This would add additional points to <span class=\"math\">N</span> corresponding to the chunks of <span class=\"math\">L_G</span>, but they would all lie above the existing first line segment of <span class=\"math\">N</span>, which cannot break the property that <span class=\"math\">N</span> lies on or above <span class=\"math\">D</span>.</p>",
  "post_number": 28,
  "post_type": 1,
  "updated_at": "2023-11-29T16:49:41.405Z",
  "reply_count": 0,
  "reply_to_post_number": null,
  "quote_count": 0,
  "incoming_link_count": 0,
  "reads": 7,
  "readers_count": 6,
  "score": 1.2,
  "yours": false,
  "topic_id": 209,
  "topic_slug": "merging-incomparable-linearizations",
  "topic_title": "Merging incomparable linearizations",
  "topic_html_title": "Merging incomparable linearizations",
  "category_id": 9,
  "display_username": "Pieter Wuille",
  "primary_group_name": null,
  "flair_name": null,
  "flair_url": null,
  "flair_bg_color": null,
  "flair_color": null,
  "flair_group_id": null,
  "version": 8,
  "can_edit": false,
  "can_delete": false,
  "can_recover": false,
  "can_see_hidden_post": false,
  "can_wiki": false,
  "user_title": null,
  "bookmarked": false,
  "raw": "New attempt, with a fully \"geometric\" approach to show the new diagram is above the old one, but largely using insights about sets from @ajtowns's proof sketch above.\n\n### Theorem\n\nGiven:\n* A linearization $L$\n* A topologically valid subset $G$ of the transactions in $L$ (\"G\" for \"good\" transactions).\n* Let $L_G$ be the linearization of the transactions $G$, in the order they appear in $L$.\n* Let $L_B$ be the linearization of the transactions *not* in $G$ (\"bad\"), in the order they appear in $L$.\n* Let $f$ be the highest chunk feerate of $L$.\n* $L_G$ (considered in isolation) must form a single chunk, with feerate $\\geq f$.\n\nThen:\n* $L_G + L_B$ is at least as good as $L$ (better or equal feerate diagram, never worse or incomparable).\n\nLet's call this the **gathering theorem** (it matches what the `VGATHER*` AVX2 x86 CPU instructions do to bitsets).\n### Proof\n\n* Let $S(x), F(x), R(x)$ respectively denote the size, fee, and feerate of the set $x$.\n* Let $(c_1, c_2, \\ldots, c_n)$ be the chunking of $L$ (the $c_i$ are transaction sets).\n* We know $R(c_i) \\leq f$ for $i=1 \\ldots n$, because of input assumptions.\n* Let $\\gamma_j = \\cup_{i=1}^{j} c_i$ (union of all chunks up to $j$).\n* Let $e_i = c_i \\cap G$ for all $i=0 \\ldots n$ (the good transactions from each chunk).\n* Let $\\zeta_j = \\cup_{i=j+1}^{n} e_i$ (union of all good transactions in chunks after $j$).\n* Because $\\zeta_j$ is a suffix of $L_G$, which is a single chunk with feerate $\\geq f$, we know $R(\\zeta_j) \\geq f$ for all $j=0 \\ldots n-1$.\n* Let $P(x) = (S(x), F(x))$ be the point in 2D space corresponding to the size and fee of set $x$.\n* Let $D$ be the diagram connecting the points $(P(\\gamma_j))_{j=0}^{n}$, corresponding to the prefixes of chunks of $L$. This is the diagram of $L$.\n* Let $N$ be the diagram connecting the points $(0,0)$ followed by $(P(\\gamma_j \\cup \\zeta_j))_{j=0}^n$, corresponding to the prefixes of $L_G + L_B$ consisting of all good transactions and the bad transactions up to chunk $j$.\n* $N$ is *not* the diagram of $L_G + L_B$ because that requires rechunking that linearization. However, rechunking can only improve the diagram, so $N$ *is* an underestimate for the diagram of $L_G + L_B$.\n* $D$ is a concave function. A point lies strictly under a concave function iff it lies under every line segment that makes up $D$, extended to infinity. Thus, a point lies on or above $D$ iff it lies on or above at least a single line that makes up $D$.\n\nIn what follows, we will show that every point on $N$ lies on or above a line making up $D$. If that holds, it follows that $N$ in its entirety lies on or above $D$:\n* The first diagram segment of $N$, from $(0,0)$ to $P(\\gamma_0 \\cup \\zeta_0)$, is easy: it corresponds to $L_G$ itself, which has feerate (slope) $\\geq f$. All of these points lie on or above the first line of $D$, from $P(\\gamma_0)$ ($= (0,0)$) to $P(\\gamma_1)$, which has feerate (slope) $f$.\n* For all other diagram segments of $N$, we will compare line segments with those in $D$ with the same $j = 0 \\ldots n-1$. In other words, we want to show that the line segment from $P(\\gamma_j \\cup \\zeta_j)$ to $P(\\gamma_{j+1} \\cup \\zeta_{j+1})$ lies on or above the line through $P(\\gamma_j)$ and $P(\\gamma_{j+1})$.\n  * $P(\\gamma_j \\cup \\zeta_j)$ lies on or above the line through $P(\\gamma_j)$ and $P(\\gamma_{j+1})$ iff $R(\\zeta_j) \\geq R(c_{j+1})$. This follows from $R(\\zeta_j) \\geq f$ and $R(c_{j+1}) \\leq f$.\n  * $P(\\gamma_{j+1} \\cup \\zeta_{j+1})$ lies on or above the line through $P(\\gamma_j)$ and $P(\\gamma_{j+1})$ iff $R(c_{j+1} \\cup \\zeta_{j+1}) \\geq R(c_{j+1})$. This follows from the $f$ relations too, except for $j=n-1$, but there the endpoints of the two graphs just coincide.\n  * All points between $P(\\gamma_j \\cup \\zeta_j)$ and $P(\\gamma_{j+1} \\cup \\zeta_{j+1})$ lie on or above the line through $P(\\gamma_j)$ and $P(\\gamma_{j+1})$, given that the endpoints of the segment do.\n\nThus, all points on an *underestimate* of the diagram of $L_G + L_B$ lie on or above the diagram of $L$, and we conclude that $L_G + L_B$ is a better or equal linearization than $L$.\n\n### Generalization\n\nIt is easy to relax the requirement that $L_G$ forms a single chunk. We can instead require that only the *lowest* chunk feerate of $L_G$ is $\\geq f$. This would add additional points to $N$ corresponding to the chunks of $L_G$, but they would all lie above the existing first line segment of $N$, which cannot break the property that $N$ lies on or above $D$.",
  "actions_summary": [],
  "moderator": false,
  "admin": false,
  "staff": false,
  "user_id": 96,
  "hidden": false,
  "trust_level": 3,
  "deleted_at": null,
  "user_deleted": false,
  "edit_reason": null,
  "can_view_edit_history": true,
  "wiki": false,
  "reactions": [
    {
      "id": "rocket",
      "type": "emoji",
      "count": 1
    }
  ],
  "current_user_reaction": null,
  "reaction_users_count": 1,
  "current_user_used_main_reaction": false
}