{
  "id": 423,
  "name": "",
  "username": "amiti",
  "avatar_template": "/letter_avatar_proxy/v4/letter/a/e5b9ba/{size}.png",
  "created_at": "2023-11-16T03:25:56.724Z",
  "cooked": "<p>This is a thread to discuss the memory usage of peers.</p>\n<h2><a name=\"interesting-things-1\" class=\"anchor\" href=\"#interesting-things-1\"></a>Interesting things:</h2>\n<ul>\n<li>average case / expected memory usage per peer</li>\n<li>difference in average case memory usage for block-relay-only peer vs full-relay peer</li>\n<li>worst case memory usage for a single peer</li>\n<li>worst case memory usage for a block-relay-only peer vs full-relay peer</li>\n<li>how different network conditions impact the expected memory usage per peer</li>\n</ul>\n<h2><a name=\"memory-monitoring-2\" class=\"anchor\" href=\"#memory-monitoring-2\"></a>Memory monitoring:</h2>\n<ul>\n<li>I have written <a href=\"https://github.com/amitiuttarwar/bitcoin/pull/5\">a patch</a> to monitor the memory usage of different types of connections. It currently reports (1) current <code>CNode</code> memory usage (2) current <code>Peer</code> memory usage &amp; (3) max <code>Peer</code> memory usage.</li>\n<li>Status: the broad strokes are in place, but there are some fields that are not yet accounted for (details in PR description). Also, I would love review to know if the code actually does what I think it does!</li>\n<li>Desired improvement: update the max peer memory usage to incorporate <code>CNode</code> memory, so it will be a better representation of the entire connection.</li>\n<li>This <a href=\"https://docs.google.com/spreadsheets/d/1VsKj0RxhLOo2m512dq1FwP6NHkA6TcKP01OIjyHUKN8/edit?usp=sharing\">spreadsheet</a> are the results from running the patch on my node with inbounds enabled for approximately 5 days (nov 10-15). it shows a dramatic difference between the max memory usage of block-relay-only peers vs full-relay peers.</li>\n</ul>\n<p>this graph shows memory usage broken down by max &amp; current, for connections with relay enabled or not.\n<em>y axis: number of bytes, x axis: different nodes.</em>\n<div class=\"lightbox-wrapper\"><a class=\"lightbox\" href=\"https://delvingbitcoin.org/uploads/default/original/1X/e71b0eb3ba3693a992f06d5ac58cc86fa6f1b46f.png\" data-download-href=\"https://delvingbitcoin.org/uploads/default/e71b0eb3ba3693a992f06d5ac58cc86fa6f1b46f\" title=\"Screen Shot 2023-11-15 at 7.11.34 PM\"><img src=\"https://delvingbitcoin.org/uploads/default/optimized/1X/e71b0eb3ba3693a992f06d5ac58cc86fa6f1b46f_2_690x423.png\" alt=\"Screen Shot 2023-11-15 at 7.11.34 PM\" data-base62-sha1=\"wYsgujkjX8Cfk9KFfyKeB3CsyiH\" width=\"690\" height=\"423\" srcset=\"https://delvingbitcoin.org/uploads/default/optimized/1X/e71b0eb3ba3693a992f06d5ac58cc86fa6f1b46f_2_690x423.png, https://delvingbitcoin.org/uploads/default/optimized/1X/e71b0eb3ba3693a992f06d5ac58cc86fa6f1b46f_2_1035x634.png 1.5x, https://delvingbitcoin.org/uploads/default/original/1X/e71b0eb3ba3693a992f06d5ac58cc86fa6f1b46f.png 2x\" data-dominant-color=\"FCFCFC\"><div class=\"meta\"><svg class=\"fa d-icon d-icon-far-image svg-icon\" aria-hidden=\"true\"><use href=\"#far-image\"></use></svg><span class=\"filename\">Screen Shot 2023-11-15 at 7.11.34 PM</span><span class=\"informations\">1324\u00d7812 36.1 KB</span><svg class=\"fa d-icon d-icon-discourse-expand svg-icon\" aria-hidden=\"true\"><use href=\"#discourse-expand\"></use></svg></div></a></div></p>\n<h2><a name=\"warnet-3\" class=\"anchor\" href=\"#warnet-3\"></a>Warnet:</h2>\n<p>Warnet can help us observe different network conditions. Here are some questions I\u2019m curious about, where I think warnet can create/isolate behaviors we sometimes see:</p>\n<ul>\n<li>When <a href=\"https://b10c.me/observations/06-linkinglion/\">LinkingLion</a> is on the prowl, there is high churn of inbound connections. How much memory does each short-lived connections use?</li>\n<li>Especially with ordinals/transcriptions, we sometimes see really high transaction volume. How does that impact the expected/average memory usage of our full-relay connections?</li>\n</ul>\n<p>Do you have more ideas? <img src=\"https://delvingbitcoin.org/images/emoji/twitter/slight_smile.png?v=12\" title=\":slight_smile:\" class=\"emoji\" alt=\":slight_smile:\" loading=\"lazy\" width=\"20\" height=\"20\"></p>",
  "post_number": 1,
  "post_type": 1,
  "updated_at": "2023-11-16T03:25:56.724Z",
  "reply_count": 1,
  "reply_to_post_number": null,
  "quote_count": 0,
  "incoming_link_count": 7,
  "reads": 5,
  "readers_count": 4,
  "score": 96.0,
  "yours": false,
  "topic_id": 194,
  "topic_slug": "per-peer-memory-usage",
  "topic_title": "Per-peer memory usage",
  "topic_html_title": "Per-peer memory usage",
  "category_id": 10,
  "display_username": "",
  "primary_group_name": null,
  "flair_name": null,
  "flair_url": null,
  "flair_bg_color": null,
  "flair_color": null,
  "flair_group_id": null,
  "version": 1,
  "can_edit": false,
  "can_delete": false,
  "can_recover": false,
  "can_see_hidden_post": false,
  "can_wiki": false,
  "user_title": null,
  "bookmarked": false,
  "raw": "This is a thread to discuss the memory usage of peers. \n\n## Interesting things:\n- average case / expected memory usage per peer\n- difference in average case memory usage for block-relay-only peer vs full-relay peer\n- worst case memory usage for a single peer \n- worst case memory usage for a block-relay-only peer vs full-relay peer \n- how different network conditions impact the expected memory usage per peer\n\n## Memory monitoring: \n- I have written [a patch](https://github.com/amitiuttarwar/bitcoin/pull/5) to monitor the memory usage of different types of connections. It currently reports (1) current `CNode` memory usage (2) current `Peer` memory usage & (3) max `Peer` memory usage.\n- Status: the broad strokes are in place, but there are some fields that are not yet accounted for (details in PR description). Also, I would love review to know if the code actually does what I think it does!\n- Desired improvement: update the max peer memory usage to incorporate `CNode` memory, so it will be a better representation of the entire connection.\n- This [spreadsheet](https://docs.google.com/spreadsheets/d/1VsKj0RxhLOo2m512dq1FwP6NHkA6TcKP01OIjyHUKN8/edit?usp=sharing) are the results from running the patch on my node with inbounds enabled for approximately 5 days (nov 10-15). it shows a dramatic difference between the max memory usage of block-relay-only peers vs full-relay peers.\n\nthis graph shows memory usage broken down by max & current, for connections with relay enabled or not. \n_y axis: number of bytes, x axis: different nodes._\n![Screen Shot 2023-11-15 at 7.11.34 PM|690x423](upload://wYsgujkjX8Cfk9KFfyKeB3CsyiH.png)\n\n\n## Warnet: \nWarnet can help us observe different network conditions. Here are some questions I'm curious about, where I think warnet can create/isolate behaviors we sometimes see:\n- When [LinkingLion](https://b10c.me/observations/06-linkinglion/) is on the prowl, there is high churn of inbound connections. How much memory does each short-lived connections use? \n- Especially with ordinals/transcriptions, we sometimes see really high transaction volume. How does that impact the expected/average memory usage of our full-relay connections? \n\nDo you have more ideas? :)",
  "actions_summary": [
    {
      "id": 2,
      "count": 2
    }
  ],
  "moderator": true,
  "admin": false,
  "staff": true,
  "group_moderator": true,
  "user_id": 4,
  "hidden": false,
  "trust_level": 3,
  "deleted_at": null,
  "user_deleted": false,
  "edit_reason": null,
  "can_view_edit_history": true,
  "wiki": false,
  "reactions": [
    {
      "id": "+1",
      "type": "emoji",
      "count": 2
    }
  ],
  "current_user_reaction": null,
  "reaction_users_count": 2,
  "current_user_used_main_reaction": false
}