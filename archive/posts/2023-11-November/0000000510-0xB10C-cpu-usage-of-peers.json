{
  "id": 510,
  "name": "0xB10C",
  "username": "0xB10C",
  "avatar_template": "/user_avatar/delvingbitcoin.org/0xb10c/{size}/15_2.png",
  "created_at": "2023-11-29T16:23:57.313Z",
  "cooked": "<p>I\u2019ve looked into this early November for <a href=\"https://github.com/bitcoin/bitcoin/pull/28463\" class=\"inline-onebox\">p2p: Increase inbound capacity for block-relay only connections by mzumsande \u00b7 Pull Request #28463 \u00b7 bitcoin/bitcoin \u00b7 GitHub</a>.</p>\n<h1><a name=\"methodology-1\" class=\"anchor\" href=\"#methodology-1\"></a>Methodology</h1>\n<p>To measure CPU usage of peers in Bitcoin Core I\u2019ve opted to measure the time we spent in <code>ProcessMessages()</code> and <code>SendMessages()</code> per peer. I\u2019ve added a tracepoint to the end of both functions and pass, for example, the peer id, the connection type, and function duration. I hook into these tracepoints with a simple <code>bpftrace</code> script that prints each <code>SendMessages()</code> and <code>ProcessMessages()</code> function call as CSV-formatted row. See <a href=\"https://github.com/0xB10C/bitcoin/commit/59c0fe438a3e62d27eda237ae20c062608e047b3\" class=\"inline-onebox\">no-merge: tracepoints and script to log fn timings \u00b7 0xB10C/bitcoin@59c0fe4 \u00b7 GitHub</a>.</p>\n<h1><a name=\"setup-2\" class=\"anchor\" href=\"#setup-2\"></a>Setup</h1>\n<p>The underlying node is hosted on a VPS of a large cloud provider and has access to four AMD EPYC 7R32 cores (the message handling thread of Bitcoin Core is single-threaded and only uses one of these). The IP address of the node is well-known in the network. The node is pruned, which means no one was doing an IBD from the node. Other than pruning and debug logging enabled, the node is running with default parameters. The timing measurements posted here were all taken with all inbound slots filled (the per-peer measurements with about half-full inbound slots were similar). I\u2019ve only looked at connections that that ended up being connected for more than a minute. This means, the data doesn\u2019t cover short-lived feeler connections we made or received and it doesn\u2019t cover short-lived spy node connections that were evicted after a few seconds.</p>\n<aside class=\"quote no-group\" data-username=\"amiti\" data-post=\"1\" data-topic=\"196\">\n<div class=\"title\">\n<div class=\"quote-controls\"></div>\n<img loading=\"lazy\" alt=\"\" width=\"24\" height=\"24\" src=\"https://delvingbitcoin.org/letter_avatar_proxy/v4/letter/a/e5b9ba/48.png\" class=\"avatar\"> amiti:</div>\n<blockquote>\n<p>how different network conditions impact the expected CPU usage per peer</p>\n</blockquote>\n</aside>\n<p>I\u2019ve repeated these measurements on weekdays and a weekend in early November 2023. The resulting numbers differ slightly. This is likely related to, for example:</p>\n<ul>\n<li>transaction broadcast rate on the network \u2192 with more transactions being broadcast we spent more time validating transactions, which is <em>expensive</em> (see below)</li>\n<li>number of <code>inbound full-relay</code> vs <code>inbound block-relay-only</code> connections\n \u2192 <code>inbound full-relay</code> are more expensive than <code>inbound block-relay-only</code> connections (see below)</li>\n<li>\u2026</li>\n</ul>\n<h1><a name=\"total-time-spent-sending-and-processing-messages-3\" class=\"anchor\" href=\"#total-time-spent-sending-and-processing-messages-3\"></a>Total time spent sending and processing messages</h1>\n<p>To start, this is the <strong>time spent per second</strong> in <code>SendMessages()</code> and <code>ProcessMessages()</code> summed up for all peers.</p>\n<p>On November 4th and 5th, the weekend before, it averaged at around 56ms per second.\n<div class=\"lightbox-wrapper\"><a class=\"lightbox\" href=\"https://delvingbitcoin.org/uploads/default/original/1X/037ef74a035b38699c2e39c3c9b9cb981602f8ba.jpeg\" data-download-href=\"https://delvingbitcoin.org/uploads/default/037ef74a035b38699c2e39c3c9b9cb981602f8ba\" title=\"image|100%\"><img src=\"https://delvingbitcoin.org/uploads/default/optimized/1X/037ef74a035b38699c2e39c3c9b9cb981602f8ba_2_690x357.jpeg\" alt=\"image|100%\" data-base62-sha1=\"uVsfUYyeYsClQ5vnJnhKOpHtq2\" width=\"690\" height=\"357\" srcset=\"https://delvingbitcoin.org/uploads/default/optimized/1X/037ef74a035b38699c2e39c3c9b9cb981602f8ba_2_690x357.jpeg, https://delvingbitcoin.org/uploads/default/optimized/1X/037ef74a035b38699c2e39c3c9b9cb981602f8ba_2_1035x535.jpeg 1.5x, https://delvingbitcoin.org/uploads/default/optimized/1X/037ef74a035b38699c2e39c3c9b9cb981602f8ba_2_1380x714.jpeg 2x\" data-dominant-color=\"EEEFF6\"><div class=\"meta\"><svg class=\"fa d-icon d-icon-far-image svg-icon\" aria-hidden=\"true\"><use href=\"#far-image\"></use></svg><span class=\"filename\">image|100%</span><span class=\"informations\">1600\u00d7828 266 KB</span><svg class=\"fa d-icon d-icon-discourse-expand svg-icon\" aria-hidden=\"true\"><use href=\"#discourse-expand\"></use></svg></div></a></div></p>\n<p>On November 7th, a Tuesday, this averaged at about 32ms per second with 125 connections. This is on average about 17ms per second processing messages and 15ms per second sending messages.\n<div class=\"lightbox-wrapper\"><a class=\"lightbox\" href=\"https://delvingbitcoin.org/uploads/default/original/1X/5cfaf11a8d32bbf1cfa2d429a0e000f27129dad7.jpeg\" data-download-href=\"https://delvingbitcoin.org/uploads/default/5cfaf11a8d32bbf1cfa2d429a0e000f27129dad7\" title=\"image|100%\"><img src=\"https://delvingbitcoin.org/uploads/default/optimized/1X/5cfaf11a8d32bbf1cfa2d429a0e000f27129dad7_2_690x357.jpeg\" alt=\"image|100%\" data-base62-sha1=\"dgxzbYKPOYDM7J9kWZHTe7mr9oX\" width=\"690\" height=\"357\" srcset=\"https://delvingbitcoin.org/uploads/default/optimized/1X/5cfaf11a8d32bbf1cfa2d429a0e000f27129dad7_2_690x357.jpeg, https://delvingbitcoin.org/uploads/default/optimized/1X/5cfaf11a8d32bbf1cfa2d429a0e000f27129dad7_2_1035x535.jpeg 1.5x, https://delvingbitcoin.org/uploads/default/optimized/1X/5cfaf11a8d32bbf1cfa2d429a0e000f27129dad7_2_1380x714.jpeg 2x\" data-dominant-color=\"E5E9F1\"><div class=\"meta\"><svg class=\"fa d-icon d-icon-far-image svg-icon\" aria-hidden=\"true\"><use href=\"#far-image\"></use></svg><span class=\"filename\">image|100%</span><span class=\"informations\">1600\u00d7828 151 KB</span><svg class=\"fa d-icon d-icon-discourse-expand svg-icon\" aria-hidden=\"true\"><use href=\"#discourse-expand\"></use></svg></div></a></div>\nThere were short periods with the total time per second reaching nearly 1000ms per second. This 100% usage of this one CPU core.</p>\n<h1><a name=\"per-peer-time-spent-sending-and-processing-messages-4\" class=\"anchor\" href=\"#per-peer-time-spent-sending-and-processing-messages-4\"></a>Per-peer time spent sending and processing messages</h1>\n<aside class=\"quote no-group\" data-username=\"amiti\" data-post=\"1\" data-topic=\"196\">\n<div class=\"title\">\n<div class=\"quote-controls\"></div>\n<img loading=\"lazy\" alt=\"\" width=\"24\" height=\"24\" src=\"https://delvingbitcoin.org/letter_avatar_proxy/v4/letter/a/e5b9ba/48.png\" class=\"avatar\"> amiti:</div>\n<blockquote>\n<ul>\n<li>worst case CPU usage for a single peer \u2192 this can help us understand if increasing the total number of incoming slots is okay, or could be problematic</li>\n<li>worst &amp; average case CPU usage for a block-relay-only peer vs full-relay peer \u2192 for more granularity around evaluating the above</li>\n</ul>\n</blockquote>\n</aside>\n<p>Looking at individual peers by connection direction and connection type shows which connections are cheaper and which are more expensive. I assume that an inbound connection sending me a version message with the <code>f_realy</code> flag set to false is an outbound block-relay-only connection by the peer. While <code>-blocksonly</code> nodes (see <a href=\"https://bitcoin.stackexchange.com/a/114082/63817\" class=\"inline-onebox\">network - What is the difference between blocksonly and block-relay-only in Bitcoin Core? - Bitcoin Stack Exchange</a>) have the fingerprint, I assume that these are rare and only marginally affect the numbers.</p>\n<p>November 4th and 5th:\n<div class=\"lightbox-wrapper\"><a class=\"lightbox\" href=\"https://delvingbitcoin.org/uploads/default/original/1X/41c44898b7f5cc254441e9d74d9c04a8f5336c78.jpeg\" data-download-href=\"https://delvingbitcoin.org/uploads/default/41c44898b7f5cc254441e9d74d9c04a8f5336c78\" title=\"image|100%\"><img src=\"https://delvingbitcoin.org/uploads/default/optimized/1X/41c44898b7f5cc254441e9d74d9c04a8f5336c78_2_690x351.jpeg\" alt=\"image|100%\" data-base62-sha1=\"9nNzpJsb0cQ7i0ZuM8izyQnUFaU\" width=\"690\" height=\"351\" srcset=\"https://delvingbitcoin.org/uploads/default/optimized/1X/41c44898b7f5cc254441e9d74d9c04a8f5336c78_2_690x351.jpeg, https://delvingbitcoin.org/uploads/default/optimized/1X/41c44898b7f5cc254441e9d74d9c04a8f5336c78_2_1035x526.jpeg 1.5x, https://delvingbitcoin.org/uploads/default/optimized/1X/41c44898b7f5cc254441e9d74d9c04a8f5336c78_2_1380x702.jpeg 2x\" data-dominant-color=\"EDE8E7\"><div class=\"meta\"><svg class=\"fa d-icon d-icon-far-image svg-icon\" aria-hidden=\"true\"><use href=\"#far-image\"></use></svg><span class=\"filename\">image|100%</span><span class=\"informations\">1600\u00d7816 173 KB</span><svg class=\"fa d-icon d-icon-discourse-expand svg-icon\" aria-hidden=\"true\"><use href=\"#discourse-expand\"></use></svg></div></a></div></p>\n<p>November 7th:\n<div class=\"lightbox-wrapper\"><a class=\"lightbox\" href=\"https://delvingbitcoin.org/uploads/default/original/1X/20a18f2fb607df745cd2c794cc64ed8e1a52d102.jpeg\" data-download-href=\"https://delvingbitcoin.org/uploads/default/20a18f2fb607df745cd2c794cc64ed8e1a52d102\" title=\"image|100%\"><img src=\"https://delvingbitcoin.org/uploads/default/optimized/1X/20a18f2fb607df745cd2c794cc64ed8e1a52d102_2_690x357.jpeg\" alt=\"image|100%\" data-base62-sha1=\"4EFpVXLiXNXuKlTdNcQ5rK3hQJA\" width=\"690\" height=\"357\" srcset=\"https://delvingbitcoin.org/uploads/default/optimized/1X/20a18f2fb607df745cd2c794cc64ed8e1a52d102_2_690x357.jpeg, https://delvingbitcoin.org/uploads/default/optimized/1X/20a18f2fb607df745cd2c794cc64ed8e1a52d102_2_1035x535.jpeg 1.5x, https://delvingbitcoin.org/uploads/default/optimized/1X/20a18f2fb607df745cd2c794cc64ed8e1a52d102_2_1380x714.jpeg 2x\" data-dominant-color=\"EDEAE9\"><div class=\"meta\"><svg class=\"fa d-icon d-icon-far-image svg-icon\" aria-hidden=\"true\"><use href=\"#far-image\"></use></svg><span class=\"filename\">image|100%</span><span class=\"informations\">1600\u00d7830 176 KB</span><svg class=\"fa d-icon d-icon-discourse-expand svg-icon\" aria-hidden=\"true\"><use href=\"#discourse-expand\"></use></svg></div></a></div></p>\n<div class=\"md-table\">\n<table>\n<thead>\n<tr>\n<th>connection type</th>\n<th>mean 4th+5th</th>\n<th>mean 7th</th>\n<th>stdev 4th+5th</th>\n<th>stdev 7th</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>outbound full-relay</td>\n<td>661.77\u00b5s</td>\n<td>611.63\u00b5s</td>\n<td>1378.43\u00b5s</td>\n<td>2596.95\u00b5s</td>\n</tr>\n<tr>\n<td>inbound full-relay</td>\n<td>457.81\u00b5s</td>\n<td>271.72\u00b5s</td>\n<td>880.94\u00b5s</td>\n<td>1061.78\u00b5s</td>\n</tr>\n<tr>\n<td>outbound block-relay-only</td>\n<td>94.62\u00b5s</td>\n<td>86.14\u00b5s</td>\n<td>24.67\u00b5s</td>\n<td>158.18\u00b5s</td>\n</tr>\n<tr>\n<td>inbound block-relay-only</td>\n<td>96.84\u00b5s</td>\n<td>84.34\u00b5s</td>\n<td>77.94\u00b5s</td>\n<td>76.31\u00b5s</td>\n</tr>\n</tbody>\n</table>\n</div><p>The connections spend slightly less time on average on the 7th, but had a higher standard deviation. Likely related to differences in messages relayed on the network, however, I haven\u2019t looked deeper into it.</p>\n<p>Outbound full-relay connections are the most expensive connections here taking more than 600\u00b5s per second on average. We currently only ever make 8 of these at a time. Inbound full-relay connections are cheaper than outbound full-relay connections but still expensive compared to block-relay connections. However, we accept up to 114 inbound full-relay connections (typically about 91 due to some being block-relay-only, see also <a href=\"https://github.com/bitcoin/bitcoin/pull/28463#issuecomment-1810591988\">#28463 (comment)</a>). Inbound and outbound block-relay-only connections spent just under 100\u00b5s sending and processing messages per second on average. These are the cheapest connections.</p>\n<h1><a name=\"time-spent-processing-messages-by-relay-type-and-connection-direction-5\" class=\"anchor\" href=\"#time-spent-processing-messages-by-relay-type-and-connection-direction-5\"></a>Time spent processing messages by relay type and connection direction</h1>\n<p>Since <code>ProcessMessages()</code> only ever processes one message at a time, we can measure the processing time by received message. <code>SendMessages()</code> might send zero, one, or multiple messages when called which makes the same measurement harder.</p>\n<p>Data from November 7th. Boxenplot of time taken to process a received message by relay-type.</p>\n<p><div class=\"lightbox-wrapper\"><a class=\"lightbox\" href=\"https://delvingbitcoin.org/uploads/default/original/1X/5aa77688d2cfad866e763fe526efb2f568f25d06.png\" data-download-href=\"https://delvingbitcoin.org/uploads/default/5aa77688d2cfad866e763fe526efb2f568f25d06\" title=\"image|100%\"><img src=\"https://delvingbitcoin.org/uploads/default/optimized/1X/5aa77688d2cfad866e763fe526efb2f568f25d06_2_690x358.png\" alt=\"image|100%\" data-base62-sha1=\"cVXL8h4BK8VTg8Ow2aAYDnz0ivI\" width=\"690\" height=\"358\" srcset=\"https://delvingbitcoin.org/uploads/default/optimized/1X/5aa77688d2cfad866e763fe526efb2f568f25d06_2_690x358.png, https://delvingbitcoin.org/uploads/default/optimized/1X/5aa77688d2cfad866e763fe526efb2f568f25d06_2_1035x537.png 1.5x, https://delvingbitcoin.org/uploads/default/optimized/1X/5aa77688d2cfad866e763fe526efb2f568f25d06_2_1380x716.png 2x\" data-dominant-color=\"F6F6F6\"><div class=\"meta\"><svg class=\"fa d-icon d-icon-far-image svg-icon\" aria-hidden=\"true\"><use href=\"#far-image\"></use></svg><span class=\"filename\">image|100%</span><span class=\"informations\">1660\u00d7863 71.1 KB</span><svg class=\"fa d-icon d-icon-discourse-expand svg-icon\" aria-hidden=\"true\"><use href=\"#discourse-expand\"></use></svg></div></a></div></p>\n<p><code>tx</code>, <code>addr</code>, and <code>addrv2</code> messages are only received and processed by full-relay peers. Especially <code>tx</code> messages are expensive with close to 0.5ms in median. While I received a few <code>inv</code> and <code>getdata</code> messages from block-relay-only peers, the majority stems from full-relay peers. Additionally, during this time-frame, all <code>cmptblock</code> messages were received by full-relay peers.</p>\n<p>Inbound <code>version</code> messages take slightly shorter to process for block-relay-only connections than for full-relay. <a class=\"mention\" href=\"/u/amiti\">@amiti</a> suggested this might be related to initializing the data structures for transaction relay?</p>\n<h1><a name=\"learnings-6\" class=\"anchor\" href=\"#learnings-6\"></a>Learnings</h1>\n<ul>\n<li>On a modern server CPU core (AMD EPYC 7R32), Bitcoin Core usually spends less than 100ms (10%) of the time in the (single-thread) message handling thread with full inbound slots.</li>\n<li>Very roughly, an <code>outbound full-relay</code> connection (~600\u00b5s per second) has about 6x the <em>CPU usage</em> of an <code>outbound block-relay-only</code> connection (~100\u00b5s per second). An <code>inbound full-relay</code> connection (~300\u00b5s per second) has 3x the <em>CPU usage</em> of an <code>inbound block-relay-only</code> connection (~100\u00b5s per second).</li>\n<li>As to be expected: Time spent processing and sending messages per second is lower for <code>block-relay-only</code> connections compared to <code>full-relay</code>. The <code>block-relay-only</code> connections don\u2019t process and send transactions. On the processing side, transaction relay is more expensive than address relay.</li>\n</ul>\n<h1><a name=\"increasing-number-of-block-relay-only-slots-and-connections-7\" class=\"anchor\" href=\"#increasing-number-of-block-relay-only-slots-and-connections-7\"></a>Increasing number of block-relay-only slots and connections</h1>\n<p><a href=\"https://github.com/bitcoin/bitcoin/pull/28463\">#28463</a> proposes to increase the number of inbound connection slots for block-relay-only connections. Currently, a node has about 91 full-relay and 23 block-relay-only inbound connections (80% and 20% of 114). As currently proposed, the PR increases this to about 113 full-relay and 75 block-relay-only connections (60% and 40% of 189 = 200 - 2 - 1 - 8).</p>\n<p>Assuming 600\u00b5s for a <code>outbound full-relay</code> connection, 300\u00b5s for an <code>inbound full-relay</code> and 100\u00b5s for a <code>block-relay</code> connection, currently we are at 34.6ms per second and will be at 46.4ms (increase of 34%) with the proposed change. 6.6ms more due to the new full-relay connections and 5.2ms due to the block-relay-only connections. While spending 46.4ms per second in the message handling thread is probably fine, a more conservative change might be to leave the number of full-relay inbound slots largely untouched. Here, RAM and bandwidth usage should be considered too.</p>\n<p>currently: <span class=\"math\"> 8 * 600\u00b5s + 2 * 100\u00b5s + 91 * 300\u00b5s + 23 * 100\u00b5s = 34600\u00b5s = 34.6ms </span>\nas proposed: <span class=\"math\"> 8 * 600\u00b5s + 2 * 100\u00b5s + 113 * 300\u00b5s + 75 * 100\u00b5s = 46400\u00b5s = 46.4ms </span></p>\n<p>Since later increasing from 2 outbound block-relay connections to 8 as proposed in <a href=\"https://github.com/bitcoin/bitcoin/issues/28462\">#28462</a> is only an increase of <span class=\"math\"> 6 * 100\u00b5s </span>, I don\u2019t see a problem with this from the <em>CPU usage</em> side.</p>\n<h1><a name=\"some-notes-8\" class=\"anchor\" href=\"#some-notes-8\"></a>Some notes</h1>\n<ul>\n<li>\n<p>It would also be useful to have these measurements for Erlay. Maybe Erlay makes transaction relay a lot cheaper (or a lot more expensive?).</p>\n</li>\n<li>\n<p>These measurements were made on a server CPU core where a 34% increase is only about 11ms per second. However, the numbers might looks very different on a <a href=\"https://www.cpubenchmark.net/compare/3894vs4297/AMD-EPYC-7R32-vs-BCM2711\">nearly 70% slower</a> Raspberry Pi 4 BCM2711 Core.\n<div class=\"lightbox-wrapper\"><a class=\"lightbox\" href=\"https://delvingbitcoin.org/uploads/default/original/1X/425ccc585b55907ea9b26b9a3bd1a7f1e796eef3.png\" data-download-href=\"https://delvingbitcoin.org/uploads/default/425ccc585b55907ea9b26b9a3bd1a7f1e796eef3\" title=\"image\"><img src=\"https://delvingbitcoin.org/uploads/default/optimized/1X/425ccc585b55907ea9b26b9a3bd1a7f1e796eef3_2_690x165.png\" alt=\"image\" data-base62-sha1=\"9t4kBszGXlMCsFx7F6XQx3ZIHoD\" width=\"690\" height=\"165\" srcset=\"https://delvingbitcoin.org/uploads/default/optimized/1X/425ccc585b55907ea9b26b9a3bd1a7f1e796eef3_2_690x165.png, https://delvingbitcoin.org/uploads/default/original/1X/425ccc585b55907ea9b26b9a3bd1a7f1e796eef3.png 1.5x, https://delvingbitcoin.org/uploads/default/original/1X/425ccc585b55907ea9b26b9a3bd1a7f1e796eef3.png 2x\" data-dominant-color=\"F0F2F3\"><div class=\"meta\"><svg class=\"fa d-icon d-icon-far-image svg-icon\" aria-hidden=\"true\"><use href=\"#far-image\"></use></svg><span class=\"filename\">image</span><span class=\"informations\">905\u00d7217 16.3 KB</span><svg class=\"fa d-icon d-icon-discourse-expand svg-icon\" aria-hidden=\"true\"><use href=\"#discourse-expand\"></use></svg></div></a></div></p>\n</li>\n<li>\n<p>Since my node is pruned, this does not include IBD data, which might raise the average time spent in <code>SendMessages()</code> (for both full-relay and block-relay connections).</p>\n</li>\n<li>\n<p>Time spent in function isn\u2019t a perfect measurement of CPU usage. For example, when sending requested blocks, a big chunk of the time might be spent waiting on disk IO.</p>\n</li>\n</ul>\n<hr>\n<p>Thank you <a href=\"https://dci.mit.edu/\">MIT DCI</a> for sponsoring the node I\u2019ve used to measure this (and five more for related purposes!).</p>",
  "post_number": 2,
  "post_type": 1,
  "updated_at": "2023-11-29T16:23:57.313Z",
  "reply_count": 0,
  "reply_to_post_number": null,
  "quote_count": 1,
  "incoming_link_count": 0,
  "reads": 8,
  "readers_count": 7,
  "score": 16.4,
  "yours": false,
  "topic_id": 196,
  "topic_slug": "cpu-usage-of-peers",
  "topic_title": "CPU usage of peers",
  "topic_html_title": "CPU usage of peers",
  "category_id": 10,
  "display_username": "0xB10C",
  "primary_group_name": null,
  "flair_name": null,
  "flair_url": null,
  "flair_bg_color": null,
  "flair_color": null,
  "flair_group_id": null,
  "version": 1,
  "can_edit": false,
  "can_delete": false,
  "can_recover": false,
  "can_see_hidden_post": false,
  "can_wiki": false,
  "user_title": null,
  "bookmarked": false,
  "raw": "I've looked into this early November for https://github.com/bitcoin/bitcoin/pull/28463.\n\n# Methodology\n\nTo measure CPU usage of peers in Bitcoin Core I've opted to measure the time we spent in `ProcessMessages()` and `SendMessages()` per peer. I've added a tracepoint to the end of both functions and pass, for example, the peer id, the connection type, and function duration. I hook into these tracepoints with a simple `bpftrace` script that prints each `SendMessages()` and `ProcessMessages()` function call as CSV-formatted row. See https://github.com/0xB10C/bitcoin/commit/59c0fe438a3e62d27eda237ae20c062608e047b3.\n\n\n# Setup\n\nThe underlying node is hosted on a VPS of a large cloud provider and has access to four AMD EPYC 7R32 cores (the message handling thread of Bitcoin Core is single-threaded and only uses one of these). The IP address of the node is well-known in the network. The node is pruned, which means no one was doing an IBD from the node. Other than pruning and debug logging enabled, the node is running with default parameters. The timing measurements posted here were all taken with all inbound slots filled (the per-peer measurements with about half-full inbound slots were similar). I've only looked at connections that that ended up being connected for more than a minute. This means, the data doesn't cover short-lived feeler connections we made or received and it doesn't cover short-lived spy node connections that were evicted after a few seconds.\n\n[quote=\"amiti, post:1, topic:196\"]\nhow different network conditions impact the expected CPU usage per peer\n[/quote]\n\nI've repeated these measurements on weekdays and a weekend in early November 2023. The resulting numbers differ slightly. This is likely related to, for example:\n\n- transaction broadcast rate on the network -> with more transactions being broadcast we spent more time validating transactions, which is _expensive_ (see below)\n- number of `inbound full-relay` vs `inbound block-relay-only` connections \n    -> `inbound full-relay` are more expensive than `inbound block-relay-only` connections (see below)\n- ...\n\n# Total time spent sending and processing messages \n\nTo start, this is the **time spent per second** in `SendMessages()` and `ProcessMessages()` summed up for all peers.\n\nOn November 4th and 5th, the weekend before, it averaged at around 56ms per second.\n![image|100%](upload://uVsfUYyeYsClQ5vnJnhKOpHtq2.jpeg)\n\nOn November 7th, a Tuesday, this averaged at about 32ms per second with 125 connections. This is on average about 17ms per second processing messages and 15ms per second sending messages.\n![image|100%](upload://dgxzbYKPOYDM7J9kWZHTe7mr9oX.jpeg)\nThere were short periods with the total time per second reaching nearly 1000ms per second. This 100% usage of this one CPU core.\n\n# Per-peer time spent sending and processing messages\n[quote=\"amiti, post:1, topic:196\"]\n* worst case CPU usage for a single peer \u2192 this can help us understand if increasing the total number of incoming slots is okay, or could be problematic\n* worst & average case CPU usage for a block-relay-only peer vs full-relay peer \u2192 for more granularity around evaluating the above\n[/quote]\n\nLooking at individual peers by connection direction and connection type shows which connections are cheaper and which are more expensive. I assume that an inbound connection sending me a version message with the `f_realy` flag set to false is an outbound block-relay-only connection by the peer. While `-blocksonly` nodes (see https://bitcoin.stackexchange.com/a/114082/63817) have the fingerprint, I assume that these are rare and only marginally affect the numbers.\n\nNovember 4th and 5th:\n![image|100%](upload://9nNzpJsb0cQ7i0ZuM8izyQnUFaU.jpeg)\n\n\nNovember 7th:\n![image|100%](upload://4EFpVXLiXNXuKlTdNcQ5rK3hQJA.jpeg)\n\n\n| connection type         | mean 4th+5th | mean 7th | stdev 4th+5th | stdev 7th |\n|---------------------------|--------------|----------|---------------|-----------|\n| outbound full-relay       | 661.77\u00b5s     | 611.63\u00b5s | 1378.43\u00b5s     | 2596.95\u00b5s |\n| inbound full-relay        | 457.81\u00b5s     | 271.72\u00b5s | 880.94\u00b5s      | 1061.78\u00b5s |\n| outbound block-relay-only | 94.62\u00b5s      | 86.14\u00b5s  | 24.67\u00b5s       | 158.18\u00b5s  |\n| inbound block-relay-only  | 96.84\u00b5s      | 84.34\u00b5s  | 77.94\u00b5s       | 76.31\u00b5s   |\n\nThe connections spend slightly less time on average on the 7th, but had a higher standard deviation. Likely related to differences in messages relayed on the network, however, I haven't looked deeper into it. \n\nOutbound full-relay connections are the most expensive connections here taking more than 600\u00b5s per second on average. We currently only ever make 8 of these at a time. Inbound full-relay connections are cheaper than outbound full-relay connections but still expensive compared to block-relay connections. However, we accept up to 114 inbound full-relay connections (typically about 91 due to some being block-relay-only, see also [#28463 (comment)](https://github.com/bitcoin/bitcoin/pull/28463#issuecomment-1810591988)). Inbound and outbound block-relay-only connections spent just under 100\u00b5s sending and processing messages per second on average. These are the cheapest connections. \n\n# Time spent processing messages by relay type and connection direction\n\nSince `ProcessMessages()` only ever processes one message at a time, we can measure the processing time by received message. `SendMessages()` might send zero, one, or multiple messages when called which makes the same measurement harder.\n\nData from November 7th. Boxenplot of time taken to process a received message by relay-type.\n\n![image|100%](upload://cVXL8h4BK8VTg8Ow2aAYDnz0ivI.png)\n\n\n`tx`, `addr`, and `addrv2` messages are only received and processed by full-relay peers. Especially `tx` messages are expensive with close to 0.5ms in median. While I received a few `inv` and `getdata` messages from block-relay-only peers, the majority stems from full-relay peers. Additionally, during this time-frame, all `cmptblock` messages were received by full-relay peers.\n\nInbound `version` messages take slightly shorter to process for block-relay-only connections than for full-relay. @amiti suggested this might be related to initializing the data structures for transaction relay?\n\n# Learnings\n- On a modern server CPU core (AMD EPYC 7R32), Bitcoin Core usually spends less than 100ms (10%) of the time in the (single-thread) message handling thread with full inbound slots.\n- Very roughly, an `outbound full-relay` connection (~600\u00b5s per second) has about 6x the _CPU usage_ of an `outbound block-relay-only` connection (~100\u00b5s per second). An `inbound full-relay` connection (~300\u00b5s per second) has 3x the _CPU usage_ of an `inbound block-relay-only` connection (~100\u00b5s per second).   \n- As to be expected: Time spent processing and sending messages per second is lower for `block-relay-only` connections compared to `full-relay`. The `block-relay-only` connections don't process and send transactions. On the processing side, transaction relay is more expensive than address relay.\n\n# Increasing number of block-relay-only slots and connections\n\n[#28463](https://github.com/bitcoin/bitcoin/pull/28463) proposes to increase the number of inbound connection slots for block-relay-only connections. Currently, a node has about 91 full-relay and 23 block-relay-only inbound connections (80% and 20% of 114). As currently proposed, the PR increases this to about 113 full-relay and 75 block-relay-only connections (60% and 40% of 189 = 200 - 2 - 1 - 8).\n\nAssuming 600\u00b5s for a `outbound full-relay` connection, 300\u00b5s for an `inbound full-relay` and 100\u00b5s for a `block-relay` connection, currently we are at 34.6ms per second and will be at 46.4ms (increase of 34%) with the proposed change. 6.6ms more due to the new full-relay connections and 5.2ms due to the block-relay-only connections. While spending 46.4ms per second in the message handling thread is probably fine, a more conservative change might be to leave the number of full-relay inbound slots largely untouched. Here, RAM and bandwidth usage should be considered too.     \n\ncurrently: $ 8 * 600\u00b5s + 2 * 100\u00b5s + 91 * 300\u00b5s + 23 * 100\u00b5s = 34600\u00b5s = 34.6ms $\nas proposed: $ 8 * 600\u00b5s + 2 * 100\u00b5s + 113 * 300\u00b5s + 75 * 100\u00b5s = 46400\u00b5s = 46.4ms $\n\nSince later increasing from 2 outbound block-relay connections to 8 as proposed in [#28462](https://github.com/bitcoin/bitcoin/issues/28462) is only an increase of $ 6 * 100\u00b5s $, I don't see a problem with this from the _CPU usage_ side.\n\n# Some notes \n- It would also be useful to have these measurements for Erlay. Maybe Erlay makes transaction relay a lot cheaper (or a lot more expensive?).\n- These measurements were made on a server CPU core where a 34% increase is only about 11ms per second. However, the numbers might looks very different on a [nearly 70% slower](https://www.cpubenchmark.net/compare/3894vs4297/AMD-EPYC-7R32-vs-BCM2711) Raspberry Pi 4 BCM2711 Core. \n![image|690x165](upload://9t4kBszGXlMCsFx7F6XQx3ZIHoD.png)\n\n- Since my node is pruned, this does not include IBD data, which might raise the average time spent in `SendMessages()` (for both full-relay and block-relay connections).   \n- Time spent in function isn't a perfect measurement of CPU usage. For example, when sending requested blocks, a big chunk of the time might be spent waiting on disk IO.\n\n---\n\nThank you [MIT DCI](https://dci.mit.edu/) for sponsoring the node I've used to measure this (and five more for related purposes!).",
  "actions_summary": [
    {
      "id": 2,
      "count": 1
    }
  ],
  "moderator": false,
  "admin": false,
  "staff": false,
  "group_moderator": true,
  "user_id": 16,
  "hidden": false,
  "trust_level": 3,
  "deleted_at": null,
  "user_deleted": false,
  "edit_reason": null,
  "can_view_edit_history": true,
  "wiki": false,
  "reactions": [
    {
      "id": "+1",
      "type": "emoji",
      "count": 1
    }
  ],
  "current_user_reaction": null,
  "reaction_users_count": 1,
  "current_user_used_main_reaction": false
}