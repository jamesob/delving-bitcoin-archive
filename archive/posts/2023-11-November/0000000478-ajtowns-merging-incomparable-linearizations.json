{
  "id": 478,
  "name": "Anthony Towns",
  "username": "ajtowns",
  "avatar_template": "/user_avatar/delvingbitcoin.org/ajtowns/{size}/417_2.png",
  "created_at": "2023-11-24T10:21:08.333Z",
  "cooked": "<ul>\n<li>Assume you have a function <span class=\"math\">C(L)</span> that takes a linearisation <span class=\"math\">L</span> and splits that into <span class=\"math\">P_L, T_L</span> where <span class=\"math\">P_L</span> is the first chunk, and <span class=\"math\">T_L</span> is the rest of the linearisation. If <span class=\"math\">L</span> is non-empty, <span class=\"math\">P_L</span> is non-empty also; however <span class=\"math\">T_L</span> may be empty.</li>\n<li>Assume you can calculate <span class=\"math\">L - X</span> where <span class=\"math\">L</span> and <span class=\"math\">X</span> and the result is just <span class=\"math\">L</span> with the transactions in <span class=\"math\">X</span> removed</li>\n<li>We say that <span class=\"math\">A \\le B</span> by doing a feerate diagram comparison and noting <span class=\"math\">B</span> is has a higher or equal feerate at all points.</li>\n</ul>\n<p>I think prefix-intersection merging, <span class=\"math\">M(L_1, L_2)</span> is equivalent to:</p>\n<ul>\n<li>Take <span class=\"math\">P_1, T_1 = C(L_1)</span> and <span class=\"math\">P_2, T_2 = C(L_2)</span></li>\n<li>Reorder the transactions in <span class=\"math\">P_1</span> to match the order they appear in <span class=\"math\">L_2</span>, call this <span class=\"math\">P^\\prime_1</span>, and then calculate <span class=\"math\">R_1, X_1 = C(P^\\prime_1)</span>. Note that <span class=\"math\">P_1 \\le R_1</span>.</li>\n<li>Calculate <span class=\"math\">R_2, X_2</span> in the same way from <span class=\"math\">P_2</span>.</li>\n<li>Choose the highest feerate chunk from <span class=\"math\">R_1, R_2</span>:\n<ul>\n<li>If <span class=\"math\">R_1</span> is the highest, then: <span class=\"math\">M(L_1, L_2) = R_1 + M(X_1 + T_1, L_2-R_1)</span></li>\n<li>Otherwise: <span class=\"math\">M_{PI}(L_1, L_2) = R_2 + M(L_1-R_2, X_2 + T_2)</span></li>\n</ul>\n</li>\n</ul>\n<p>For the case where <span class=\"math\">R_1</span> is highest, then <span class=\"math\">M(L_1, L_2) = M(R_1 + X_1 + T_1, L_2)</span> and <span class=\"math\">L_1 \\le R_1 + X_1 + T_1</span>.</p>\n<p>The question is whether <span class=\"math\">L_2 \\le R_1 + (L_2-R_1)</span>, noting that the transactions in <span class=\"math\">R_1</span> that we\u2019ve removed from <span class=\"math\">L_2</span> maintain their order, and have an equal or higher feerate than the original best chunk.</p>\n<p>Consider each chunk from <span class=\"math\">L_2</span>, call them <span class=\"math\">c_1, c_2, c_3, \\dots, c_n</span>. Then define <span class=\"math\">d_i = c_i - R_1</span>, and <span class=\"math\">e_i = c_i - d_i</span>. In that case <span class=\"math\">R_1 = e_1 + e_2 + e_3 + \\dots + e_n</span> (because <span class=\"math\">R_1</span> is the first chunk of <span class=\"math\">P^\\prime_1</span> which had its transactions put in the same order as <span class=\"math\">L_2</span>).</p>\n<p>Define:</p>\n<div class=\"math\">\n\\begin{align}\n\\gamma_j &amp;= \\sum_{i=1}^j c_i \\\\\n\\delta_j &amp;= \\sum_{i=1}^j d_i \\\\\n\\epsilon_j &amp;= \\sum_{i=1}^j e_i \\\\\n\\zeta_j &amp;= \\sum_{i=j+1}^n e_i \\\\\n\\end{align}\n</div>\n<p>We see <span class=\"math\">L_2 = \\gamma_n</span>, and <span class=\"math\">R_1 + (L_2 - R_1) = \\epsilon_n + \\delta_n</span> and <span class=\"math\">\\epsilon_n = \\epsilon_j + \\zeta_j</span>. Note that the feerate of <span class=\"math\">\\zeta_j</span> is greater or equal to the feerate of <span class=\"math\">R_1 = \\epsilon_n</span> in all cases \u2013 otherwise those transactions would not have been included in <span class=\"math\">R_1</span> when calculating the chunk.</p>\n<p>Consider total size of <span class=\"math\">\\gamma_j</span>, <span class=\"math\">S(\\gamma_j)</span> and its total fee <span class=\"math\">F(\\gamma_j)</span>. Note that the feerate diagram of <span class=\"math\">L_2</span> is made up of the pairs <span class=\"math\">S(\\gamma_j), F(\\gamma_j)</span>.</p>\n<p>If we consider <span class=\"math\">\\epsilon_j + \\delta_j</span> then we simply have <span class=\"math\">S(\\epsilon_j + \\delta_j) = S(\\gamma_j)</span> and <span class=\"math\">F(\\epsilon_j + \\delta_j) = F(\\gamma_j)</span>.</p>\n<p>Now consider <span class=\"math\">\\epsilon_j + \\delta_j + \\zeta_j</span> \u2013 for which the feerate diagram at position <span class=\"math\">S(\\gamma_j)</span> is at least <span class=\"math\">F(\\epsilon_j + \\delta_j)</span>, ie at least <span class=\"math\">F(\\gamma_j)</span>. But we know <span class=\"math\">\\zeta_j</span> has a higher fee rate than any chunk in <span class=\"math\">\\epsilon_j + \\delta_j</span>, so the feerate diagram of <span class=\"math\">\\epsilon_j + \\zeta_j + \\delta_j</span> is an improvement. That gives <span class=\"math\">\\gamma_j \\le \\epsilon_n + \\delta_j</span>, and choosing <span class=\"math\">j=n</span> gives <span class=\"math\">L_2 = \\gamma_j \\le \\epsilon_n + \\delta_n = R_1 + (L_2 - R_1)</span>. QED?</p>",
  "post_number": 9,
  "post_type": 1,
  "posts_count": 46,
  "updated_at": "2023-11-24T15:23:37.932Z",
  "reply_count": 2,
  "reply_to_post_number": null,
  "quote_count": 0,
  "incoming_link_count": 0,
  "reads": 35,
  "readers_count": 34,
  "score": 17.0,
  "yours": false,
  "topic_id": 209,
  "topic_slug": "merging-incomparable-linearizations",
  "topic_title": "Merging incomparable linearizations",
  "topic_html_title": "Merging incomparable linearizations",
  "category_id": 8,
  "display_username": "Anthony Towns",
  "primary_group_name": null,
  "flair_name": null,
  "flair_url": null,
  "flair_bg_color": null,
  "flair_color": null,
  "flair_group_id": null,
  "badges_granted": [],
  "version": 3,
  "can_edit": false,
  "can_delete": false,
  "can_recover": false,
  "can_see_hidden_post": false,
  "can_wiki": false,
  "user_title": null,
  "bookmarked": false,
  "raw": "\n* Assume you have a function $C(L)$ that takes a linearisation $L$ and splits that into $P_L, T_L$ where $P_L$ is the first chunk, and $T_L$ is the rest of the linearisation. If $L$ is non-empty, $P_L$ is non-empty also; however $T_L$ may be empty.\n* Assume you can calculate $L - X$ where $L$ and $X$ and the result is just $L$ with the transactions in $X$ removed\n* We say that $A \\le B$ by doing a feerate diagram comparison and noting $B$ is has a higher or equal feerate at all points.\n\nI think prefix-intersection merging, $M(L_1, L_2)$ is equivalent to:\n\n* Take $P_1, T_1 = C(L_1)$ and $P_2, T_2 = C(L_2)$\n* Reorder the transactions in $P_1$ to match the order they appear in $L_2$, call this $P^\\prime_1$, and then calculate $R_1, X_1 = C(P^\\prime_1)$. Note that $P_1 \\le R_1$.\n* Calculate $R_2, X_2$ in the same way from $P_2$.\n* Choose the highest feerate chunk from $R_1, R_2$:\n  * If $R_1$ is the highest, then: $M(L_1, L_2) = R_1 + M(X_1 + T_1, L_2-R_1)$\n  * Otherwise: $M_{PI}(L_1, L_2) = R_2 + M(L_1-R_2, X_2 + T_2)$\n\nFor the case where $R_1$ is highest, then $M(L_1, L_2) = M(R_1 + X_1 + T_1, L_2)$ and $L_1 \\le R_1 + X_1 + T_1$.\n\nThe question is whether $L_2 \\le R_1 + (L_2-R_1)$, noting that the transactions in $R_1$ that we've removed from $L_2$ maintain their order, and have an equal or higher feerate than the original best chunk.\n\nConsider each chunk from $L_2$, call them $c_1, c_2, c_3, \\dots, c_n$. Then define $d_i = c_i - R_1$, and $e_i = c_i - d_i$. In that case $R_1 = e_1 + e_2 + e_3 + \\dots + e_n$ (because $R_1$ is the first chunk of $P^\\prime_1$ which had its transactions put in the same order as $L_2$).\n\nDefine:\n\n$$\n\\begin{align}\n\\gamma_j &= \\sum_{i=1}^j c_i \\\\\n\\delta_j &= \\sum_{i=1}^j d_i \\\\\n\\epsilon_j &= \\sum_{i=1}^j e_i \\\\\n\\zeta_j &= \\sum_{i=j+1}^n e_i \\\\\n\\end{align}\n$$\n\nWe see $L_2 = \\gamma_n$, and $R_1 + (L_2 - R_1) = \\epsilon_n + \\delta_n$ and $\\epsilon_n = \\epsilon_j + \\zeta_j$. Note that the feerate of $\\zeta_j$ is greater or equal to the feerate of $R_1 = \\epsilon_n$ in all cases -- otherwise those transactions would not have been included in $R_1$ when calculating the chunk.\n\nConsider total size of $\\gamma_j$, $S(\\gamma_j)$ and its total fee $F(\\gamma_j)$. Note that the feerate diagram of $L_2$ is made up of the pairs $S(\\gamma_j), F(\\gamma_j)$.\n\nIf we consider $\\epsilon_j + \\delta_j$ then we simply have $S(\\epsilon_j + \\delta_j) = S(\\gamma_j)$ and $F(\\epsilon_j + \\delta_j) = F(\\gamma_j)$.\n\nNow consider $\\epsilon_j + \\delta_j + \\zeta_j$ -- for which the feerate diagram at position $S(\\gamma_j)$ is at least $F(\\epsilon_j + \\delta_j)$, ie at least $F(\\gamma_j)$. But we know $\\zeta_j$ has a higher fee rate than any chunk in $\\epsilon_j + \\delta_j$, so the feerate diagram of $\\epsilon_j + \\zeta_j + \\delta_j$ is an improvement. That gives $\\gamma_j \\le \\epsilon_n + \\delta_j$, and choosing $j=n$ gives $L_2 = \\gamma_j \\le \\epsilon_n + \\delta_n = R_1 + (L_2 - R_1)$. QED?",
  "actions_summary": [],
  "moderator": true,
  "admin": true,
  "staff": true,
  "user_id": 3,
  "hidden": false,
  "trust_level": 4,
  "deleted_at": null,
  "user_deleted": false,
  "edit_reason": null,
  "can_view_edit_history": true,
  "wiki": false,
  "excerpt": "Assume you have a function C(L) that takes a linearisation L and splits that into P_L, T_L where P_L is the first chunk, and T_L is the rest of the linearisation. If L is non-empty, P_L is non-empty also; however T_L may be empty.\nAssume you can calculate L - X where L and X and the result is just L&hellip;",
  "truncated": true,
  "post_url": "/t/merging-incomparable-linearizations/209/9",
  "reactions": [],
  "current_user_reaction": null,
  "reaction_users_count": 0,
  "current_user_used_main_reaction": false,
  "can_accept_answer": false,
  "can_unaccept_answer": false,
  "accepted_answer": false,
  "topic_accepted_answer": null
}