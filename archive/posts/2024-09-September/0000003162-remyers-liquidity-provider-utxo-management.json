{
  "id": 3162,
  "name": "Richard Myers",
  "username": "remyers",
  "avatar_template": "/user_avatar/delvingbitcoin.org/remyers/{size}/159_2.png",
  "created_at": "2024-09-11T15:14:28.042Z",
  "cooked": "<p>I have some results from testing <a href=\"https://github.com/bitcoin/bitcoin/pull/30080\" rel=\"noopener nofollow ugc\">PR 30080</a> with a simulation of funding liquidity ads and moved the PR out of draft. I\u2019d love to get some feedback on it.</p>\n<h2><a name=\"p-3162-results-1\" class=\"anchor\" href=\"#p-3162-results-1\"></a>Results</h2>\n<p>The top line result is that adding excess to the funding output (instead of to fees) in changeless transactions with the new <code>add_excess_to_recipient_position</code> parameter produces extra transaction fees of about 14% compared to 26% over the baseline case without any changes to coin selection. Lower is better.</p>\n<p>I compare the effect of this PR on transaction fees in my simulation against the baseline cost of a one input, one output transaction. If all 24809 simulated funding transactions were funded with a single input and output then that would score 0% extra fees.</p>\n<p>Using the <code>max_excess</code> parameter does not significantly reduce the extra fees result in this simulation, but does increase the amount of changeless transactions from 86% to 92% and created more UTXOs in the target buckets. More changeless txs means more confirmed UTXOs in our mempool available to create new funding transactions. Fewer UTXOs but a (slightly) higher average bucket capacity increases the chance of creating changeless transactions.</p>\n<h2><a name=\"p-3162-simulation-2\" class=\"anchor\" href=\"#p-3162-simulation-2\"></a>Simulation</h2>\n<p>I simulate a series of funding requests from a provided probability distribution (see below) and a series of historic fee rates for the period April 2023 to April 2024. Feerate data is from <a href=\"https://txstats.com/d/000000011/fee-estimation?orgId=1\" rel=\"noopener nofollow ugc\">txstats.com</a>. This time range had two distinct periods with high fee rates.</p>\n<p>The overall results after 24809 simulated funding transactions:</p>\n<div class=\"md-table\">\n<table>\n<thead>\n<tr>\n<th>simulation</th>\n<th>utxo set size</th>\n<th>avg bucket capacity</th>\n<th>extra fees</th>\n<th>changless txs</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Disable add excess (current bitcoind behavior)</td>\n<td>15294</td>\n<td>73%</td>\n<td>126%</td>\n<td>86%</td>\n</tr>\n<tr>\n<td>Add excess (max excess = cost of adding a change output)</td>\n<td>14763</td>\n<td>72%</td>\n<td>114%</td>\n<td>87%</td>\n</tr>\n<tr>\n<td>Add excess (max excess = 10000 sats)</td>\n<td>13884</td>\n<td>73%</td>\n<td>114%</td>\n<td>92%</td>\n</tr>\n</tbody>\n</table>\n</div><p>A graph that compares the three different simulations for extra fees paid:\n<div class=\"lightbox-wrapper\"><a class=\"lightbox\" href=\"https://delvingbitcoin.org/uploads/default/original/1X/71cc4ed3f1a31f0ad548cfea72e16345bb544460.png\" data-download-href=\"https://delvingbitcoin.org/uploads/default/71cc4ed3f1a31f0ad548cfea72e16345bb544460\" title=\"extra_fees\"><img src=\"https://delvingbitcoin.org/uploads/default/optimized/1X/71cc4ed3f1a31f0ad548cfea72e16345bb544460_2_690x235.png\" alt=\"extra_fees\" data-base62-sha1=\"geHGh5ewik7uLje1Le4WDxF6UqQ\" width=\"690\" height=\"235\" srcset=\"https://delvingbitcoin.org/uploads/default/optimized/1X/71cc4ed3f1a31f0ad548cfea72e16345bb544460_2_690x235.png, https://delvingbitcoin.org/uploads/default/optimized/1X/71cc4ed3f1a31f0ad548cfea72e16345bb544460_2_1035x352.png 1.5x, https://delvingbitcoin.org/uploads/default/optimized/1X/71cc4ed3f1a31f0ad548cfea72e16345bb544460_2_1380x470.png 2x\" data-dominant-color=\"FBFAF6\"><div class=\"meta\"><svg class=\"fa d-icon d-icon-far-image svg-icon\" aria-hidden=\"true\"><use href=\"#far-image\"></use></svg><span class=\"filename\">extra_fees</span><span class=\"informations\">1855\u00d7632 180 KB</span><svg class=\"fa d-icon d-icon-discourse-expand svg-icon\" aria-hidden=\"true\"><use href=\"#discourse-expand\"></use></svg></div></a></div></p>\n<p>and percent of changeless transactions created:\n<div class=\"lightbox-wrapper\"><a class=\"lightbox\" href=\"https://delvingbitcoin.org/uploads/default/original/1X/f73b155abe1cb4fdba4c62a67216e5def9f85a61.png\" data-download-href=\"https://delvingbitcoin.org/uploads/default/f73b155abe1cb4fdba4c62a67216e5def9f85a61\" title=\"percent\"><img src=\"https://delvingbitcoin.org/uploads/default/optimized/1X/f73b155abe1cb4fdba4c62a67216e5def9f85a61_2_690x235.png\" alt=\"percent\" data-base62-sha1=\"zh6wi5I4f09fta9u2hZrtLguTeN\" width=\"690\" height=\"235\" srcset=\"https://delvingbitcoin.org/uploads/default/optimized/1X/f73b155abe1cb4fdba4c62a67216e5def9f85a61_2_690x235.png, https://delvingbitcoin.org/uploads/default/optimized/1X/f73b155abe1cb4fdba4c62a67216e5def9f85a61_2_1035x352.png 1.5x, https://delvingbitcoin.org/uploads/default/optimized/1X/f73b155abe1cb4fdba4c62a67216e5def9f85a61_2_1380x470.png 2x\" data-dominant-color=\"FAFAF8\"><div class=\"meta\"><svg class=\"fa d-icon d-icon-far-image svg-icon\" aria-hidden=\"true\"><use href=\"#far-image\"></use></svg><span class=\"filename\">percent</span><span class=\"informations\">1855\u00d7632 146 KB</span><svg class=\"fa d-icon d-icon-discourse-expand svg-icon\" aria-hidden=\"true\"><use href=\"#discourse-expand\"></use></svg></div></a></div></p>\n<h2><a name=\"p-3162-simulation-details-3\" class=\"anchor\" href=\"#p-3162-simulation-details-3\"></a>Simulation Details</h2>\n<p>The simulation tracks buckets of UTXOs at different possible fee rates and funding amounts. For example, 66% of the 1000 UTXOs in the 10400 sats/kvbyte bucket will be utxos of 10000 sats+the fee to create a 1 input, 1 output transaction at 10400 sats/kvbyte.</p>\n<p>When the capacity of any of these buckets drops below 70%, the current fee rate is less than 20000 sats/kvbyte and there are UTXOs greater than the largest bucket, it will use the largest spendable UTXO and split up the change output to refill the buckets.</p>\n<p>The simulation adds 255 utxos of 0.05 BTC at the start and again every 10,000 blocks to refill the buckets.</p>\n<p>I estimated the fee rate probability distribution from the time period of my simulation and increase the count for buckets further from the refill fee rate. The funding bucket probabilities were used to create the simulated funding requests in my scenario.</p>\n<p>The funding buckets and fee rate probability distributions I used for these simulations are:</p>\n<pre data-code-wrap=\"json\"><code class=\"lang-json\">{\n    \"buckets\": [\n        {\n            \"start_satoshis\": 10000,\n            \"target_utxo_percent\": 0.66\n        },\n        {\n            \"start_satoshis\": 50000,\n            \"target_utxo_percent\": 0.22\n        },\n        {\n            \"start_satoshis\": 200000,\n            \"target_utxo_percent\": 0.10\n        },\n        {\n            \"start_satoshis\": 1000000,\n            \"target_utxo_percent\": 0.02\n        }\n    ],\n    \"bucket_refill_feerate\": 20000,\n    \"feerates_satoshis_per_kvbyte\": [\n    {\n      \"feerate\": 10400,\n      \"target_count\": 1000\n    },\n    {\n      \"feerate\": 14400,\n      \"target_count\": 1000\n    },\n    {\n      \"feerate\": 19900,\n      \"target_count\": 1000\n    },\n    {\n      \"feerate\": 27400,\n      \"target_count\": 1000\n    },\n    {\n      \"feerate\": 37700,\n      \"target_count\": 1000\n    },\n    {\n      \"feerate\": 51800,\n      \"target_count\": 1000\n    },\n    {\n      \"feerate\": 71400,\n      \"target_count\": 1000\n    },\n    {\n      \"feerate\": 98200,\n      \"target_count\": 2000\n    },\n    {\n      \"feerate\": 135000,\n      \"target_count\": 2000\n    },\n    {\n      \"feerate\": 186000,\n      \"target_count\": 3000\n    },\n    {\n      \"feerate\": 256000,\n      \"target_count\": 4000\n    },\n    {\n      \"feerate\": 354000,\n      \"target_count\": 5000\n    },\n    {\n      \"feerate\": 487000,\n      \"target_count\": 6000\n    },\n    {\n      \"feerate\": 671000,\n      \"target_count\": 6000\n    }\n  ]\n\n}\n</code></pre>\n<p>Simulation code and results can be found <a href=\"https://github.com/remyers/coin-selection-simulation/tree/targets\" rel=\"noopener nofollow ugc\">here</a> .</p>",
  "post_number": 13,
  "post_type": 1,
  "updated_at": "2024-09-11T15:14:28.042Z",
  "reply_count": 0,
  "reply_to_post_number": null,
  "quote_count": 0,
  "incoming_link_count": 0,
  "reads": 8,
  "readers_count": 7,
  "score": 1.6,
  "yours": false,
  "topic_id": 600,
  "topic_slug": "liquidity-provider-utxo-management",
  "topic_title": "Liquidity provider utxo management",
  "topic_html_title": "Liquidity provider utxo management",
  "category_id": 8,
  "display_username": "Richard Myers",
  "primary_group_name": null,
  "flair_name": null,
  "flair_url": null,
  "flair_bg_color": null,
  "flair_color": null,
  "flair_group_id": null,
  "version": 1,
  "can_edit": false,
  "can_delete": false,
  "can_recover": false,
  "can_see_hidden_post": false,
  "can_wiki": false,
  "user_title": "",
  "bookmarked": false,
  "raw": "I have some results from testing [PR 30080](https://github.com/bitcoin/bitcoin/pull/30080) with a simulation of funding liquidity ads and moved the PR out of draft. I'd love to get some feedback on it.\n\n## Results\n\nThe top line result is that adding excess to the funding output (instead of to fees) in changeless transactions with the new `add_excess_to_recipient_position` parameter produces extra transaction fees of about 14% compared to 26% over the baseline case without any changes to coin selection. Lower is better.\n\nI compare the effect of this PR on transaction fees in my simulation against the baseline cost of a one input, one output transaction. If all 24809 simulated funding transactions were funded with a single input and output then that would score 0% extra fees.\n\nUsing the `max_excess` parameter does not significantly reduce the extra fees result in this simulation, but does increase the amount of changeless transactions from 86% to 92% and created more UTXOs in the target buckets. More changeless txs means more confirmed UTXOs in our mempool available to create new funding transactions. Fewer UTXOs but a (slightly) higher average bucket capacity increases the chance of creating changeless transactions.\n\n## Simulation\n\nI simulate a series of funding requests from a provided probability distribution (see below) and a series of historic fee rates for the period April 2023 to April 2024. Feerate data is from [txstats.com](https://txstats.com/d/000000011/fee-estimation?orgId=1). This time range had two distinct periods with high fee rates.\n\nThe overall results after 24809 simulated funding transactions:\n\n|  simulation  | utxo set size | avg bucket capacity | extra fees | changless txs |\n| ----------------| ----------------- | ---------------------------|---------------|------------------- |\n|  Disable add excess (current bitcoind behavior) | 15294 | 73% | 126% | 86% |\n| Add excess (max excess = cost of adding a change output) | 14763 | 72% | 114% | 87% |\n| Add excess (max excess = 10000 sats) | 13884 | 73% | 114% | 92% | \n\nA graph that compares the three different simulations for extra fees paid:\n![extra_fees|690x235](upload://geHGh5ewik7uLje1Le4WDxF6UqQ.png)\n\nand percent of changeless transactions created:\n![percent|690x235](upload://zh6wi5I4f09fta9u2hZrtLguTeN.png)\n\n## Simulation Details\n\nThe simulation tracks buckets of UTXOs at different possible fee rates and funding amounts. For example, 66% of the 1000 UTXOs in the 10400 sats/kvbyte bucket will be utxos of 10000 sats+the fee to create a 1 input, 1 output transaction at 10400 sats/kvbyte. \n\nWhen the capacity of any of these buckets drops below 70%, the current fee rate is less than 20000 sats/kvbyte and there are UTXOs greater than the largest bucket, it will use the largest spendable UTXO and split up the change output to refill the buckets. \n\nThe simulation adds 255 utxos of 0.05 BTC at the start and again every 10,000 blocks to refill the buckets.\n\nI estimated the fee rate probability distribution from the time period of my simulation and increase the count for buckets further from the refill fee rate. The funding bucket probabilities were used to create the simulated funding requests in my scenario.\n\nThe funding buckets and fee rate probability distributions I used for these simulations are: \n\n```json\n{\n    \"buckets\": [\n        {\n            \"start_satoshis\": 10000,\n            \"target_utxo_percent\": 0.66\n        },\n        {\n            \"start_satoshis\": 50000,\n            \"target_utxo_percent\": 0.22\n        },\n        {\n            \"start_satoshis\": 200000,\n            \"target_utxo_percent\": 0.10\n        },\n        {\n            \"start_satoshis\": 1000000,\n            \"target_utxo_percent\": 0.02\n        }\n    ],\n    \"bucket_refill_feerate\": 20000,\n    \"feerates_satoshis_per_kvbyte\": [\n    {\n      \"feerate\": 10400,\n      \"target_count\": 1000\n    },\n    {\n      \"feerate\": 14400,\n      \"target_count\": 1000\n    },\n    {\n      \"feerate\": 19900,\n      \"target_count\": 1000\n    },\n    {\n      \"feerate\": 27400,\n      \"target_count\": 1000\n    },\n    {\n      \"feerate\": 37700,\n      \"target_count\": 1000\n    },\n    {\n      \"feerate\": 51800,\n      \"target_count\": 1000\n    },\n    {\n      \"feerate\": 71400,\n      \"target_count\": 1000\n    },\n    {\n      \"feerate\": 98200,\n      \"target_count\": 2000\n    },\n    {\n      \"feerate\": 135000,\n      \"target_count\": 2000\n    },\n    {\n      \"feerate\": 186000,\n      \"target_count\": 3000\n    },\n    {\n      \"feerate\": 256000,\n      \"target_count\": 4000\n    },\n    {\n      \"feerate\": 354000,\n      \"target_count\": 5000\n    },\n    {\n      \"feerate\": 487000,\n      \"target_count\": 6000\n    },\n    {\n      \"feerate\": 671000,\n      \"target_count\": 6000\n    }\n  ]\n\n}\n```\nSimulation code and results can be found [here](https://github.com/remyers/coin-selection-simulation/tree/targets) .",
  "actions_summary": [],
  "moderator": false,
  "admin": false,
  "staff": false,
  "user_id": 55,
  "hidden": false,
  "trust_level": 1,
  "deleted_at": null,
  "user_deleted": false,
  "edit_reason": null,
  "can_view_edit_history": true,
  "wiki": false,
  "reactions": [],
  "current_user_reaction": null,
  "reaction_users_count": 0,
  "current_user_used_main_reaction": false
}