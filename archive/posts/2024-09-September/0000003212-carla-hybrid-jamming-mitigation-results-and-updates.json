{
  "id": 3212,
  "name": "Carla Kirk-Cohen",
  "username": "carla",
  "avatar_template": "/user_avatar/delvingbitcoin.org/carla/{size}/119_2.png",
  "created_at": "2024-09-17T14:16:51.741Z",
  "cooked": "<p>Writing with an update on the work that Clara and I have been doing to investigate the effectiveness of our hybrid mitigation for channel jamming attacks against lightning. This post assumes familiarity with the proposal, so please check out the high level write up <a href=\"https://gist.github.com/carlaKC/02251cd061260bbb149f361c65fc9f2f\" rel=\"noopener nofollow ugc\">here</a> if you need to catch up.</p>\n<p>tl;dr:</p>\n<ul>\n<li>The mitigation performs as expected against slow and fast jamming attacks, appropriately compensating nodes that are attacked.</li>\n<li>It is resilient against most reputation-spoiling attacks, but needs to be updated to protect against a downstream attacker that opportunistically holds HTLCs to ruin reputation along the route.</li>\n</ul>\n<details>  \n <summary>PSA: Sections with in-depth details are in collapsable summaries.</summary>  \n\ud83e\udef6 Please click on them for more detail \ud83e\udef6\n</details>\n<h2><a name=\"p-3212-introduction-1\" class=\"anchor\" href=\"#p-3212-introduction-1\"></a>Introduction</h2>\n<p>Our reputation algorithm is designed to ensure that the cost of acquiring reputation is comparable to the damage that can be done by abusing that reputation. If there is no revenue loss under attack, we can ensure that nodes are not economically damaged by attacks [0].</p>\n<p><strong>Note that we do not guarantee that jamming attacks cannot occur, only that nodes targeted will be compensated by at least the amount that they would have earned with regular operation.</strong></p>\n<p>While we can\u2019t possibly enumerate every possible attack, one of the best ways to understand how this mitigation performs is to try to break it and see what happens. So we got a group of lightning developers together earlier in the year for an \u201c<a href=\"https://github.com/carlaKC/attackathon\" rel=\"noopener nofollow ugc\">attackathon</a>\u201d where they experimented with various approaches to breaking our mitigation.</p>\n<p>This post reports on the performance of our mitigation under the various attacks, and outlines improvements made to the proposal based on insights gained from the attackathon.</p>\n<h2><a name=\"p-3212-attacks-2\" class=\"anchor\" href=\"#p-3212-attacks-2\"></a>Attacks</h2>\n<p>As is the case with any jamming mitigation, there is a risk that the mitigation itself is abused to restrict the resources of the network. In our case, this would be achieved by targeting a node\u2019s reputation to restrict its ability to operate. We therefore need to think about two different approaches to jamming attacks in the context of this solution:</p>\n<p><strong>Resource jamming</strong>: aims to consume all channel resources, as we think of jamming attacks today. Successfully executed when:</p>\n<ul>\n<li>All general resources have been exhausted by the attacker.</li>\n<li>All protected resources have been exhausted by the attacker</li>\n</ul>\n<p><strong>Reputation jamming</strong>: aims to render protected resources unusable by sabotaging the reputation of a node\u2019s peers, effectively jamming the channel because the mitigation does not assign these resources to honest peers. (h/t: Thomas for first flagging this one!) Successfully executed when:</p>\n<ul>\n<li>All general resources have been exhausted by the attacker on the targeted channel.</li>\n<li>All of the target node\u2019s peers have low reputation with it.</li>\n</ul>\n<h3><a name=\"p-3212-resource-attacks-3\" class=\"anchor\" href=\"#p-3212-resource-attacks-3\"></a>Resource attacks</h3>\n<p>Two teams at the attackathon wrote resource jamming attacks, where they aimed to build up reputation with a target node then leverage it to occupy all of its protected resources. We\u2019ve since built out these attacks and run them against a 50 node test <a href=\"https://github.com/bitcoin-dev-project/warnet\" rel=\"noopener nofollow ugc\">warnet</a> to get an understanding of their impact.</p>\n<details>\n <summary>Full details about our test network are available here.</summary>\nWe used real lightning nodes in our resource jamming experiment so that we could capture all the nuance of pathfinding, dust limits and force closures that you need to be conscious of when thinking about channel jamming. We also wanted to create an approachable network that anyone could try to break, rather than a specialist simulator that would likely lack the APIs required to explore different attack approaches. \n<p>To create a large network, we used <a href=\"https://github.com/bitcoin-dev-project/warnet\" rel=\"noopener nofollow ugc\">warnet</a> to create a test network of <a href=\"https://github.com/carlaKC/lnd/tree/attackathon\" rel=\"noopener nofollow ugc\">LND</a> nodes running our <a href=\"https://github.com/carlaKC/lrc\" rel=\"noopener nofollow ugc\">reputation mitigation</a> [1]. We reduced the mainnet graph to 50 nodes using a random sample of the neighborhood around the Acinq node, which was our target node for attacks (sorry Acinq!). Using warcli\u2019s <a href=\"https://github.com/bitcoin-dev-project/warnet/blob/7f0a082da2a9b0405743c62da3dadfc7b8752f1b/src/cli/graph.py#L43\" rel=\"noopener nofollow ugc\">import_json</a> command, we could then spin up a lightning network with the channels and policies of the reduced mainnet graph. None of this would have happened without Zip and the warnet team, I am many beers indebted!</p>\n<p>Running with realistic payment history and traffic was important to testing our mitigation in a dynamic environment. We used <a href=\"https://github.com/bitcoin-dev-project/sim-ln\" rel=\"noopener nofollow ugc\">sim-ln</a>, which can run against real lightning nodes or as a sped up payment simulator to create activity for a given graph, in several places:</p>\n<ul>\n<li><strong>Reputation bootstrap</strong>: running in simulation mode for the chosen graph, we generated payment histories for honest nodes which were imported to our reputation system to provide historical data without having to execute months of payments on the actual nodes.</li>\n<li><strong>Honest payments</strong>: running connected to every honest node in the network, we generated honest payment activity in the network during the attack.</li>\n<li><strong>Projected revenue</strong>: running in simulation mode with the same fixed seed as the honest payments, we generated a projection of the payments that nodes in the network would have processed in the absence of a jamming attack. We generated these projections 50 times for the network, and used the mean to represent the network in peace times.</li>\n</ul>\n<p>This payment traffic is, of course, an imperfect representation of mainnet traffic. It does however provide a baseline for comparison across attacks and peacetime for the simulations.</p>\n<p>Some of the time-based parameters in our proposal were reduced to shorten our runtime:</p>\n<ul>\n<li>Revenue window = 1 hour</li>\n<li>Reputation window = 24 hours</li>\n<li>HTLC opportunity cost = 12 blocks</li>\n<li>Block time = 5 minutes</li>\n</ul>\n</details>\n<h4><a name=\"p-3212-slow-slot-jamming-4\" class=\"anchor\" href=\"#p-3212-slow-slot-jamming-4\"></a>Slow Slot Jamming</h4>\n<p>We ran a slow slot jamming attack against a single channel on our targeted node, aiming to consume &gt; 480 slots on the target channel for a period of 10 minutes.</p>\n<details>\n <summary>An in depth description of the attack strategy is available here.</summary>\nThe approach taken to orchestrate a slow jamming attack against the target channel A-B by malicious nodes M0/1/2 works as follows:\n<ol>\n<li>M0 \u201cpre-pays\u201d good reputation with A on M0-A by sending fast-resolving, successful payments over M0-A-M1.</li>\n</ol>\n<ul>\n<li>These payments do not need to be endorsed, because fast-resolving successful unendorsed payments will bootstrap their reputation.</li>\n<li>Note that we don\u2019t want to build a reputation on a path that utilizes A-B, because this would inflate the value of AB for M0 to later attack.</li>\n<li>M0 will occasionally send an endorsed payment probe over M0-A-B-M2 to determine whether they\u2019ve built sufficient reputation to use A-B\u2019s protected resources.</li>\n</ul>\n<ol start=\"2\">\n<li>Once M0 has built up sufficient reputation, M1 sends a set unendorsed payments over M1-A-B-M2 to occupy all of the general resources on A-B and holds them for the duration of the attack.</li>\n<li>Finally, M0 will send a series of endorsed payments over M0-A-B-M2 to occupy all of the protected resources on A-B and hold them for the duration of the attack.</li>\n</ol>\n<ul>\n<li>This can be fine-tuned to distinguish between reputation-based and liquidity based failures by iteratively probing and \u201cpre-paying\u201d for more reputation (as described in (1) to ensure that M0 does not overpay for access to the protected slots.</li>\n<li>It\u2019s likely that A doesn\u2019t have sufficient reputation with B to occupy all of its protected resources on its channels with M2, so two channels are opened so that all jamming payments can be accommodated in the general buckets of the channels between B and M2.</li>\n</ul>\n<p><strong><div class=\"lightbox-wrapper\"><a class=\"lightbox\" href=\"https://delvingbitcoin.org/uploads/default/original/1X/3fd0e0eed694731af57ab0e4eeb8efc6812532ae.png\" data-download-href=\"https://delvingbitcoin.org/uploads/default/3fd0e0eed694731af57ab0e4eeb8efc6812532ae\" title=\"\"><img src=\"https://delvingbitcoin.org/uploads/default/optimized/1X/3fd0e0eed694731af57ab0e4eeb8efc6812532ae_2_489x284.png\" alt=\"\" data-base62-sha1=\"96xBgvNkQf7eJTerYDKjW46DM5g\" width=\"489\" height=\"284\" role=\"presentation\" srcset=\"https://delvingbitcoin.org/uploads/default/optimized/1X/3fd0e0eed694731af57ab0e4eeb8efc6812532ae_2_489x284.png, https://delvingbitcoin.org/uploads/default/optimized/1X/3fd0e0eed694731af57ab0e4eeb8efc6812532ae_2_733x426.png 1.5x, https://delvingbitcoin.org/uploads/default/optimized/1X/3fd0e0eed694731af57ab0e4eeb8efc6812532ae_2_978x568.png 2x\" data-dominant-color=\"F5F2E9\"><div class=\"meta\"><svg class=\"fa d-icon d-icon-far-image svg-icon\" aria-hidden=\"true\"><use href=\"#far-image\"></use></svg><span class=\"filename\"></span><span class=\"informations\">1600\u00d7930 86.7 KB</span><svg class=\"fa d-icon d-icon-discourse-expand svg-icon\" aria-hidden=\"true\"><use href=\"#discourse-expand\"></use></svg></div></a></div></strong></p>\n</details>\n<p>In our experiment, the mitigation strategy worked as expected - the targeted node did not lose revenue when targeted, and the majority of attacker costs were for reputation building.</p>\n<p><strong>Attacker paid</strong>: \u200b\u200b1,370,485 msat in off-chain fees:</p>\n<ul>\n<li>Success case (94% of total): 1,286,744 msat</li>\n<li>Unconditional (6% of total): 83,740 msat</li>\n</ul>\n<p><strong>Target earned</strong>: 1,875,080 msat in off-chain fees:</p>\n<ul>\n<li>Success case (97% of total): 1,815,280 msat</li>\n<li>Unconditional (3% of total): 59,799 msat</li>\n</ul>\n<p>The target was paid 1,446,343 msat in off-chain fees by the attacker, so their revenue breakdown is:</p>\n<ul>\n<li>93% of revenue paid by attacker traffic</li>\n<li>7% of revenue was paid by honest traffic</li>\n</ul>\n<p>To compare revenue under attack to the target node\u2019s expected revenue in times of peace, we ran our payment simulator 50 times to get an average expected revenue of <strong>15,030 msat over 10 minutes</strong> and <strong>1,205,876 msat over a 2 week period</strong>.</p>\n<p>Since the HTLCs for the slow jamming attack can be held for up to two weeks, we compare our attacker costs to projected revenue over a two week period. T<strong>here is a 19.94% increase in revenue for the targeted node under attack</strong>. This is not surprising, because our per\u2013htlc \u201copportunity cost\u201d charges quite a steep fee for each slot in our protected bucket of resources [2].</p>\n<details>\n <summary>Raw data for the experiments is available here.</summary>\n<div class=\"md-table\">\n<table>\n<thead>\n<tr>\n<th>ID</th>\n<th>Success case fees paid by attacker</th>\n<th>Unconditional fees paid by attacker</th>\n<th>Success case fees earned by target (all senders)</th>\n<th>Unconditional fees earned by sender (all senders)</th>\n<th>Fees paid from attacker to target</th>\n<th>Time Slot Jammed (&gt;440)</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>0</td>\n<td>1,286,350.00</td>\n<td>82,463.50</td>\n<td>1,291,127.00</td>\n<td>53,511.27</td>\n<td>1,339,813.50</td>\n<td>10.09</td>\n</tr>\n<tr>\n<td>1</td>\n<td>1,296,305.00</td>\n<td>88,347.05</td>\n<td>1,308,725.00</td>\n<td>57,131.25</td>\n<td>1,353,242.05</td>\n<td>10.18</td>\n</tr>\n<tr>\n<td>2</td>\n<td>1,292,105.00</td>\n<td>88,305.05</td>\n<td>2,144,659.00</td>\n<td>65,470.97</td>\n<td>1,349,000.05</td>\n<td>10.38</td>\n</tr>\n<tr>\n<td>3</td>\n<td>1,296,305.00</td>\n<td>88,347.05</td>\n<td>1,308,658.00</td>\n<td>57,080.58</td>\n<td>1,353,242.05</td>\n<td>10.45</td>\n</tr>\n<tr>\n<td>4</td>\n<td>1,274,705.00</td>\n<td>88,107.05</td>\n<td>1,290,544.00</td>\n<td>56,895.44</td>\n<td>1,331,412.05</td>\n<td>10.38</td>\n</tr>\n<tr>\n<td>5</td>\n<td>1,292,105.00</td>\n<td>88,305.05</td>\n<td>1,301,111.00</td>\n<td>57,015.11</td>\n<td>1,349,000.05</td>\n<td>10.12</td>\n</tr>\n<tr>\n<td>6</td>\n<td>1,293,505.00</td>\n<td>76,751.05</td>\n<td>1,307,637.00</td>\n<td>50,363.27</td>\n<td>1,343,666.05</td>\n<td>10.03</td>\n</tr>\n<tr>\n<td>7</td>\n<td>1,272,837.00</td>\n<td>76,520.37</td>\n<td>1,283,632.00</td>\n<td>50,108.96</td>\n<td>1,322,777.37</td>\n<td>10.13</td>\n</tr>\n<tr>\n<td>8</td>\n<td>1,272,837.00</td>\n<td>76,520.37</td>\n<td>1,283,365.00</td>\n<td>50,055.65</td>\n<td>1,322,777.37</td>\n<td>10.06</td>\n</tr>\n<tr>\n<td>9</td>\n<td>1,290,394.00</td>\n<td>82,503.94</td>\n<td>1,296,973.00</td>\n<td>53,619.73</td>\n<td>1,343,897.94</td>\n<td>11.02</td>\n</tr>\n<tr>\n<td>MEAN</td>\n<td>1,286,744.80</td>\n<td>83,740.73</td>\n<td>1,391,050.89</td>\n<td>55,292.50</td>\n<td>1,340,547.84</td>\n<td>10.20</td>\n</tr>\n<tr>\n<td>STDDEV</td>\n<td>10,102.26</td>\n<td>5,678.04</td>\n<td>282,789.65</td>\n<td>4,968.40</td>\n<td>12,198.72</td>\n<td>0.1582123597</td>\n</tr>\n<tr>\n<td>MEAN/STDDEV</td>\n<td>127.37</td>\n<td>14.75</td>\n<td>4.92</td>\n<td>11.13</td>\n<td>109.89</td>\n<td>64.47496481</td>\n</tr>\n</tbody>\n</table>\n</div></details>\n<h4><a name=\"p-3212-fast-slot-jamming-5\" class=\"anchor\" href=\"#p-3212-fast-slot-jamming-5\"></a>Fast Slot Jamming</h4>\n<p>This attack is a variation on the slow jamming attack described above, where the targeted node\u2019s protected resources are occupied by a continuous stream of fast-failing payments. This was particularly interesting to us, because it manages to exhaust protected resources without the attacker losing their reputation. In this attack, the targeted node is protected only by unconditional fees, and the eventual decay of the reputation that the attacker built up to gain access to the protected bucket in the first place.</p>\n<p>When unconditional fees will be a major cost to the attacker, it\u2019s worth examining whether slot or liquidity jamming will be more economical to fully occupy the channel\u2019s resources. The costs that we need to consider are:</p>\n<ul>\n<li><strong>Reputation cost</strong>: the amount paid to gain access to protected resources, generally expected to be higher for liquidity jamming because this cost depends on the fee for the HTLC.</li>\n<li><strong>Unconditional fee cost</strong>: the unconditional fee paid to continuously occupy protected resources with many slot jamming payments or fewer larger liquidity jams; dependent on the fee policy of the targeted channel.</li>\n</ul>\n<p>We ran <a href=\"https://gist.github.com/carlaKC/9763ef8df9790713f542dc553aff8a03\" rel=\"noopener nofollow ugc\">this comparison</a> against a snapshot of the mainnet graph and found that it\u2019s more economical to fast slot jam 59% of the channel policies on the network.</p>\n<p>As was the case with our slow jamming attack, the mitigation performs as expected and the targeted node is compensated for the revenue that it would lose in the window that it is jammed. But unlike a slow jamming attack, the attacker does not lose their \u201cprepaid\u201d reputation so they will be able to continue the fast jamming attack until their reputation decays.</p>\n<p>To keep the channel jammed, the attacker will need to continuously dispatch fast-failing payments to occupy the protected resource on a channel. For an attack time t (expressed in seconds) the total unconditional fees that they will have to pay for a fast-slot attack is: <code>t / 90 * 242 * base_fee * 0.01</code>.</p>\n<p>This produces 32,524,833 msat in unconditional fees for our targeted channel to continue the attack for 2 weeks (given a base fee of 1000 msat). This represents a 25% increase in revenue when targeted by a fast slot jamming attack. We also sanity checked this result against a liquidity jamming attack, which requires fewer HTLCs with higher reputation \u201ccosts\u201d, and saw similar revenue numbers.</p>\n<details>\n <summary>Raw data for the experiments is available here.</summary>\n<div class=\"md-table\">\n<table>\n<thead>\n<tr>\n<th>ID</th>\n<th>Success case fees paid by attacker</th>\n<th>Unconditional fees paid by attacker</th>\n<th>Success case fees earned by target (all senders)</th>\n<th>Unconditional fees earned by sender (all senders)</th>\n<th>Fees paid from attacker to target</th>\n<th>Time Under Attack (&gt;440)</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>0</td>\n<td>1,288,839.00</td>\n<td>157,248.39</td>\n<td>1,300,920.00</td>\n<td>97,249.20</td>\n<td>1,385,937.39</td>\n<td>7.96</td>\n</tr>\n<tr>\n<td>1</td>\n<td>1,263,505.00</td>\n<td>156,923.05</td>\n<td>1,282,525.00</td>\n<td>97,043.49</td>\n<td>1,360,308.05</td>\n<td>7.03</td>\n</tr>\n<tr>\n<td>2</td>\n<td>1,288,839.00</td>\n<td>152,016.39</td>\n<td>1,295,841.00</td>\n<td>94,136.41</td>\n<td>1,382,885.39</td>\n<td>6.00</td>\n</tr>\n<tr>\n<td>4</td>\n<td>1,221,960.00</td>\n<td>141,243.60</td>\n<td>1,245,060.00</td>\n<td>87,764.60</td>\n<td>1,309,443.60</td>\n<td>8.74</td>\n</tr>\n<tr>\n<td>5</td>\n<td>1,293,505.00</td>\n<td>172,247.05</td>\n<td>1,302,040.00</td>\n<td>106,002.41</td>\n<td>1,399,372.05</td>\n<td>7.86</td>\n</tr>\n<tr>\n<td>7</td>\n<td>1,293,505.00</td>\n<td>124,055.05</td>\n<td>1,304,477.00</td>\n<td>77,934.87</td>\n<td>1,371,260.05</td>\n<td>9.97</td>\n</tr>\n<tr>\n<td>9</td>\n<td>1,293,505.00</td>\n<td>125,351.05</td>\n<td>1,297,040.00</td>\n<td>78,586.47</td>\n<td>1,372,016.05</td>\n<td>10.44</td>\n</tr>\n<tr>\n<td>10</td>\n<td>1,274,392.00</td>\n<td>136,631.92</td>\n<td>1,278,920.00</td>\n<td>85,067.23</td>\n<td>1,359,403.92</td>\n<td>10.42</td>\n</tr>\n<tr>\n<td>11</td>\n<td>1,204,851.00</td>\n<td>183,504.51</td>\n<td>1,215,927.00</td>\n<td>112,195.27</td>\n<td>1,316,915.51</td>\n<td>6.01</td>\n</tr>\n<tr>\n<td>12</td>\n<td>1,292,060.00</td>\n<td>182,582.60</td>\n<td>1,300,087.00</td>\n<td>112,032.87</td>\n<td>1,403,962.60</td>\n<td>9.35</td>\n</tr>\n<tr>\n<td>MEAN</td>\n<td>1,271,496.10</td>\n<td>153,180.36</td>\n<td>1,282,283.70</td>\n<td>94,801.28</td>\n<td>1,366,150.46</td>\n<td>8.38</td>\n</tr>\n<tr>\n<td>STDDEV</td>\n<td>32,395.54</td>\n<td>21,650.22</td>\n<td>29,342.54</td>\n<td>12,596.60</td>\n<td>31,596.28</td>\n<td>1.68</td>\n</tr>\n<tr>\n<td>MEAN/STDDEV</td>\n<td>39.25</td>\n<td>7.08</td>\n<td>43.70</td>\n<td>7.53</td>\n<td>43.24</td>\n<td>4.97</td>\n</tr>\n</tbody>\n</table>\n</div></details>\n<p>h/t: Jules/Sachin/Kevin for this one!</p>\n<h3><a name=\"p-3212-reputation-attacks-6\" class=\"anchor\" href=\"#p-3212-reputation-attacks-6\"></a>Reputation attacks</h3>\n<p>We also saw a variety of approaches to trying to abuse the reputation system. Two themes emerged across the various attacks:</p>\n<ul>\n<li><strong>Optimization</strong>: attacks that attempt to decrease the cost of acquiring good reputation with a target node.</li>\n<li><strong>Manipulation</strong>: strategies for using the reputation system itself to cut off honest nodes from access to protected resources.</li>\n</ul>\n<h4><a name=\"p-3212-optimization-laddering-attack-7\" class=\"anchor\" href=\"#p-3212-optimization-laddering-attack-7\"></a>Optimization - Laddering Attack</h4>\n<p>A laddering attack exploits a chain of nodes with increasing reputation to gain endorsement with a higher-value node downstream. Since reputation is related to fee revenue, an attacker can identify a chain of gradually increasing channel sizes (assuming that size is a proxy for activity) and build reputation with the cheapest rung of the ladder.</p>\n<details>\n <summary>A detailed walkthrough of this concept is available here.\n</summary>\n<p>Starting with an honest network of A, B, C, D, we\u2019ll assume that we have the following \u201claddered\u201d (increasing) traffic pattern:</p>\n<ul>\n<li>Payments sent over A -&gt; B represent 100% of A\u2019s outgoing traffic.</li>\n<li>Payments sent over A -&gt; B represent 10% of B\u2019s forwards on BC</li>\n<li>Payments sent over B -&gt; C represent 25% of C\u2019s forwards on CD</li>\n<li>Payments sent over C -&gt; D represent 50% of D\u2019s forwards onwards.</li>\n</ul>\n<p>To keep things simple for the sake of an example, we\u2019ll walk through revenue flows between the nodes without thinking about fee calculations - so when you see 120k of reputation/revenue, think \u201c120k of traffic\u2019s fees of reputation/revenue\u201d. We\u2019ll also assume that traffic is constant over time, so that we can easily move between 2 week and 6 month horizons.</p>\n<p>Over a period of 6 months, A forwards 120k of payments to B that will use the BC outgoing link:</p>\n<p><strong><div class=\"lightbox-wrapper\"><a class=\"lightbox\" href=\"https://delvingbitcoin.org/uploads/default/original/1X/05a87ec54de98acf7ac18806999dd735b6e23548.png\" data-download-href=\"https://delvingbitcoin.org/uploads/default/05a87ec54de98acf7ac18806999dd735b6e23548\" title=\"\"><img src=\"https://delvingbitcoin.org/uploads/default/optimized/1X/05a87ec54de98acf7ac18806999dd735b6e23548_2_624x87.png\" alt=\"\" data-base62-sha1=\"O3nYhmeGELzoyhOneEsjf8v4fK\" width=\"624\" height=\"87\" role=\"presentation\" srcset=\"https://delvingbitcoin.org/uploads/default/optimized/1X/05a87ec54de98acf7ac18806999dd735b6e23548_2_624x87.png, https://delvingbitcoin.org/uploads/default/optimized/1X/05a87ec54de98acf7ac18806999dd735b6e23548_2_936x130.png 1.5x, https://delvingbitcoin.org/uploads/default/optimized/1X/05a87ec54de98acf7ac18806999dd735b6e23548_2_1248x174.png 2x\" data-dominant-color=\"F3E5B9\"><div class=\"meta\"><svg class=\"fa d-icon d-icon-far-image svg-icon\" aria-hidden=\"true\"><use href=\"#far-image\"></use></svg><span class=\"filename\"></span><span class=\"informations\">1600\u00d7222 42 KB</span><svg class=\"fa d-icon d-icon-discourse-expand svg-icon\" aria-hidden=\"true\"><use href=\"#discourse-expand\"></use></svg></div></a></div></strong></p>\n<p>This means that A will have accrued 120k of reputation with B over a period of 6 months. We can then calculate the reputation threshold for B\u2019s outgoing link as follows:</p>\n<ul>\n<li>A is 10% of B\u2019s traffic, so the total traffic over 6 months is 120k * 10 = 1.2m</li>\n<li>The revenue threshold for the outgoing link BC is 1.2m/12 = 100k because we consider our outgoing revenue over a 2 week period.</li>\n</ul>\n<p><strong><div class=\"lightbox-wrapper\"><a class=\"lightbox\" href=\"https://delvingbitcoin.org/uploads/default/original/1X/1b1b3c3dcb62ae7a8da9fc7bd92709ec0a3d93a9.png\" data-download-href=\"https://delvingbitcoin.org/uploads/default/1b1b3c3dcb62ae7a8da9fc7bd92709ec0a3d93a9\" title=\"\"><img src=\"https://delvingbitcoin.org/uploads/default/optimized/1X/1b1b3c3dcb62ae7a8da9fc7bd92709ec0a3d93a9_2_624x95.png\" alt=\"\" data-base62-sha1=\"3RNf4tVn6ca9MaiZjfLb8GE9g81\" width=\"624\" height=\"95\" role=\"presentation\" srcset=\"https://delvingbitcoin.org/uploads/default/optimized/1X/1b1b3c3dcb62ae7a8da9fc7bd92709ec0a3d93a9_2_624x95.png, https://delvingbitcoin.org/uploads/default/optimized/1X/1b1b3c3dcb62ae7a8da9fc7bd92709ec0a3d93a9_2_936x142.png 1.5x, https://delvingbitcoin.org/uploads/default/optimized/1X/1b1b3c3dcb62ae7a8da9fc7bd92709ec0a3d93a9_2_1248x190.png 2x\" data-dominant-color=\"F1E6C3\"><div class=\"meta\"><svg class=\"fa d-icon d-icon-far-image svg-icon\" aria-hidden=\"true\"><use href=\"#far-image\"></use></svg><span class=\"filename\"></span><span class=\"informations\">1600\u00d7243 46 KB</span><svg class=\"fa d-icon d-icon-discourse-expand svg-icon\" aria-hidden=\"true\"><use href=\"#discourse-expand\"></use></svg></div></a></div></strong></p>\n<p>This means that B will have accrued 1.2m of reputation with C over a period of 6 months. Likewise we\u2019ll calculate the reputation threshold of C\u2019s outgoing link as follows:</p>\n<ul>\n<li>B is 25% of C\u2019s traffic, so the total revenue over 6 months is 1.2m * 4 = 4.8m</li>\n<li>The revenue threshold for the outgoing link CD is 4.8m/12 = 400k because we consider our outgoing revenue over a 2 week period.</li>\n</ul>\n<p><strong><div class=\"lightbox-wrapper\"><a class=\"lightbox\" href=\"https://delvingbitcoin.org/uploads/default/original/1X/cff35af47894c38912a1ef3dcfa41fb960ca0513.png\" data-download-href=\"https://delvingbitcoin.org/uploads/default/cff35af47894c38912a1ef3dcfa41fb960ca0513\" title=\"\"><img src=\"https://delvingbitcoin.org/uploads/default/optimized/1X/cff35af47894c38912a1ef3dcfa41fb960ca0513_2_624x91.png\" alt=\"\" data-base62-sha1=\"tFCdO226Qz5IDZMPXhhI5nPC4nh\" width=\"624\" height=\"91\" role=\"presentation\" srcset=\"https://delvingbitcoin.org/uploads/default/optimized/1X/cff35af47894c38912a1ef3dcfa41fb960ca0513_2_624x91.png, https://delvingbitcoin.org/uploads/default/optimized/1X/cff35af47894c38912a1ef3dcfa41fb960ca0513_2_936x136.png 1.5x, https://delvingbitcoin.org/uploads/default/optimized/1X/cff35af47894c38912a1ef3dcfa41fb960ca0513_2_1248x182.png 2x\" data-dominant-color=\"F0E5C0\"><div class=\"meta\"><svg class=\"fa d-icon d-icon-far-image svg-icon\" aria-hidden=\"true\"><use href=\"#far-image\"></use></svg><span class=\"filename\"></span><span class=\"informations\">1600\u00d7234 45.4 KB</span><svg class=\"fa d-icon d-icon-discourse-expand svg-icon\" aria-hidden=\"true\"><use href=\"#discourse-expand\"></use></svg></div></a></div></strong></p>\n<p>An attacker looking to perform a laddering attack would aim to build good reputation with A, so that they can get HTLCs endorsed on the more valuable downstream C -&gt; D link. An attacker would need to pay 10k to obtain good reputation with A (120k/ 12 = 10k), and additionally pay for the opportunity cost of any HTLC that they\u2019d like A to endorse.</p>\n<p>To get an idea of the damage that an attacker can do with this laddering attack, we look at the difference in A\u2019s current reputation and B\u2019s revenue threshold: 100k - 120k = 20k. This represents the total \u201cbudget\u201d that is available for in-flight HTLCs before A\u2019s reputation drops below B\u2019s revenue threshold.</p>\n<p>Using our HTLC opportunity cost function, we can calculate the largest HTLC that A can get endorsed based on this budget: <code>budget = htlc_amt * blocks_till_expiry * 10 * 60 / 90</code>. Assuming that a HTLC forwarded on A will expire after 160 blocks, the largest HTLC that an attacker can get endorsed by A (and thus downstream on CD)  in 17 msat, which is insufficient to jam the protected resources along the route.</p>\n<p>This example deals with toy numbers, but it should give you a general idea of how this type of attack would work. We\u2019ve created a spreadsheet <a href=\"https://docs.google.com/spreadsheets/d/1AmuRE7-XAZzfy-Ku6MyK1AVfE-aj5j66fb6c5_Zbr7c/edit?usp=sharing\" rel=\"noopener nofollow ugc\">here</a> which allows you to plug in different values to get a grasp on how these numbers work out (make a copy to change the values!).</p>\n</details>\n<p>We wrote a <a href=\"https://github.com/carlaKC/reputation-fuzz/blob/fda5a8823a26fd6b6dc243f3035288523a5e50b6/fuzz_test.go#L13\" rel=\"noopener nofollow ugc\">basic fuzzing test</a> for this attack with the following conditions:</p>\n<ul>\n<li>Create a ladder of nodes with 1-8 hops between the attacker and the laddering target</li>\n<li>Traffic must increase with each hop in the ladder</li>\n<li>The target node must have sufficient reputation to get a $1 HTLC endorsed with its peer [3].</li>\n<li>The attack is successful both of the following hold:\n<ul>\n<li>Acquiring reputation via the ladder is less expensive than doing so directly with the target node.</li>\n<li>Using the ladder to slow jam the target node results in it losing reputation with its downstream peer.</li>\n</ul>\n</li>\n</ul>\n<p>We ran the fuzzer for ~24H (~ 23 billion execs) and did not produce any effective ladder attacks. While this of course doesn\u2019t mean that there are no cases where this attack could work, our manual efforts and the fuzzer couldn\u2019t find one!</p>\n<h4><a name=\"p-3212-manipulation-surge-attack-8\" class=\"anchor\" href=\"#p-3212-manipulation-surge-attack-8\"></a>Manipulation - Surge Attack</h4>\n<p>In this attack, the attacker inflates the value of the outgoing channel instead of trying to build a direct reputation with the node. By sending many successful payments over the channel, the attacker can drive up the threshold for good reputation, and potentially price out the node\u2019s peers so that they lose access to its protected resources. A key insight here is that the attacker does not need to pay up to the reputation threshold of the channel, just the difference between its peers\u2019 incoming reputation and the outgoing channel\u2019s revenue.</p>\n<p>We also <a href=\"https://github.com/carlaKC/reputation-fuzz/blob/fda5a8823a26fd6b6dc243f3035288523a5e50b6/fuzz_test.go#L116\" rel=\"noopener nofollow ugc\">fuzzed this attack</a> for ~24H (~22 billion execs) with the following conditions, and did not find any attacks where the targeted node loses revenue to the attack:</p>\n<ul>\n<li>Create a set of 2-255 peers for the targeted node.</li>\n<li>Generate 6 month revenue values for each peer, restricted to &lt; 1 BTC.</li>\n<li>Choose a cutoff point for the attack:\n<ul>\n<li>Sort peers by ascending fee revenue order.</li>\n<li>Choose an index that represents the highest value peer that will be cut off.</li>\n<li>The cutoff peer must have sufficient reputation to get a $1 HTLC endorsed.</li>\n</ul>\n</li>\n<li>The attack is successful if the sum of the total paid by the attacker to inflate the link and its remaining revenue (not targeted in the surge attack) is less than its revenue when not under attack.</li>\n</ul>\n<h4><a name=\"p-3212-manipulation-sink-attack-9\" class=\"anchor\" href=\"#p-3212-manipulation-sink-attack-9\"></a>Manipulation - Sink Attack</h4>\n<p>A sink attack aims to decrease the reputation of a targeted node\u2019s peers by creating shorter/cheaper paths in the network, and sabotaging payments forwarded through its channels to decrease the reputation of all the nodes preceding it in the route.</p>\n<p>We ran this attack against our test network of 50 nodes with the following strategy (massive  thanks to Moorehouse for the code!):</p>\n<ul>\n<li>Attacking node opens zero-fee channels with the 10 largest nodes that are not directly connected to the target node, and a single channel with the target.</li>\n<li>Endorsed HTLCs are held by the attacking node for 5 hours, then released to reach their eventual destination.</li>\n<li>General jam the target node\u2019s channels once its peers have lost their reputation.</li>\n</ul>\n<p>This attack successfully reduced the target node\u2019s revenue to 15% of its peacetime revenue, with the only cost to the attacker being 11x channel opens and some minor unconditional fees for the payments used to jam the target\u2019s general slots. <strong>This is possible because our mitigation only accounts for the risk of a jamming attack by our <em>incoming</em> link, but does not account for the damage that our <em>outgoing</em> link can do by holding HTLCs.</strong></p>\n<p>It\u2019s tempting to think about <a href=\"https://github.com/lightning/bolts/pull/1044\" rel=\"noopener nofollow ugc\">attributable errors</a> and latency aware routing to fight against an attack that depends on attracting traffic along a route to be successful, because nodes would route around the attacker after one delayed payment [4]. However this attack will still be successful if the attacker can lure in <a href=\"https://github.com/lightning/bolts/pull/1071#pullrequestreview-2219558063\" rel=\"noopener nofollow ugc\">sufficient distinct senders</a> to ruin the target node\u2019s reputation. We could also consider pathfinding that avoids newer links, but we think that\u2019s an unacceptable centralization tradeoff (and a patient attacker can just prepare in advance).</p>\n<p>So we\u2019re proceeding with the assumption that an attacker will be able to draw in a reasonable amount of traffic with a well placed, cheap set of channels - <strong>please let us know if you think we\u2019re wrong about this [5]!</strong> We\u2019re also primarily concerned with slow jamming in this case, because it\u2019s unlikely that an attacker will be able to draw in the volume of payments required to fast-jam a channel entirely.</p>\n<h3><a name=\"p-3212-bidirectional-reputation-10\" class=\"anchor\" href=\"#p-3212-bidirectional-reputation-10\"></a>Bidirectional Reputation</h3>\n<p>To update our solution to account for the risk that our outgoing link will jam us, we consider reputation bidirectionally [7]. This means that when a payment is forwarded over A - B - C, the forwarding node will consider both A\u2019s <a href=\"https://github.com/lightning/bolts/pull/1071/files#diff-cacdd96a68db515fcae910df93d77abd001eb3e6641d06fb490c46218e3dc6b2R119\" rel=\"noopener nofollow ugc\">reputation as an incoming node</a> and C\u2019s reputation as an outgoing node when it makes forwarding decisions.</p>\n<p>A\u2019s incoming reputation is calculated as outlined in our original proposal, and we additionally consider the following values for C\u2019s reputation as an outgoing node:</p>\n<ul>\n<li><code>outgoing_channel_reputation</code>: the total fees that C has earned as an outgoing link over 6 months (the <a href=\"https://github.com/lightning/bolts/pull/1071/files#diff-cacdd96a68db515fcae910df93d77abd001eb3e6641d06fb490c46218e3dc6b2R218-R219\" rel=\"noopener nofollow ugc\">reputation_window</a> in our proposal).</li>\n<li><code>in_flight_risk</code>: the <a href=\"https://github.com/lightning/bolts/pull/1071/files#diff-cacdd96a68db515fcae910df93d77abd001eb3e6641d06fb490c46218e3dc6b2R240-R241\" rel=\"noopener nofollow ugc\">outstanding risk</a> of all outgoing HTLCs currently held by C.</li>\n<li><code>incoming_channel_revenue</code>: the bidirectional revenue that A has earned us over 2 weeks (the <a href=\"https://github.com/lightning/bolts/pull/1071/files#diff-cacdd96a68db515fcae910df93d77abd001eb3e6641d06fb490c46218e3dc6b2R187\" rel=\"noopener nofollow ugc\">revenue_window</a> in our proposal).</li>\n</ul>\n<p>Similar to the incoming direction, C will be considered to have good reputation in the outgoing direction if: <code>outgoing_channel_reputation - in_flight_risk &gt;= incoming_channel_revenue</code></p>\n<p>Here we compare the value that C has offered us as an outgoing link to the value that we may lose if C uses this HTLC in an attempt to jam A. By enforcing this inequality in both directions, we ensure that we have been compensated for any damage an attacker in either direction may inflict.</p>\n<h4><a name=\"p-3212-forwarding-decisions-11\" class=\"anchor\" href=\"#p-3212-forwarding-decisions-11\"></a>Forwarding Decisions</h4>\n<p>In the original proposal, we consider risk to both our resources and reputation when we receive a HTLC from an incoming peer and make our forwarding decision. When a HTLC is not endorsed by a high reputation peer:</p>\n<ul>\n<li><strong>Resources</strong>: we limit resource usage to the general bucket of the outgoing channel, so that it cannot be saturated.</li>\n<li><strong>Reputation</strong>: we drop the endorsement signal to protect our reputation with the downstream peer.</li>\n</ul>\n<p>Likewise, we should consider the risk to our resources and reputation when we forward HTLCs on to an outgoing peer:</p>\n<ul>\n<li><strong>Resources</strong>: we have a HTLC locked in on the incoming link, possibly using protected resources, which the outgoing peer may use for slow-jamming.</li>\n<li><strong>Reputation</strong>: if the HTLC was endorsed by our incoming peer, the outgoing peer may use it to trash our peer\u2019s reputation by delaying resolution.</li>\n</ul>\n<p>When considering the risk that an outgoing peer poses to us, we don\u2019t have the option to drop the endorsement signal and minimize resource utilization to protect ourselves against attack; we\u2019ve already committed to an incoming HTLCs. To fully protect against malicious outgoing peers, <strong>forwarding nodes will need to drop endorsed HTLCs if the outgoing peer has low reputation.</strong></p>\n<p>Rather than endorse all HTLCs, we suggest that HTLCs are unendorsed by default and only endorsed if the sending node experiences payment failures [7]. We tested endorse-on-failure payments against a test network of 50 nodes and saw no significant decrease in forwarding node revenue, and observed that less than 0.5% of payments were dropped due to this new mechanism.</p>\n<p>The importance of dropping endorsed payments becomes apparent when we look at how this mitigation defends against a sink attack. The figure below shows the forwarding decisions made by the target node for HTLCs sent to the attacker when we ran the sink attack on our test network with bidirectional reputation implemented.</p>\n<p>\n  <div class=\"lightbox-wrapper\"><a class=\"lightbox\" href=\"https://delvingbitcoin.org/uploads/default/original/1X/d9d74513a82eaad69243203ab8db5ea08247c83a.jpeg\" data-download-href=\"https://delvingbitcoin.org/uploads/default/d9d74513a82eaad69243203ab8db5ea08247c83a\" title=\"AD_4nXdOY4nZGjKf_wAq-ff9cU73_XL4H_8-UAMc4a72uxzPhVc-5u_dUEkxQ0trPcBcOOmnRonegFSA5v-aQLl40CD24_E6dU0KUBBnpL0Us5DWNybv8ljYtD-Ed1Cm-lDR5Kbvexy38TQElYVAkhjDMjFIfZks.jpg\"><img src=\"https://delvingbitcoin.org/uploads/default/optimized/1X/d9d74513a82eaad69243203ab8db5ea08247c83a_2_690x338.jpeg\" data-base62-sha1=\"v56P7EZJ8YdxfgFf2DaxoIHx7qG\" width=\"690\" height=\"338\" srcset=\"https://delvingbitcoin.org/uploads/default/optimized/1X/d9d74513a82eaad69243203ab8db5ea08247c83a_2_690x338.jpeg, https://delvingbitcoin.org/uploads/default/optimized/1X/d9d74513a82eaad69243203ab8db5ea08247c83a_2_1035x507.jpeg 1.5x, https://delvingbitcoin.org/uploads/default/optimized/1X/d9d74513a82eaad69243203ab8db5ea08247c83a_2_1380x676.jpeg 2x\" data-dominant-color=\"F9FAF9\"><div class=\"meta\"><svg class=\"fa d-icon d-icon-far-image svg-icon\" aria-hidden=\"true\"><use href=\"#far-image\"></use></svg><span class=\"filename\">AD_4nXdOY4nZGjKf_wAq-ff9cU73_XL4H_8-UAMc4a72uxzPhVc-5u_dUEkxQ0trPcBcOOmnRonegFSA5v-aQLl40CD24_E6dU0KUBBnpL0Us5DWNybv8ljYtD-Ed1Cm-lDR5Kbvexy38TQElYVAkhjDMjFIfZks.jpg</span><span class=\"informations\">1600\u00d7784 105 KB</span><svg class=\"fa d-icon d-icon-discourse-expand svg-icon\" aria-hidden=\"true\"><use href=\"#discourse-expand\"></use></svg></div></a></div>\n</p>\n<p>When the attacker starts to hold HTLCs, its outgoing reputation will drop because in-flight HTLCs reduce reputation. The target node then starts to drop endorsed payments to the attacker, because the attacker no longer has a good reputation. It will still forward unendorsed payments to the attacker, as they represent no risk to its reputation or resources. In our experiment, the target node did not suffer revenue loss - the revenue from the attacker-created cheap paths offsets any loss from the jamming attack, and the attacker is cut off from any endorsed HTLCs thereafter.</p>\n<p>Please note that we ran out of time to more rigorously test this out before the summit, so take this all with the \u201cwe ran it twice\u201d grain of salt it deserves!</p>\n<h4><a name=\"p-3212-change-summary-12\" class=\"anchor\" href=\"#p-3212-change-summary-12\"></a>Change Summary</h4>\n<p>The introduction of bidirectional reputation adds a new component to our original proposal. It\u2019s not much more code, and a POC implementation is available <a href=\"https://github.com/carlaKC/lrc/tree/bidirectional-reputation\" rel=\"noopener nofollow ugc\">here</a>. The decision tree for the reputation system is outlined below:</p>\n<pre><code class=\"lang-auto\">if incoming htlc endorsed:\n\tif good incoming reputation and good outgoing reputation:\n\t\tforward endorsed\n\telif bad outgoing reputation:\n\t\tdrop payment\n\telse:\n\t\tforward unendorsed (as below)\nelse:\n\tif general resources available:\n\t\tforward unendorsed\n\telse:\n\t\tdrop payment, no resources\n</code></pre>\n<h3><a name=\"p-3212-up-next-13\" class=\"anchor\" href=\"#p-3212-up-next-13\"></a>Up Next</h3>\n<p>Our next steps will be to run a more complete set of experiments to test bidirectional reputation as a mitigation against sink attacks, and to re-run our jamming experiments above to ensure that there are no regressions [8]. We\u2019re interested in hearing thoughts on this approach from other protocol developers [9], so please let us know what you think!</p>\n<p>This is a difficult problem to solve, and it will require hard tradeoffs, but we\u2019re happy with the mitigation\u2019s performance against resource jamming attacks and optimistic about bidirectional reputation\u2019s ability to mitigate downstream sink attacks.</p>\n<p>We\u2019d also like to express our heartfelt gratitude to all that made the trip to attend the attackathon. This work immensely benefited from a wider range of perspectives looking at this problem, and is far better for it!</p>\n<details>\n <summary>Footnotes</summary>\n<p>[0] We only consider economic value that is observable within the protocol (forwarding fees) when we consider the impact of an attack. Users that value their ability to forward payments beyond fees, such as the value of doing business as a lightning service, should be able to specify this exogenous value as an input to the reputation algorithm.<br>\n[1] Reputation was implemented via <a href=\"https://github.com/carlaKC/circuitbreaker/tree/attackathon\" rel=\"noopener nofollow ugc\">circuitbreaker</a>, which allowed us to quickly implement and iterate on a library with the full reputation algorithm rather than making it LND-specific. Unconditional fees were not implemented in LND, but they are accounted for in our analysis scripts.<br>\n[2] This is something we\u2019d potentially look into decreasing (relating this cost to the actual traffic on the channel) if we get some real world numbers indicating that this amount is too steep for honest actors. In that case, we\u2019d expect to come closer to breaking even.<br>\n[3] If we remove the requirement that the targeted node can get at least a $1 HTLC endorsed, then we see some cases where an attacker can save around 5% of their costs by performing a laddering attack against a target node that\u2019s barely crossed the reputation threshold.<br>\n[4] <a href=\"https://github.com/lightning/bolts/pull/1044\" rel=\"noopener nofollow ugc\">Attributable errors</a> allow sending nodes to attribute time delays to nodes along the route, which opens the door to latency-sensitive routing algorithms that could route around these malicious sinks.<br>\n[5] It\u2019s again tempting to think about <a href=\"https://lists.linuxfoundation.org/pipermail/lightning-dev/2021-February/002958.html\" rel=\"noopener nofollow ugc\">monetary solutions</a> here, but these will become prohibitively expensive for honest users to account for the worst-case hold time.<br>\n[6] While we assume the attacker can attract some traffic, we do not expect the consistent thundering herd of payments required for a fast jamming attack.<br>\n[7]  Previously our algorithm only accounted for the risk that an attacker A is targeting outgoing channel BC. By examining reputation in both directions, we can also account for the risk that an attacker B is targeting incoming channel AB.<br>\n[7] It\u2019s likely that nodes would not endorse by default anyway, because the upside of successful endorsed/unendorsed payments is the same and endorsed payments pose a risk to their reputation. By only endorsing on failure, sending nodes only take advantage of protected resources when they need to.<br>\n[8] We don\u2019t expect any, if anything it\u2019ll make these attacks harder as well, but will repeat for completeness. We wanted to get this post out before the summit, and ran out of time to repeat them!<br>\n[9] As is the case with all bitcoin problems, this has already been discussed on the <a href=\"https://lists.linuxfoundation.org/pipermail/lightning-dev/2018-May/001232.html\" rel=\"noopener nofollow ugc\">mailing list</a> before our time, so we\u2019re particularly interested in hearing about any conversations that happened off-mailing-list back then!</p>\n</details>",
  "post_number": 1,
  "post_type": 1,
  "updated_at": "2024-09-17T14:21:56.575Z",
  "reply_count": 0,
  "reply_to_post_number": null,
  "quote_count": 0,
  "incoming_link_count": 5,
  "reads": 4,
  "readers_count": 3,
  "score": 15.8,
  "yours": false,
  "topic_id": 1147,
  "topic_slug": "hybrid-jamming-mitigation-results-and-updates",
  "topic_title": "Hybrid Jamming Mitigation: Results and Updates",
  "topic_html_title": "Hybrid Jamming Mitigation: Results and Updates",
  "category_id": 7,
  "display_username": "Carla Kirk-Cohen",
  "primary_group_name": null,
  "flair_name": null,
  "flair_url": null,
  "flair_bg_color": null,
  "flair_color": null,
  "flair_group_id": null,
  "version": 2,
  "can_edit": false,
  "can_delete": false,
  "can_recover": false,
  "can_see_hidden_post": false,
  "can_wiki": false,
  "user_title": "",
  "bookmarked": false,
  "raw": "Writing with an update on the work that Clara and I have been doing to investigate the effectiveness of our hybrid mitigation for channel jamming attacks against lightning. This post assumes familiarity with the proposal, so please check out the high level write up [here](https://gist.github.com/carlaKC/02251cd061260bbb149f361c65fc9f2f) if you need to catch up. \n\ntl;dr:\n\n* The mitigation performs as expected against slow and fast jamming attacks, appropriately compensating nodes that are attacked.  \n* It is resilient against most reputation-spoiling attacks, but needs to be updated to protect against a downstream attacker that opportunistically holds HTLCs to ruin reputation along the route.\n\n<details>  \n <summary>PSA: Sections with in-depth details are in collapsable summaries.</summary>  \n\ud83e\udef6 Please click on them for more detail \ud83e\udef6\n</details>\n\n## Introduction\n\nOur reputation algorithm is designed to ensure that the cost of acquiring reputation is comparable to the damage that can be done by abusing that reputation. If there is no revenue loss under attack, we can ensure that nodes are not economically damaged by attacks \\[0\\].\n\n**Note that we do not guarantee that jamming attacks cannot occur, only that nodes targeted will be compensated by at least the amount that they would have earned with regular operation.**\n\nWhile we can\u2019t possibly enumerate every possible attack, one of the best ways to understand how this mitigation performs is to try to break it and see what happens. So we got a group of lightning developers together earlier in the year for an \u201c[attackathon](https://github.com/carlaKC/attackathon)\u201d where they experimented with various approaches to breaking our mitigation. \n\nThis post reports on the performance of our mitigation under the various attacks, and outlines improvements made to the proposal based on insights gained from the attackathon.\n\n## Attacks\n\nAs is the case with any jamming mitigation, there is a risk that the mitigation itself is abused to restrict the resources of the network. In our case, this would be achieved by targeting a node\u2019s reputation to restrict its ability to operate. We therefore need to think about two different approaches to jamming attacks in the context of this solution:\n\n**Resource jamming**: aims to consume all channel resources, as we think of jamming attacks today. Successfully executed when:\n\n* All general resources have been exhausted by the attacker.  \n* All protected resources have been exhausted by the attacker\n\n**Reputation jamming**: aims to render protected resources unusable by sabotaging the reputation of a node\u2019s peers, effectively jamming the channel because the mitigation does not assign these resources to honest peers. (h/t: Thomas for first flagging this one\\!) Successfully executed when:\n\n* All general resources have been exhausted by the attacker on the targeted channel.  \n* All of the target node\u2019s peers have low reputation with it. \n\n### Resource attacks\n\nTwo teams at the attackathon wrote resource jamming attacks, where they aimed to build up reputation with a target node then leverage it to occupy all of its protected resources. We\u2019ve since built out these attacks and run them against a 50 node test [warnet](https://github.com/bitcoin-dev-project/warnet) to get an understanding of their impact.\n\n<details>\n <summary>Full details about our test network are available here.</summary>\nWe used real lightning nodes in our resource jamming experiment so that we could capture all the nuance of pathfinding, dust limits and force closures that you need to be conscious of when thinking about channel jamming. We also wanted to create an approachable network that anyone could try to break, rather than a specialist simulator that would likely lack the APIs required to explore different attack approaches. \n\nTo create a large network, we used [warnet](https://github.com/bitcoin-dev-project/warnet) to create a test network of [LND](https://github.com/carlaKC/lnd/tree/attackathon) nodes running our [reputation mitigation](https://github.com/carlaKC/lrc) \\[1\\]. We reduced the mainnet graph to 50 nodes using a random sample of the neighborhood around the Acinq node, which was our target node for attacks (sorry Acinq\\!). Using warcli\u2019s [import\\_json](https://github.com/bitcoin-dev-project/warnet/blob/7f0a082da2a9b0405743c62da3dadfc7b8752f1b/src/cli/graph.py#L43) command, we could then spin up a lightning network with the channels and policies of the reduced mainnet graph. None of this would have happened without Zip and the warnet team, I am many beers indebted\\!\n\nRunning with realistic payment history and traffic was important to testing our mitigation in a dynamic environment. We used [sim-ln](https://github.com/bitcoin-dev-project/sim-ln), which can run against real lightning nodes or as a sped up payment simulator to create activity for a given graph, in several places:\n\n* **Reputation bootstrap**: running in simulation mode for the chosen graph, we generated payment histories for honest nodes which were imported to our reputation system to provide historical data without having to execute months of payments on the actual nodes.  \n* **Honest payments**: running connected to every honest node in the network, we generated honest payment activity in the network during the attack.    \n* **Projected revenue**: running in simulation mode with the same fixed seed as the honest payments, we generated a projection of the payments that nodes in the network would have processed in the absence of a jamming attack. We generated these projections 50 times for the network, and used the mean to represent the network in peace times.\n\nThis payment traffic is, of course, an imperfect representation of mainnet traffic. It does however provide a baseline for comparison across attacks and peacetime for the simulations.\n\nSome of the time-based parameters in our proposal were reduced to shorten our runtime:\n\n* Revenue window \\= 1 hour  \n* Reputation window \\= 24 hours  \n* HTLC opportunity cost \\= 12 blocks  \n* Block time \\= 5 minutes\n</details>\n\n#### Slow Slot Jamming\n\nWe ran a slow slot jamming attack against a single channel on our targeted node, aiming to consume \\> 480 slots on the target channel for a period of 10 minutes.\n\n<details>\n <summary>An in depth description of the attack strategy is available here.</summary>\nThe approach taken to orchestrate a slow jamming attack against the target channel A-B by malicious nodes M0/1/2 works as follows:\n\n1. M0 \u201cpre-pays\u201d good reputation with A on M0-A by sending fast-resolving, successful payments over M0-A-M1.  \n- These payments do not need to be endorsed, because fast-resolving successful unendorsed payments will bootstrap their reputation.  \n- Note that we don\u2019t want to build a reputation on a path that utilizes A-B, because this would inflate the value of AB for M0 to later attack.  \n- M0 will occasionally send an endorsed payment probe over M0-A-B-M2 to determine whether they\u2019ve built sufficient reputation to use A-B\u2019s protected resources.  \n2. Once M0 has built up sufficient reputation, M1 sends a set unendorsed payments over M1-A-B-M2 to occupy all of the general resources on A-B and holds them for the duration of the attack.   \n3. Finally, M0 will send a series of endorsed payments over M0-A-B-M2 to occupy all of the protected resources on A-B and hold them for the duration of the attack.  \n- This can be fine-tuned to distinguish between reputation-based and liquidity based failures by iteratively probing and \u201cpre-paying\u201d for more reputation (as described in (1) to ensure that M0 does not overpay for access to the protected slots.  \n- It\u2019s likely that A doesn\u2019t have sufficient reputation with B to occupy all of its protected resources on its channels with M2, so two channels are opened so that all jamming payments can be accommodated in the general buckets of the channels between B and M2.\n\n**![|489x284](upload://96xBgvNkQf7eJTerYDKjW46DM5g.png)**\n\n</details>\n\nIn our experiment, the mitigation strategy worked as expected \\- the targeted node did not lose revenue when targeted, and the majority of attacker costs were for reputation building. \n\n**Attacker paid**: \u200b\u200b1,370,485 msat in off-chain fees:\n\n* Success case (94% of total): 1,286,744 msat  \n* Unconditional (6% of total): 83,740 msat\n\n**Target earned**: 1,875,080 msat in off-chain fees:\n\n* Success case (97% of total): 1,815,280 msat  \n* Unconditional (3% of total): 59,799 msat\n\nThe target was paid 1,446,343 msat in off-chain fees by the attacker, so their revenue breakdown is:\n\n* 93% of revenue paid by attacker traffic  \n* 7% of revenue was paid by honest traffic\n\nTo compare revenue under attack to the target node\u2019s expected revenue in times of peace, we ran our payment simulator 50 times to get an average expected revenue of **15,030 msat over 10 minutes** and **1,205,876 msat over a 2 week period**.\n\nSince the HTLCs for the slow jamming attack can be held for up to two weeks, we compare our attacker costs to projected revenue over a two week period. T**here is a 19.94% increase in revenue for the targeted node under attack**. This is not surprising, because our per\u2013htlc \u201copportunity cost\u201d charges quite a steep fee for each slot in our protected bucket of resources \\[2\\]. \n\n<details>\n <summary>Raw data for the experiments is available here.</summary>\n\n| ID | Success case fees paid by attacker | Unconditional fees paid by attacker | Success case fees earned by target (all senders) | Unconditional fees earned by sender (all senders) | Fees paid from attacker to target | Time Slot Jammed (\\>440) |\n| ----- | ----- | ----- | ----- | ----- | ----- | ----- |\n| 0 | 1,286,350.00 | 82,463.50 | 1,291,127.00 | 53,511.27 | 1,339,813.50 | 10.09 |\n| 1 | 1,296,305.00 | 88,347.05 | 1,308,725.00 | 57,131.25 | 1,353,242.05 | 10.18 |\n| 2 | 1,292,105.00 | 88,305.05 | 2,144,659.00 | 65,470.97 | 1,349,000.05 | 10.38 |\n| 3 | 1,296,305.00 | 88,347.05 | 1,308,658.00 | 57,080.58 | 1,353,242.05 | 10.45 |\n| 4 | 1,274,705.00 | 88,107.05 | 1,290,544.00 | 56,895.44 | 1,331,412.05 | 10.38 |\n| 5 | 1,292,105.00 | 88,305.05 | 1,301,111.00 | 57,015.11 | 1,349,000.05 | 10.12 |\n| 6 | 1,293,505.00 | 76,751.05 | 1,307,637.00 | 50,363.27 | 1,343,666.05 | 10.03 |\n| 7 | 1,272,837.00 | 76,520.37 | 1,283,632.00 | 50,108.96 | 1,322,777.37 | 10.13 |\n| 8 | 1,272,837.00 | 76,520.37 | 1,283,365.00 | 50,055.65 | 1,322,777.37 | 10.06 |\n| 9 | 1,290,394.00 | 82,503.94 | 1,296,973.00 | 53,619.73 | 1,343,897.94 | 11.02 |\n| MEAN | 1,286,744.80 | 83,740.73 | 1,391,050.89 | 55,292.50 | 1,340,547.84 | 10.20 |\n| STDDEV | 10,102.26 | 5,678.04 | 282,789.65 | 4,968.40 | 12,198.72 | 0.1582123597 |\n| MEAN/STDDEV | 127.37 | 14.75 | 4.92 | 11.13 | 109.89 | 64.47496481 |\n\n</details>\n\n#### Fast Slot Jamming\n\nThis attack is a variation on the slow jamming attack described above, where the targeted node\u2019s protected resources are occupied by a continuous stream of fast-failing payments. This was particularly interesting to us, because it manages to exhaust protected resources without the attacker losing their reputation. In this attack, the targeted node is protected only by unconditional fees, and the eventual decay of the reputation that the attacker built up to gain access to the protected bucket in the first place.\n\nWhen unconditional fees will be a major cost to the attacker, it\u2019s worth examining whether slot or liquidity jamming will be more economical to fully occupy the channel\u2019s resources. The costs that we need to consider are:\n\n* **Reputation cost**: the amount paid to gain access to protected resources, generally expected to be higher for liquidity jamming because this cost depends on the fee for the HTLC.  \n* **Unconditional fee cost**: the unconditional fee paid to continuously occupy protected resources with many slot jamming payments or fewer larger liquidity jams; dependent on the fee policy of the targeted channel.\n\nWe ran [this comparison](https://gist.github.com/carlaKC/9763ef8df9790713f542dc553aff8a03) against a snapshot of the mainnet graph and found that it\u2019s more economical to fast slot jam 59% of the channel policies on the network.\n\nAs was the case with our slow jamming attack, the mitigation performs as expected and the targeted node is compensated for the revenue that it would lose in the window that it is jammed. But unlike a slow jamming attack, the attacker does not lose their \u201cprepaid\u201d reputation so they will be able to continue the fast jamming attack until their reputation decays. \n\nTo keep the channel jammed, the attacker will need to continuously dispatch fast-failing payments to occupy the protected resource on a channel. For an attack time t (expressed in seconds) the total unconditional fees that they will have to pay for a fast-slot attack is: `t / 90 * 242 * base_fee * 0.01`. \n\nThis produces 32,524,833 msat in unconditional fees for our targeted channel to continue the attack for 2 weeks (given a base fee of 1000 msat). This represents a 25% increase in revenue when targeted by a fast slot jamming attack. We also sanity checked this result against a liquidity jamming attack, which requires fewer HTLCs with higher reputation \u201ccosts\u201d, and saw similar revenue numbers.\n\n<details>\n <summary>Raw data for the experiments is available here.</summary>\n\n| ID | Success case fees paid by attacker | Unconditional fees paid by attacker | Success case fees earned by target (all senders) | Unconditional fees earned by sender (all senders) | Fees paid from attacker to target | Time Under Attack (\\>440) |\n| ----- | ----- | ----- | ----- | ----- | ----- | ----- |\n| 0 | 1,288,839.00 | 157,248.39 | 1,300,920.00 | 97,249.20 | 1,385,937.39 | 7.96 |\n| 1 | 1,263,505.00 | 156,923.05 | 1,282,525.00 | 97,043.49 | 1,360,308.05 | 7.03 |\n| 2 | 1,288,839.00 | 152,016.39 | 1,295,841.00 | 94,136.41 | 1,382,885.39 | 6.00 |\n| 4 | 1,221,960.00 | 141,243.60 | 1,245,060.00 | 87,764.60 | 1,309,443.60 | 8.74 |\n| 5 | 1,293,505.00 | 172,247.05 | 1,302,040.00 | 106,002.41 | 1,399,372.05 | 7.86 |\n| 7 | 1,293,505.00 | 124,055.05 | 1,304,477.00 | 77,934.87 | 1,371,260.05 | 9.97  |\n| 9 | 1,293,505.00 | 125,351.05 | 1,297,040.00 | 78,586.47 | 1,372,016.05 | 10.44 |\n| 10 | 1,274,392.00 | 136,631.92 | 1,278,920.00 | 85,067.23 | 1,359,403.92 | 10.42 |\n| 11 | 1,204,851.00 | 183,504.51 | 1,215,927.00 | 112,195.27 | 1,316,915.51 | 6.01 |\n| 12 | 1,292,060.00 | 182,582.60 | 1,300,087.00 | 112,032.87 | 1,403,962.60 | 9.35 |\n| MEAN | 1,271,496.10 | 153,180.36 | 1,282,283.70 | 94,801.28 | 1,366,150.46 | 8.38 |\n| STDDEV | 32,395.54 | 21,650.22 | 29,342.54 | 12,596.60 | 31,596.28 | 1.68 |\n| MEAN/STDDEV | 39.25 | 7.08 | 43.70 | 7.53 | 43.24 | 4.97 |\n\n</details>\n\nh/t: Jules/Sachin/Kevin for this one!\n\n### Reputation attacks\n\nWe also saw a variety of approaches to trying to abuse the reputation system. Two themes emerged across the various attacks: \n\n* **Optimization**: attacks that attempt to decrease the cost of acquiring good reputation with a target node.  \n* **Manipulation**: strategies for using the reputation system itself to cut off honest nodes from access to protected resources.\n\n#### Optimization \\- Laddering Attack\n\nA laddering attack exploits a chain of nodes with increasing reputation to gain endorsement with a higher-value node downstream. Since reputation is related to fee revenue, an attacker can identify a chain of gradually increasing channel sizes (assuming that size is a proxy for activity) and build reputation with the cheapest rung of the ladder.\n\n\n<details>\n <summary>A detailed walkthrough of this concept is available here.\n</summary>\n\nStarting with an honest network of A, B, C, D, we\u2019ll assume that we have the following \u201claddered\u201d (increasing) traffic pattern:\n\n* Payments sent over A \\-\\> B represent 100% of A\u2019s outgoing traffic.  \n* Payments sent over A \\-\\> B represent 10% of B\u2019s forwards on BC  \n* Payments sent over B \\-\\> C represent 25% of C\u2019s forwards on CD  \n* Payments sent over C \\-\\> D represent 50% of D\u2019s forwards onwards.\n\nTo keep things simple for the sake of an example, we\u2019ll walk through revenue flows between the nodes without thinking about fee calculations \\- so when you see 120k of reputation/revenue, think \u201c120k of traffic\u2019s fees of reputation/revenue\u201d. We\u2019ll also assume that traffic is constant over time, so that we can easily move between 2 week and 6 month horizons.\n\nOver a period of 6 months, A forwards 120k of payments to B that will use the BC outgoing link:\n\n**![|624x87](upload://O3nYhmeGELzoyhOneEsjf8v4fK.png)**\n\nThis means that A will have accrued 120k of reputation with B over a period of 6 months. We can then calculate the reputation threshold for B\u2019s outgoing link as follows:\n\n* A is 10% of B\u2019s traffic, so the total traffic over 6 months is 120k \\* 10 \\= 1.2m  \n* The revenue threshold for the outgoing link BC is 1.2m/12 \\= 100k because we consider our outgoing revenue over a 2 week period.\n\n**![|624x95](upload://3RNf4tVn6ca9MaiZjfLb8GE9g81.png)**\n\nThis means that B will have accrued 1.2m of reputation with C over a period of 6 months. Likewise we\u2019ll calculate the reputation threshold of C\u2019s outgoing link as follows:\n\n* B is 25% of C\u2019s traffic, so the total revenue over 6 months is 1.2m \\* 4 \\= 4.8m  \n* The revenue threshold for the outgoing link CD is 4.8m/12 \\= 400k because we consider our outgoing revenue over a 2 week period.\n\n**![|624x91](upload://tFCdO226Qz5IDZMPXhhI5nPC4nh.png)**\n\nAn attacker looking to perform a laddering attack would aim to build good reputation with A, so that they can get HTLCs endorsed on the more valuable downstream C \\-\\> D link. An attacker would need to pay 10k to obtain good reputation with A (120k/ 12 \\= 10k), and additionally pay for the opportunity cost of any HTLC that they\u2019d like A to endorse.\n\nTo get an idea of the damage that an attacker can do with this laddering attack, we look at the difference in A\u2019s current reputation and B\u2019s revenue threshold: 100k \\- 120k \\= 20k. This represents the total \u201cbudget\u201d that is available for in-flight HTLCs before A\u2019s reputation drops below B\u2019s revenue threshold.\n\nUsing our HTLC opportunity cost function, we can calculate the largest HTLC that A can get endorsed based on this budget: `budget = htlc_amt * blocks_till_expiry * 10 * 60 / 90`. Assuming that a HTLC forwarded on A will expire after 160 blocks, the largest HTLC that an attacker can get endorsed by A (and thus downstream on CD)  in 17 msat, which is insufficient to jam the protected resources along the route.\n\nThis example deals with toy numbers, but it should give you a general idea of how this type of attack would work. We\u2019ve created a spreadsheet [here](https://docs.google.com/spreadsheets/d/1AmuRE7-XAZzfy-Ku6MyK1AVfE-aj5j66fb6c5_Zbr7c/edit?usp=sharing) which allows you to plug in different values to get a grasp on how these numbers work out (make a copy to change the values\\!).\n\n</details>\n\nWe wrote a [basic fuzzing test](https://github.com/carlaKC/reputation-fuzz/blob/fda5a8823a26fd6b6dc243f3035288523a5e50b6/fuzz_test.go#L13) for this attack with the following conditions:\n\n* Create a ladder of nodes with 1-8 hops between the attacker and the laddering target  \n* Traffic must increase with each hop in the ladder  \n* The target node must have sufficient reputation to get a $1 HTLC endorsed with its peer \\[3\\].  \n* The attack is successful both of the following hold:  \n  * Acquiring reputation via the ladder is less expensive than doing so directly with the target node.  \n  * Using the ladder to slow jam the target node results in it losing reputation with its downstream peer.\n\nWe ran the fuzzer for \\~24H (\\~ 23 billion execs) and did not produce any effective ladder attacks. While this of course doesn\u2019t mean that there are no cases where this attack could work, our manual efforts and the fuzzer couldn\u2019t find one\\!\n\n#### Manipulation - Surge Attack\n\nIn this attack, the attacker inflates the value of the outgoing channel instead of trying to build a direct reputation with the node. By sending many successful payments over the channel, the attacker can drive up the threshold for good reputation, and potentially price out the node\u2019s peers so that they lose access to its protected resources. A key insight here is that the attacker does not need to pay up to the reputation threshold of the channel, just the difference between its peers' incoming reputation and the outgoing channel\u2019s revenue.\n\nWe also [fuzzed this attack](https://github.com/carlaKC/reputation-fuzz/blob/fda5a8823a26fd6b6dc243f3035288523a5e50b6/fuzz_test.go#L116) for ~24H (~22 billion execs) with the following conditions, and did not find any attacks where the targeted node loses revenue to the attack:\n\n* Create a set of 2-255 peers for the targeted node.\n* Generate 6 month revenue values for each peer, restricted to < 1 BTC.\n* Choose a cutoff point for the attack:\n  * Sort peers by ascending fee revenue order.\n  * Choose an index that represents the highest value peer that will be cut off.\n  * The cutoff peer must have sufficient reputation to get a $1 HTLC endorsed.\n* The attack is successful if the sum of the total paid by the attacker to inflate the link and its remaining revenue (not targeted in the surge attack) is less than its revenue when not under attack.\n\n#### Manipulation \\- Sink Attack\n\nA sink attack aims to decrease the reputation of a targeted node\u2019s peers by creating shorter/cheaper paths in the network, and sabotaging payments forwarded through its channels to decrease the reputation of all the nodes preceding it in the route. \n\nWe ran this attack against our test network of 50 nodes with the following strategy (massive  thanks to Moorehouse for the code\\!):\n\n* Attacking node opens zero-fee channels with the 10 largest nodes that are not directly connected to the target node, and a single channel with the target.   \n* Endorsed HTLCs are held by the attacking node for 5 hours, then released to reach their eventual destination.  \n* General jam the target node\u2019s channels once its peers have lost their reputation.\n\nThis attack successfully reduced the target node\u2019s revenue to 15% of its peacetime revenue, with the only cost to the attacker being 11x channel opens and some minor unconditional fees for the payments used to jam the target\u2019s general slots. **This is possible because our mitigation only accounts for the risk of a jamming attack by our *incoming* link, but does not account for the damage that our *outgoing* link can do by holding HTLCs.** \n\nIt\u2019s tempting to think about [attributable errors](https://github.com/lightning/bolts/pull/1044) and latency aware routing to fight against an attack that depends on attracting traffic along a route to be successful, because nodes would route around the attacker after one delayed payment \\[4\\]. However this attack will still be successful if the attacker can lure in [sufficient distinct senders](https://github.com/lightning/bolts/pull/1071#pullrequestreview-2219558063) to ruin the target node\u2019s reputation. We could also consider pathfinding that avoids newer links, but we think that\u2019s an unacceptable centralization tradeoff (and a patient attacker can just prepare in advance). \n\nSo we\u2019re proceeding with the assumption that an attacker will be able to draw in a reasonable amount of traffic with a well placed, cheap set of channels \\- **please let us know if you think we\u2019re wrong about this \\[5\\]\\!** We\u2019re also primarily concerned with slow jamming in this case, because it\u2019s unlikely that an attacker will be able to draw in the volume of payments required to fast-jam a channel entirely.\n\n### Bidirectional Reputation\n\nTo update our solution to account for the risk that our outgoing link will jam us, we consider reputation bidirectionally [7]. This means that when a payment is forwarded over A - B - C, the forwarding node will consider both A\u2019s [reputation as an incoming node](https://github.com/lightning/bolts/pull/1071/files#diff-cacdd96a68db515fcae910df93d77abd001eb3e6641d06fb490c46218e3dc6b2R119) and C\u2019s reputation as an outgoing node when it makes forwarding decisions.\n\nA\u2019s incoming reputation is calculated as outlined in our original proposal, and we additionally consider the following values for C\u2019s reputation as an outgoing node:\n\n* `outgoing_channel_reputation`: the total fees that C has earned as an outgoing link over 6 months (the [reputation_window](https://github.com/lightning/bolts/pull/1071/files#diff-cacdd96a68db515fcae910df93d77abd001eb3e6641d06fb490c46218e3dc6b2R218-R219) in our proposal).\n* `in_flight_risk`: the [outstanding risk](https://github.com/lightning/bolts/pull/1071/files#diff-cacdd96a68db515fcae910df93d77abd001eb3e6641d06fb490c46218e3dc6b2R240-R241) of all outgoing HTLCs currently held by C.\n* `incoming_channel_revenue`: the bidirectional revenue that A has earned us over 2 weeks (the [revenue_window](https://github.com/lightning/bolts/pull/1071/files#diff-cacdd96a68db515fcae910df93d77abd001eb3e6641d06fb490c46218e3dc6b2R187) in our proposal).\n\nSimilar to the incoming direction, C will be considered to have good reputation in the outgoing direction if: `outgoing_channel_reputation - in_flight_risk >= incoming_channel_revenue`\n\nHere we compare the value that C has offered us as an outgoing link to the value that we may lose if C uses this HTLC in an attempt to jam A. By enforcing this inequality in both directions, we ensure that we have been compensated for any damage an attacker in either direction may inflict.\n\n#### Forwarding Decisions\n\nIn the original proposal, we consider risk to both our resources and reputation when we receive a HTLC from an incoming peer and make our forwarding decision. When a HTLC is not endorsed by a high reputation peer:\n\n* **Resources**: we limit resource usage to the general bucket of the outgoing channel, so that it cannot be saturated.  \n* **Reputation**: we drop the endorsement signal to protect our reputation with the downstream peer.\n\nLikewise, we should consider the risk to our resources and reputation when we forward HTLCs on to an outgoing peer:\n\n* **Resources**: we have a HTLC locked in on the incoming link, possibly using protected resources, which the outgoing peer may use for slow-jamming.  \n* **Reputation**: if the HTLC was endorsed by our incoming peer, the outgoing peer may use it to trash our peer\u2019s reputation by delaying resolution.\n\nWhen considering the risk that an outgoing peer poses to us, we don\u2019t have the option to drop the endorsement signal and minimize resource utilization to protect ourselves against attack; we\u2019ve already committed to an incoming HTLCs. To fully protect against malicious outgoing peers, **forwarding nodes will need to drop endorsed HTLCs if the outgoing peer has low reputation.**\n\nRather than endorse all HTLCs, we suggest that HTLCs are unendorsed by default and only endorsed if the sending node experiences payment failures \\[7\\]. We tested endorse-on-failure payments against a test network of 50 nodes and saw no significant decrease in forwarding node revenue, and observed that less than 0.5% of payments were dropped due to this new mechanism.\n\nThe importance of dropping endorsed payments becomes apparent when we look at how this mitigation defends against a sink attack. The figure below shows the forwarding decisions made by the target node for HTLCs sent to the attacker when we ran the sink attack on our test network with bidirectional reputation implemented.\n\n<p align=\"center\">\n  <img src=\"upload://v56P7EZJ8YdxfgFf2DaxoIHx7qG.jpeg\"/>\n</p>\n\nWhen the attacker starts to hold HTLCs, its outgoing reputation will drop because in-flight HTLCs reduce reputation. The target node then starts to drop endorsed payments to the attacker, because the attacker no longer has a good reputation. It will still forward unendorsed payments to the attacker, as they represent no risk to its reputation or resources. In our experiment, the target node did not suffer revenue loss - the revenue from the attacker-created cheap paths offsets any loss from the jamming attack, and the attacker is cut off from any endorsed HTLCs thereafter.\n\nPlease note that we ran out of time to more rigorously test this out before the summit, so take this all with the \u201cwe ran it twice\u201d grain of salt it deserves!\n\n#### Change Summary\n\nThe introduction of bidirectional reputation adds a new component to our original proposal. It\u2019s not much more code, and a POC implementation is available [here](https://github.com/carlaKC/lrc/tree/bidirectional-reputation). The decision tree for the reputation system is outlined below:\n\n```\nif incoming htlc endorsed:\n\tif good incoming reputation and good outgoing reputation:\n\t\tforward endorsed\n\telif bad outgoing reputation:\n\t\tdrop payment\n\telse:\n\t\tforward unendorsed (as below)\nelse:\n\tif general resources available:\n\t\tforward unendorsed\n\telse:\n\t\tdrop payment, no resources\n```\n\n### Up Next\n\nOur next steps will be to run a more complete set of experiments to test bidirectional reputation as a mitigation against sink attacks, and to re-run our jamming experiments above to ensure that there are no regressions [8]. We\u2019re interested in hearing thoughts on this approach from other protocol developers [9], so please let us know what you think!\n\nThis is a difficult problem to solve, and it will require hard tradeoffs, but we\u2019re happy with the mitigation\u2019s performance against resource jamming attacks and optimistic about bidirectional reputation\u2019s ability to mitigate downstream sink attacks.\n\nWe\u2019d also like to express our heartfelt gratitude to all that made the trip to attend the attackathon. This work immensely benefited from a wider range of perspectives looking at this problem, and is far better for it!\n\n<details>\n <summary>Footnotes</summary>\n\n\\[0\\] We only consider economic value that is observable within the protocol (forwarding fees) when we consider the impact of an attack. Users that value their ability to forward payments beyond fees, such as the value of doing business as a lightning service, should be able to specify this exogenous value as an input to the reputation algorithm.   \n\\[1\\] Reputation was implemented via [circuitbreaker](https://github.com/carlaKC/circuitbreaker/tree/attackathon), which allowed us to quickly implement and iterate on a library with the full reputation algorithm rather than making it LND-specific. Unconditional fees were not implemented in LND, but they are accounted for in our analysis scripts.   \n\\[2\\] This is something we\u2019d potentially look into decreasing (relating this cost to the actual traffic on the channel) if we get some real world numbers indicating that this amount is too steep for honest actors. In that case, we\u2019d expect to come closer to breaking even.  \n\\[3\\] If we remove the requirement that the targeted node can get at least a $1 HTLC endorsed, then we see some cases where an attacker can save around 5% of their costs by performing a laddering attack against a target node that\u2019s barely crossed the reputation threshold.  \n\\[4\\] [Attributable errors](https://github.com/lightning/bolts/pull/1044) allow sending nodes to attribute time delays to nodes along the route, which opens the door to latency-sensitive routing algorithms that could route around these malicious sinks.  \n\\[5\\] It\u2019s again tempting to think about [monetary solutions](https://lists.linuxfoundation.org/pipermail/lightning-dev/2021-February/002958.html) here, but these will become prohibitively expensive for honest users to account for the worst-case hold time.  \n\\[6\\] While we assume the attacker can attract some traffic, we do not expect the consistent thundering herd of payments required for a fast jamming attack.   \n\\[7\\]  Previously our algorithm only accounted for the risk that an attacker A is targeting outgoing channel BC. By examining reputation in both directions, we can also account for the risk that an attacker B is targeting incoming channel AB.  \n\\[7\\] It\u2019s likely that nodes would not endorse by default anyway, because the upside of successful endorsed/unendorsed payments is the same and endorsed payments pose a risk to their reputation. By only endorsing on failure, sending nodes only take advantage of protected resources when they need to.  \n\\[8\\] We don\u2019t expect any, if anything it\u2019ll make these attacks harder as well, but will repeat for completeness. We wanted to get this post out before the summit, and ran out of time to repeat them\\!  \n\\[9\\] As is the case with all bitcoin problems, this has already been discussed on the [mailing list](https://lists.linuxfoundation.org/pipermail/lightning-dev/2018-May/001232.html) before our time, so we\u2019re particularly interested in hearing about any conversations that happened off-mailing-list back then\\!\n\n</details>",
  "actions_summary": [],
  "moderator": false,
  "admin": false,
  "staff": false,
  "user_id": 124,
  "hidden": false,
  "trust_level": 1,
  "deleted_at": null,
  "user_deleted": false,
  "edit_reason": "Github link was replaced with a permanent link",
  "can_view_edit_history": true,
  "wiki": false,
  "reactions": [],
  "current_user_reaction": null,
  "reaction_users_count": 0,
  "current_user_used_main_reaction": false
}