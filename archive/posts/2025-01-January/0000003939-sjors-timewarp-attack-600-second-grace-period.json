{
  "id": 3939,
  "name": "Sjors Provoost",
  "username": "sjors",
  "avatar_template": "/user_avatar/delvingbitcoin.org/sjors/{size}/59_2.png",
  "created_at": "2025-01-03T12:35:01.369Z",
  "cooked": "<aside class=\"quote no-group\" data-username=\"AntoineP\" data-post=\"16\" data-topic=\"1326\">\n<div class=\"title\">\n<div class=\"quote-controls\"></div>\n<img loading=\"lazy\" alt=\"\" width=\"24\" height=\"24\" src=\"https://delvingbitcoin.org/user_avatar/delvingbitcoin.org/antoinep/48/483_2.png\" class=\"avatar\"> AntoineP:</div>\n<blockquote>\n<p>It\u2019d make more sense for miners to artificially increase the block rate thereby bringing available block space up and, all other things equal, fee rates down. With the current concentration of mining we shouldn\u2019t underestimate the odds of it happening. We should not keep in place the incentive for them to pull it off by making the fix too loose.</p>\n</blockquote>\n</aside>\n<p>I don\u2019t think this is dangerous for the network for the numbers we\u2019re discussing, i.e. a 10% speedup after a sustained 51% attack for 59 difficulty periods. And why would a miner want to reduce their own fee revenue?</p>\n<aside class=\"quote no-group quote-modified\" data-username=\"AntoineP\" data-post=\"16\" data-topic=\"1326\">\n<div class=\"title\">\n<div class=\"quote-controls\"></div>\n<img loading=\"lazy\" alt=\"\" width=\"24\" height=\"24\" src=\"https://delvingbitcoin.org/user_avatar/delvingbitcoin.org/antoinep/48/483_2.png\" class=\"avatar\"> AntoineP:</div>\n<blockquote>\n<aside class=\"quote no-group\" data-username=\"sjors\" data-post=\"14\" data-topic=\"1326\">\n<div class=\"title\">\n<div class=\"quote-controls\"></div>\n<img loading=\"lazy\" alt=\"\" width=\"24\" height=\"24\" src=\"https://delvingbitcoin.org/user_avatar/delvingbitcoin.org/sjors/48/59_2.png\" class=\"avatar\"> sjors:</div>\n<blockquote>\n<p>Above I linked to two actual mining pool software bugs that caused invalid blocks on testnet4 because they were using the system clock instead of the block template <code>nTime</code>.</p>\n</blockquote>\n</aside>\n<p>Those softwares are already broken today due to the MTP rule. \u201cExisting broken software may produce invalid blocks under exceptional circumstances\u201d is not a valid argument for looser bounds if said software can already produce invalid blocks with current rules under exceptional circumstances!</p>\n</blockquote>\n</aside>\n<p>But no miner ran into that bug so far, because it takes significant hash rate to push MTP above wall clock time and perform this attack. With the timewarp rule, griefing a miner that uses wall clock time only requires finding the last block in a retarget period and setting its time (a bit more than) 600 seconds in the future. Both attacks are free, but the latter only requires luck, no large percentage of hash power.</p>\n<aside class=\"quote no-group quote-modified\" data-username=\"AntoineP\" data-post=\"16\" data-topic=\"1326\">\n<div class=\"title\">\n<div class=\"quote-controls\"></div>\n<img loading=\"lazy\" alt=\"\" width=\"24\" height=\"24\" src=\"https://delvingbitcoin.org/user_avatar/delvingbitcoin.org/antoinep/48/483_2.png\" class=\"avatar\"> AntoineP:</div>\n<blockquote>\n<aside class=\"quote no-group\" data-username=\"sjors\" data-post=\"14\" data-topic=\"1326\">\n<div class=\"title\">\n<div class=\"quote-controls\"></div>\n<img loading=\"lazy\" alt=\"\" width=\"24\" height=\"24\" src=\"https://delvingbitcoin.org/user_avatar/delvingbitcoin.org/sjors/48/59_2.png\" class=\"avatar\"> sjors:</div>\n<blockquote>\n<p>Bitcoin Core itself (briefly) had a bug where it could accidentally violate the timewarp rule.</p>\n</blockquote>\n</aside>\n<p>What is this bug?</p>\n</blockquote>\n</aside>\n<aside class=\"onebox githubpullrequest\" data-onebox-src=\"https://github.com/bitcoin/bitcoin/pull/30681\">\n  <header class=\"source\">\n\n      <a href=\"https://github.com/bitcoin/bitcoin/pull/30681\" target=\"_blank\" rel=\"noopener\">github.com/bitcoin/bitcoin</a>\n  </header>\n\n  <article class=\"onebox-body\">\n    <div class=\"github-row\" data-github-private-repo=\"false\">\n\n\n\n    <div class=\"github-icon-container\" title=\"Pull Request\">\n      <svg width=\"60\" height=\"60\" class=\"github-icon\" viewBox=\"0 0 12 16\" aria-hidden=\"true\"><path fill-rule=\"evenodd\" d=\"M11 11.28V5c-.03-.78-.34-1.47-.94-2.06C9.46 2.35 8.78 2.03 8 2H7V0L4 3l3 3V4h1c.27.02.48.11.69.31.21.2.3.42.31.69v6.28A1.993 1.993 0 0 0 10 15a1.993 1.993 0 0 0 1-3.72zm-1 2.92c-.66 0-1.2-.55-1.2-1.2 0-.65.55-1.2 1.2-1.2.65 0 1.2.55 1.2 1.2 0 .65-.55 1.2-1.2 1.2zM4 3c0-1.11-.89-2-2-2a1.993 1.993 0 0 0-1 3.72v6.56A1.993 1.993 0 0 0 2 15a1.993 1.993 0 0 0 1-3.72V4.72c.59-.34 1-.98 1-1.72zm-.8 10c0 .66-.55 1.2-1.2 1.2-.65 0-1.2-.55-1.2-1.2 0-.65.55-1.2 1.2-1.2.65 0 1.2.55 1.2 1.2zM2 4.2C1.34 4.2.8 3.65.8 3c0-.65.55-1.2 1.2-1.2.65 0 1.2.55 1.2 1.2 0 .65-.55 1.2-1.2 1.2z\"></path></svg>\n    </div>\n\n  <div class=\"github-info-container\">\n\n\n\n      <h4>\n        <a href=\"https://github.com/bitcoin/bitcoin/pull/30681\" target=\"_blank\" rel=\"noopener\">Have miner account for timewarp mitigation, activate on regtest, lower nPowTargetTimespan to 144 and add test</a>\n      </h4>\n\n    <div class=\"branches\">\n      <code>bitcoin:master</code> \u2190 <code>Sjors:2024/08/conervative-timewarp</code>\n    </div>\n\n      <div class=\"github-info\">\n        <div class=\"date\">\n          opened <span class=\"discourse-local-date\" data-format=\"ll\" data-date=\"2024-08-20\" data-time=\"08:47:12\" data-timezone=\"UTC\">08:47AM - 20 Aug 24 UTC</span>\n        </div>\n\n        <div class=\"user\">\n          <a href=\"https://github.com/Sjors\" target=\"_blank\" rel=\"noopener\">\n            <img alt=\"\" src=\"https://delvingbitcoin.org/uploads/default/original/1X/37e9679d22884392534900d6028f1cc537512e9b.png\" class=\"onebox-avatar-inline\" width=\"20\" height=\"20\" data-dominant-color=\"6C6963\">\n            Sjors\n          </a>\n        </div>\n\n        <div class=\"lines\" title=\"4 commits changed 8 files with 72 additions and 11 deletions\">\n          <a href=\"https://github.com/bitcoin/bitcoin/pull/30681/files\" target=\"_blank\" rel=\"noopener\">\n            <span class=\"added\">+72</span>\n            <span class=\"removed\">-11</span>\n          </a>\n        </div>\n      </div>\n  </div>\n</div>\n\n  <div class=\"github-row\">\n    <p class=\"github-body-container\">Because #30647 reduced the timewarp attack threshold from 7200s to 600s, our min<span class=\"show-more-container\"><a href=\"https://github.com/bitcoin/bitcoin/pull/30681\" target=\"_blank\" rel=\"noopener\" class=\"show-more\">\u2026</a></span><span class=\"excerpt hidden\">er code will fail to propose a block template (on testnet4) if the last block of the previous period has a timestamp two hours in the future. This PR fixes that and also adds a test.\n\nThe non-test changes in the last commit should be in v28, otherwise miners have to patch it themselves. If necessary I can split that out into a separate PR, but I prefer to get the tests in as well.\n\nIn order to add the test, we activate BIP94 on regtest.\n\nIn order for the test to run faster, we reduce its difficulty retarget period to 144, the same number that's already used for softfork activation logic. Regtest does not actually adjust its difficulty, so this change has no effect (except for `getnetworkhashps`, see commit).\n\nAn alternative approach would be to run this test on testnet4, by hardcoding its first 2015 in the test suite. But since the timewarp mitigation is a serious candidate for a future mainnet softfork, it seems better to just deploy it on regtest.\n\nThe next commits add a test and fix the miner code.\n\nThe `MAX_TIMEWARP` constant is moved to `consensus.h` so both validation and miner code have access to it.</span></p>\n  </div>\n\n  </article>\n\n  <div class=\"onebox-metadata\">\n    \n    \n  </div>\n\n  <div style=\"clear: both\"></div>\n</aside>\n\n<p>The main change adds this to miner.cpp:</p>\n<pre data-code-wrap=\"cpp\"><code class=\"lang-cpp\">if (consensusParams.enforce_BIP94) {\n        // Height of block to be mined.\n        const int height{pindexPrev-&gt;nHeight + 1};\n        if (height % consensusParams.DifficultyAdjustmentInterval() == 0) {\n            nNewTime = std::max&lt;int64_t&gt;(nNewTime, pindexPrev-&gt;GetBlockTime() - MAX_TIMEWARP);\n        }\n    }\n</code></pre>\n<p>The pull request description is focussed on a different scenario, but this (also) fixes the second griefing attack.</p>\n<aside class=\"quote no-group\" data-username=\"AntoineP\" data-post=\"16\" data-topic=\"1326\">\n<div class=\"title\">\n<div class=\"quote-controls\"></div>\n<img loading=\"lazy\" alt=\"\" width=\"24\" height=\"24\" src=\"https://delvingbitcoin.org/user_avatar/delvingbitcoin.org/antoinep/48/483_2.png\" class=\"avatar\"> AntoineP:</div>\n<blockquote>\n<p>Assuming you are still proposing to use 150 minutes instead, could you provide an argument for why this value would possibly better accommodate broken software we do not know about?</p>\n</blockquote>\n</aside>\n<p>Yes, 150 minutes makes the above griefing attack on broken miner software impossible, because the attacker can\u2019t put their timestamp more than 120 minutes in the future.</p>\n<aside class=\"quote no-group quote-modified\" data-username=\"AntoineP\" data-post=\"16\" data-topic=\"1326\">\n<div class=\"title\">\n<div class=\"quote-controls\"></div>\n<img loading=\"lazy\" alt=\"\" width=\"24\" height=\"24\" src=\"https://delvingbitcoin.org/user_avatar/delvingbitcoin.org/antoinep/48/483_2.png\" class=\"avatar\"> AntoineP:</div>\n<blockquote>\n<aside class=\"quote no-group\" data-username=\"sjors\" data-post=\"14\" data-topic=\"1326\">\n<div class=\"title\">\n<div class=\"quote-controls\"></div>\n<img loading=\"lazy\" alt=\"\" width=\"24\" height=\"24\" src=\"https://delvingbitcoin.org/user_avatar/delvingbitcoin.org/sjors/48/59_2.png\" class=\"avatar\"> sjors:</div>\n<blockquote>\n<p>The timewarp fix with a 600 second limit deviates from that because it requires miners to also check their entire stack of mining software. Whereas a 150 minute threshold only requires them to upgrade their node.</p>\n</blockquote>\n</aside>\n<p>How so? Could you be more specific? I don\u2019t think we\u2019ve established that.</p>\n</blockquote>\n</aside>\n<p>Hopefully the above example illustrates this? With a 150 minute threshold there\u2019s no (additional) danger in having a bug in mining software that ignores the <code>nTime</code> value provided in the Bicoin Core template.  They might ignore it by accident like SRI <a href=\"https://github.com/stratum-mining/stratum/issues/1324\" class=\"inline-onebox\">Pool and JDC update `nTime` field with current timestamp - they should use the one sent by TP \u00b7 Issue #1324 \u00b7 stratum-mining/stratum \u00b7 GitHub</a>, or they might have custom code that calculates <code>nTime</code> correctly under the current rules (but not accounting for the new timewarp rule).</p>",
  "post_number": 18,
  "post_type": 1,
  "posts_count": 43,
  "updated_at": "2025-01-03T12:41:43.617Z",
  "reply_count": 2,
  "reply_to_post_number": null,
  "quote_count": 2,
  "incoming_link_count": 1,
  "reads": 35,
  "readers_count": 34,
  "score": 22.0,
  "yours": false,
  "topic_id": 1326,
  "topic_slug": "timewarp-attack-600-second-grace-period",
  "topic_title": "Timewarp attack 600 second grace period",
  "topic_html_title": "Timewarp attack 600 second grace period",
  "category_id": 7,
  "display_username": "Sjors Provoost",
  "primary_group_name": null,
  "flair_name": null,
  "flair_url": null,
  "flair_bg_color": null,
  "flair_color": null,
  "flair_group_id": null,
  "badges_granted": [],
  "version": 2,
  "can_edit": false,
  "can_delete": false,
  "can_recover": false,
  "can_see_hidden_post": false,
  "can_wiki": false,
  "user_title": null,
  "bookmarked": false,
  "raw": "[quote=\"AntoineP, post:16, topic:1326\"]\nIt\u2019d make more sense for miners to artificially increase the block rate thereby bringing available block space up and, all other things equal, fee rates down. With the current concentration of mining we shouldn\u2019t underestimate the odds of it happening. We should not keep in place the incentive for them to pull it off by making the fix too loose.\n[/quote]\n\nI don't think this is dangerous for the network for the numbers we're discussing, i.e. a 10% speedup after a sustained 51% attack for 59 difficulty periods. And why would a miner want to reduce their own fee revenue?\n\n[quote=\"AntoineP, post:16, topic:1326\"]\n[quote=\"sjors, post:14, topic:1326\"]\nAbove I linked to two actual mining pool software bugs that caused invalid blocks on testnet4 because they were using the system clock instead of the block template `nTime`.\n[/quote]\n\nThose softwares are already broken today due to the MTP rule. \u201cExisting broken software may produce invalid blocks under exceptional circumstances\u201d is not a valid argument for looser bounds if said software can already produce invalid blocks with current rules under exceptional circumstances!\n[/quote]\n\nBut no miner ran into that bug so far, because it takes significant hash rate to push MTP above wall clock time and perform this attack. With the timewarp rule, griefing a miner that uses wall clock time only requires finding the last block in a retarget period and setting its time (a bit more than) 600 seconds in the future. Both attacks are free, but the latter only requires luck, no large percentage of hash power. \n\n[quote=\"AntoineP, post:16, topic:1326\"]\n[quote=\"sjors, post:14, topic:1326\"]\nBitcoin Core itself (briefly) had a bug where it could accidentally violate the timewarp rule.\n[/quote]\n\nWhat is this bug?\n[/quote]\n\nhttps://github.com/bitcoin/bitcoin/pull/30681\n\nThe main change adds this to miner.cpp:\n\n```cpp\nif (consensusParams.enforce_BIP94) {\n        // Height of block to be mined.\n        const int height{pindexPrev->nHeight + 1};\n        if (height % consensusParams.DifficultyAdjustmentInterval() == 0) {\n            nNewTime = std::max<int64_t>(nNewTime, pindexPrev->GetBlockTime() - MAX_TIMEWARP);\n        }\n    }\n```\n\nThe pull request description is focussed on a different scenario, but this (also) fixes the second griefing attack.\n\n[quote=\"AntoineP, post:16, topic:1326\"]\nAssuming you are still proposing to use 150 minutes instead, could you provide an argument for why this value would possibly better accommodate broken software we do not know about?\n[/quote]\n\nYes, 150 minutes makes the above griefing attack on broken miner software impossible, because the attacker can't put their timestamp more than 120 minutes in the future.\n\n[quote=\"AntoineP, post:16, topic:1326\"]\n[quote=\"sjors, post:14, topic:1326\"]\nThe timewarp fix with a 600 second limit deviates from that because it requires miners to also check their entire stack of mining software. Whereas a 150 minute threshold only requires them to upgrade their node.\n[/quote]\n\nHow so? Could you be more specific? I don\u2019t think we\u2019ve established that.\n[/quote]\n\nHopefully the above example illustrates this? With a 150 minute threshold there's no (additional) danger in having a bug in mining software that ignores the `nTime` value provided in the Bicoin Core template.  They might ignore it by accident like SRI https://github.com/stratum-mining/stratum/issues/1324, or they might have custom code that calculates `nTime` correctly under the current rules (but not accounting for the new timewarp rule).",
  "actions_summary": [],
  "moderator": false,
  "admin": false,
  "staff": false,
  "user_id": 71,
  "hidden": false,
  "trust_level": 3,
  "deleted_at": null,
  "user_deleted": false,
  "edit_reason": null,
  "can_view_edit_history": true,
  "wiki": false,
  "excerpt": "I don\u2019t think this is dangerous for the network for the numbers we\u2019re discussing, i.e. a 10% speedup after a sustained 51% attack for 59 difficulty periods. And why would a miner want to reduce their own fee revenue? \n\nThose softwares are already broken today due to the MTP rule. \u201cExisting broken s&hellip;",
  "truncated": true,
  "post_url": "/t/timewarp-attack-600-second-grace-period/1326/18",
  "reactions": [],
  "current_user_reaction": null,
  "reaction_users_count": 0,
  "current_user_used_main_reaction": false,
  "can_accept_answer": false,
  "can_unaccept_answer": false,
  "accepted_answer": false,
  "topic_accepted_answer": null
}