{
  "id": 3552,
  "name": "Rene Pickhardt",
  "username": "renepickhardt",
  "avatar_template": "/user_avatar/delvingbitcoin.org/renepickhardt/{size}/7_2.png",
  "created_at": "2024-11-17T11:12:50.266Z",
  "cooked": "<aside class=\"quote no-group\" data-username=\"ajtowns\" data-post=\"2\" data-topic=\"1259\">\n<div class=\"title\">\n<div class=\"quote-controls\"></div>\n<img loading=\"lazy\" alt=\"\" width=\"24\" height=\"24\" src=\"https://delvingbitcoin.org/user_avatar/delvingbitcoin.org/ajtowns/48/417_2.png\" class=\"avatar\"> ajtowns:</div>\n<blockquote>\n<p>For a given initial network state, is the resulting spanning tree reproducible/predictable?</p>\n</blockquote>\n</aside>\n<p>I am not sure I understand your question correctly. My post said we can for a fixed wealth distribution predict the location of the spanning tree by solving the integer linear program. So I guess the answer is: Yes, if we knew the wealth distribution of coins on the network.</p>\n<aside class=\"quote no-group\" data-username=\"ajtowns\" data-post=\"2\" data-topic=\"1259\">\n<div class=\"title\">\n<div class=\"quote-controls\"></div>\n<img loading=\"lazy\" alt=\"\" width=\"24\" height=\"24\" src=\"https://delvingbitcoin.org/user_avatar/delvingbitcoin.org/ajtowns/48/417_2.png\" class=\"avatar\"> ajtowns:</div>\n<blockquote>\n<p>Are there circumstances where the spanning tree change after being established, solely due to payments being made, without opening/closing channels (or changing fee rates)?</p>\n</blockquote>\n</aside>\n<p>That I am not too sure about and I also listed it as an open question in my OP. Thus the following is mainly a summary of observations and conjectures:</p>\n<p>Of course the initial wealth distribution has an impact to which channels deplete. For example, if I send away all my funds, then consequently all my channels will be depleted. But as that is an extreme state I would guess with fixed topology / fees the location of the spanning tree should be somewhat stable if arbitrary wealth distributions are being picked to test for this.</p>\n<p>Actually I tried to adopt my code to track the location of the spanning tree while the wealth distribution changes (e.g. payments are being conducted). So far my impression is that the location is less stable than I would expect. E.g. Channels which are often not depleted are still depleted in about 50% of all tested wealth distributions. (Other channels are depleted much more frequently)</p>\n<p>Somehow this makes sense as in my original simulation the network was never in the optimal fee potential state but only close to it and a payment changed the wealth distribution.</p>\n<p>My problem: I haven\u2019t found a good statistical measure / visualization for that yet. I will need more time to come back to that question.</p>\n<aside class=\"quote no-group\" data-username=\"ajtowns\" data-post=\"2\" data-topic=\"1259\">\n<div class=\"title\">\n<div class=\"quote-controls\"></div>\n<img loading=\"lazy\" alt=\"\" width=\"24\" height=\"24\" src=\"https://delvingbitcoin.org/user_avatar/delvingbitcoin.org/ajtowns/48/417_2.png\" class=\"avatar\"> ajtowns:</div>\n<blockquote>\n<p>This seems to me like a bit like you\u2019ve designed a network with an implicit \u201cmost expensive\u201d spanning tree, and that the simulation simply exhausts all the cheaper paths until that\u2019s what\u2019s left?</p>\n</blockquote>\n</aside>\n<p>No, I don\u00b4t think that is an accurate summary / description of what I tried to present.</p>\n<p>Just to be clear I haven\u2019t designed a network. I just tried to find a way to explain the emergent phenomena of channel depletion that most people observe and report about.</p>\n<p>Once I understood that the existence of different cost cycles are the reason I found it quite simple to explain:</p>\n<ol>\n<li>Imagine the network topology was actually a spanning tree to begin with. If Alice wants to pay x sats to Bob and then Bob wants to return those x sats to Alice the network would be back in the initial state (<a href=\"https://github.com/renepickhardt/Lightning-Network-Limitations/blob/305db330c96dc751f0615d9abb096b12b8a6191f/Limits%20of%20two%20party%20channels/paper/a%20mathematical%20theory%20of%20payment%20channel%20networks.pdf\" rel=\"noopener nofollow ugc\">as every wealth distribution corresponds to exactly one liquidity state in a spanning tree</a>)</li>\n<li>Now, if on the other hand the network had cycles and the fees on the edges vary it is very likely that the flow of x sats from Alice to Bob goes along a different route than the return payment. (E.g. in the example below Bob would pay Alice via Carol)</li>\n<li>Thus, the payment back and forth would actually flows along a cycle and contribute to deplete that cycle.</li>\n<li>In particular depletion takes place even if we don\u2019t have source and sink nodes.</li>\n</ol>\n<p>Take a look at the following extreme example:</p>\n<p><div class=\"lightbox-wrapper\"><a class=\"lightbox\" href=\"https://delvingbitcoin.org/uploads/default/original/1X/acc89de7651340ebb89c9314bd4c3803626e18cc.jpeg\" data-download-href=\"https://delvingbitcoin.org/uploads/default/acc89de7651340ebb89c9314bd4c3803626e18cc\" title=\"image\"><img src=\"https://delvingbitcoin.org/uploads/default/optimized/1X/acc89de7651340ebb89c9314bd4c3803626e18cc_2_579x500.jpeg\" alt=\"image\" data-base62-sha1=\"oEvWyu0QfKSxL1H7Br2QWQZkS3a\" width=\"579\" height=\"500\" srcset=\"https://delvingbitcoin.org/uploads/default/optimized/1X/acc89de7651340ebb89c9314bd4c3803626e18cc_2_579x500.jpeg, https://delvingbitcoin.org/uploads/default/optimized/1X/acc89de7651340ebb89c9314bd4c3803626e18cc_2_868x750.jpeg 1.5x, https://delvingbitcoin.org/uploads/default/optimized/1X/acc89de7651340ebb89c9314bd4c3803626e18cc_2_1158x1000.jpeg 2x\" data-dominant-color=\"F4F4F4\"><div class=\"meta\"><svg class=\"fa d-icon d-icon-far-image svg-icon\" aria-hidden=\"true\"><use href=\"#far-image\"></use></svg><span class=\"filename\">image</span><span class=\"informations\">1270\u00d71096 141 KB</span><svg class=\"fa d-icon d-icon-discourse-expand svg-icon\" aria-hidden=\"true\"><use href=\"#discourse-expand\"></use></svg></div></a></div></p>\n<p>Assume initially in the network every node has half of the capacity on their side and now nodes randomly send each other one sat.</p>\n<p>The network will converge to the following state:</p>\n<p><div class=\"lightbox-wrapper\"><a class=\"lightbox\" href=\"https://delvingbitcoin.org/uploads/default/original/1X/e8d4177991e7783895d6fc1669260d88421cea47.jpeg\" data-download-href=\"https://delvingbitcoin.org/uploads/default/e8d4177991e7783895d6fc1669260d88421cea47\" title=\"image\"><img src=\"https://delvingbitcoin.org/uploads/default/optimized/1X/e8d4177991e7783895d6fc1669260d88421cea47_2_579x500.jpeg\" alt=\"image\" data-base62-sha1=\"xdHb0mkXCQNySEP5FGBj5CG1LJd\" width=\"579\" height=\"500\" srcset=\"https://delvingbitcoin.org/uploads/default/optimized/1X/e8d4177991e7783895d6fc1669260d88421cea47_2_579x500.jpeg, https://delvingbitcoin.org/uploads/default/optimized/1X/e8d4177991e7783895d6fc1669260d88421cea47_2_868x750.jpeg 1.5x, https://delvingbitcoin.org/uploads/default/optimized/1X/e8d4177991e7783895d6fc1669260d88421cea47_2_1158x1000.jpeg 2x\" data-dominant-color=\"F8F6FA\"><div class=\"meta\"><svg class=\"fa d-icon d-icon-far-image svg-icon\" aria-hidden=\"true\"><use href=\"#far-image\"></use></svg><span class=\"filename\">image</span><span class=\"informations\">1270\u00d71096 175 KB</span><svg class=\"fa d-icon d-icon-discourse-expand svg-icon\" aria-hidden=\"true\"><use href=\"#discourse-expand\"></use></svg></div></a></div></p>\n<p>This is very interesting for several reasons:</p>\n<ol>\n<li>All channels deplete (while all nodes keep roughly the same amount of total coins)</li>\n<li>The red channels are those where the liquidity is on the cheaper end of the channel (contradicting your intuition that I have just created a \u201cmost expensive\u201d spanning tree.</li>\n<li>In fact, it is the global topology (including fees) and actual payment flows that defines which channels deplete (on which end)</li>\n</ol>\n<p>For completeness I will also post the time series of how the liquidity shifts in those channels while 1 sat payments are randomly conducted between the peers:</p>\n<p><div class=\"lightbox-wrapper\"><a class=\"lightbox\" href=\"https://delvingbitcoin.org/uploads/default/original/1X/e296612778e892160941f694a1c2ab2881d6ddde.png\" data-download-href=\"https://delvingbitcoin.org/uploads/default/e296612778e892160941f694a1c2ab2881d6ddde\" title=\"Screenshot from 2024-11-16 22-29-07\"><img src=\"https://delvingbitcoin.org/uploads/default/optimized/1X/e296612778e892160941f694a1c2ab2881d6ddde_2_690x453.png\" alt=\"Screenshot from 2024-11-16 22-29-07\" data-base62-sha1=\"wku5SV6EsqNeuNY5vrbHKKcceoS\" width=\"690\" height=\"453\" srcset=\"https://delvingbitcoin.org/uploads/default/optimized/1X/e296612778e892160941f694a1c2ab2881d6ddde_2_690x453.png, https://delvingbitcoin.org/uploads/default/optimized/1X/e296612778e892160941f694a1c2ab2881d6ddde_2_1035x679.png 1.5x, https://delvingbitcoin.org/uploads/default/optimized/1X/e296612778e892160941f694a1c2ab2881d6ddde_2_1380x906.png 2x\" data-dominant-color=\"F6F7F9\"><div class=\"meta\"><svg class=\"fa d-icon d-icon-far-image svg-icon\" aria-hidden=\"true\"><use href=\"#far-image\"></use></svg><span class=\"filename\">Screenshot from 2024-11-16 22-29-07</span><span class=\"informations\">1411\u00d7927 136 KB</span><svg class=\"fa d-icon d-icon-discourse-expand svg-icon\" aria-hidden=\"true\"><use href=\"#discourse-expand\"></use></svg></div></a></div></p>\n<p>Again it is interesting to note that it is not the cheapest <code>0 ppm</code> channel that depletes first. (Makes sense at it also has twice the liquidity) but in this particular case it depletes at the same time as the other channels.</p>\n<aside class=\"quote no-group\" data-username=\"ajtowns\" data-post=\"2\" data-topic=\"1259\">\n<div class=\"title\">\n<div class=\"quote-controls\"></div>\n<img loading=\"lazy\" alt=\"\" width=\"24\" height=\"24\" src=\"https://delvingbitcoin.org/user_avatar/delvingbitcoin.org/ajtowns/48/417_2.png\" class=\"avatar\"> ajtowns:</div>\n<blockquote>\n<p>Are some nodes themselves running out of lightning funds?</p>\n</blockquote>\n</aside>\n<p>As just laid out, in the above example nodes have not run out of funds. I will add the zoomed in view depeicting how the wealth of each node progresses over time while the 1 sat payments deplete the channels:</p>\n<p><div class=\"lightbox-wrapper\"><a class=\"lightbox\" href=\"https://delvingbitcoin.org/uploads/default/original/1X/9009c699d4fafe06e546173c87ba106e61786271.png\" data-download-href=\"https://delvingbitcoin.org/uploads/default/9009c699d4fafe06e546173c87ba106e61786271\" title=\"image\"><img src=\"https://delvingbitcoin.org/uploads/default/optimized/1X/9009c699d4fafe06e546173c87ba106e61786271_2_690x363.png\" alt=\"image\" data-base62-sha1=\"kydHpPebgiYG19O7OqDJuvTGk7L\" width=\"690\" height=\"363\" srcset=\"https://delvingbitcoin.org/uploads/default/optimized/1X/9009c699d4fafe06e546173c87ba106e61786271_2_690x363.png, https://delvingbitcoin.org/uploads/default/optimized/1X/9009c699d4fafe06e546173c87ba106e61786271_2_1035x544.png 1.5x, https://delvingbitcoin.org/uploads/default/optimized/1X/9009c699d4fafe06e546173c87ba106e61786271_2_1380x726.png 2x\" data-dominant-color=\"F2F6F9\"><div class=\"meta\"><svg class=\"fa d-icon d-icon-far-image svg-icon\" aria-hidden=\"true\"><use href=\"#far-image\"></use></svg><span class=\"filename\">image</span><span class=\"informations\">1397\u00d7736 146 KB</span><svg class=\"fa d-icon d-icon-discourse-expand svg-icon\" aria-hidden=\"true\"><use href=\"#discourse-expand\"></use></svg></div></a></div></p>\n<p>Note if you zoomed the y-axis to <code>[0,1]</code> then you would visually just see streight horizontal lines.</p>\n<p>Maybe I should have explicitely made the conclusion in my OP that:</p>\n<ul>\n<li>Channels deplete even if the netflow of all nodes is 0. No Source and Sink nodes are needed. Which I find quite remarkable and seems to be routed in the existance of cycles with varying costs.</li>\n</ul>\n<aside class=\"quote no-group\" data-username=\"ajtowns\" data-post=\"2\" data-topic=\"1259\">\n<div class=\"title\">\n<div class=\"quote-controls\"></div>\n<img loading=\"lazy\" alt=\"\" width=\"24\" height=\"24\" src=\"https://delvingbitcoin.org/user_avatar/delvingbitcoin.org/ajtowns/48/417_2.png\" class=\"avatar\"> ajtowns:</div>\n<blockquote>\n<p>You could perhaps modify your simulation to address that, eg \u201cI\u2019m receiving $10000 a month, some by lightning, some by fiat rails; I\u2019m likewise spending $9000 a month; if my lightning balance is $50000 or more, I\u2019ll try to send all my payments via lightning; if it\u2019s $25000, I\u2019ll only try to send half my payments via lighting\u201d.</p>\n<p>If lightning is always your first choice when sending payments, then hitting a balance of $0 will mean as soon as you receive $50, you\u2019ll send it right back out, so will stay depleted, which isn\u2019t a good strategy if you want to get any value out of participating in lightning. The above might be a simple way of modelling a better one?</p>\n</blockquote>\n</aside>\n<p>I am not sure about your proposed simulation. Of course I see the point that in reality people may chose between various payment rails and also onchain and ofchain payments and act acording to their liquidity requirements. But even in that world the LN graph is a somewhat closed system (with potentially less demand as some is taking place via other payment rails). In any case as laid out the phenomenon of channels to deplete seems to emerge because of various fees and the existence of cycles even if the netflow of all nodes in the network is 0.</p>\n<p>Instead of focusing on such a mixed model wouldn\u2019t it be more interesting to focus on how node operators should adjust their fees to help with flow control and adjust to channel depletion? Also Sending nodes could eventually adopt their route selection to use that knowledge to more quickly deliver payments.</p>\n<aside class=\"quote no-group\" data-username=\"ajtowns\" data-post=\"2\" data-topic=\"1259\">\n<div class=\"title\">\n<div class=\"quote-controls\"></div>\n<img loading=\"lazy\" alt=\"\" width=\"24\" height=\"24\" src=\"https://delvingbitcoin.org/user_avatar/delvingbitcoin.org/ajtowns/48/417_2.png\" class=\"avatar\"> ajtowns:</div>\n<blockquote>\n<p>Having the network spontaneously resolve itself to an acyclic spanning tree seems similar to things like <a href=\"https://www.nature.com/articles/35035159\" rel=\"noopener nofollow ugc\">amoeba maze solving</a> or electricity finding the path of least resistance to me.</p>\n</blockquote>\n</aside>\n<p>Yes, the math that I use here to model and understand the emerging phenomena of the LN is also used to model electrical grids and other fluid networks. Intuitively it makes sense that it is also applicable in the amoeba maze solving (which I wasn\u2019t aware of so far).</p>",
  "post_number": 3,
  "post_type": 1,
  "updated_at": "2024-11-17T11:17:52.428Z",
  "reply_count": 1,
  "reply_to_post_number": 2,
  "quote_count": 1,
  "incoming_link_count": 55,
  "reads": 11,
  "readers_count": 10,
  "score": 282.0,
  "yours": false,
  "topic_id": 1259,
  "topic_slug": "channel-depletion-ln-topology-cycles-and-rational-behavior-of-nodes",
  "topic_title": "Channel depletion, LN Topology, Cycles and rational behavior of nodes",
  "topic_html_title": "Channel depletion, LN Topology, Cycles and rational behavior of nodes",
  "category_id": 7,
  "display_username": "Rene Pickhardt",
  "primary_group_name": null,
  "flair_name": null,
  "flair_url": null,
  "flair_bg_color": null,
  "flair_color": null,
  "flair_group_id": null,
  "version": 2,
  "can_edit": false,
  "can_delete": false,
  "can_recover": false,
  "can_see_hidden_post": false,
  "can_wiki": false,
  "user_title": null,
  "bookmarked": false,
  "raw": "[quote=\"ajtowns, post:2, topic:1259, full:false\"]\nFor a given initial network state, is the resulting spanning tree reproducible/predictable? \n[/quote]\n\nI am not sure I understand your question correctly. My post said we can for a fixed wealth distribution predict the location of the spanning tree by solving the integer linear program. So I guess the answer is: Yes, if we knew the wealth distribution of coins on the network.\n\n[quote=\"ajtowns, post:2, topic:1259, full:false\"]\nAre there circumstances where the spanning tree change after being established, solely due to payments being made, without opening/closing channels (or changing fee rates)?\n[/quote]\n\nThat I am not too sure about and I also listed it as an open question in my OP. Thus the following is mainly a summary of observations and conjectures: \n\nOf course the initial wealth distribution has an impact to which channels deplete. For example, if I send away all my funds, then consequently all my channels will be depleted. But as that is an extreme state I would guess with fixed topology / fees the location of the spanning tree should be somewhat stable if arbitrary wealth distributions are being picked to test for this.\n\nActually I tried to adopt my code to track the location of the spanning tree while the wealth distribution changes (e.g. payments are being conducted). So far my impression is that the location is less stable than I would expect. E.g. Channels which are often not depleted are still depleted in about 50% of all tested wealth distributions. (Other channels are depleted much more frequently)\n\nSomehow this makes sense as in my original simulation the network was never in the optimal fee potential state but only close to it and a payment changed the wealth distribution.\n\nMy problem: I haven't found a good statistical measure / visualization for that yet. I will need more time to come back to that question.\n\n[quote=\"ajtowns, post:2, topic:1259, full:false\"]\nThis seems to me like a bit like you\u2019ve designed a network with an implicit \u201cmost expensive\u201d spanning tree, and that the simulation simply exhausts all the cheaper paths until that\u2019s what\u2019s left?\n[/quote]\n\nNo, I don\u00b4t think that is an accurate summary / description of what I tried to present.\n\nJust to be clear I haven't designed a network. I just tried to find a way to explain the emergent phenomena of channel depletion that most people observe and report about. \n\nOnce I understood that the existence of different cost cycles are the reason I found it quite simple to explain: \n\n1. Imagine the network topology was actually a spanning tree to begin with. If Alice wants to pay x sats to Bob and then Bob wants to return those x sats to Alice the network would be back in the initial state ([as every wealth distribution corresponds to exactly one liquidity state in a spanning tree](https://github.com/renepickhardt/Lightning-Network-Limitations/blob/305db330c96dc751f0615d9abb096b12b8a6191f/Limits%20of%20two%20party%20channels/paper/a%20mathematical%20theory%20of%20payment%20channel%20networks.pdf)) \n2. Now, if on the other hand the network had cycles and the fees on the edges vary it is very likely that the flow of x sats from Alice to Bob goes along a different route than the return payment. (E.g. in the example below Bob would pay Alice via Carol)\n3. Thus, the payment back and forth would actually flows along a cycle and contribute to deplete that cycle. \n4. In particular depletion takes place even if we don't have source and sink nodes. \n\nTake a look at the following extreme example: \n \n![image|579x500](upload://oEvWyu0QfKSxL1H7Br2QWQZkS3a.jpeg)\n\nAssume initially in the network every node has half of the capacity on their side and now nodes randomly send each other one sat. \n\nThe network will converge to the following state:\n\n![image|579x500](upload://xdHb0mkXCQNySEP5FGBj5CG1LJd.jpeg)\n\nThis is very interesting for several reasons: \n\n1. All channels deplete (while all nodes keep roughly the same amount of total coins)\n2. The red channels are those where the liquidity is on the cheaper end of the channel (contradicting your intuition that I have just created a \"most expensive\" spanning tree. \n3. In fact, it is the global topology (including fees) and actual payment flows that defines which channels deplete (on which end)\n\nFor completeness I will also post the time series of how the liquidity shifts in those channels while 1 sat payments are randomly conducted between the peers: \n\n![Screenshot from 2024-11-16 22-29-07|690x453](upload://wku5SV6EsqNeuNY5vrbHKKcceoS.png)\n\nAgain it is interesting to note that it is not the cheapest `0 ppm` channel that depletes first. (Makes sense at it also has twice the liquidity) but in this particular case it depletes at the same time as the other channels. \n\n[quote=\"ajtowns, post:2, topic:1259, full:false\"]\nAre some nodes themselves running out of lightning funds? \n[/quote]\n\nAs just laid out, in the above example nodes have not run out of funds. I will add the zoomed in view depeicting how the wealth of each node progresses over time while the 1 sat payments deplete the channels: \n\n![image|690x363](upload://kydHpPebgiYG19O7OqDJuvTGk7L.png)\n\nNote if you zoomed the y-axis to `[0,1]` then you would visually just see streight horizontal lines.\n\nMaybe I should have explicitely made the conclusion in my OP that:\n\n* Channels deplete even if the netflow of all nodes is 0. No Source and Sink nodes are needed. Which I find quite remarkable and seems to be routed in the existance of cycles with varying costs.\n\n[quote=\"ajtowns, post:2, topic:1259, full:false\"]\n\nYou could perhaps modify your simulation to address that, eg \u201cI\u2019m receiving $10000 a month, some by lightning, some by fiat rails; I\u2019m likewise spending $9000 a month; if my lightning balance is $50000 or more, I\u2019ll try to send all my payments via lightning; if it\u2019s $25000, I\u2019ll only try to send half my payments via lighting\u201d.\n\nIf lightning is always your first choice when sending payments, then hitting a balance of $0 will mean as soon as you receive $50, you\u2019ll send it right back out, so will stay depleted, which isn\u2019t a good strategy if you want to get any value out of participating in lightning. The above might be a simple way of modelling a better one?\n[/quote]\n\nI am not sure about your proposed simulation. Of course I see the point that in reality people may chose between various payment rails and also onchain and ofchain payments and act acording to their liquidity requirements. But even in that world the LN graph is a somewhat closed system (with potentially less demand as some is taking place via other payment rails). In any case as laid out the phenomenon of channels to deplete seems to emerge because of various fees and the existence of cycles even if the netflow of all nodes in the network is 0. \n\nInstead of focusing on such a mixed model wouldn't it be more interesting to focus on how node operators should adjust their fees to help with flow control and adjust to channel depletion? Also Sending nodes could eventually adopt their route selection to use that knowledge to more quickly deliver payments. \n\n[quote=\"ajtowns, post:2, topic:1259, full:false\"]\nHaving the network spontaneously resolve itself to an acyclic spanning tree seems similar to things like [amoeba maze solving](https://www.nature.com/articles/35035159) or electricity finding the path of least resistance to me.\n[/quote]\nYes, the math that I use here to model and understand the emerging phenomena of the LN is also used to model electrical grids and other fluid networks. Intuitively it makes sense that it is also applicable in the amoeba maze solving (which I wasn't aware of so far).",
  "actions_summary": [],
  "moderator": false,
  "admin": false,
  "staff": false,
  "user_id": 8,
  "hidden": false,
  "trust_level": 2,
  "deleted_at": null,
  "user_deleted": false,
  "edit_reason": "Github link was replaced with a permanent link",
  "can_view_edit_history": true,
  "wiki": false,
  "reactions": [],
  "current_user_reaction": null,
  "reaction_users_count": 0,
  "current_user_used_main_reaction": false
}