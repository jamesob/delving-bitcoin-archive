{
  "id": 3525,
  "name": "Rene Pickhardt",
  "username": "renepickhardt",
  "avatar_template": "/user_avatar/delvingbitcoin.org/renepickhardt/{size}/7_2.png",
  "created_at": "2024-11-15T12:22:14.839Z",
  "cooked": "<p>Dear fellow Lightning developers,</p>\n<p>at this time I believe I have rather strong evidence to explain how economic rational behavior and network topology lead to the high rate of channel depletion that we observe on the network.</p>\n<p>Thus, I would like to share some follow up results of the <a href=\"https://github.com/renepickhardt/Lightning-Network-Limitations/blob/305db330c96dc751f0615d9abb096b12b8a6191f/Limits%20of%20two%20party%20channels/paper/a%20mathematical%20theory%20of%20payment%20channel%20networks.pdf\" rel=\"noopener nofollow ugc\">mathematical theory of payment channel networks</a> with you. Before extending the linked document I thought I collect feedback from you about two notebooks / results (<a href=\"https://github.com/renepickhardt/Lightning-Network-Limitations/blob/702a0b669a0c3329701adef38657782b9ff95a94/Limits%20of%20two%20party%20channels/Estimating%20Liquidity%20State%20given%20Fees%20and%20Network%20Topologies.ipynb\" rel=\"noopener nofollow ugc\">notebook1</a> and <a href=\"https://github.com/renepickhardt/Lightning-Network-Limitations/blob/702a0b669a0c3329701adef38657782b9ff95a94/Limits%20of%20two%20party%20channels/Selfish%20Sending%20yields%20Almost%20solution%20to%20Global%20Fee%20Potential%20Optimization.ipynb\" rel=\"noopener nofollow ugc\">notebook2</a>) that I have been developing after your valuable thoughts and feedback in Tokyo.</p>\n<p>In the afore mentioned paper I already provided a proof for the intuitive observation that cycles on the channel graph produce several liquidity states with the same wealth distribution (as a cycle usually allows for circular off-chain rebalancing, which - when neglecting routing fees - does not change the wealth distribution. Similarly <a href=\"https://github.com/gr-g/ln-steady-state-model/issues/1\" rel=\"noopener nofollow ugc\">it was shown with a markov model that the steady state of the LN is a spanning tree while all other channels should be depleted</a>. I am able to come to the same conclusion but with a different approach:</p>\n<h2><a name=\"p-3525-fee-potential-of-the-network-1\" class=\"anchor\" href=\"#p-3525-fee-potential-of-the-network-1\"></a>Fee Potential of the Network</h2>\n<p>(The motivation why to study the fee potential will follow in the next section)</p>\n<p>Neglecting the base fee we can define the fee potential of a node as:</p>\n<p><span class=\"math\">\\phi_v = \\sum_{e\\in E: v\\in E}\\left(\\lambda(v,e)\\cdot ppm(v,e)\\right)</span></p>\n<p>This is just the sum of a node\u2019s outgoing liquidity in all their channels multiplied with the ppm the node can expect to earn when routing the liquidity on the channel. <a href=\"https://github.com/DerEwige/speedupln.com/blob/9ff62b1af79ee601016187f6967498e4f0c45def/docs/fee_potential_and_rebalancing.md\" rel=\"noopener nofollow ugc\">This is motivated by note operators who seem to maximize their fee potential</a>.</p>\n<p>In a similar fashion the fee potential for the entire network can be defined as:</p>\n<p><span class=\"math\">\\phi = \\sum_{v\\in V}\\phi_v</span></p>\n<p>Using <a href=\"https://github.com/renepickhardt/Lightning-Network-Limitations/pull/2\" rel=\"noopener nofollow ugc\">integer linear programming when finding a feasible liquidity state for a given wealth distribution</a> one could at the same time find a feasible liquidity state that maximizes <span class=\"math\">\\phi</span> (or more conveniently minimize <span class=\"math\">-\\phi</span>). I have done this in <a href=\"https://github.com/renepickhardt/Lightning-Network-Limitations/blob/702a0b669a0c3329701adef38657782b9ff95a94/Limits%20of%20two%20party%20channels/Estimating%20Liquidity%20State%20given%20Fees%20and%20Network%20Topologies.ipynb\" rel=\"noopener nofollow ugc\">this notebook</a> and made a rather interesting observation:</p>\n<p><div class=\"lightbox-wrapper\"><a class=\"lightbox\" href=\"https://delvingbitcoin.org/uploads/default/original/1X/0c479074381ad1d4ccee231a0fdf0d31cc470bba.png\" data-download-href=\"https://delvingbitcoin.org/uploads/default/0c479074381ad1d4ccee231a0fdf0d31cc470bba\" title=\"image\"><img src=\"https://delvingbitcoin.org/uploads/default/optimized/1X/0c479074381ad1d4ccee231a0fdf0d31cc470bba_2_663x500.png\" alt=\"image\" data-base62-sha1=\"1KD3qVVsDhmHqb3wZ04gmPorgYG\" width=\"663\" height=\"500\" srcset=\"https://delvingbitcoin.org/uploads/default/optimized/1X/0c479074381ad1d4ccee231a0fdf0d31cc470bba_2_663x500.png, https://delvingbitcoin.org/uploads/default/optimized/1X/0c479074381ad1d4ccee231a0fdf0d31cc470bba_2_994x750.png 1.5x, https://delvingbitcoin.org/uploads/default/original/1X/0c479074381ad1d4ccee231a0fdf0d31cc470bba.png 2x\" data-dominant-color=\"F9FAFA\"><div class=\"meta\"><svg class=\"fa d-icon d-icon-far-image svg-icon\" aria-hidden=\"true\"><use href=\"#far-image\"></use></svg><span class=\"filename\">image</span><span class=\"informations\">1030\u00d7776 46.9 KB</span><svg class=\"fa d-icon d-icon-discourse-expand svg-icon\" aria-hidden=\"true\"><use href=\"#discourse-expand\"></use></svg></div></a></div></p>\n<p>We see that the number of depleted channels in the network grows linearly with the <a href=\"https://en.wikipedia.org/wiki/Circuit_rank\" rel=\"noopener nofollow ugc\">circuit rank of the network</a> when <span class=\"math\">\\phi</span> is being maximized. Working over 10 years in statistics this is the strongest correlation on emperical data that I have ever seen. So it will be no surprise that I have a formal proof for this pattern to occur. (Disclaimer: <a href=\"https://sidiropo.people.uic.edu/\" rel=\"noopener nofollow ugc\">Sidiropoulos</a> shared a similar proof with me in a private conversation after I showed him the diagram / result).</p>\n<p>(The circuit rank basically tells us how many more channels we have than a spanning tree or hub and spoke model.)</p>\n<h2><a name=\"p-3525-why-maximizing-the-fee-potential-2\" class=\"anchor\" href=\"#p-3525-why-maximizing-the-fee-potential-2\"></a>Why maximizing the fee potential?</h2>\n<p>Now you could argue why should the network coordinate to maximize <span class=\"math\">\\phi</span>? I was doing the same. Thus I created a small simulation in a <a href=\"https://github.com/renepickhardt/Lightning-Network-Limitations/blob/702a0b669a0c3329701adef38657782b9ff95a94/Limits%20of%20two%20party%20channels/Selfish%20Sending%20yields%20Almost%20solution%20to%20Global%20Fee%20Potential%20Optimization.ipynb\" rel=\"noopener nofollow ugc\">second notebook</a> to study if the default behavior of nodes would produce a similar state as globally solving the optimization problem.</p>\n<p>For this I assumed the network to be initially in a random state and that nodes send each other money. For sending money the agents in the simulation will use liquid payment routs that minimize their cost. Without loss of generality I choose just the <span class=\"math\">ppm</span> as a cost function for the <a href=\"https://arxiv.org/abs/2107.05322\" rel=\"noopener nofollow ugc\">min cost flow computation</a>.</p>\n<p>After every simulation step I computed the networks fee potential <span class=\"math\">\\phi</span> and compare it with the maximized <span class=\"math\">\\phi</span> potential. Similarly I looked how many channels are depleted and compared it with the circuit rank of the network.</p>\n<p><div class=\"lightbox-wrapper\"><a class=\"lightbox\" href=\"https://delvingbitcoin.org/uploads/default/original/1X/f5b4fb591c74add8a64a5671c8c689245de9c9ec.png\" data-download-href=\"https://delvingbitcoin.org/uploads/default/f5b4fb591c74add8a64a5671c8c689245de9c9ec\" title=\"image\"><img src=\"https://delvingbitcoin.org/uploads/default/optimized/1X/f5b4fb591c74add8a64a5671c8c689245de9c9ec_2_684x499.png\" alt=\"image\" data-base62-sha1=\"z3CJnXrMKYppjvtRVdz2VC9K6C0\" width=\"684\" height=\"499\" srcset=\"https://delvingbitcoin.org/uploads/default/optimized/1X/f5b4fb591c74add8a64a5671c8c689245de9c9ec_2_684x499.png, https://delvingbitcoin.org/uploads/default/optimized/1X/f5b4fb591c74add8a64a5671c8c689245de9c9ec_2_1026x748.png 1.5x, https://delvingbitcoin.org/uploads/default/original/1X/f5b4fb591c74add8a64a5671c8c689245de9c9ec.png 2x\" data-dominant-color=\"F6F9FA\"><div class=\"meta\"><svg class=\"fa d-icon d-icon-far-image svg-icon\" aria-hidden=\"true\"><use href=\"#far-image\"></use></svg><span class=\"filename\">image</span><span class=\"informations\">1158\u00d7846 75.4 KB</span><svg class=\"fa d-icon d-icon-discourse-expand svg-icon\" aria-hidden=\"true\"><use href=\"#discourse-expand\"></use></svg></div></a></div></p>\n<p>One can see that very quickly the network reaches a state in which the network\u2019s fee potential is very close to the maximized fee potential. Similarly almost as many channels as the circuit rank (which is the number of cycles) will be depleted.</p>\n<h2><a name=\"p-3525-do-we-know-which-channels-deplete-3\" class=\"anchor\" href=\"#p-3525-do-we-know-which-channels-deplete-3\"></a>Do we know which channels deplete?</h2>\n<p>Just because <span class=\"math\">\\frac{\\phi}{\\phi_{opt}}\\sim 1</span> does not mean that the liquidity states are actually similar. Therefor in a final step I computed after each payment also the <a href=\"https://en.wikipedia.org/wiki/Average_absolute_deviation\" rel=\"noopener nofollow ugc\">mean absolute deviation</a> of the current liquidity state and the one that maximizes <span class=\"math\">\\phi</span>.</p>\n<p><div class=\"lightbox-wrapper\"><a class=\"lightbox\" href=\"https://delvingbitcoin.org/uploads/default/original/1X/36e74e11afb89cbc9a590cccedc783662a9ea156.png\" data-download-href=\"https://delvingbitcoin.org/uploads/default/36e74e11afb89cbc9a590cccedc783662a9ea156\" title=\"image\"><img src=\"https://delvingbitcoin.org/uploads/default/optimized/1X/36e74e11afb89cbc9a590cccedc783662a9ea156_2_655x500.png\" alt=\"image\" data-base62-sha1=\"7PHlP32Mv9lmzneAz9ahV2aVUSa\" width=\"655\" height=\"500\" srcset=\"https://delvingbitcoin.org/uploads/default/optimized/1X/36e74e11afb89cbc9a590cccedc783662a9ea156_2_655x500.png, https://delvingbitcoin.org/uploads/default/optimized/1X/36e74e11afb89cbc9a590cccedc783662a9ea156_2_982x750.png 1.5x, https://delvingbitcoin.org/uploads/default/original/1X/36e74e11afb89cbc9a590cccedc783662a9ea156.png 2x\" data-dominant-color=\"F7F9FA\"><div class=\"meta\"><svg class=\"fa d-icon d-icon-far-image svg-icon\" aria-hidden=\"true\"><use href=\"#far-image\"></use></svg><span class=\"filename\">image</span><span class=\"informations\">1017\u00d7776 38.7 KB</span><svg class=\"fa d-icon d-icon-discourse-expand svg-icon\" aria-hidden=\"true\"><use href=\"#discourse-expand\"></use></svg></div></a></div></p>\n<p>As you can see, only through sending payments the network converges to a liquidity state that can easily be predicted by just <a href=\"https://github.com/renepickhardt/Lightning-Network-Limitations/blob/702a0b669a0c3329701adef38657782b9ff95a94/Limits%20of%20two%20party%20channels/Selfish%20Sending%20yields%20Almost%20solution%20to%20Global%20Fee%20Potential%20Optimization.ipynb\" rel=\"noopener nofollow ugc\">solving the integer linear programming problem of maximizing the fee potential</a> with the data from gossip.</p>\n<p>With respect to privacy: Yet again I am surprised how much information (in this case about liquidity) we can learn from gossip and the default behavior of software clients.</p>\n<h2><a name=\"p-3525-limits-conclusions-open-questions-4\" class=\"anchor\" href=\"#p-3525-limits-conclusions-open-questions-4\"></a>Limits, Conclusions &amp; Open questions:</h2>\n<p>I am aware of a few limitations and have some open questions. There is probably more.</p>\n<h3><a name=\"p-3525-limits-5\" class=\"anchor\" href=\"#p-3525-limits-5\"></a>Limits:</h3>\n<ul>\n<li>Of course the actual distribution of the liquidity depends on the assumed (but unknown) wealth distribution</li>\n<li>In Reality implementations use various cost functions while the simulation only used one.</li>\n<li>While payment dynamics are part of the model the network topology and fees are assumed to be static.</li>\n<li>I used uniformly distributed random payment pairs and uniform payment amounts from 0 to the max flow between the pair. (While unrealistic, I hope it does not change the emergent phenomenon but maybe only the speed with which the phenomenon emerges)</li>\n</ul>\n<h3><a name=\"p-3525-conclusions-6\" class=\"anchor\" href=\"#p-3525-conclusions-6\"></a>Conclusions</h3>\n<ul>\n<li>Most likely much less probing will be necessary to estimate where the liquidity is located</li>\n<li>A spanning tree of non depleted channels remains. This is pretty much a <a href=\"https://en.wikipedia.org/wiki/Spoke%E2%80%93hub_distribution_paradigm\" rel=\"noopener nofollow ugc\">hub and spoke topology</a>.</li>\n<li>The direction of the drain of a particular channel depends on the topology and fees within the entire network (and payment flows). In particular it the ratio of ppms in both directions may be less indicative.</li>\n</ul>\n<h3><a name=\"p-3525-open-questions-7\" class=\"anchor\" href=\"#p-3525-open-questions-7\"></a>Open Questions:</h3>\n<ul>\n<li>Is this evidence enough to conclude that drain on channels and depletion does not come from the existence of sink / and source nodes but would also emerge in a circular economy?</li>\n<li>Can one derive strategies for node operators to adopt fees in their liquidity management strategies?</li>\n<li>Are more channels than a spanning tree useful? I mean obviously they provide redundancy but also depeletion and have on chain cost.</li>\n<li>Similarly, how stable is the location of the spanning tree while the wealth distribution changes.</li>\n<li>Could the bimodel prior that is being used by many implementations be changed to one that estimates liquidity to be on one side or is it useful as the dynamic often changes the side where the liquidity will be located?</li>\n<li>How does the situation change if sending nodes use this knowledge to predict where liquidity is located while solving the optimization problem to send payments?</li>\n<li>Has anyone a good data set to test how accurate the prediction is in comparison to the actual network?</li>\n</ul>",
  "post_number": 1,
  "post_type": 1,
  "updated_at": "2024-11-15T12:27:20.283Z",
  "reply_count": 0,
  "reply_to_post_number": null,
  "quote_count": 0,
  "incoming_link_count": 71,
  "reads": 5,
  "readers_count": 4,
  "score": 331.0,
  "yours": false,
  "topic_id": 1259,
  "topic_slug": "channel-depletion-ln-topology-cycles-and-rational-behavior-of-nodes",
  "topic_title": "Channel depletion, LN Topology, Cycles and rational behavior of nodes",
  "topic_html_title": "Channel depletion, LN Topology, Cycles and rational behavior of nodes",
  "category_id": 7,
  "display_username": "Rene Pickhardt",
  "primary_group_name": null,
  "flair_name": null,
  "flair_url": null,
  "flair_bg_color": null,
  "flair_color": null,
  "flair_group_id": null,
  "version": 2,
  "can_edit": false,
  "can_delete": false,
  "can_recover": false,
  "can_see_hidden_post": false,
  "can_wiki": false,
  "user_title": null,
  "bookmarked": false,
  "raw": "Dear fellow Lightning developers, \n\nat this time I believe I have rather strong evidence to explain how economic rational behavior and network topology lead to the high rate of channel depletion that we observe on the network.\n\nThus, I would like to share some follow up results of the [mathematical theory of payment channel networks](https://github.com/renepickhardt/Lightning-Network-Limitations/blob/305db330c96dc751f0615d9abb096b12b8a6191f/Limits%20of%20two%20party%20channels/paper/a%20mathematical%20theory%20of%20payment%20channel%20networks.pdf) with you. Before extending the linked document I thought I collect feedback from you about two notebooks / results ([notebook1](https://github.com/renepickhardt/Lightning-Network-Limitations/blob/702a0b669a0c3329701adef38657782b9ff95a94/Limits%20of%20two%20party%20channels/Estimating%20Liquidity%20State%20given%20Fees%20and%20Network%20Topologies.ipynb) and [notebook2](https://github.com/renepickhardt/Lightning-Network-Limitations/blob/702a0b669a0c3329701adef38657782b9ff95a94/Limits%20of%20two%20party%20channels/Selfish%20Sending%20yields%20Almost%20solution%20to%20Global%20Fee%20Potential%20Optimization.ipynb)) that I have been developing after your valuable thoughts and feedback in Tokyo.\n\nIn the afore mentioned paper I already provided a proof for the intuitive observation that cycles on the channel graph produce several liquidity states with the same wealth distribution (as a cycle usually allows for circular off-chain rebalancing, which - when neglecting routing fees - does not change the wealth distribution. Similarly [it was shown with a markov model that the steady state of the LN is a spanning tree while all other channels should be depleted](https://github.com/gr-g/ln-steady-state-model/issues/1). I am able to come to the same conclusion but with a different approach: \n\n## Fee Potential of the Network\n\n(The motivation why to study the fee potential will follow in the next section)\n\nNeglecting the base fee we can define the fee potential of a node as:\n\n$\\phi_v = \\sum_{e\\in E: v\\in E}\\left(\\lambda(v,e)\\cdot ppm(v,e)\\right)$\n\nThis is just the sum of a node's outgoing liquidity in all their channels multiplied with the ppm the node can expect to earn when routing the liquidity on the channel. [This is motivated by note operators who seem to maximize their fee potential](https://github.com/DerEwige/speedupln.com/blob/9ff62b1af79ee601016187f6967498e4f0c45def/docs/fee_potential_and_rebalancing.md). \n\nIn a similar fashion the fee potential for the entire network can be defined as: \n\n$\\phi = \\sum_{v\\in V}\\phi_v$\n\nUsing [integer linear programming when finding a feasible liquidity state for a given wealth distribution](https://github.com/renepickhardt/Lightning-Network-Limitations/pull/2) one could at the same time find a feasible liquidity state that maximizes $\\phi$ (or more conveniently minimize $-\\phi$). I have done this in [this notebook](https://github.com/renepickhardt/Lightning-Network-Limitations/blob/702a0b669a0c3329701adef38657782b9ff95a94/Limits%20of%20two%20party%20channels/Estimating%20Liquidity%20State%20given%20Fees%20and%20Network%20Topologies.ipynb) and made a rather interesting observation: \n \n![image|663x500](upload://1KD3qVVsDhmHqb3wZ04gmPorgYG.png)\n\nWe see that the number of depleted channels in the network grows linearly with the [circuit rank of the network](https://en.wikipedia.org/wiki/Circuit_rank) when $\\phi$ is being maximized. Working over 10 years in statistics this is the strongest correlation on emperical data that I have ever seen. So it will be no surprise that I have a formal proof for this pattern to occur. (Disclaimer: [Sidiropoulos](https://sidiropo.people.uic.edu/) shared a similar proof with me in a private conversation after I showed him the diagram / result).\n\n(The circuit rank basically tells us how many more channels we have than a spanning tree or hub and spoke model.)\n\n## Why maximizing the fee potential?\nNow you could argue why should the network coordinate to maximize $\\phi$? I was doing the same. Thus I created a small simulation in a [second notebook](https://github.com/renepickhardt/Lightning-Network-Limitations/blob/702a0b669a0c3329701adef38657782b9ff95a94/Limits%20of%20two%20party%20channels/Selfish%20Sending%20yields%20Almost%20solution%20to%20Global%20Fee%20Potential%20Optimization.ipynb) to study if the default behavior of nodes would produce a similar state as globally solving the optimization problem. \n\nFor this I assumed the network to be initially in a random state and that nodes send each other money. For sending money the agents in the simulation will use liquid payment routs that minimize their cost. Without loss of generality I choose just the $ppm$ as a cost function for the [min cost flow computation](https://arxiv.org/abs/2107.05322).\n\nAfter every simulation step I computed the networks fee potential $\\phi$ and compare it with the maximized $\\phi$ potential. Similarly I looked how many channels are depleted and compared it with the circuit rank of the network.  \n\n![image|684x499](upload://z3CJnXrMKYppjvtRVdz2VC9K6C0.png)\n\nOne can see that very quickly the network reaches a state in which the network's fee potential is very close to the maximized fee potential. Similarly almost as many channels as the circuit rank (which is the number of cycles) will be depleted.\n\n## Do we know which channels deplete?\nJust because $\\frac{\\phi}{\\phi_{opt}}\\sim 1$ does not mean that the liquidity states are actually similar. Therefor in a final step I computed after each payment also the [mean absolute deviation](https://en.wikipedia.org/wiki/Average_absolute_deviation) of the current liquidity state and the one that maximizes $\\phi$. \n\n![image|655x500](upload://7PHlP32Mv9lmzneAz9ahV2aVUSa.png)\n\nAs you can see, only through sending payments the network converges to a liquidity state that can easily be predicted by just [solving the integer linear programming problem of maximizing the fee potential](https://github.com/renepickhardt/Lightning-Network-Limitations/blob/702a0b669a0c3329701adef38657782b9ff95a94/Limits%20of%20two%20party%20channels/Selfish%20Sending%20yields%20Almost%20solution%20to%20Global%20Fee%20Potential%20Optimization.ipynb) with the data from gossip. \n\nWith respect to privacy: Yet again I am surprised how much information (in this case about liquidity) we can learn from gossip and the default behavior of software clients.  \n\n## Limits, Conclusions & Open questions:\n\nI am aware of a few limitations and have some open questions. There is probably more.\n\n### Limits:\n* Of course the actual distribution of the liquidity depends on the assumed (but unknown) wealth distribution\n* In Reality implementations use various cost functions while the simulation only used one.\n* While payment dynamics are part of the model the network topology and fees are assumed to be static.\n* I used uniformly distributed random payment pairs and uniform payment amounts from 0 to the max flow between the pair. (While unrealistic, I hope it does not change the emergent phenomenon but maybe only the speed with which the phenomenon emerges) \n\n### Conclusions\n\n* Most likely much less probing will be necessary to estimate where the liquidity is located\n* A spanning tree of non depleted channels remains. This is pretty much a [hub and spoke topology](https://en.wikipedia.org/wiki/Spoke%E2%80%93hub_distribution_paradigm). \n* The direction of the drain of a particular channel depends on the topology and fees within the entire network (and payment flows). In particular it the ratio of ppms in both directions may be less indicative.\n \n### Open Questions:\n* Is this evidence enough to conclude that drain on channels and depletion does not come from the existence of sink / and source nodes but would also emerge in a circular economy? \n* Can one derive strategies for node operators to adopt fees in their liquidity management strategies?\n* Are more channels than a spanning tree useful? I mean obviously they provide redundancy but also depeletion and have on chain cost. \n* Similarly, how stable is the location of the spanning tree while the wealth distribution changes.\n* Could the bimodel prior that is being used by many implementations be changed to one that estimates liquidity to be on one side or is it useful as the dynamic often changes the side where the liquidity will be located?\n* How does the situation change if sending nodes use this knowledge to predict where liquidity is located while solving the optimization problem to send payments?\n* Has anyone a good data set to test how accurate the prediction is in comparison to the actual network?",
  "actions_summary": [],
  "moderator": false,
  "admin": false,
  "staff": false,
  "user_id": 8,
  "hidden": false,
  "trust_level": 2,
  "deleted_at": null,
  "user_deleted": false,
  "edit_reason": "Github link was replaced with a permanent link",
  "can_view_edit_history": true,
  "wiki": false,
  "reactions": [],
  "current_user_reaction": null,
  "reaction_users_count": 0,
  "current_user_used_main_reaction": false
}