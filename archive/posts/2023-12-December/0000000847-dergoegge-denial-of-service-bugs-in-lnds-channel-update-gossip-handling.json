{
  "id": 847,
  "name": "Niklas G\u00f6gge",
  "username": "dergoegge",
  "avatar_template": "/user_avatar/delvingbitcoin.org/dergoegge/{size}/14_2.png",
  "created_at": "2023-12-21T16:39:35.378Z",
  "cooked": "<p>This is a write-up of two denial-of-service bugs I found in <a href=\"https://github.com/lightningnetwork/lnd\">LND</a> at the end of 2021. Users do not need to take any action at this time, as the initial fixed versions are themselves superseded due to other <a href=\"https://github.com/lightningnetwork/lnd/security/advisories/GHSA-hc82-w9v8-83pr\">exploited</a> and <a href=\"https://morehouse.github.io/lightning/fake-channel-dos/\">disclosed</a> vulnerabilities.</p>\n<h1><a name=\"h-1-premature-channel_update-denial-of-service-1\" class=\"anchor\" href=\"#h-1-premature-channel_update-denial-of-service-1\"></a>(1) Premature <code>channel_update</code> denial-of-service</h1>\n<p>LND prior to <a href=\"https://github.com/lightningnetwork/lnd/releases/tag/v0.14.0-beta\">v0.14.0</a> was vulnerable to denial-of-service by running out of memory from unconditionally storing premature channel updates.</p>\n<h2><a name=\"details-2\" class=\"anchor\" href=\"#details-2\"></a>Details</h2>\n<p>When a channel is first established between two parties, three gossip messages will be broadcast to the network: a <code>channel_announcement</code> and two <code>channel_update</code>s (one for each channel direction). During the propagation of these messages, a race may occur in which the channel updates are received prior to the channel announcement. The receiving node can not validate these premature channel updates, as the channel announcement contains the public keys that correspond to the signatures in the updates.</p>\n<p>To address this race, LND used a buffer for temporarily storing premature channel updates until the channel announcement is received. Unfortunately the size of this buffer was unbounded and an attacker could fill it with entirely invalid updates, leading the victim to run out of memory. As with any crash bug in lightning node software, this comes with a <strong>risk of loosing funds</strong>.</p>\n<p>The issue was fixed in <a href=\"https://github.com/lightningnetwork/lnd/pull/5902\">PR #5902</a> by replacing the unbounded buffer with a limited cache that can hold up to 100 premature updates.</p>\n<p>Fun fact: The issue was <a href=\"https://github.com/lightningnetwork/lnd/pull/4895\">fixed</a> earlier in Jan. 2021 by removing the buffer entirely but it is unclear whether or not that was intentional, as the fix was later <a href=\"https://github.com/lightningnetwork/lnd/pull/5003\">rolled back</a> due to flaky tests.</p>\n<h1><a name=\"h-2-channel_update-signature-validation-after-rate-limiting-3\" class=\"anchor\" href=\"#h-2-channel_update-signature-validation-after-rate-limiting-3\"></a>(2) <code>channel_update</code> signature validation after rate limiting</h1>\n<p>LND prior to <a href=\"https://github.com/lightningnetwork/lnd/releases/tag/v0.15.0-beta\">v0.15.0</a> was vulnerable to channel update gossip censorship.</p>\n<h2><a name=\"details-4\" class=\"anchor\" href=\"#details-4\"></a>Details</h2>\n<p>In the lightning protocol, there is no inherent cost to creating and broadcasting <code>channel_update</code> messages besides having to sign them. To address this, all lightning implementations rate limit how many channel updates they will relay within a given time frame (to prevent gossip spam on the network).</p>\n<p>LND used to check signatures of channel updates after applying its relay rate limits. As consequence, an attacker could censor channel updates for any channel from propagating by creating invalid channel updates and spamming them to LND nodes (causing any new valid updates from the victim to be ignored).</p>\n<p>The issue was fixed in <a href=\"https://github.com/lightningnetwork/lnd/pull/6278\">PR #6278</a> by ensuring that signature validation of channel updates happens prior to applying the rate limits.</p>\n<h1><a name=\"timeline-5\" class=\"anchor\" href=\"#timeline-5\"></a>Timeline</h1>\n<p>Disclosure timeline for both bugs:</p>\n<ul>\n<li>19-10-2021: Initial disclosure to Lightning Labs</li>\n<li>05-11-2021: (1) fixed: <a href=\"https://github.com/lightningnetwork/lnd/pull/5902\">https://github.com/lightningnetwork/lnd/pull/5902</a></li>\n<li>17-11-2021: v0.14.0 released</li>\n<li>16-03-2022: (2) fixed: <a href=\"https://github.com/lightningnetwork/lnd/pull/6278\">https://github.com/lightningnetwork/lnd/pull/6278</a></li>\n<li>24-06-2022: v0.15.0 released</li>\n<li>21-12-2023: Public disclosure</li>\n</ul>\n<hr>\n<p>Support security focused Bitcoin research and development by <a href=\"https://brink.dev/donate\">donating to Brink</a>.</p>",
  "post_number": 1,
  "post_type": 1,
  "updated_at": "2023-12-21T16:39:35.378Z",
  "reply_count": 0,
  "reply_to_post_number": null,
  "quote_count": 0,
  "incoming_link_count": 15,
  "reads": 10,
  "readers_count": 9,
  "score": 92.0,
  "yours": false,
  "topic_id": 314,
  "topic_slug": "denial-of-service-bugs-in-lnds-channel-update-gossip-handling",
  "topic_title": "Denial-of-service bugs in LND's channel update gossip handling",
  "topic_html_title": "Denial-of-service bugs in LND&rsquo;s channel update gossip handling",
  "category_id": 8,
  "display_username": "Niklas G\u00f6gge",
  "primary_group_name": null,
  "flair_name": null,
  "flair_url": null,
  "flair_bg_color": null,
  "flair_color": null,
  "flair_group_id": null,
  "version": 1,
  "can_edit": false,
  "can_delete": false,
  "can_recover": false,
  "can_see_hidden_post": false,
  "can_wiki": false,
  "user_title": null,
  "bookmarked": false,
  "raw": "This is a write-up of two denial-of-service bugs I found in [LND](https://github.com/lightningnetwork/lnd) at the end of 2021. Users do not need to take any action at this time, as the initial fixed versions are themselves superseded due to other [exploited](https://github.com/lightningnetwork/lnd/security/advisories/GHSA-hc82-w9v8-83pr) and [disclosed](https://morehouse.github.io/lightning/fake-channel-dos/) vulnerabilities.\n\n# (1) Premature `channel_update` denial-of-service\n\nLND prior to [v0.14.0](https://github.com/lightningnetwork/lnd/releases/tag/v0.14.0-beta) was vulnerable to denial-of-service by running out of memory from unconditionally storing premature channel updates.\n\n## Details\n\nWhen a channel is first established between two parties, three gossip messages will be broadcast to the network: a `channel_announcement` and two `channel_update`s (one for each channel direction). During the propagation of these messages, a race may occur in which the channel updates are received prior to the channel announcement. The receiving node can not validate these premature channel updates, as the channel announcement contains the public keys that correspond to the signatures in the updates.\n\nTo address this race, LND used a buffer for temporarily storing premature channel updates until the channel announcement is received. Unfortunately the size of this buffer was unbounded and an attacker could fill it with entirely invalid updates, leading the victim to run out of memory. As with any crash bug in lightning node software, this comes with a **risk of loosing funds**.\n\nThe issue was fixed in [PR #5902](https://github.com/lightningnetwork/lnd/pull/5902) by replacing the unbounded buffer with a limited cache that can hold up to 100 premature updates.\n\nFun fact: The issue was [fixed](https://github.com/lightningnetwork/lnd/pull/4895) earlier in Jan. 2021 by removing the buffer entirely but it is unclear whether or not that was intentional, as the fix was later [rolled back](https://github.com/lightningnetwork/lnd/pull/5003) due to flaky tests.\n\n# (2) `channel_update` signature validation after rate limiting\n\nLND prior to [v0.15.0](https://github.com/lightningnetwork/lnd/releases/tag/v0.15.0-beta) was vulnerable to channel update gossip censorship.\n\n## Details\n\nIn the lightning protocol, there is no inherent cost to creating and broadcasting `channel_update` messages besides having to sign them. To address this, all lightning implementations rate limit how many channel updates they will relay within a given time frame (to prevent gossip spam on the network).\n\nLND used to check signatures of channel updates after applying its relay rate limits. As consequence, an attacker could censor channel updates for any channel from propagating by creating invalid channel updates and spamming them to LND nodes (causing any new valid updates from the victim to be ignored).\n\nThe issue was fixed in [PR #6278](https://github.com/lightningnetwork/lnd/pull/6278) by ensuring that signature validation of channel updates happens prior to applying the rate limits.\n\n# Timeline\n\nDisclosure timeline for both bugs:\n\n- 19-10-2021: Initial disclosure to Lightning Labs\n- 05-11-2021: (1) fixed: [https://github.com/lightningnetwork/lnd/pull/5902](https://github.com/lightningnetwork/lnd/pull/5902)\n- 17-11-2021: v0.14.0 released\n- 16-03-2022: (2) fixed: [https://github.com/lightningnetwork/lnd/pull/6278](https://github.com/lightningnetwork/lnd/pull/6278)\n- 24-06-2022: v0.15.0 released\n- 21-12-2023: Public disclosure\n\n---\n\nSupport security focused Bitcoin research and development by [donating to Brink](https://brink.dev/donate).",
  "actions_summary": [
    {
      "id": 2,
      "count": 1
    }
  ],
  "moderator": false,
  "admin": false,
  "staff": false,
  "user_id": 15,
  "hidden": false,
  "trust_level": 3,
  "deleted_at": null,
  "user_deleted": false,
  "edit_reason": null,
  "can_view_edit_history": true,
  "wiki": false,
  "reactions": [
    {
      "id": "+1",
      "type": "emoji",
      "count": 1
    }
  ],
  "current_user_reaction": null,
  "reaction_users_count": 1,
  "current_user_used_main_reaction": false
}