{
  "id": 62,
  "name": "James O'Beirne",
  "username": "jamesob",
  "avatar_template": "/user_avatar/delvingbitcoin.org/jamesob/{size}/271_2.png",
  "created_at": "2023-08-16T14:53:52.896Z",
  "cooked": "<p>Back in June, AJ published an <a href=\"https://www.erisian.com.au/wordpress/2023/06/21/putting-the-b-in-btc\">underread blogpost</a> about scaling. I\u2019ll do a hasty job of paraphrasing the post \u2013  which you should read in full \u2013 by noting that it hypothesizes that the way that we might scale to <strong>1 billion</strong> users transacting at about <strong>1 tx/week</strong> (which is checking-account volume, my personal target) is by having about 50,000 kinda-sorted-trusted off-chain entities that bear the brunt of most payment volume.</p>\n<p>Here I discuss whether I think this is realistic, and if it tells us anything about possible consensus changes.</p>\n<h2><a name=\"off-chain-entities-1\" class=\"anchor\" href=\"#off-chain-entities-1\"></a>Off-chain entities?</h2>\n<p>If you wanted to be especially coarse you could just say \u201cbitcoin banks.\u201d Examples of what I mean here are</p>\n<ol>\n<li>a traditional, federated sidechain like Liquid,\n<ul>\n<li>You send your coins to be controlled by some third party, but in return you get more expressive scripting abilities or confidential assets or faster blocks or some combination of all of them.</li>\n<li>Drivechains are sort of like this, but the peg-in and -out are mediated by bitcoin miners.</li>\n</ul>\n</li>\n<li>some kind of Chaumian ecash bank like fedimint or cashu,\n<ul>\n<li>You send your coins to a federation (or even an individual operator), and you get some privacy benefits.</li>\n</ul>\n</li>\n<li>or some yet-to-be-discovered design that doesn\u2019t hinge on trusting some third party to return your coins (\u201cpeg out\u201d), instead relying on enforcement via smart contract (i.e. bitcoin script) and a magic sprinkle of <em>time-sensitivity</em> on the part of its users.\n<ul>\n<li>This is like a <a href=\"https://coinpool.dev\">coinpool</a> or something vaguely in the direction of <a href=\"https://www.arkpill.me/\">Ark</a> (which is itself right now just a vague direction).</li>\n<li>You could think of this as behaving like the generalization of a lightning channel from 2 parties to <code>n</code> parties. It would probably require interactivity across all participants for each payment, but the holy grail would be some design that allows subsets of participants to generate off-chain activity without requiring everyone to sign. Though whether the latter is even possible is an area of ongoing research.</li>\n<li>For the purposes of this post, this could even be some kind of <a href=\"https://github.com/john-light/validity-rollups/blob/fecc3433d8e95ab40263db8c2941794e0115d2d5/validity_rollups_on_bitcoin.md\">ZKP rollup</a> thing - after all, \u201cfraud proof\u201d and \u201cpenalty transaction\u201d seem basically equivalent. (<em>Edit: John Light <a href=\"https://twitter.com/lightcoin/status/1691828900748226860\">notes</a> that validity proofs don\u2019t require fraud proofs or liveness.)</em></li>\n<li>We\u2019ll just refer to this thing as \u201ccoinpool\u201d for short.</li>\n</ul>\n</li>\n</ol>\n<p>There are other options, like <a href=\"https://github.com/RubenSomsen/spacechains\">spacechains</a>, that I won\u2019t cover in detail here.</p>\n<p>The last option, this hypothetical coinpool thing, seems clearly preferable since it\u2019s not relying on a third party. But it\u2019s still a hypothetical, and then even if it weren\u2019t (as we\u2019ve seen with lightning) there are operational caveats around actually maintaining a working, live presence that understands a layer 2 protocol and is able to validate new activity and not get sybiled, etc.</p>\n<p>Even relative experts aren\u2019t necessarily able to run networked infrastructure that can lose money if it goes offline. It\u2019s a full-time job, probably for multiple people.</p>\n<h2><a name=\"layer-1-uncomfortable-2\" class=\"anchor\" href=\"#layer-1-uncomfortable-2\"></a>Layer 1: uncomfortable</h2>\n<p>Okay, so to get back on track here: in our projected scaling scenario, each user holds value with 3 or 4 of these semi-trusted/time-sensitive offchain services that more or less resemble community banks. These \u201cbanks\u201d are probably networked with payment channels (or atomic swappability) so that they can handle cross-bank liquidity operations, like doing the equivalent of wire transfers. I.e. I want to pay you, but we\u2019re at different bitcoin banks, so the entities themselves facilitate some kind of batched settlement over a lightning gateway.</p>\n<p>The quiet part out loud here is that by the time 1 billion people want to use bitcoin, the main chain is very expensive to transact on. Note that I say \u201cvery expensive\u201d and not \u201cimpossibly expensive,\u201d because if users lose the ability to take some form of layer 1 physical custody, bitcoin is just gold with less friction: a paper market will develop and all the nice properties of bitcoin will diminish, as AJ talks about in his post (<a href=\"https://www.erisian.com.au/wordpress/2023/06/21/putting-the-b-in-btc\">link again</a>).</p>\n<p>Note also that part of what keeps these offchain constructions workable is the threat of their depositors somehow interacting with layer 1. Even in the case of some kind of \u201ctrustless\u201d coinpool thing, <em>the ability to appeal to layer 1 is what makes it all work</em>. So if L1 is too expensive to appeal to for most people, the coinpool design doesn\u2019t really work. Maybe among poorer users, that appeal process happens in groups to amortize base layer fees over a set of users.</p>\n<p>These bank things are incentivized to keep operating (and not run away with the money) because (i) they collect fees and (ii?) they may be subject to some kind of local legal jurisdiction. But one of the saving graces here is that the the nature of bitcoin makes it feasible for each customer to also be an auditor.</p>\n<p>So let\u2019s assume for simplicity that throwing a transaction on layer 1 costs maybe a few hundred bucks: something many could afford in case there\u2019s a Big Problem with their \u201cbank\u201d and they need to flee to layer 1 bitcoin, but not something everyone can afford, and definitely not something that you\u2019d want to do every month or even every year.</p>\n<h2><a name=\"how-we-scale-3\" class=\"anchor\" href=\"#how-we-scale-3\"></a>How we scale?</h2>\n<p>I think this is roughly what scaling to a billion people looks like for Bitcoin: a constellation of 50,000 networked \u201cbanks,\u201d with (hopefully!) roughly uniform distribution of BTC managed across each bank, and a hub-and-spoke use of a few of those banks at the individual level.</p>\n<p>The alternatives? Can\u2019t just raise the blocksize. Distributing the equivalent of the world\u2019s checking account activity over a network of validating nodes just doesn\u2019t allow you to preserve decentralization.</p>\n<p>I truly don\u2019t think that your average person is going to manage a lightning node (directional liquidity and uptime are annoying), and the Phoenix model of a semi-trusted LSP that is by definition a kind of friendly sybil still requires pushing around a UTXO, which isn\u2019t workable at the scale of a billion people. Assuming 41 bytes a UTXO, 1 billion of those things equates to about 380GB just for your UTXO set. This would make timely validation very difficult, although I dunno maybe it\u2019s worth some experimentation. <a href=\"https://bitcoinops.org/en/topics/utreexo/\">Utreexo</a> does help somewhat with this, and would probably be prerequisite to even approaching the problem.</p>\n<p>Is the 50,000-\u201dbank\u201d thing  a compromise away from layer 1 ownership? Yes. But UTXO ownership for the entire world \u2013 barring some unforeseen magic, which of course I\u2019m rooting for! \u2013 isn\u2019t in the cards. At least with bitcoin\u2019s technological context, we can have good auditing and custody tools to ensure that fraud is easily detectable and theft is basically impossible.</p>\n<h3><a name=\"depression-pitstop-4\" class=\"anchor\" href=\"#depression-pitstop-4\"></a>Depression pitstop</h3>\n<p>When reading a draft of this post, my wife got kind of depressed right around here. Her macabre question, basically, is: \u201cif everyone just winds up interacting with sidechains, and not Real Bitcoin, hasn\u2019t the whole thing failed? At every point you\u2019re dealing with some token that isn\u2019t really bitcoin.\u201d</p>\n<p>I think this is an uncomfortable realization, and I don\u2019t enjoy it. I hope the conclusion is wrong, and that we come up with some great cryptographic construct that solves the mismatch between decentralized validatability and volume, but I don\u2019t think we should plan for that.</p>\n<p>Even if this is how things pan out, I think it might sound worse than it is. The win over the existing financial regime is that we still get a base-layer money that can\u2019t be inflated. A particular bank might attempt some mischief, but bitcoin-native software tools make trust into a finer gradient, and they ensure the mischief will be much more readily evident (Proof of Reserves?) and in certain cases relative to the legacy system, just impossible (DLCs disintermediating brokers? collaborative custody? onchain observability?).</p>\n<p>So, assuming you\u2019re willing to entertain these broad strokes, this architectural target gives us a few hints about bitcoin development in the short- to mid-term.</p>\n<h2><a name=\"design-for-exit-5\" class=\"anchor\" href=\"#design-for-exit-5\"></a>Design for exit</h2>\n<p>Because we\u2019re probably going to see a few dominant second layer (\u201cbank\u201d) designs emerge, we have to account for correlated failure. While reviewing this article, <a href=\"https://twitter.com/rot13maxi\">Rijndael</a> referred to this as \u201cthe thundering herd.\u201d</p>\n<p>Take for example the <a href=\"https://github.com/btcsuite/btcd/issues/1906\">lnd fiasco(s)</a> within the last year that could have caused mass channel closures amongst lnd nodes. Once a few workable L2 designs come into common use, the probability of a mass exit event goes up, making this seem like a crucial usecase to plan for.</p>\n<p>Because layer 1 space is scarce, we need to be able to pack all the exits we can into some timespan of blocks. The way to do this seems to be decoupling the actions \u201cget out\u201d from \u201cactually reclaim your funds\u201d (i.e. create new UTXOs) so that we can facilitate a timely exit for as many participants as possible. This is more or less congestion control, an idea largely pioneered by <a href=\"https://rubin.io\">Jeremy Rubin</a> during the mid-days of CTV development.</p>\n<p>Locking funds for later claim to a prespecified path (or set of paths) should be made as concise as possible so that in times of cataclysm, we can pack in as many exit transactions as possible.</p>\n<p>For a case like this, I don\u2019t think you can get more concise than the bare script <code>&lt;32 byte hash&gt; OP_CHECKTEMPLATEVERIFY</code>.</p>\n<p>It\u2019s worth noting that a P2TR scriptPubKey is the same size (<code>OP_1 &lt;32 byte pubkey&gt;</code>), but then actually spending that coin comes with 17vB overhead (= <code>(34vB (controlblock) + 33vB (CTV script)) / 4</code>). If you\u2019re trying to fill a block with 2-in-1-out CTV unrolls, this could be about 10% overhead.</p>\n<p>The burden of this overhead decreases as you add inputs or outputs of course, so \u201cbatch\u201d unrolls for multiple users won\u2019t benefit as much from bare script CTVs (vs. P2TR script paths). But the most common use-case these days would be lightning channel closes, which are 1-in-2-out.</p>\n<p>There are rival proposals to CTV that are more flexible, like <code>OP_TX</code>/<code>OP_TXHASH</code> and others, but in a correlated crisis requiring mass exit from an L2, flexibility isn\u2019t what\u2019s needed - judicious use of layer 1 is. So whether or not <code>OP_TX</code> et al. are good for other things (I don\u2019t know of any usecases?), I think CTV is needed simply because it is the most concise way to articulate exit from a contract on-chain at a time when blockspace might be precious.</p>\n<p>Per some basic analysis, using CTV\u2019s spend compression (congestion control), you\u2019d be able to pack in <a href=\"https://github.com/jamesob/verystable/blob/18a57207fe4fc106c4befaffc1784b012afc696c/examples/txn_size.py\">~33% more lightning closes</a> into a block in times of crisis:</p>\n<pre data-code-wrap=\"shell\"><code class=\"lang-shell\">src/verystable (init 18a5720) % python examples/txn_size.py\nCTV txn: 128vB\nnon-CTV txn: 171vB\nCTV txns per block: 31250\nnon-CTV txns per block: 23391\nmore per block with CTV: 33.6%\n</code></pre>\n<h2><a name=\"bomb-proof-custody-patterns-6\" class=\"anchor\" href=\"#bomb-proof-custody-patterns-6\"></a>Bomb-proof custody patterns</h2>\n<p>The other observation that comes to mind is if there are going to be ~50,000 entities managing large sums of bitcoin each, many of them perhaps managed by federated signers, there need to be relatively straightfoward custodial patterns that let us be pretty sure that theft or loss is out of the question.</p>\n<p>It shouldn\u2019t come as a surprise that I think the functionality in <a href=\"https://github.com/jamesob/bips/blob/e2ff23b3f07215450e75779f7f944d24660a9d47/bip-0345.mediawiki\"><code>OP_VAULT</code></a> is an important piece here, because it enables \u201creactive security.\u201d As Jameson Lopp <a href=\"https://blog.keys.casa/why-bitcoin-needs-covenants/\">says</a>:</p>\n<blockquote>\n<p>With the right tools, we can be <em>reactive</em> rather than only <em>proactive</em> with regard to recovering from key compromises.</p>\n<p>Vaults allow for the creation of a new set of game theory. Similar to how you can run watchtowers to look out for a Lightning channel counterparty trying to cheat you, you would be able to run a watchtower to make sure no one has compromised your bitcoin vault. If you find that a compromise has occurred, sweeping the funds to safety is simple enough that you can automate it!</p>\n<p>It is my sincere belief that every bitcoin self-custody user and every wallet developer should be salivating over the prospect of user-friendly vault functionality. The ability to \u201cclaw back\u201d funds that have been lost due to a compromised security architecture means that bitcoiners can sleep more peacefully at night, knowing that they can be fallible, make mistakes, and not have to suffer from catastrophic loss due to a single oversight.</p>\n</blockquote>\n<p>I think that vaults that are enforced on-chain are probably a necessary part of successfully scaling custody to a large number of collaboratively managed pools of bitcoin. And <code>OP_VAULT</code> seems like the most chainspace-efficient way to do this. You can maybe emulate <code>OP_VAULT</code>\u2019s behavior with, say, <a href=\"https://merkle.fun/\">MATT</a>. But I think the point above about CTV and congestion control tells us that common operations should be made as efficient as possible (<a href=\"https://www.baeldung.com/cs/risc-vs-cisc\">CISC-like</a>).</p>\n<p>Obviously there are a lot of parameters to be decided, e.g.</p>\n<ul>\n<li>who manages a watchtower, and how much do they know?</li>\n<li>what does recovery look like: highly secure/inconvenient keys, social recovery, or some time-decayed composition of both?</li>\n</ul>\n<p>and I\u2019m sure others. But I don\u2019t think we can rely on proactive security to get 50,000 entities feeling good about putting a lot of capital on the line in an automated way. Even if you could template out some standard array of HSMs, the supply chain attacks (both from hardware and software) seem too feasible.</p>\n<h2><a name=\"other-stuff-7\" class=\"anchor\" href=\"#other-stuff-7\"></a>Other stuff</h2>\n<p>Of course I\u2019m leaving a lot out here. Stuff that isn\u2019t related to covenants per se, but is essential to allowing time-sensitive L2 protocols to actually work, like good mempool/fee management policy. Lightning is going to fall down without that work. And stuff that just lets Bitcoin work in a censorship resistant way, like BIP324.</p>\n<p>Someone should also work on fleshing out a \u201cminimum viable coinpool,\u201d and figure out if we need primitives above and beyond taproot and CTV. That would be valuable info.</p>\n<h2><a name=\"conclusion-8\" class=\"anchor\" href=\"#conclusion-8\"></a>Conclusion</h2>\n<p>This article is already long enough, and there will probably be subsequent writings from me that either build on this or respond to posts from others using this lens.</p>\n<p>I think barring some kind of magical development, which I\u2019m not counting on, the way that we wind up scaling bitcoin to handle checking-account volume is with something on the order of 50,000 entities that manage/risk pools of capital to facilitate payment flows. These entities would be networked, probably with lightning, and will offer a gradation of trust. \u201cOsmotic\u201d pressure from the threat of withdrawal to L1 or opposing financial entities will discipline these things into behaving, almost certainly with some bumps along the way.</p>\n<p>As <a href=\"https://bitcointalk.org/index.php?topic=2500.msg34211#msg34211\">Hal said in 2010</a>:</p>\n<blockquote>\n<p>Actually there is a very good reason for Bitcoin-backed banks to exist, issuing their own digital cash currency, redeemable for bitcoins. Bitcoin itself cannot scale to have every single financial transaction in the world be broadcast to everyone and included in the block chain. There needs to be a secondary level of payment systems which is lighter weight and more efficient. Likewise, the time needed for Bitcoin transactions to finalize will be impractical for medium to large value purchases.\nBitcoin backed banks will solve these problems. They can work like banks did before nationalization of currency. Different banks can have different policies, some more aggressive, some more conservative. Some would be fractional reserve while others may be 100% Bitcoin backed. Interest rates may vary. Cash from some banks may trade at a discount to that from others.</p>\n<p>George Selgin has worked out the theory of competitive free banking in detail, and he argues that such a system would be stable, inflation resistant and self-regulating.</p>\n<p>I believe this will be the ultimate fate of Bitcoin, to be the \u201chigh-powered money\u201d that serves as a reserve currency for banks that issue their own digital cash. Most Bitcoin transactions will occur between banks, to settle net transfers. Bitcoin transactions by private individuals will be as rare as\u2026 well, as Bitcoin based purchases are today.</p>\n</blockquote>\n<p>It\u2019s important for those of us building layers beneath these entities to give them the tools to do their job safely and efficiently, and to build them in such a way that their users can retain the ability to audit and move freely.</p>\n<p>Along with many other things I\u2019ve missed, this implies</p>\n<ul>\n<li>making concise and quick exit to L1 possible when necessary (in response to failures that will likely be correlated), and</li>\n<li>making every day custodial operations safe and simple.</li>\n</ul>",
  "post_number": 1,
  "post_type": 1,
  "posts_count": 6,
  "updated_at": "2023-08-16T15:22:13.243Z",
  "reply_count": 1,
  "reply_to_post_number": null,
  "quote_count": 0,
  "incoming_link_count": 3084,
  "reads": 97,
  "readers_count": 96,
  "score": 15549.4,
  "yours": false,
  "topic_id": 32,
  "topic_slug": "thoughts-on-scaling-and-consensus-changes-2023",
  "topic_title": "Thoughts on scaling and consensus changes (2023)",
  "topic_html_title": "Thoughts on scaling and consensus changes (2023)",
  "category_id": 7,
  "display_username": "James O'Beirne",
  "primary_group_name": null,
  "flair_name": null,
  "flair_url": null,
  "flair_bg_color": null,
  "flair_color": null,
  "flair_group_id": null,
  "badges_granted": [],
  "version": 4,
  "can_edit": false,
  "can_delete": false,
  "can_recover": false,
  "can_see_hidden_post": false,
  "can_wiki": false,
  "user_title": null,
  "bookmarked": false,
  "raw": "Back in June, AJ published an [underread blogpost](https://www.erisian.com.au/wordpress/2023/06/21/putting-the-b-in-btc) about scaling. I\u2019ll do a hasty job of paraphrasing the post --  which you should read in full -- by noting that it hypothesizes that the way that we might scale to **1 billion** users transacting at about **1 tx/week** (which is checking-account volume, my personal target) is by having about 50,000 kinda-sorted-trusted off-chain entities that bear the brunt of most payment volume.\n\nHere I discuss whether I think this is realistic, and if it tells us anything about possible consensus changes.\n\n## Off-chain entities?\n\nIf you wanted to be especially coarse you could just say \u201cbitcoin banks.\u201d Examples of what I mean here are\n\n1. a traditional, federated sidechain like Liquid,\n    - You send your coins to be controlled by some third party, but in return you get more expressive scripting abilities or confidential assets or faster blocks or some combination of all of them.\n    - Drivechains are sort of like this, but the peg-in and -out are mediated by bitcoin miners.\n2. some kind of Chaumian ecash bank like fedimint or cashu,\n    - You send your coins to a federation (or even an individual operator), and you get some privacy benefits.\n3. or some yet-to-be-discovered design that doesn\u2019t hinge on trusting some third party to return your coins (\"peg out\"), instead relying on enforcement via smart contract (i.e. bitcoin script) and a magic sprinkle of *time-sensitivity* on the part of its users. \n    - This is like a [coinpool](https://coinpool.dev) or something vaguely in the direction of [Ark](https://www.arkpill.me/) (which is itself right now just a vague direction).\n    - You could think of this as behaving like the generalization of a lightning channel from 2 parties to `n` parties. It would probably require interactivity across all participants for each payment, but the holy grail would be some design that allows subsets of participants to generate off-chain activity without requiring everyone to sign. Though whether the latter is even possible is an area of ongoing research.\n    - For the purposes of this post, this could even be some kind of [ZKP rollup](https://github.com/john-light/validity-rollups/blob/fecc3433d8e95ab40263db8c2941794e0115d2d5/validity_rollups_on_bitcoin.md) thing - after all, \u201cfraud proof\u201d and \u201cpenalty transaction\u201d seem basically equivalent. (*Edit: John Light [notes](https://twitter.com/lightcoin/status/1691828900748226860) that validity proofs don't require fraud proofs or liveness.)*\n    - We\u2019ll just refer to this thing as \u201ccoinpool\u201d for short.\n\nThere are other options, like [spacechains](https://github.com/RubenSomsen/spacechains), that I won't cover in detail here. \n\nThe last option, this hypothetical coinpool thing, seems clearly preferable since it\u2019s not relying on a third party. But it\u2019s still a hypothetical, and then even if it weren\u2019t (as we\u2019ve seen with lightning) there are operational caveats around actually maintaining a working, live presence that understands a layer 2 protocol and is able to validate new activity and not get sybiled, etc.\n\nEven relative experts aren\u2019t necessarily able to run networked infrastructure that can lose money if it goes offline. It\u2019s a full-time job, probably for multiple people.\n\n## Layer 1: uncomfortable\n\nOkay, so to get back on track here: in our projected scaling scenario, each user holds value with 3 or 4 of these semi-trusted/time-sensitive offchain services that more or less resemble community banks. These \u201cbanks\u201d are probably networked with payment channels (or atomic swappability) so that they can handle cross-bank liquidity operations, like doing the equivalent of wire transfers. I.e. I want to pay you, but we\u2019re at different bitcoin banks, so the entities themselves facilitate some kind of batched settlement over a lightning gateway.\n\nThe quiet part out loud here is that by the time 1 billion people want to use bitcoin, the main chain is very expensive to transact on. Note that I say \u201cvery expensive\u201d and not \u201cimpossibly expensive,\u201d because if users lose the ability to take some form of layer 1 physical custody, bitcoin is just gold with less friction: a paper market will develop and all the nice properties of bitcoin will diminish, as AJ talks about in his post ([link again](https://www.erisian.com.au/wordpress/2023/06/21/putting-the-b-in-btc)).\n\nNote also that part of what keeps these offchain constructions workable is the threat of their depositors somehow interacting with layer 1. Even in the case of some kind of \"trustless\" coinpool thing, *the ability to appeal to layer 1 is what makes it all work*. So if L1 is too expensive to appeal to for most people, the coinpool design doesn\u2019t really work. Maybe among poorer users, that appeal process happens in groups to amortize base layer fees over a set of users.\n\nThese bank things are incentivized to keep operating (and not run away with the money) because (i) they collect fees and (ii?) they may be subject to some kind of local legal jurisdiction. But one of the saving graces here is that the the nature of bitcoin makes it feasible for each customer to also be an auditor.\n\nSo let's assume for simplicity that throwing a transaction on layer 1 costs maybe a few hundred bucks: something many could afford in case there\u2019s a Big Problem with their \u201cbank\u201d and they need to flee to layer 1 bitcoin, but not something everyone can afford, and definitely not something that you'd want to do every month or even every year.\n\n## How we scale?\n\nI think this is roughly what scaling to a billion people looks like for Bitcoin: a constellation of 50,000 networked \u201cbanks,\u201d with (hopefully!) roughly uniform distribution of BTC managed across each bank, and a hub-and-spoke use of a few of those banks at the individual level.\n\nThe alternatives? Can\u2019t just raise the blocksize. Distributing the equivalent of the world\u2019s checking account activity over a network of validating nodes just doesn\u2019t allow you to preserve decentralization.\n\nI truly don\u2019t think that your average person is going to manage a lightning node (directional liquidity and uptime are annoying), and the Phoenix model of a semi-trusted LSP that is by definition a kind of friendly sybil still requires pushing around a UTXO, which isn\u2019t workable at the scale of a billion people. Assuming 41 bytes a UTXO, 1 billion of those things equates to about 380GB just for your UTXO set. This would make timely validation very difficult, although I dunno maybe it's worth some experimentation. [Utreexo](https://bitcoinops.org/en/topics/utreexo/) does help somewhat with this, and would probably be prerequisite to even approaching the problem.\n\nIs the 50,000-\u201dbank\u201d thing  a compromise away from layer 1 ownership? Yes. But UTXO ownership for the entire world -- barring some unforeseen magic, which of course I\u2019m rooting for! -- isn\u2019t in the cards. At least with bitcoin\u2019s technological context, we can have good auditing and custody tools to ensure that fraud is easily detectable and theft is basically impossible.\n\n### Depression pitstop\n\nWhen reading a draft of this post, my wife got kind of depressed right around here. Her macabre question, basically, is: \"if everyone just winds up interacting with sidechains, and not Real Bitcoin, hasn't the whole thing failed? At every point you're dealing with some token that isn't really bitcoin.\"\n\nI think this is an uncomfortable realization, and I don't enjoy it. I hope the conclusion is wrong, and that we come up with some great cryptographic construct that solves the mismatch between decentralized validatability and volume, but I don't think we should plan for that. \n\nEven if this is how things pan out, I think it might sound worse than it is. The win over the existing financial regime is that we still get a base-layer money that can't be inflated. A particular bank might attempt some mischief, but bitcoin-native software tools make trust into a finer gradient, and they ensure the mischief will be much more readily evident (Proof of Reserves?) and in certain cases relative to the legacy system, just impossible (DLCs disintermediating brokers? collaborative custody? onchain observability?).\n\n\n\nSo, assuming you\u2019re willing to entertain these broad strokes, this architectural target gives us a few hints about bitcoin development in the short- to mid-term.\n\n## Design for exit\n\nBecause we\u2019re probably going to see a few dominant second layer (\u201cbank\u201d) designs emerge, we have to account for correlated failure. While reviewing this article, [Rijndael](https://twitter.com/rot13maxi) referred to this as \"the thundering herd.\"\n\nTake for example the [lnd fiasco(s)](https://github.com/btcsuite/btcd/issues/1906) within the last year that could have caused mass channel closures amongst lnd nodes. Once a few workable L2 designs come into common use, the probability of a mass exit event goes up, making this seem like a crucial usecase to plan for.\n\nBecause layer 1 space is scarce, we need to be able to pack all the exits we can into some timespan of blocks. The way to do this seems to be decoupling the actions \u201cget out\u201d from \u201cactually reclaim your funds\u201d (i.e. create new UTXOs) so that we can facilitate a timely exit for as many participants as possible. This is more or less congestion control, an idea largely pioneered by [Jeremy Rubin](https://rubin.io) during the mid-days of CTV development.\n\nLocking funds for later claim to a prespecified path (or set of paths) should be made as concise as possible so that in times of cataclysm, we can pack in as many exit transactions as possible.\n\nFor a case like this, I don\u2019t think you can get more concise than the bare script `<32 byte hash> OP_CHECKTEMPLATEVERIFY`.\n\nIt\u2019s worth noting that a P2TR scriptPubKey is the same size (`OP_1 <32 byte pubkey>`), but then actually spending that coin comes with 17vB overhead (= `(34vB (controlblock) + 33vB (CTV script)) / 4`). If you\u2019re trying to fill a block with 2-in-1-out CTV unrolls, this could be about 10% overhead.\n\nThe burden of this overhead decreases as you add inputs or outputs of course, so \u201cbatch\u201d unrolls for multiple users won\u2019t benefit as much from bare script CTVs (vs. P2TR script paths). But the most common use-case these days would be lightning channel closes, which are 1-in-2-out.\n\nThere are rival proposals to CTV that are more flexible, like `OP_TX`/`OP_TXHASH` and others, but in a correlated crisis requiring mass exit from an L2, flexibility isn\u2019t what\u2019s needed - judicious use of layer 1 is. So whether or not `OP_TX` et al. are good for other things (I don't know of any usecases?), I think CTV is needed simply because it is the most concise way to articulate exit from a contract on-chain at a time when blockspace might be precious.\n\nPer some basic analysis, using CTV's spend compression (congestion control), you'd be able to pack in [~33% more lightning closes](https://github.com/jamesob/verystable/blob/18a57207fe4fc106c4befaffc1784b012afc696c/examples/txn_size.py) into a block in times of crisis:\n\n```shell\nsrc/verystable (init 18a5720) % python examples/txn_size.py\nCTV txn: 128vB\nnon-CTV txn: 171vB\nCTV txns per block: 31250\nnon-CTV txns per block: 23391\nmore per block with CTV: 33.6%\n```\n\n## Bomb-proof custody patterns\n\nThe other observation that comes to mind is if there are going to be ~50,000 entities managing large sums of bitcoin each, many of them perhaps managed by federated signers, there need to be relatively straightfoward custodial patterns that let us be pretty sure that theft or loss is out of the question.\n\nIt shouldn\u2019t come as a surprise that I think the functionality in [`OP_VAULT`](https://github.com/jamesob/bips/blob/e2ff23b3f07215450e75779f7f944d24660a9d47/bip-0345.mediawiki) is an important piece here, because it enables \u201creactive security.\u201d As Jameson Lopp [says](https://blog.keys.casa/why-bitcoin-needs-covenants/):\n\n>With the right tools, we can be *reactive* rather than only *proactive* with regard to recovering from key compromises.\n>\n>Vaults allow for the creation of a new set of game theory. Similar to how you can run watchtowers to look out for a Lightning channel counterparty trying to cheat you, you would be able to run a watchtower to make sure no one has compromised your bitcoin vault. If you find that a compromise has occurred, sweeping the funds to safety is simple enough that you can automate it!\n>\n> It is my sincere belief that every bitcoin self-custody user and every wallet developer should be salivating over the prospect of user-friendly vault functionality. The ability to \"claw back\" funds that have been lost due to a compromised security architecture means that bitcoiners can sleep more peacefully at night, knowing that they can be fallible, make mistakes, and not have to suffer from catastrophic loss due to a single oversight.\n\nI think that vaults that are enforced on-chain are probably a necessary part of successfully scaling custody to a large number of collaboratively managed pools of bitcoin. And `OP_VAULT` seems like the most chainspace-efficient way to do this. You can maybe emulate `OP_VAULT`'s behavior with, say, [MATT](https://merkle.fun/). But I think the point above about CTV and congestion control tells us that common operations should be made as efficient as possible ([CISC-like](https://www.baeldung.com/cs/risc-vs-cisc)).\n\nObviously there are a lot of parameters to be decided, e.g.\n- who manages a watchtower, and how much do they know?\n- what does recovery look like: highly secure/inconvenient keys, social recovery, or some time-decayed composition of both?\n\nand I\u2019m sure others. But I don\u2019t think we can rely on proactive security to get 50,000 entities feeling good about putting a lot of capital on the line in an automated way. Even if you could template out some standard array of HSMs, the supply chain attacks (both from hardware and software) seem too feasible.\n\n\n## Other stuff\n\nOf course I'm leaving a lot out here. Stuff that isn't related to covenants per se, but is essential to allowing time-sensitive L2 protocols to actually work, like good mempool/fee management policy. Lightning is going to fall down without that work. And stuff that just lets Bitcoin work in a censorship resistant way, like BIP324.\n\nSomeone should also work on fleshing out a \"minimum viable coinpool,\" and figure out if we need primitives above and beyond taproot and CTV. That would be valuable info.\n\n## Conclusion\n\nThis article is already long enough, and there will probably be subsequent writings from me that either build on this or respond to posts from others using this lens.\n\nI think barring some kind of magical development, which I\u2019m not counting on, the way that we wind up scaling bitcoin to handle checking-account volume is with something on the order of 50,000 entities that manage/risk pools of capital to facilitate payment flows. These entities would be networked, probably with lightning, and will offer a gradation of trust. \"Osmotic\" pressure from the threat of withdrawal to L1 or opposing financial entities will discipline these things into behaving, almost certainly with some bumps along the way.\n\nAs [Hal said in 2010](https://bitcointalk.org/index.php?topic=2500.msg34211#msg34211):\n\n> Actually there is a very good reason for Bitcoin-backed banks to exist, issuing their own digital cash currency, redeemable for bitcoins. Bitcoin itself cannot scale to have every single financial transaction in the world be broadcast to everyone and included in the block chain. There needs to be a secondary level of payment systems which is lighter weight and more efficient. Likewise, the time needed for Bitcoin transactions to finalize will be impractical for medium to large value purchases.\n> Bitcoin backed banks will solve these problems. They can work like banks did before nationalization of currency. Different banks can have different policies, some more aggressive, some more conservative. Some would be fractional reserve while others may be 100% Bitcoin backed. Interest rates may vary. Cash from some banks may trade at a discount to that from others.\n> \n> George Selgin has worked out the theory of competitive free banking in detail, and he argues that such a system would be stable, inflation resistant and self-regulating.\n> \n> I believe this will be the ultimate fate of Bitcoin, to be the \"high-powered money\" that serves as a reserve currency for banks that issue their own digital cash. Most Bitcoin transactions will occur between banks, to settle net transfers. Bitcoin transactions by private individuals will be as rare as... well, as Bitcoin based purchases are today.\n\nIt\u2019s important for those of us building layers beneath these entities to give them the tools to do their job safely and efficiently, and to build them in such a way that their users can retain the ability to audit and move freely.\n\nAlong with many other things I\u2019ve missed, this implies \n- making concise and quick exit to L1 possible when necessary (in response to failures that will likely be correlated), and \n- making every day custodial operations safe and simple.",
  "actions_summary": [
    {
      "id": 2,
      "count": 6
    }
  ],
  "moderator": false,
  "admin": false,
  "staff": false,
  "user_id": 9,
  "hidden": false,
  "trust_level": 3,
  "deleted_at": null,
  "user_deleted": false,
  "edit_reason": null,
  "can_view_edit_history": true,
  "wiki": false,
  "excerpt": "Back in June, AJ published an <a href=\"https://www.erisian.com.au/wordpress/2023/06/21/putting-the-b-in-btc\">underread blogpost</a> about scaling. I\u2019ll do a hasty job of paraphrasing the post \u2013  which you should read in full \u2013 by noting that it hypothesizes that the way that we might scale to 1 billion users transacting at about 1 tx/week (which is checking-account volume, my pers&hellip;",
  "truncated": true,
  "post_url": "/t/thoughts-on-scaling-and-consensus-changes-2023/32/1",
  "reactions": [
    {
      "id": "+1",
      "type": "emoji",
      "count": 3
    },
    {
      "id": "heart",
      "type": "emoji",
      "count": 2
    },
    {
      "id": "clap",
      "type": "emoji",
      "count": 1
    }
  ],
  "current_user_reaction": null,
  "reaction_users_count": 6,
  "current_user_used_main_reaction": false,
  "can_accept_answer": false,
  "can_unaccept_answer": false,
  "accepted_answer": false,
  "topic_accepted_answer": null,
  "can_vote": false
}