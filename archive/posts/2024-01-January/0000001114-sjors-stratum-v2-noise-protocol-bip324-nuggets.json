{
  "id": 1114,
  "name": "Sjors Provoost",
  "username": "sjors",
  "avatar_template": "/user_avatar/delvingbitcoin.org/sjors/{size}/59_2.png",
  "created_at": "2024-01-15T13:45:11.198Z",
  "cooked": "<p>The Stratum v2 <a href=\"https://github.com/stratum-mining/sv2-spec\">specification</a> introduces a <a href=\"https://github.com/stratum-mining/sv2-spec/blob/73ec7a6f52924b061386272707da0f692f8dea66/04-Protocol-Security.md\">protocol</a> for its end-to-end encrypted communication based on the <a href=\"https://github.com/stratum-mining/sv2-spec/blob/73ec7a6f52924b061386272707da0f692f8dea66/04-Protocol-Security.md\">Noise Protocol Framework</a>.</p>\n<p>It uses cryptographic primitives that were picked to make integration into Bitcoin Core easier. Bitcoin Core plays the Template Provider role as part of the <a href=\"https://github.com/stratum-mining/sv2-spec/blob/73ec7a6f52924b061386272707da0f692f8dea66/07-Template-Distribution-Protocol.md\">Template Distribution protocol</a>. There is a <a href=\"https://github.com/bitcoin/bitcoin/pull/28983\">draft PR</a> to Bitcoin Core to implement this role, that yours truly took over.</p>\n<p>Although the protocol is similar to <a href=\"https://github.com/bitcoin/bips/blob/deae64bfd31f6938253c05392aa355bf6d7e7605/bip-0324.mediawiki\">BIP324</a> peer-to-peer encryption, the spec was written earlier. Stratum v2 can\u2019t switch over to BIP324 for the time being, because:</p>\n<ol>\n<li>Sunk cost / momentum</li>\n<li>Server authentication (sending work to the right pool)</li>\n<li>Message routing (this part is not very clear to me, but it <em>may</em> be useful for proxies to forward messages to and from individual mining machines based on the <code>channel_id</code> field in the header, without having to decrypt the payload)</li>\n</ol>\n<p>Issue (2) may be addressed in the longer run with an authentication extension to BIP324.</p>\n<p>Issue (3) - if it actually matters - may be more difficult to address, because BIP324 splits messages differently: the length is encrypted in 3 bytes, followed by a single blob with both header and payload.</p>\n<p>Despite (1) I believe there\u2019s still some room to tweak the Stratum v2 spec. So my question to you all is: which little nuggets from BIP324 could be ported over?</p>\n<p>I\u2019m looking for potential improvements that don\u2019t require sv2 implementers to do any drastic overhaul. At the same time these changes might make a future transition to BIP324 easier.</p>\n<p>Things that already the same (AFAIK):</p>\n<ol>\n<li>The use of ChaCha20 and Poly1305 in AEAD mode</li>\n<li>The use of sha256 to mix keys</li>\n</ol>\n<p>Perhaps easy to implement:</p>\n<ol>\n<li>Use tagged hashes</li>\n</ol>\n<p>Slightly more difficult to implement:</p>\n<ol start=\"2\">\n<li>Use EllSwift encoding and ECDH: <a href=\"https://github.com/stratum-mining/sv2-spec/pull/66\" class=\"inline-onebox\">RFC: Use EllSwift for ECDH by Sjors \u00b7 Pull Request #66 \u00b7 stratum-mining/sv2-spec \u00b7 GitHub</a></li>\n</ol>\n<p>Initially I didn\u2019t want to propose (2), but it turned about implementations were not actually following the spec when it came to ECDH, so it might be worth changing the spec to remove the ambiguity.</p>\n<p>This rest of this list is so small it\u2019s probably not worth bothering.</p>",
  "post_number": 1,
  "post_type": 1,
  "updated_at": "2024-01-15T13:54:13.031Z",
  "reply_count": 0,
  "reply_to_post_number": null,
  "quote_count": 0,
  "incoming_link_count": 1,
  "reads": 15,
  "readers_count": 14,
  "score": 7.8,
  "yours": false,
  "topic_id": 413,
  "topic_slug": "stratum-v2-noise-protocol-bip324-nuggets",
  "topic_title": "Stratum v2 Noise Protocol: BIP324 nuggets?",
  "topic_html_title": "Stratum v2 Noise Protocol: BIP324 nuggets?",
  "category_id": 7,
  "display_username": "Sjors Provoost",
  "primary_group_name": null,
  "flair_name": null,
  "flair_url": null,
  "flair_bg_color": null,
  "flair_color": null,
  "flair_group_id": null,
  "version": 2,
  "can_edit": false,
  "can_delete": false,
  "can_recover": false,
  "can_see_hidden_post": false,
  "can_wiki": false,
  "user_title": null,
  "bookmarked": false,
  "raw": "The Stratum v2 [specification](https://github.com/stratum-mining/sv2-spec) introduces a [protocol](https://github.com/stratum-mining/sv2-spec/blob/73ec7a6f52924b061386272707da0f692f8dea66/04-Protocol-Security.md) for its end-to-end encrypted communication based on the [Noise Protocol Framework](https://github.com/stratum-mining/sv2-spec/blob/73ec7a6f52924b061386272707da0f692f8dea66/04-Protocol-Security.md).\n\nIt uses cryptographic primitives that were picked to make integration into Bitcoin Core easier. Bitcoin Core plays the Template Provider role as part of the [Template Distribution protocol](https://github.com/stratum-mining/sv2-spec/blob/73ec7a6f52924b061386272707da0f692f8dea66/07-Template-Distribution-Protocol.md). There is a [draft PR](https://github.com/bitcoin/bitcoin/pull/28983) to Bitcoin Core to implement this role, that yours truly took over.\n\nAlthough the protocol is similar to [BIP324](https://github.com/bitcoin/bips/blob/deae64bfd31f6938253c05392aa355bf6d7e7605/bip-0324.mediawiki) peer-to-peer encryption, the spec was written earlier. Stratum v2 can't switch over to BIP324 for the time being, because:\n\n1. Sunk cost / momentum\n2. Server authentication (sending work to the right pool)\n3. Message routing (this part is not very clear to me, but it _may_ be useful for proxies to forward messages to and from individual mining machines based on the `channel_id` field in the header, without having to decrypt the payload)\n\nIssue (2) may be addressed in the longer run with an authentication extension to BIP324.\n\nIssue (3) - if it actually matters - may be more difficult to address, because BIP324 splits messages differently: the length is encrypted in 3 bytes, followed by a single blob with both header and payload.\n\nDespite (1) I believe there's still some room to tweak the Stratum v2 spec. So my question to you all is: which little nuggets from BIP324 could be ported over?\n\nI'm looking for potential improvements that don't require sv2 implementers to do any drastic overhaul. At the same time these changes might make a future transition to BIP324 easier.\n\nThings that already the same (AFAIK):\n\n1. The use of ChaCha20 and Poly1305 in AEAD mode\n2. The use of sha256 to mix keys\n\nPerhaps easy to implement:\n\n1. Use tagged hashes\n\nSlightly more difficult to implement:\n\n2. Use EllSwift encoding and ECDH: https://github.com/stratum-mining/sv2-spec/pull/66 \n\nInitially I didn't want to propose (2), but it turned about implementations were not actually following the spec when it came to ECDH, so it might be worth changing the spec to remove the ambiguity.\n\nThis rest of this list is so small it's probably not worth bothering.",
  "actions_summary": [],
  "moderator": false,
  "admin": false,
  "staff": false,
  "user_id": 71,
  "hidden": false,
  "trust_level": 3,
  "deleted_at": null,
  "user_deleted": false,
  "edit_reason": "Github link was replaced with a permanent link",
  "can_view_edit_history": true,
  "wiki": false,
  "reactions": [],
  "current_user_reaction": null,
  "reaction_users_count": 0,
  "current_user_used_main_reaction": false
}