{
  "id": 1185,
  "name": "Bastien Teinturier",
  "username": "t-bast",
  "avatar_template": "/user_avatar/delvingbitcoin.org/t-bast/{size}/98_2.png",
  "created_at": "2024-01-18T14:31:34.683Z",
  "cooked": "<aside class=\"quote no-group\" data-username=\"morehouse\" data-post=\"12\" data-topic=\"418\">\n<div class=\"title\">\n<div class=\"quote-controls\"></div>\n<img loading=\"lazy\" alt=\"\" width=\"24\" height=\"24\" src=\"https://delvingbitcoin.org/letter_avatar_proxy/v4/letter/m/df705f/48.png\" class=\"avatar\"> morehouse:</div>\n<blockquote>\n<p>I think v3 also prevents MitM pinning attacks where someone extracts the <code>SIGHASH_SINGLE | SIGHASH_ANYONECANPAY</code> signature and uses it to construct and pin a low feerate conflicting transaction.</p>\n</blockquote>\n</aside>\n<p>Can you explain that? I don\u2019t see how someone can do anything with the <code>SIGHASH_SINGLE | SIGHASH_ANYONECANPAY</code> signature extracted from the witness, as it\u2019s not sufficient to spend the output, they also need a second signature from the owner of the HTLC tx, which will be using <code>SIGHASH_ALL</code>?</p>\n<aside class=\"quote no-group\" data-username=\"morehouse\" data-post=\"12\" data-topic=\"418\">\n<div class=\"title\">\n<div class=\"quote-controls\"></div>\n<img loading=\"lazy\" alt=\"\" width=\"24\" height=\"24\" src=\"https://delvingbitcoin.org/letter_avatar_proxy/v4/letter/m/df705f/48.png\" class=\"avatar\"> morehouse:</div>\n<blockquote>\n<p>Because Mallory\u2019s preimage spend can opt out of v3 policy, she is able to pin her transaction in mempools while preventing Alice from learning the preimage or confirming her HTLC-timeout transaction.</p>\n</blockquote>\n</aside>\n<p>True, that\u2019s another pinning attack (that ariard described a while ago if I remember correctly). I\u2019m not sure this one needs to be fixed by v3 though. When we discussed it a long time ago, we realized that:</p>\n<ul>\n<li>the attacked node doesn\u2019t necessarily need their HTLC-timeout tx to confirm: if they learn the preimage, they don\u2019t need to claim the output at all</li>\n<li>the attacker is taking some risk, because the attacked node can potentially still learn the preimage <strong>and</strong> get their HTLC-timeout confirmed, in which case the attacker is losing money</li>\n<li>a simple preimage gossip mechanism over lightning would fix that</li>\n<li>a mechanism in bitcoind that would let us inspect conflicting peer transactions to potentially extract the preimage would also fix that</li>\n</ul>\n<p>I don\u2019t think we should go down the rabbit hole of trying to exchange signatures to require a 2nd-stage HTLC transaction when spending from the remote commit: we simply cannot do this with the current <code>commit_sig</code> / <code>revoke_and_ack</code> protocol, as there\u2019s a chicken-and-egg issue where you don\u2019t know beforehand what you should be signing (we had the same issue when investigating that change for liquidity ads: <a href=\"https://lists.linuxfoundation.org/pipermail/lightning-dev/2023-November/004219.html\" class=\"inline-onebox\">[Lightning-dev] Liquidity Ads: Updated Spec Posted,\tplease review</a>)</p>\n<aside class=\"quote no-group\" data-username=\"instagibbs\" data-post=\"13\" data-topic=\"418\">\n<div class=\"title\">\n<div class=\"quote-controls\"></div>\n<img loading=\"lazy\" alt=\"\" width=\"24\" height=\"24\" src=\"https://delvingbitcoin.org/user_avatar/delvingbitcoin.org/instagibbs/48/28_2.png\" class=\"avatar\"> instagibbs:</div>\n<blockquote>\n<p>Huh! I hadn\u2019t considered the fact that <em>revoked</em> states would allow <em>HLTC-Timeout paths</em> to create pins.</p>\n</blockquote>\n</aside>\n<p>Can you describe that in more details? I don\u2019t see what issue you\u2019re referring to. If Bob broadcasts a revoked commitment, it cannot pin it while it\u2019s unconfirmed because that revoked commitment is using v3. Once the revoked commitment is confirmed, Bob can only spend the HTLC outputs via a pre-signed HTLC tx, whose output also contains a revocation path that Alice will be able to claim? So in the end Alice will get all the funds?</p>\n<aside class=\"quote no-group\" data-username=\"ajtowns\" data-post=\"14\" data-topic=\"418\">\n<div class=\"title\">\n<div class=\"quote-controls\"></div>\n<img loading=\"lazy\" alt=\"\" width=\"24\" height=\"24\" src=\"https://delvingbitcoin.org/user_avatar/delvingbitcoin.org/ajtowns/48/3_2.png\" class=\"avatar\"> ajtowns:</div>\n<blockquote>\n<p>In either case, she probably doesn\u2019t need to use any confirmed funds, as she can pay the on-chain fees directly from her channel balance immediately.</p>\n</blockquote>\n</aside>\n<p>Yes, that is a very nice benefit of the v3 change! Being able to pay the on-chain fees directly from the channel balance is a very important but often overlooked improvement in my opinion.</p>",
  "post_number": 17,
  "post_type": 1,
  "updated_at": "2024-01-18T14:31:34.683Z",
  "reply_count": 1,
  "reply_to_post_number": 13,
  "quote_count": 3,
  "incoming_link_count": 5,
  "reads": 9,
  "readers_count": 8,
  "score": 31.8,
  "yours": false,
  "topic_id": 418,
  "topic_slug": "lightning-transactions-with-v3-and-ephemeral-anchors",
  "topic_title": "Lightning transactions with v3 and ephemeral anchors",
  "topic_html_title": "Lightning transactions with v3 and ephemeral anchors",
  "category_id": 7,
  "display_username": "Bastien Teinturier",
  "primary_group_name": null,
  "flair_name": null,
  "flair_url": null,
  "flair_bg_color": null,
  "flair_color": null,
  "flair_group_id": null,
  "version": 1,
  "can_edit": false,
  "can_delete": false,
  "can_recover": false,
  "can_see_hidden_post": false,
  "can_wiki": false,
  "user_title": null,
  "bookmarked": false,
  "raw": "[quote=\"morehouse, post:12, topic:418\"]\nI think v3 also prevents MitM pinning attacks where someone extracts the `SIGHASH_SINGLE | SIGHASH_ANYONECANPAY` signature and uses it to construct and pin a low feerate conflicting transaction.\n[/quote]\n\nCan you explain that? I don't see how someone can do anything with the `SIGHASH_SINGLE | SIGHASH_ANYONECANPAY` signature extracted from the witness, as it's not sufficient to spend the output, they also need a second signature from the owner of the HTLC tx, which will be using `SIGHASH_ALL`?\n\n[quote=\"morehouse, post:12, topic:418\"]\nBecause Mallory\u2019s preimage spend can opt out of v3 policy, she is able to pin her transaction in mempools while preventing Alice from learning the preimage or confirming her HTLC-timeout transaction.\n[/quote]\n\nTrue, that's another pinning attack (that ariard described a while ago if I remember correctly). I'm not sure this one needs to be fixed by v3 though. When we discussed it a long time ago, we realized that:\n\n- the attacked node doesn't necessarily need their HTLC-timeout tx to confirm: if they learn the preimage, they don't need to claim the output at all\n- the attacker is taking some risk, because the attacked node can potentially still learn the preimage **and** get their HTLC-timeout confirmed, in which case the attacker is losing money\n- a simple preimage gossip mechanism over lightning would fix that\n- a mechanism in bitcoind that would let us inspect conflicting peer transactions to potentially extract the preimage would also fix that\n\nI don't think we should go down the rabbit hole of trying to exchange signatures to require a 2nd-stage HTLC transaction when spending from the remote commit: we simply cannot do this with the current `commit_sig` / `revoke_and_ack` protocol, as there's a chicken-and-egg issue where you don't know beforehand what you should be signing (we had the same issue when investigating that change for liquidity ads: https://lists.linuxfoundation.org/pipermail/lightning-dev/2023-November/004219.html)\n\n[quote=\"instagibbs, post:13, topic:418\"]\nHuh! I hadn\u2019t considered the fact that *revoked* states would allow *HLTC-Timeout paths* to create pins.\n[/quote]\n\nCan you describe that in more details? I don't see what issue you're referring to. If Bob broadcasts a revoked commitment, it cannot pin it while it's unconfirmed because that revoked commitment is using v3. Once the revoked commitment is confirmed, Bob can only spend the HTLC outputs via a pre-signed HTLC tx, whose output also contains a revocation path that Alice will be able to claim? So in the end Alice will get all the funds?\n\n[quote=\"ajtowns, post:14, topic:418\"]\nIn either case, she probably doesn\u2019t need to use any confirmed funds, as she can pay the on-chain fees directly from her channel balance immediately.\n[/quote]\n\nYes, that is a very nice benefit of the v3 change! Being able to pay the on-chain fees directly from the channel balance is a very important but often overlooked improvement in my opinion.",
  "actions_summary": [],
  "moderator": false,
  "admin": false,
  "staff": false,
  "user_id": 101,
  "hidden": false,
  "trust_level": 3,
  "deleted_at": null,
  "user_deleted": false,
  "edit_reason": null,
  "can_view_edit_history": true,
  "wiki": false,
  "reactions": [],
  "current_user_reaction": null,
  "reaction_users_count": 0,
  "current_user_used_main_reaction": false
}