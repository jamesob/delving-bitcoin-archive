{
  "id": 1092,
  "name": "Chris Stewart",
  "username": "Chris_Stewart_5",
  "avatar_template": "/letter_avatar_proxy/v4/letter/c/da6949/{size}.png",
  "created_at": "2024-01-12T16:08:37.259Z",
  "cooked": "<p>Hi all,</p>\n<p><a href=\"https://delvingbitcoin.org/t/64-bit-arithmetic-soft-fork/397/18\">I currently have another consensus proposal to add 64bit arithmetic op codes to the Script Interpreter</a>. It has been suggested that an optimal way to deploy this feature is with a new taproot leaf version.</p>\n<p>I have been unable to find any examples in draft consensus PRs on github of deploying <em>new</em> leaf versions (please link me if they exist!). This post is intended to talk about what different leaf versions implemented in the interpreter would look like.</p>\n<p><a href=\"https://github.com/bitcoin/bips/blob/deae64bfd31f6938253c05392aa355bf6d7e7605/bip-0341.mediawiki#cite_note-7\" rel=\"noopener nofollow ugc\">From BIP341</a></p>\n<blockquote>\n<p><strong><a href=\"https://github.com/bitcoin/bips/blob/deae64bfd31f6938253c05392aa355bf6d7e7605/bip-0341.mediawiki#cite_ref-7-0\" rel=\"noopener nofollow ugc\">^</a></strong> <strong>What constraints are there on the leaf version?</strong> First, the leaf version cannot be odd as <em>c[0] &amp; 0xfe</em> will always be even, and cannot be <em>0x50</em> as that would result in ambiguity with the annex. In addition, in order to support some forms of static analysis that rely on being able to identify script spends without access to the output being spent, it is recommended to avoid using any leaf versions that would conflict with a valid first byte of either a valid P2WPKH pubkey or a valid P2WSH script (that is, both <em>v</em> and <em>v | 1</em> should be an undefined, invalid or disabled opcode or an opcode that is not valid as the first opcode). The values that comply to this rule are the 32 even values between <em>0xc0</em> and <em>0xfe</em> and also <em>0x66</em>, <em>0x7e</em>, <em>0x80</em>, <em>0x84</em>, <em>0x96</em>, <em>0x98</em>, <em>0xba</em>, <em>0xbc</em>, <em>0xbe</em>. Note also that this constraint implies that leaf versions should be shared amongst different witness versions, as knowing the witness version requires access to the output being spent.</p>\n</blockquote>\n<p>Lets arbitrarily choose <code>0x66</code> as our leaf version.</p>\n<p>My understanding it is capable to alter the <em>interpretation of op codes</em> in <code>interpreter.cpp</code> based on what the leaf version is.</p>\n<p>Here is my toy example. I decided to disable OP_CHECKSIGADD for leaf version <code>0x66</code> in my code. Setting aside the functionality of this new leaf version (i\u2019m not advocating for disabling OP_CSA), is this how new leaf versions were intended to be used?</p>\n<aside class=\"onebox githubfolder\" data-onebox-src=\"https://github.com/Christewart/bitcoin/tree/2024-01-12-new-tapleaf-ver-example\">\n  <header class=\"source\">\n      <img src=\"https://github.githubassets.com/favicons/favicon.svg\" class=\"site-icon\" width=\"32\" height=\"32\">\n\n      <a href=\"https://github.com/Christewart/bitcoin/tree/2024-01-12-new-tapleaf-ver-example\" target=\"_blank\" rel=\"noopener nofollow ugc\">github.com</a>\n  </header>\n\n  <article class=\"onebox-body\">\n    <h3><a href=\"https://github.com/Christewart/bitcoin/tree/2024-01-12-new-tapleaf-ver-example\" target=\"_blank\" rel=\"noopener nofollow ugc\">GitHub - Christewart/bitcoin at 2024-01-12-new-tapleaf-ver-example</a></h3>\n\n  <p><a href=\"https://github.com/Christewart/bitcoin/tree/2024-01-12-new-tapleaf-ver-example\" target=\"_blank\" rel=\"noopener nofollow ugc\">2024-01-12-new-tapleaf-ver-example</a></p>\n\n  <p><span class=\"label1\">Bitcoin Core integration/staging tree. Contribute to Christewart/bitcoin development by creating an account on GitHub.</span></p>\n\n  </article>\n\n  <div class=\"onebox-metadata\">\n    \n    \n  </div>\n\n  <div style=\"clear: both\"></div>\n</aside>\n",
  "post_number": 1,
  "post_type": 1,
  "updated_at": "2024-01-12T16:14:14.980Z",
  "reply_count": 0,
  "reply_to_post_number": null,
  "quote_count": 0,
  "incoming_link_count": 0,
  "reads": 15,
  "readers_count": 14,
  "score": 3.0,
  "yours": false,
  "topic_id": 406,
  "topic_slug": "deploying-new-taproot-leaf-versions",
  "topic_title": "Deploying new taproot leaf versions",
  "topic_html_title": "Deploying new taproot leaf versions",
  "category_id": 7,
  "display_username": "Chris Stewart",
  "primary_group_name": null,
  "flair_name": null,
  "flair_url": null,
  "flair_bg_color": null,
  "flair_color": null,
  "flair_group_id": null,
  "version": 2,
  "can_edit": false,
  "can_delete": false,
  "can_recover": false,
  "can_see_hidden_post": false,
  "can_wiki": false,
  "user_title": null,
  "bookmarked": false,
  "raw": "Hi all,\n\n[I currently have another consensus proposal to add 64bit arithmetic op codes to the Script Interpreter](https://delvingbitcoin.org/t/64-bit-arithmetic-soft-fork/397/18). It has been suggested that an optimal way to deploy this feature is with a new taproot leaf version. \n\nI have been unable to find any examples in draft consensus PRs on github of deploying _new_ leaf versions (please link me if they exist!). This post is intended to talk about what different leaf versions implemented in the interpreter would look like. \n\n[From BIP341](https://github.com/bitcoin/bips/blob/deae64bfd31f6938253c05392aa355bf6d7e7605/bip-0341.mediawiki#cite_note-7)\n\n> **[^](https://github.com/bitcoin/bips/blob/deae64bfd31f6938253c05392aa355bf6d7e7605/bip-0341.mediawiki#cite_ref-7-0)** **What constraints are there on the leaf version?** First, the leaf version cannot be odd as *c[0] & 0xfe* will always be even, and cannot be *0x50* as that would result in ambiguity with the annex. In addition, in order to support some forms of static analysis that rely on being able to identify script spends without access to the output being spent, it is recommended to avoid using any leaf versions that would conflict with a valid first byte of either a valid P2WPKH pubkey or a valid P2WSH script (that is, both *v* and *v | 1* should be an undefined, invalid or disabled opcode or an opcode that is not valid as the first opcode). The values that comply to this rule are the 32 even values between *0xc0* and *0xfe* and also *0x66*, *0x7e*, *0x80*, *0x84*, *0x96*, *0x98*, *0xba*, *0xbc*, *0xbe*. Note also that this constraint implies that leaf versions should be shared amongst different witness versions, as knowing the witness version requires access to the output being spent.\n\nLets arbitrarily choose `0x66` as our leaf version.\n\nMy understanding it is capable to alter the _interpretation of op codes_ in `interpreter.cpp` based on what the leaf version is. \n\nHere is my toy example. I decided to disable OP_CHECKSIGADD for leaf version `0x66` in my code. Setting aside the functionality of this new leaf version (i'm not advocating for disabling OP_CSA), is this how new leaf versions were intended to be used?\n\nhttps://github.com/Christewart/bitcoin/tree/2024-01-12-new-tapleaf-ver-example",
  "actions_summary": [],
  "moderator": false,
  "admin": false,
  "staff": false,
  "user_id": 193,
  "hidden": false,
  "trust_level": 1,
  "deleted_at": null,
  "user_deleted": false,
  "edit_reason": "Github link was replaced with a permanent link",
  "can_view_edit_history": true,
  "wiki": false,
  "reactions": [],
  "current_user_reaction": null,
  "reaction_users_count": 0,
  "current_user_used_main_reaction": false
}