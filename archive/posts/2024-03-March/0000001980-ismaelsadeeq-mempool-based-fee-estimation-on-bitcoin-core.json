{
  "id": 1980,
  "name": "Abubakar Sadiq Ismail",
  "username": "ismaelsadeeq",
  "avatar_template": "/user_avatar/delvingbitcoin.org/ismaelsadeeq/{size}/151_2.png",
  "created_at": "2024-03-21T14:45:24.061Z",
  "cooked": "<h4><a name=\"mempool-based-fee-estimation-in-bitcoin-core-1\" class=\"anchor\" href=\"#mempool-based-fee-estimation-in-bitcoin-core-1\"></a>Mempool-Based Fee Estimation in Bitcoin Core</h4>\n<p>A Node can get a fee estimate by generating a block template from mempool transactions, using the fee rate of the transaction/package at the 50th percentile[0] of the generated block weight as the fee rate estimate <code>k</code> for the next block.</p>\n<p>Creating a new transaction/package with the same fee rate as <code>k</code> will align it with transactions/packages in the block template and will likely be included in the next block when propagated in the network.</p>\n<h4><a name=\"relevance-of-mempool-based-fee-estimation-2\" class=\"anchor\" href=\"#relevance-of-mempool-based-fee-estimation-2\"></a>Relevance of mempool-based fee estimation.</h4>\n<ul>\n<li>\n<p>It is assumed that most miners are generating block templates they intend to mine next from their node\u2019s mempool[1]. Hence placing a bid using mempool-based fee estimation puts the transaction/package in the same rank as the transactions/package in the block template miners are processing and will most likely be included in the block.\nAs such, if your mempool is roughly in sync with miners this is the most accurate method of ensuring your transaction gets mined in the next block.</p>\n</li>\n<li>\n<p>It quickly reacts to changing conditions when the mempool is full due to high block confirmation time or the user\u2019s mempool becomes shallow.</p>\n</li>\n</ul>\n<h4><a name=\"instances-where-mempool-based-fee-estimation-falls-short-3\" class=\"anchor\" href=\"#instances-where-mempool-based-fee-estimation-falls-short-3\"></a>Instances where mempool-based fee estimation falls short.</h4>\n<ul>\n<li>\n<p>When a node\u2019s mempool diverges with the network miners\u2019 mempool, assumptions will be wrong and lead to inaccurate results.</p>\n<ul>\n<li>This will happen due to the policy rules[2] of the node.</li>\n<li>The peers connected to a node, i.e. how well connected the node is in the network to get information on all the transactions being broadcasted in the network.</li>\n</ul>\n</li>\n<li>\n<p>If miners are accepting most of the transactions they mine via other means than the P2P network, users\u2019 mempool will not be roughly the same as miners.</p>\n</li>\n<li>\n<p>The mempool-based fee estimate for confirmation target &gt; 1 is unreliable due to mempool changing conditions.\nWhen the confirmation target is &gt; 1 block in the future the mempool conditions will likely change e.g. high confirmation time, high demand for block space. Assertions made on the miner\u2019s block template previously will not hold.</p>\n</li>\n<li>\n<p>The node might be accepting some transactions that miners might not accept into their mempool due node\u2019s lax policy rules[2] and this will mess with their estimate.</p>\n</li>\n</ul>\n<h4><a name=\"how-do-we-know-if-a-nodes-mempool-aligns-with-the-network-or-not-4\" class=\"anchor\" href=\"#how-do-we-know-if-a-nodes-mempool-aligns-with-the-network-or-not-4\"></a>How do we know if a node\u2019s mempool aligns with the network or not?</h4>\n<ul>\n<li>\n<p>By adding sanity checks that will serve as indications of whether a node is roughly in sync with miners in the network or not based on previously mined blocks and the transactions that are in the node\u2019s mempool at the time the previous block was mined.\nWhenever we suspect that a node\u2019s mempool diverges from miners we prevent the node from getting a fee estimate.</p>\n<ol>\n<li>\n<p>We can do this by checking if most of the transactions in previously mined blocks were present in the node\u2019s mempool when the target block arrived.</p>\n</li>\n<li>\n<p>Check if the node\u2019s mempool high mining score transactions are getting confirmed.</p>\n</li>\n</ol>\n</li>\n<li>\n<p>We can count the number of times we had expected a mempool transaction with a high mining score to confirm and it did not, if its count value reached a certain threshold we prevent considering the transaction when generating a block template, it\u2019s most likely that miners don\u2019t consider this transaction.</p>\n<ul>\n<li>The idea for these sanity checks was taken from this issue description <a href=\"https://github.com/bitcoin/bitcoin/issues/27995\" class=\"inline-onebox\" rel=\"noopener nofollow ugc\">Improving fee estimation accuracy \u00b7 Issue #27995 \u00b7 bitcoin/bitcoin \u00b7 GitHub</a></li>\n</ul>\n</li>\n</ul>\n<h4><a name=\"limitations-of-the-sanity-checks-5\" class=\"anchor\" href=\"#limitations-of-the-sanity-checks-5\"></a>Limitations of the sanity checks.</h4>\n<ul>\n<li>\n<p>These sanity checks are based on the past blocks and past mempool; they will not accurately tell us that the node\u2019s current mempool is likely the same as miners.</p>\n</li>\n<li>\n<p>The checks only give some confidence that if previously our mempool was roughly in sync with miners then we can use it for fee estimate because it\u2019s most likely the node is widely connected and maintains sane policy rules that are alike with miners, and the network miners are also picking from the broadcasted transaction in the network. That might not always be true. I can\u2019t think of a scenario when it will not be true.</p>\n</li>\n</ul>\n<p><a href=\"https://github.com/ismaelsadeeq/bitcoin/tree/02-2024-fee-estimation-with-mempool\" rel=\"noopener nofollow ugc\">Implementation of mempool-based fee estimation with the sanity check</a></p>\n<h3><a name=\"the-challenge-of-mempool-based-fee-estimation-implementation-above-6\" class=\"anchor\" href=\"#the-challenge-of-mempool-based-fee-estimation-implementation-above-6\"></a>The challenge of mempool-based fee estimation Implementation above.</h3>\n<ul>\n<li>Performing these sanity checks requires that immediately after a new block is connected we build a block template[3] we are expecting before evicting the block transactions from the node\u2019s mempool, building a block template has roughly O(n*m) (n is the total mempool transaction and m is mapModified transactions) which might take some time and we don\u2019t want any expensive code execution at that code path as it will slow block propagation in the network.</li>\n</ul>\n<p>Post cluster mempool, we will have a total mempool ordering, enabling getting the block template in linear time. Hence getting the expected block template after a new block is connected is not expensive.</p>\n<h3><a name=\"is-it-worth-adding-this-feature-7\" class=\"anchor\" href=\"#is-it-worth-adding-this-feature-7\"></a>Is it worth adding this feature?</h3>\n<p>We can have an RPC with this estimation mode that users can manually use as the fee rate of their transactions/packages. Subsequently, in the future, we can automate it in the wallet if it is deemed to be reliable.</p>\n<h4><a name=\"cluster-mempool-is-still-a-work-in-progress-what-is-the-way-forward-8\" class=\"anchor\" href=\"#cluster-mempool-is-still-a-work-in-progress-what-is-the-way-forward-8\"></a>Cluster Mempool is still a work in progress, What is the way Forward?</h4>\n<ul>\n<li>\n<p><code>CBlockPolicyEstimator</code>[4] is the current fee estimation being used by Bitcoin Core and its dependencies  which has known issues[5] of Overestimating / Underestimating fee rates and in some cases making transactions become stuck in the mempool due to inaccurate estimates.</p>\n</li>\n<li>\n<p>We can have a mempool-based fee estimator without any sanity check, available from an experimental RPC that can be used by node users with caution. and then add the sanity checks upon deployment of Cluster mempool.</p>\n</li>\n<li>\n<p>I have been analyzing the disparities between fee estimates of the mempool-based fee estimator without sanity check, <code>CBlockPolicyEstimator</code>[4], against the confirmed block target median fee rate.</p>\n</li>\n</ul>\n<h4><a name=\"methodology-9\" class=\"anchor\" href=\"#methodology-9\"></a>Methodology</h4>\n<ul>\n<li>I\u2019ve implemented a <a href=\"https://github.com/ismaelsadeeq/bitcoin/tree/02-2024-fee-estimation-with-mempool-without-s-check\" rel=\"noopener nofollow ugc\">mempool-based fee estimator without any sanity check</a>, made it available in an RPC, and schedule a job that logs the fee estimate from mempool, <code>CBlockPolicyEstimator</code>[4] estimatesmartfee after every one minute with confirmation target 1, then when the target block is confirmed its median and average fee rate are also logged.</li>\n</ul>\n<p>My node runs from <b>832330</b> to <b>832453</b>, after that using a simple Python script I filter through my debug.log and collect all the fee estimates and the confirmed block target median and average fee rate to make a comparison.</p>\n<p>The chart below represents fee estimates with mempool in blue and <code>estimatesmartfee</code> in yellow, and the block median fee rate in red consecutively every one minute from Block <b>832330</b> to <b>832453</b></p>\n<p><div class=\"lightbox-wrapper\"><a class=\"lightbox\" href=\"https://delvingbitcoin.org/uploads/default/original/1X/9e660698b675bcea974308841f39db24822faeb0.png\" data-download-href=\"https://delvingbitcoin.org/uploads/default/9e660698b675bcea974308841f39db24822faeb0\" title=\"Mempool fee estimate vs estimatesmartfee vs Actual block median fee\"><img src=\"https://delvingbitcoin.org/uploads/default/optimized/1X/9e660698b675bcea974308841f39db24822faeb0_2_690x426.png\" alt=\"Mempool fee estimate vs estimatesmartfee vs Actual block median fee\" data-base62-sha1=\"mBg1PvRprzITiGStE7Kltdh4sWA\" width=\"690\" height=\"426\" srcset=\"https://delvingbitcoin.org/uploads/default/optimized/1X/9e660698b675bcea974308841f39db24822faeb0_2_690x426.png, https://delvingbitcoin.org/uploads/default/optimized/1X/9e660698b675bcea974308841f39db24822faeb0_2_1035x639.png 1.5x, https://delvingbitcoin.org/uploads/default/original/1X/9e660698b675bcea974308841f39db24822faeb0.png 2x\" data-dominant-color=\"F9F8F9\"><div class=\"meta\"><svg class=\"fa d-icon d-icon-far-image svg-icon\" aria-hidden=\"true\"><use href=\"#far-image\"></use></svg><span class=\"filename\">Mempool fee estimate vs estimatesmartfee vs Actual block median fee</span><span class=\"informations\">1179\u00d7729 92.3 KB</span><svg class=\"fa d-icon d-icon-discourse-expand svg-icon\" aria-hidden=\"true\"><use href=\"#discourse-expand\"></use></svg></div></a></div></p>\n<p>From the data above fee estimation with mempool is closely following the block median fee rate, more accurate than <code>CBlockPolicyEstimator</code>[4] <code>estimatesmartfee</code>.</p>\n<p>You can make a copy of the <a href=\"https://docs.google.com/spreadsheets/d/1leEM-uA8EZ-MQLlIh5I9KfGnNPaDnPRem8mrhPW8bVo/edit?usp=sharing\" rel=\"noopener nofollow ugc\">sheet</a> and mess around with the chart data range to see the difference.</p>\n<ul>\n<li>You can also build the <a href=\"https://github.com/ismaelsadeeq/bitcoin/tree/02-2024-fee-estimation-with-mempool-without-s-check\" rel=\"noopener nofollow ugc\">branch</a> and call <code>estimatefeewithmempool</code>  and make a comparison with mempool.space and the target block median fee rate that will be logged.</li>\n</ul>\n<p>This is a joint work with <a class=\"mention\" href=\"/u/willcl-ark\">@willcl-ark</a> , I appreciate <a class=\"mention\" href=\"/u/glozow\">@glozow</a> 's input on some of the ideas above.</p>\n<p>Thank you for reading.</p>\n<hr>\n<p>[0] <a href=\"https://en.wikipedia.org/wiki/Percentile\" rel=\"noopener nofollow ugc\">Percentile</a></p>\n<p>[1] <a href=\"https://chat.bitcoinsearch.xyz/?author=holocat&amp;question=where%2520are%2520mining%2520pools%2520getting%2520block%2520transactions%2520from\" rel=\"noopener nofollow ugc\">How mining pool generate block templates</a></p>\n<p>[2] <a href=\"https://chat.bitcoinsearch.xyz/?author=holocat&amp;question=what%2520are%2520policy%2520rules%2520in%2520the%2520bitcoin%2520network\" rel=\"noopener nofollow ugc\">Bitcoin Core Policy rules</a></p>\n<p>[3] <a href=\"https://github.com/bitcoin/bitcoin/blob/71b63195b30b2fa0dff20ebb262ce7566dd5d673/src/node/miner.cpp#L106\" class=\"inline-onebox\" rel=\"noopener nofollow ugc\">bitcoin/src/node/miner.cpp at 71b63195b30b2fa0dff20ebb262ce7566dd5d673 \u00b7 bitcoin/bitcoin \u00b7 GitHub</a></p>\n<p>[4] <a href=\"https://johnnewbery.com/an-intro-to-bitcoin-core-fee-estimation/\" class=\"inline-onebox\" rel=\"noopener nofollow ugc\">An Introduction to Bitcoin Core Fee Estimation | John Newbery</a></p>\n<p>[5] <a href=\"https://hackmd.io/@kEyqkad6QderjWKtcBF5Hg/cChallengies-with-estimating-transaction-fees\" rel=\"noopener nofollow ugc\">Challengies with estimating transactions fee rates</a></p>",
  "post_number": 1,
  "post_type": 1,
  "updated_at": "2024-03-21T16:27:09.262Z",
  "reply_count": 0,
  "reply_to_post_number": null,
  "quote_count": 0,
  "incoming_link_count": 7,
  "reads": 13,
  "readers_count": 12,
  "score": 67.6,
  "yours": false,
  "topic_id": 703,
  "topic_slug": "mempool-based-fee-estimation-on-bitcoin-core",
  "topic_title": "Mempool Based Fee Estimation on Bitcoin Core",
  "topic_html_title": "Mempool Based Fee Estimation on Bitcoin Core",
  "category_id": 8,
  "display_username": "Abubakar Sadiq Ismail",
  "primary_group_name": null,
  "flair_name": null,
  "flair_url": null,
  "flair_bg_color": null,
  "flair_color": null,
  "flair_group_id": null,
  "version": 5,
  "can_edit": false,
  "can_delete": false,
  "can_recover": false,
  "can_see_hidden_post": false,
  "can_wiki": false,
  "user_title": null,
  "bookmarked": false,
  "raw": "#### Mempool-Based Fee Estimation in Bitcoin Core\n\nA Node can get a fee estimate by generating a block template from mempool transactions, using the fee rate of the transaction/package at the 50th percentile[0] of the generated block weight as the fee rate estimate `k` for the next block.\n\nCreating a new transaction/package with the same fee rate as `k` will align it with transactions/packages in the block template and will likely be included in the next block when propagated in the network.\n\n#### Relevance of mempool-based fee estimation.\n\n- It is assumed that most miners are generating block templates they intend to mine next from their node's mempool[1]. Hence placing a bid using mempool-based fee estimation puts the transaction/package in the same rank as the transactions/package in the block template miners are processing and will most likely be included in the block.\nAs such, if your mempool is roughly in sync with miners this is the most accurate method of ensuring your transaction gets mined in the next block.\n\n- It quickly reacts to changing conditions when the mempool is full due to high block confirmation time or the user's mempool becomes shallow. \n\n\n#### Instances where mempool-based fee estimation falls short.\n\n- When a node's mempool diverges with the network miners' mempool, assumptions will be wrong and lead to inaccurate results.\n  - This will happen due to the policy rules[2] of the node.\n  - The peers connected to a node, i.e. how well connected the node is in the network to get information on all the transactions being broadcasted in the network.\n\n- If miners are accepting most of the transactions they mine via other means than the P2P network, users' mempool will not be roughly the same as miners.\n\n- The mempool-based fee estimate for confirmation target > 1 is unreliable due to mempool changing conditions.\nWhen the confirmation target is > 1 block in the future the mempool conditions will likely change e.g. high confirmation time, high demand for block space. Assertions made on the miner's block template previously will not hold.\n\n- The node might be accepting some transactions that miners might not accept into their mempool due node's lax policy rules[2] and this will mess with their estimate.\n\n#### How do we know if a node's mempool aligns with the network or not?\n\n\n-  By adding sanity checks that will serve as indications of whether a node is roughly in sync with miners in the network or not based on previously mined blocks and the transactions that are in the node's mempool at the time the previous block was mined.\nWhenever we suspect that a node's mempool diverges from miners we prevent the node from getting a fee estimate.\n\n    1. We can do this by checking if most of the transactions in previously mined blocks were present in the node's mempool when the target block arrived.\n\n    2. Check if the node's mempool high mining score transactions are getting confirmed.\n\n- We can count the number of times we had expected a mempool transaction with a high mining score to confirm and it did not, if its count value reached a certain threshold we prevent considering the transaction when generating a block template, it's most likely that miners don't consider this transaction.\n\n    - The idea for these sanity checks was taken from this issue description https://github.com/bitcoin/bitcoin/issues/27995\n\n#### Limitations of the sanity checks.\n\n- These sanity checks are based on the past blocks and past mempool; they will not accurately tell us that the node's current mempool is likely the same as miners.\n\n- The checks only give some confidence that if previously our mempool was roughly in sync with miners then we can use it for fee estimate because it's most likely the node is widely connected and maintains sane policy rules that are alike with miners, and the network miners are also picking from the broadcasted transaction in the network. That might not always be true. I can't think of a scenario when it will not be true.\n\n[Implementation of mempool-based fee estimation with the sanity check](https://github.com/ismaelsadeeq/bitcoin/tree/02-2024-fee-estimation-with-mempool)\n\n### The challenge of mempool-based fee estimation Implementation above.\n\n- Performing these sanity checks requires that immediately after a new block is connected we build a block template[3] we are expecting before evicting the block transactions from the node's mempool, building a block template has roughly O(n*m) (n is the total mempool transaction and m is mapModified transactions) which might take some time and we don't want any expensive code execution at that code path as it will slow block propagation in the network.\n    \nPost cluster mempool, we will have a total mempool ordering, enabling getting the block template in linear time. Hence getting the expected block template after a new block is connected is not expensive.  \n\n            \n### Is it worth adding this feature?\n\nWe can have an RPC with this estimation mode that users can manually use as the fee rate of their transactions/packages. Subsequently, in the future, we can automate it in the wallet if it is deemed to be reliable.\n\n\n\n#### Cluster Mempool is still a work in progress, What is the way Forward?\n\n- `CBlockPolicyEstimator`[4] is the current fee estimation being used by Bitcoin Core and its dependencies  which has known issues[5] of Overestimating / Underestimating fee rates and in some cases making transactions become stuck in the mempool due to inaccurate estimates.\n\n- We can have a mempool-based fee estimator without any sanity check, available from an experimental RPC that can be used by node users with caution. and then add the sanity checks upon deployment of Cluster mempool.\n\n\n- I have been analyzing the disparities between fee estimates of the mempool-based fee estimator without sanity check, `CBlockPolicyEstimator`[4], against the confirmed block target median fee rate.\n\n#### Methodology\n- I've implemented a [mempool-based fee estimator without any sanity check](https://github.com/ismaelsadeeq/bitcoin/tree/02-2024-fee-estimation-with-mempool-without-s-check), made it available in an RPC, and schedule a job that logs the fee estimate from mempool, `CBlockPolicyEstimator`[4] estimatesmartfee after every one minute with confirmation target 1, then when the target block is confirmed its median and average fee rate are also logged.\n\nMy node runs from <b>832330</b> to <b>832453</b>, after that using a simple Python script I filter through my debug.log and collect all the fee estimates and the confirmed block target median and average fee rate to make a comparison.\n\n\nThe chart below represents fee estimates with mempool in blue and `estimatesmartfee` in yellow, and the block median fee rate in red consecutively every one minute from Block <b>832330</b> to <b>832453</b>\n\n![Mempool fee estimate vs estimatesmartfee vs Actual block median fee|690x426](upload://mBg1PvRprzITiGStE7Kltdh4sWA.png)\n\n\nFrom the data above fee estimation with mempool is closely following the block median fee rate, more accurate than `CBlockPolicyEstimator`[4] `estimatesmartfee`.\n\nYou can make a copy of the [sheet](https://docs.google.com/spreadsheets/d/1leEM-uA8EZ-MQLlIh5I9KfGnNPaDnPRem8mrhPW8bVo/edit?usp=sharing) and mess around with the chart data range to see the difference.\n\n- You can also build the [branch](https://github.com/ismaelsadeeq/bitcoin/tree/02-2024-fee-estimation-with-mempool-without-s-check) and call `estimatefeewithmempool`  and make a comparison with mempool.space and the target block median fee rate that will be logged.\n\nThis is a joint work with @willcl-ark , I appreciate @glozow 's input on some of the ideas above.\n\nThank you for reading.\n\n\n---\n[0] [Percentile](https://en.wikipedia.org/wiki/Percentile)\n\n[1] [How mining pool generate block templates](https://chat.bitcoinsearch.xyz/?author=holocat&question=where%2520are%2520mining%2520pools%2520getting%2520block%2520transactions%2520from)\n\n[2] [Bitcoin Core Policy rules](https://chat.bitcoinsearch.xyz/?author=holocat&question=what%2520are%2520policy%2520rules%2520in%2520the%2520bitcoin%2520network)\n\n[3] https://github.com/bitcoin/bitcoin/blob/71b63195b30b2fa0dff20ebb262ce7566dd5d673/src/node/miner.cpp#L106\n\n[4] https://johnnewbery.com/an-intro-to-bitcoin-core-fee-estimation/\n\n[5] [Challengies with estimating transactions fee rates](https://hackmd.io/@kEyqkad6QderjWKtcBF5Hg/cChallengies-with-estimating-transaction-fees)",
  "actions_summary": [
    {
      "id": 2,
      "count": 2
    }
  ],
  "moderator": false,
  "admin": false,
  "staff": false,
  "user_id": 135,
  "hidden": false,
  "trust_level": 1,
  "deleted_at": null,
  "user_deleted": false,
  "edit_reason": null,
  "can_view_edit_history": true,
  "wiki": false,
  "reactions": [
    {
      "id": "+1",
      "type": "emoji",
      "count": 1
    },
    {
      "id": "rocket",
      "type": "emoji",
      "count": 1
    }
  ],
  "current_user_reaction": null,
  "reaction_users_count": 2,
  "current_user_used_main_reaction": false
}