{
  "id": 6461,
  "name": "",
  "username": "simul",
  "avatar_template": "/user_avatar/delvingbitcoin.org/simul/{size}/1704_2.png",
  "created_at": "2025-12-18T22:38:10.735Z",
  "cooked": "<h1><a name=\"p-6461-anchor-gated-utxo-moving-template-bound-spend-1\" class=\"anchor\" href=\"#p-6461-anchor-gated-utxo-moving-template-bound-spend-1\"></a>Anchor-gated, UTXO-moving, template-bound spend</h1>\n<h2><a name=\"p-6461-using-op_txhash-op_ctv-with-an-escape-hatch-2\" class=\"anchor\" href=\"#p-6461-using-op_txhash-op_ctv-with-an-escape-hatch-2\"></a>using OP_TXHASH + OP_CTV with an escape hatch</h2>\n<p><em>(prunable-friendly; quantum-resilient to signature forgery)</em></p>\n<hr>\n<h2><a name=\"p-6461-assumptions-3\" class=\"anchor\" href=\"#p-6461-assumptions-3\"></a>Assumptions</h2>\n<ul>\n<li>\n<p><strong>OP_CHECKTEMPLATEVERIFY (OP_CTV)</strong> is available per BIP119.\nThe 32-byte template hash is <code>DefaultCheckTemplateVerifyHash</code>.\n<a href=\"https://bips.dev/119/\" class=\"inline-onebox\" rel=\"noopener nofollow ugc\">BIP 119: CHECKTEMPLATEVERIFY</a></p>\n</li>\n<li>\n<p><strong>OP_TXHASH / OP_CHECKTXHASHVERIFY</strong> is available per the current draft proposal,\nallowing scripts to hash and verify selected fields of the <em>spending transaction</em>\nwithout committing to a full transaction template.</p>\n</li>\n<li>\n<p><strong>Relative timelocks</strong> exist (BIP68 / BIP112).</p>\n</li>\n<li>\n<p><strong>SHA256 preimage resistance holds</strong>, even if ECDSA/Schnorr signatures become forgeable.</p>\n</li>\n</ul>\n<hr>\n<h2><a name=\"p-6461-threat-model-4\" class=\"anchor\" href=\"#p-6461-threat-model-4\"></a>Threat model</h2>\n<p>An attacker may:</p>\n<ul>\n<li>Forge signatures.</li>\n<li>Intercept, delay, reorder, or fee-bump transactions.</li>\n<li>Front-run in the mempool.</li>\n<li>Exploit shallow reorgs.</li>\n</ul>\n<p>An attacker may <strong>not</strong>:</p>\n<ul>\n<li>Break SHA256 preimage resistance.</li>\n<li>Violate OP_CTV semantics.</li>\n<li>Violate OP_TXHASH semantics.</li>\n<li>Violate relative timelock rules.</li>\n<li>Rewrite deep chain history.</li>\n</ul>\n<hr>\n<h2><a name=\"p-6461-high-level-idea-5\" class=\"anchor\" href=\"#p-6461-high-level-idea-5\"></a>High-level idea</h2>\n<p>This construction creates a <strong>multi-phase envelope</strong> that separates:</p>\n<ul>\n<li><em>who can trigger execution</em> from</li>\n<li><em>where value is allowed to go</em>.</li>\n</ul>\n<p>Even if signatures are forgeable, funds can only move into a protected\nAnchor envelope, and from there only along template-bound paths.</p>\n<ul>\n<li><strong>Phase 0</strong> funnels all value into a predetermined Anchor envelope.</li>\n<li><strong>Phase 1</strong> instantiates that envelope on-chain.</li>\n<li><strong>Phase 2</strong> either:\n<ul>\n<li>reveals a one-time secret to complete a template-bound spend, or</li>\n<li>uses an escape hatch without revealing the secret.</li>\n</ul>\n</li>\n</ul>\n<p>At no point does Phase 0 commit to final recipients.</p>\n<hr>\n<h2><a name=\"p-6461-data-definitions-6\" class=\"anchor\" href=\"#p-6461-data-definitions-6\"></a>Data definitions</h2>\n<ul>\n<li>\n<p><strong>x</strong>: one-time secret (recommended 32 bytes).</p>\n</li>\n<li>\n<p><strong>C = SHA256(x)</strong>.</p>\n</li>\n<li>\n<p><strong>k</strong>: <code>uint32</code> relative confirmation depth parameter.</p>\n</li>\n<li>\n<p><strong>T</strong>: 32-byte CTV template hash for the intended reveal spend.</p>\n</li>\n<li>\n<p><strong>E</strong>: 32-byte CTV template hash for the escape-hatch spend.</p>\n</li>\n<li>\n<p><strong>P_anchor</strong>: Taproot output key committing to an Anchor script tree that:</p>\n<ul>\n<li>embeds <code>C</code>,</li>\n<li>enforces <em>reveal-or-escape</em> spending conditions,</li>\n<li>optionally enforces a relative timelock <code>k</code> on the reveal path.</li>\n</ul>\n</li>\n</ul>\n<hr>\n<h2><a name=\"p-6461-transactions-and-scripts-7\" class=\"anchor\" href=\"#p-6461-transactions-and-scripts-7\"></a>Transactions and scripts</h2>\n<h3><a name=\"p-6461-phase-0-funding-coin-initial-utxo-8\" class=\"anchor\" href=\"#p-6461-phase-0-funding-coin-initial-utxo-8\"></a>Phase 0: Funding coin (initial UTXO)</h3>\n<p><strong>Purpose:</strong>\nEnsure that, even in a future where signatures are forgeable, all value must\nenter the Anchor envelope and cannot be redirected elsewhere.</p>\n<h4><a name=\"p-6461-phase-0-locking-policy-9\" class=\"anchor\" href=\"#p-6461-phase-0-locking-policy-9\"></a>Phase 0 locking policy</h4>\n<p>The Phase 0 UTXO enforces the following:</p>\n<ol>\n<li>\n<p><strong>Anchor pinning</strong>\nAny spend MUST create exactly one value-bearing output whose\n<code>scriptPubKey</code> equals <code>P_anchor</code>.</p>\n</li>\n<li>\n<p><strong>No value leakage</strong>\nNo other value-bearing outputs are permitted.\nTransaction fees are paid by reducing the Anchor output amount.</p>\n</li>\n<li>\n<p><strong>Fee bound</strong>\nThe Phase 0 script MUST enforce a bound on fee extraction, e.g.:</p>\n</li>\n</ol>\n<pre><code class=\"lang-auto\">\nAnchorValue \u2265 InputValue \u2212 MaxFee\n\n</code></pre>\n<p>This prevents an attacker from draining value via excessive fees while\npreserving fee flexibility.</p>\n<p>These conditions are enforced using <strong>OP_TXHASH</strong>, selecting and verifying:</p>\n<ul>\n<li>the number of outputs,</li>\n<li>the <code>scriptPubKey</code> of the Anchor output,</li>\n<li>and sufficient value information to enforce the fee bound.</li>\n</ul>\n<p>No commitment is made to final recipients or future templates.</p>\n<hr>\n<h3><a name=\"p-6461-phase-1-anchorpublishtx-10\" class=\"anchor\" href=\"#p-6461-phase-1-anchorpublishtx-10\"></a>Phase 1: AnchorPublishTx</h3>\n<p><strong>Properties:</strong></p>\n<ul>\n<li>Spends the Phase 0 UTXO.</li>\n<li>Creates exactly one output: the <strong>Anchor UTXO</strong>, locked to <code>P_anchor</code>.</li>\n</ul>\n<p>The Anchor envelope is now instantiated on-chain.\nAn attacker may have triggered this spend, but cannot redirect value.</p>\n<hr>\n<h3><a name=\"p-6461-anchor-utxo-locking-script-11\" class=\"anchor\" href=\"#p-6461-anchor-utxo-locking-script-11\"></a>Anchor UTXO locking script</h3>\n<p>A Taproot script tree with two spending paths.</p>\n<h4><a name=\"p-6461-path-1-reveal-spend-normal-12\" class=\"anchor\" href=\"#p-6461-path-1-reveal-spend-normal-12\"></a>Path 1: Reveal spend (normal)</h4>\n<p>Conditions:</p>\n<ol>\n<li>\n<p><strong>Relative depth gate</strong>\nThe Anchor UTXO must have aged by at least <code>k</code> blocks (CSV).</p>\n</li>\n<li>\n<p><strong>Reveal check</strong>\n<code>SHA256(x) == C</code>.</p>\n</li>\n<li>\n<p><strong>Template enforcement</strong>\nThe spending transaction MUST match template <code>T</code> via OP_CTV.</p>\n</li>\n</ol>\n<hr>\n<h4><a name=\"p-6461-path-2-escape-hatch-13\" class=\"anchor\" href=\"#p-6461-path-2-escape-hatch-13\"></a>Path 2: Escape hatch</h4>\n<p>Conditions:</p>\n<ol>\n<li>\n<p><strong>Template enforcement</strong>\nThe spending transaction MUST match template <code>E</code> via OP_CTV.</p>\n</li>\n<li>\n<p><strong>No secret revealed</strong>\nThe value <code>x</code> is not disclosed on this path.</p>\n</li>\n</ol>\n<p>The escape path may be immediately available or time-delayed,\ndepending on the chosen policy.</p>\n<hr>\n<h3><a name=\"p-6461-phase-2-spendanchortx-14\" class=\"anchor\" href=\"#p-6461-phase-2-spendanchortx-14\"></a>Phase 2: SpendAnchorTx</h3>\n<ul>\n<li><strong>Reveal path witness:</strong> <code>x</code> plus any required non-cryptographic data.</li>\n<li><strong>Escape path witness:</strong> no <code>x</code>.</li>\n</ul>\n<hr>\n<h2><a name=\"p-6461-security-properties-15\" class=\"anchor\" href=\"#p-6461-security-properties-15\"></a>Security properties</h2>\n<ul>\n<li>\n<p><strong>Quantum signature safety</strong>\nForged signatures do not enable theft. All value is confined to the Anchor\nenvelope before any secret is revealed.</p>\n</li>\n<li>\n<p><strong>No redirect-after-reveal</strong>\nOnce <code>x</code> is revealed, OP_CTV pins the outputs. An interceptor cannot redirect\nvalue.</p>\n</li>\n<li>\n<p><strong>Observation is sufficient</strong>\nIf an attacker publishes Phase 0 or Phase 1 spends, the Anchor script still\ncontains a usable escape hatch.</p>\n</li>\n<li>\n<p><strong>Reorg resistance</strong>\nThe relative timelock <code>k</code> mitigates shallow reorg games at the reveal boundary.</p>\n</li>\n<li>\n<p><strong>Prunable-friendly</strong>\nValidation requires no historical transaction lookup.</p>\n</li>\n<li>\n<p><strong>Graceful degradation</strong>\nA quantum attacker can force execution or cause delay, but cannot steal value.</p>\n</li>\n</ul>\n<hr>\n<h2><a name=\"p-6461-where-op_txhash-fits-16\" class=\"anchor\" href=\"#p-6461-where-op_txhash-fits-16\"></a>Where OP_TXHASH fits</h2>\n<p>OP_TXHASH is used <strong>only in Phase 0</strong> to enforce a <em>partial covenant</em>:</p>\n<ul>\n<li>it pins the <strong>next envelope</strong> (<code>P_anchor</code>),</li>\n<li>without pinning final recipients,</li>\n<li>without pinning templates <code>T</code> or <code>E</code>,</li>\n<li>without committing to exact output amounts.</li>\n</ul>\n<p>This is the minimal constraint required to survive a future where\nsignatures are forgeable.</p>\n<p>Because the destination is pinned only to the Anchor envelope,\nReplace-By-Fee (RBF) is safe to allow in Phase 0.</p>\n<hr>\n<h2><a name=\"p-6461-summary-17\" class=\"anchor\" href=\"#p-6461-summary-17\"></a>Summary</h2>\n<p>Phase 0 pins the <strong>envelope</strong>, not the destination.\nPhase 1 instantiates the envelope.\nPhase 2 chooses and enforces the destination.</p>\n<p>The attacker is reduced from a thief to a griefer.</p>\n<p>See: <a href=\"https://gist.github.com/earonesty/ea086aa995be1a860af093f93bd45bf2\" class=\"inline-onebox\" rel=\"noopener nofollow ugc\">demonstration pseudocode for quantum-resistant spends \u00b7 GitHub</a> for demo code.</p>",
  "post_number": 1,
  "post_type": 1,
  "posts_count": 2,
  "updated_at": "2025-12-21T00:51:45.363Z",
  "reply_count": 0,
  "reply_to_post_number": null,
  "quote_count": 0,
  "incoming_link_count": 108,
  "reads": 30,
  "readers_count": 29,
  "score": 550.8,
  "yours": false,
  "topic_id": 2168,
  "topic_slug": "a-quantum-resistance-script-only-using-op-ctv-op-txhash-and-no-new-signatures",
  "topic_title": "A quantum resistance script only using op_ctv/op_txhash and no new signatures",
  "topic_html_title": "A quantum resistance script only using op_ctv/op_txhash and no new signatures",
  "category_id": 7,
  "display_username": "",
  "primary_group_name": null,
  "flair_name": null,
  "flair_url": null,
  "flair_bg_color": null,
  "flair_color": null,
  "flair_group_id": null,
  "badges_granted": [],
  "version": 10,
  "can_edit": false,
  "can_delete": false,
  "can_recover": false,
  "can_see_hidden_post": false,
  "can_wiki": false,
  "user_title": null,
  "bookmarked": false,
  "raw": "# Anchor-gated, UTXO-moving, template-bound spend\n\n## using OP_TXHASH + OP_CTV with an escape hatch\n\n*(prunable-friendly; quantum-resilient to signature forgery)*\n\n---\n\n## Assumptions\n\n* **OP_CHECKTEMPLATEVERIFY (OP_CTV)** is available per BIP119.\n  The 32-byte template hash is `DefaultCheckTemplateVerifyHash`.\n  https://bips.dev/119/\n\n* **OP_TXHASH / OP_CHECKTXHASHVERIFY** is available per the current draft proposal,\n  allowing scripts to hash and verify selected fields of the *spending transaction*\n  without committing to a full transaction template.\n\n* **Relative timelocks** exist (BIP68 / BIP112).\n\n* **SHA256 preimage resistance holds**, even if ECDSA/Schnorr signatures become forgeable.\n\n---\n\n## Threat model\n\nAn attacker may:\n\n* Forge signatures.\n* Intercept, delay, reorder, or fee-bump transactions.\n* Front-run in the mempool.\n* Exploit shallow reorgs.\n\nAn attacker may **not**:\n\n* Break SHA256 preimage resistance.\n* Violate OP_CTV semantics.\n* Violate OP_TXHASH semantics.\n* Violate relative timelock rules.\n* Rewrite deep chain history.\n\n---\n\n## High-level idea\n\nThis construction creates a **multi-phase envelope** that separates:\n\n* *who can trigger execution* from\n* *where value is allowed to go*.\n\nEven if signatures are forgeable, funds can only move into a protected\nAnchor envelope, and from there only along template-bound paths.\n\n* **Phase 0** funnels all value into a predetermined Anchor envelope.\n* **Phase 1** instantiates that envelope on-chain.\n* **Phase 2** either:\n  * reveals a one-time secret to complete a template-bound spend, or\n  * uses an escape hatch without revealing the secret.\n\nAt no point does Phase 0 commit to final recipients.\n\n---\n\n## Data definitions\n\n* **x**: one-time secret (recommended 32 bytes).\n\n* **C = SHA256(x)**.\n\n* **k**: `uint32` relative confirmation depth parameter.\n\n* **T**: 32-byte CTV template hash for the intended reveal spend.\n\n* **E**: 32-byte CTV template hash for the escape-hatch spend.\n\n* **P_anchor**: Taproot output key committing to an Anchor script tree that:\n\n  * embeds `C`,\n  * enforces *reveal-or-escape* spending conditions,\n  * optionally enforces a relative timelock `k` on the reveal path.\n\n---\n\n## Transactions and scripts\n\n### Phase 0: Funding coin (initial UTXO)\n\n**Purpose:**\nEnsure that, even in a future where signatures are forgeable, all value must\nenter the Anchor envelope and cannot be redirected elsewhere.\n\n#### Phase 0 locking policy\n\nThe Phase 0 UTXO enforces the following:\n\n1. **Anchor pinning**\n   Any spend MUST create exactly one value-bearing output whose\n   `scriptPubKey` equals `P_anchor`.\n\n2. **No value leakage**\n   No other value-bearing outputs are permitted.\n   Transaction fees are paid by reducing the Anchor output amount.\n\n3. **Fee bound**\n   The Phase 0 script MUST enforce a bound on fee extraction, e.g.:\n\n```\n\nAnchorValue \u2265 InputValue \u2212 MaxFee\n\n```\n\nThis prevents an attacker from draining value via excessive fees while\npreserving fee flexibility.\n\nThese conditions are enforced using **OP_TXHASH**, selecting and verifying:\n\n* the number of outputs,\n* the `scriptPubKey` of the Anchor output,\n* and sufficient value information to enforce the fee bound.\n\nNo commitment is made to final recipients or future templates.\n\n---\n\n### Phase 1: AnchorPublishTx\n\n**Properties:**\n\n* Spends the Phase 0 UTXO.\n* Creates exactly one output: the **Anchor UTXO**, locked to `P_anchor`.\n\nThe Anchor envelope is now instantiated on-chain.\nAn attacker may have triggered this spend, but cannot redirect value.\n\n---\n\n### Anchor UTXO locking script\n\nA Taproot script tree with two spending paths.\n\n#### Path 1: Reveal spend (normal)\n\nConditions:\n\n1. **Relative depth gate**\n   The Anchor UTXO must have aged by at least `k` blocks (CSV).\n\n2. **Reveal check**\n   `SHA256(x) == C`.\n\n3. **Template enforcement**\n   The spending transaction MUST match template `T` via OP_CTV.\n\n---\n\n#### Path 2: Escape hatch\n\nConditions:\n\n1. **Template enforcement**\n   The spending transaction MUST match template `E` via OP_CTV.\n\n2. **No secret revealed**\n   The value `x` is not disclosed on this path.\n\nThe escape path may be immediately available or time-delayed,\ndepending on the chosen policy.\n\n---\n\n### Phase 2: SpendAnchorTx\n\n* **Reveal path witness:** `x` plus any required non-cryptographic data.\n* **Escape path witness:** no `x`.\n\n---\n\n## Security properties\n\n* **Quantum signature safety**\n  Forged signatures do not enable theft. All value is confined to the Anchor\n  envelope before any secret is revealed.\n\n* **No redirect-after-reveal**\n  Once `x` is revealed, OP_CTV pins the outputs. An interceptor cannot redirect\n  value.\n\n* **Observation is sufficient**\n  If an attacker publishes Phase 0 or Phase 1 spends, the Anchor script still\n  contains a usable escape hatch.\n\n* **Reorg resistance**\n  The relative timelock `k` mitigates shallow reorg games at the reveal boundary.\n\n* **Prunable-friendly**\n  Validation requires no historical transaction lookup.\n\n* **Graceful degradation**\n  A quantum attacker can force execution or cause delay, but cannot steal value.\n\n---\n\n## Where OP_TXHASH fits\n\nOP_TXHASH is used **only in Phase 0** to enforce a *partial covenant*:\n\n* it pins the **next envelope** (`P_anchor`),\n* without pinning final recipients,\n* without pinning templates `T` or `E`,\n* without committing to exact output amounts.\n\nThis is the minimal constraint required to survive a future where\nsignatures are forgeable.\n\nBecause the destination is pinned only to the Anchor envelope,\nReplace-By-Fee (RBF) is safe to allow in Phase 0.\n\n---\n\n## Summary\n\nPhase 0 pins the **envelope**, not the destination.\nPhase 1 instantiates the envelope.\nPhase 2 chooses and enforces the destination.\n\nThe attacker is reduced from a thief to a griefer.\n\nSee: https://gist.github.com/earonesty/ea086aa995be1a860af093f93bd45bf2 for demo code.",
  "actions_summary": [
    {
      "id": 2,
      "count": 1
    }
  ],
  "moderator": false,
  "admin": false,
  "staff": false,
  "user_id": 1008,
  "hidden": false,
  "trust_level": 0,
  "deleted_at": null,
  "user_deleted": false,
  "edit_reason": null,
  "can_view_edit_history": true,
  "wiki": false,
  "excerpt": "<a name=\"p-6461-anchor-gated-utxo-moving-template-bound-spend-1\" class=\"anchor\" href=\"#p-6461-anchor-gated-utxo-moving-template-bound-spend-1\"></a>Anchor-gated, UTXO-moving, template-bound spend\n<a name=\"p-6461-using-op_txhash-op_ctv-with-an-escape-hatch-2\" class=\"anchor\" href=\"#p-6461-using-op_txhash-op_ctv-with-an-escape-hatch-2\"></a>using OP_TXHASH + OP_CTV with an escape hatch\n(prunable-friendly; quantum-resilient to signature forgery) \n\n<a name=\"p-6461-assumptions-3\" class=\"anchor\" href=\"#p-6461-assumptions-3\"></a>Assumptions\n\n\nOP_CHECKTEMPLATEVERIFY (OP_CTV) is available per BIP119.\nThe 32-byte template hash is DefaultCheckTemplateVerifyHash.\n<a href=\"https://bips.dev/119/\" class=\"inline-onebox\" rel=\"noopener nofollow ugc\">BIP 119: CHE&hellip;</a>",
  "truncated": true,
  "post_url": "/t/a-quantum-resistance-script-only-using-op-ctv-op-txhash-and-no-new-signatures/2168/1",
  "reactions": [
    {
      "id": "+1",
      "type": "emoji",
      "count": 1
    }
  ],
  "current_user_reaction": null,
  "reaction_users_count": 1,
  "current_user_used_main_reaction": false,
  "can_accept_answer": false,
  "can_unaccept_answer": false,
  "accepted_answer": false,
  "topic_accepted_answer": null,
  "can_vote": false
}