{
  "id": 2336,
  "name": "Brandon Black",
  "username": "reardencode",
  "avatar_template": "/user_avatar/delvingbitcoin.org/reardencode/{size}/27_2.png",
  "created_at": "2024-04-27T04:46:19.394Z",
  "cooked": "<h1><a name=\"withdrawn-1\" class=\"anchor\" href=\"#withdrawn-1\"></a>WITHDRAWN</h1>\n<blockquote>\n<ul>\n<li>Let <em>t = hashTapTweak(p || km)</em>.</li>\n</ul>\n</blockquote>\n<p>You can\u2019t back-calculate the internal key from the SPK and the script tree - would make taproot all in secure if that worked.</p>\n<details>\n<summary>\nOriginal post</summary>\n<p>I blame Lisa.</p>\n<p>I\u2019m writing my deck for BTC++ and I think that there\u2019s an alternate design for Lightning Symmetry channel scripts when specifically designed for use with LNHANCE instead of APO.</p>\n<p>Basic background reading is Greg\u2019s <a href=\"https://delvingbitcoin.org/t/ln-symmetry-project-recap/359\">thread</a>.</p>\n<h2><a name=\"scripts-2\" class=\"anchor\" href=\"#scripts-2\"></a>Scripts</h2>\n<p>For LNHANCE-Symmetry, we have the following script structures:</p>\n<h3><a name=\"channel-outpoint-3\" class=\"anchor\" href=\"#channel-outpoint-3\"></a>Channel outpoint</h3>\n<p>LNHANCE: <code>tr(musig2(a, b), CTV INTERNALKEY CSFS)</code></p>\n<p>APO: <code>tr(musig(a, b), 1 CHECKSIG)</code></p>\n<h3><a name=\"update-tapleaves-4\" class=\"anchor\" href=\"#update-tapleaves-4\"></a>Update (tapleaves)</h3>\n<p>LNHANCE: <code>tr(settlement-hash, {&lt;n+1&gt; CLTV DROP CTV musig2(a, b) CSFS, INTERNALKEY CTV})</code></p>\n<p>APO: <code>tr(musig(a, b), {&lt;n+1&gt; CLTV DROP 1 CHECKSIG, &lt;settlement-sig&gt; &lt;G&gt; CHECKSIG})</code></p>\n<h3><a name=\"update-op_if-5\" class=\"anchor\" href=\"#update-op_if-5\"></a>Update (OP_IF)</h3>\n<p>LNHANCE: <code>tr(settlement-hash, DEPTH NOTIF INTERNALKEY CTV ELSE &lt;n+1&gt; CLTV DROP CTV musig2(a, b) CSFS ENDIF)</code></p>\n<p>APO: <code>tr(musig(a, b), DEPTH NOTIF &lt;settlement-sig&gt; &lt;G&gt; CHECKSIG ELSE &lt;n+1&gt; CLTV DROP 1 CHECKSIG ENDIF)</code></p>\n<h2><a name=\"discussion-6\" class=\"anchor\" href=\"#discussion-6\"></a>Discussion</h2>\n<p>In Greg\u2019s APO-Symmetry design, the taproot annex is used to store the hash of the settlement transaction which was used to generate the settlement sig for the settlement transaction corresponding to the update transaction being signed. This ensures that if Alice publishes an update and Bob has a later update, he can recover the taproot sibling hash needed to spend Alice\u2019s update.</p>\n<p>In LNHANCE-Symmetry, the settlement transaction\u2019s CTV hash can be ground to a valid X on the curve and then used as the internal key for the taproot output. This makes the tapscripts identical from update to update ensuring that either party can store O(1) data and be able to spend any prior update.</p>\n<h2><a name=\"witness-sizes-7\" class=\"anchor\" href=\"#witness-sizes-7\"></a>Witness sizes</h2>\n<h3><a name=\"summary-8\" class=\"anchor\" href=\"#summary-8\"></a>Summary</h3>\n<div class=\"md-table\">\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">Variant</th>\n<th style=\"text-align:left\">Initial update</th>\n<th style=\"text-align:left\">Subsequent update</th>\n<th style=\"text-align:left\">Settlement</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">APO-Symmetry (tapleaves)</td>\n<td style=\"text-align:left\">137WU</td>\n<td style=\"text-align:left\">176WU</td>\n<td style=\"text-align:left\">168WU</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">APO-Symmetry (OP_IF)</td>\n<td style=\"text-align:left\">137WU</td>\n<td style=\"text-align:left\">249WU</td>\n<td style=\"text-align:left\">149WU</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">LNHANCE-Symmetry (tapleaves)</td>\n<td style=\"text-align:left\">136WU</td>\n<td style=\"text-align:left\">207WU</td>\n<td style=\"text-align:left\">69WU</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">LNHANCE-Symmetry (OP_IF)</td>\n<td style=\"text-align:left\">136WU</td>\n<td style=\"text-align:left\">149WU</td>\n<td style=\"text-align:left\">83WU</td>\n</tr>\n</tbody>\n</table>\n</div><details>\n<summary>\nweight calculations</summary>\n<h3><a name=\"apo-symmetry-9\" class=\"anchor\" href=\"#apo-symmetry-9\"></a>APO-Symmetry:</h3>\n<h4><a name=\"initial-update-10\" class=\"anchor\" href=\"#initial-update-10\"></a>Initial update</h4>\n<ul>\n<li>33-byte annex</li>\n<li>33-byte control block</li>\n<li>2-byte script</li>\n<li>65-byte signature</li>\n<li>Total: 4+33+33+2+65=137WU</li>\n</ul>\n<h4><a name=\"subsequent-update-tapleaves-11\" class=\"anchor\" href=\"#subsequent-update-tapleaves-11\"></a>Subsequent update (tapleaves)</h4>\n<ul>\n<li>33-byte annex</li>\n<li>65-byte control block</li>\n<li>9-byte script</li>\n<li>65-byte signature</li>\n<li>Total: 4+33+65+9+65=176WU</li>\n</ul>\n<h4><a name=\"settlement-tapleaves-12\" class=\"anchor\" href=\"#settlement-tapleaves-12\"></a>Settlement (tapleaves)</h4>\n<ul>\n<li>65-byte control block</li>\n<li>66+33+1-byte script</li>\n<li>Total: 2+65+(65+1+33+1+1)=168WU</li>\n</ul>\n<h4><a name=\"subsequent-update-op_if-13\" class=\"anchor\" href=\"#subsequent-update-op_if-13\"></a>Subsequent update (OP_IF)</h4>\n<ul>\n<li>33-byte annex</li>\n<li>33-byte control block</li>\n<li>114-byte script</li>\n<li>65-byte signature</li>\n<li>Total: 4+33+33+114+65=249WU</li>\n</ul>\n<h4><a name=\"settlement-op_if-14\" class=\"anchor\" href=\"#settlement-op_if-14\"></a>Settlement (OP_IF)</h4>\n<ul>\n<li>65-byte control block</li>\n<li>114-byte script</li>\n<li>Total: 2+33+114=149WU</li>\n</ul>\n<h3><a name=\"lnhance-symmetry-15\" class=\"anchor\" href=\"#lnhance-symmetry-15\"></a>LNHANCE-Symmetry</h3>\n<h4><a name=\"initial-update-16\" class=\"anchor\" href=\"#initial-update-16\"></a>Initial update</h4>\n<ul>\n<li>33-byte control block</li>\n<li>3-byte script</li>\n<li>32-byte hash</li>\n<li>64-byte signature</li>\n<li>Total: 4+33+3+64+32=136WU</li>\n</ul>\n<h4><a name=\"subsequent-update-tapleaves-17\" class=\"anchor\" href=\"#subsequent-update-tapleaves-17\"></a>Subsequent update (tapleaves)</h4>\n<ul>\n<li>65-byte control block</li>\n<li>42-byte script</li>\n<li>32-byte hash</li>\n<li>64-byte signature</li>\n<li>Total: 4+65+42+64=207WU</li>\n</ul>\n<h4><a name=\"settlement-tapleaves-18\" class=\"anchor\" href=\"#settlement-tapleaves-18\"></a>Settlement (tapleaves)</h4>\n<ul>\n<li>65-byte control block</li>\n<li>2-byte script</li>\n<li>Total: 2+65+2=69WU</li>\n</ul>\n<h4><a name=\"subsequent-update-op_if-19\" class=\"anchor\" href=\"#subsequent-update-op_if-19\"></a>Subsequent update (OP_IF)</h4>\n<ul>\n<li>33-byte control block</li>\n<li>48-byte script</li>\n<li>32-byte hash</li>\n<li>64-byte signature</li>\n<li>Total: 4+33+48+64=149WU</li>\n</ul>\n<h4><a name=\"settlement-op_if-20\" class=\"anchor\" href=\"#settlement-op_if-20\"></a>Settlement (OP_IF)</h4>\n<ul>\n<li>33-byte control block</li>\n<li>48-byte script</li>\n<li>Total: 2+33+48=83WU</li>\n</ul>\n</details>\n<h2><a name=\"conclusion-21\" class=\"anchor\" href=\"#conclusion-21\"></a>Conclusion?</h2>\n<p>Where a 32-byte hash can be used for settlement, there is a significant weight saving for Lightning Symmetry channels from overloading the taproot internal key with the settlement hash.</p>\n<h3><a name=\"edit-added-op_if-variants-22\" class=\"anchor\" href=\"#edit-added-op_if-variants-22\"></a>Edit: Added OP_IF variants</h3>\n<p>The APO-Symmetry OP_IF variant favors force closes that are not challenged significantly. It moderately reduces overall weight when a close is not challenged and significantly increases overall weight when it is challenged.</p>\n<p>LNHANCE-Symmetry already favors non-challenged closes significantly, and the OP_IF variant reduces that. It slightly increases overall weight when a close is not challenged, and significantly reduces overall weight when it is challenged.</p>\n<p>Which of these variants might be preferred when building production Lightning Symmetry depends on the relative importance they give to unchallenged force close weight vs. the cost of challenge when necessary.</p>\n<p>Edit: not as great a savings when i properly include the ctv hash in the update witness stack. Sigh. OP_TEMPLATEHASH (or TXHASH) in tapscript only would improve the gains.</p>\n</details>",
  "post_number": 1,
  "post_type": 1,
  "updated_at": "2024-04-27T14:14:25.572Z",
  "reply_count": 1,
  "reply_to_post_number": null,
  "quote_count": 0,
  "incoming_link_count": 57,
  "reads": 16,
  "readers_count": 15,
  "score": 303.0,
  "yours": false,
  "topic_id": 839,
  "topic_slug": "withdrawn-alternate-script-design-for-lnhance-symmetry",
  "topic_title": "[WITHDRAWN] Alternate script design for LNHANCE-Symmetry",
  "topic_html_title": "[WITHDRAWN] Alternate script design for LNHANCE-Symmetry",
  "category_id": 7,
  "display_username": "Brandon Black",
  "primary_group_name": null,
  "flair_name": null,
  "flair_url": null,
  "flair_bg_color": null,
  "flair_color": null,
  "flair_group_id": null,
  "version": 5,
  "can_edit": false,
  "can_delete": false,
  "can_recover": false,
  "can_see_hidden_post": false,
  "can_wiki": false,
  "user_title": null,
  "bookmarked": false,
  "raw": "# WITHDRAWN\n\n> * Let *t = hashTapTweak(p || km)*.\n\nYou can't back-calculate the internal key from the SPK and the script tree - would make taproot all in secure if that worked.\n\n[details=Original post]\nI blame Lisa.\n\nI'm writing my deck for BTC++ and I think that there's an alternate design for Lightning Symmetry channel scripts when specifically designed for use with LNHANCE instead of APO.\n\nBasic background reading is Greg's [thread](https://delvingbitcoin.org/t/ln-symmetry-project-recap/359).\n\n## Scripts\n\nFor LNHANCE-Symmetry, we have the following script structures:\n\n### Channel outpoint\n\nLNHANCE: `tr(musig2(a, b), CTV INTERNALKEY CSFS)`\n\nAPO: `tr(musig(a, b), 1 CHECKSIG)`\n\n### Update (tapleaves)\n\nLNHANCE: `tr(settlement-hash, {<n+1> CLTV DROP CTV musig2(a, b) CSFS, INTERNALKEY CTV})`\n\nAPO: `tr(musig(a, b), {<n+1> CLTV DROP 1 CHECKSIG, <settlement-sig> <G> CHECKSIG})`\n\n### Update (OP_IF)\n\nLNHANCE: `tr(settlement-hash, DEPTH NOTIF INTERNALKEY CTV ELSE <n+1> CLTV DROP CTV musig2(a, b) CSFS ENDIF)`\n\nAPO: `tr(musig(a, b), DEPTH NOTIF <settlement-sig> <G> CHECKSIG ELSE <n+1> CLTV DROP 1 CHECKSIG ENDIF)`\n\n## Discussion\n\nIn Greg's APO-Symmetry design, the taproot annex is used to store the hash of the settlement transaction which was used to generate the settlement sig for the settlement transaction corresponding to the update transaction being signed. This ensures that if Alice publishes an update and Bob has a later update, he can recover the taproot sibling hash needed to spend Alice's update.\n\nIn LNHANCE-Symmetry, the settlement transaction's CTV hash can be ground to a valid X on the curve and then used as the internal key for the taproot output. This makes the tapscripts identical from update to update ensuring that either party can store O(1) data and be able to spend any prior update.\n\n## Witness sizes\n\n### Summary\n\nVariant                      | Initial update | Subsequent update | Settlement\n:--------------------------- | :------------- | :---------------- | :---------\nAPO-Symmetry (tapleaves)     | 137WU          | 176WU             | 168WU\nAPO-Symmetry (OP_IF)         | 137WU          | 249WU             | 149WU\nLNHANCE-Symmetry (tapleaves) | 136WU          | 207WU             | 69WU\nLNHANCE-Symmetry (OP_IF)     | 136WU          | 149WU             | 83WU\n\n[details=weight calculations]\n\n### APO-Symmetry:\n\n#### Initial update\n\n* 33-byte annex\n* 33-byte control block\n* 2-byte script\n* 65-byte signature\n* Total: 4+33+33+2+65=137WU\n\n#### Subsequent update (tapleaves)\n\n* 33-byte annex\n* 65-byte control block\n* 9-byte script\n* 65-byte signature\n* Total: 4+33+65+9+65=176WU\n\n#### Settlement (tapleaves)\n\n* 65-byte control block\n* 66+33+1-byte script\n* Total: 2+65+(65+1+33+1+1)=168WU\n\n#### Subsequent update (OP_IF)\n\n* 33-byte annex\n* 33-byte control block\n* 114-byte script\n* 65-byte signature\n* Total: 4+33+33+114+65=249WU\n\n#### Settlement (OP_IF)\n\n* 65-byte control block\n* 114-byte script\n* Total: 2+33+114=149WU\n\n### LNHANCE-Symmetry\n\n#### Initial update\n\n* 33-byte control block\n* 3-byte script\n* 32-byte hash\n* 64-byte signature\n* Total: 4+33+3+64+32=136WU\n\n#### Subsequent update (tapleaves)\n\n* 65-byte control block\n* 42-byte script\n* 32-byte hash\n* 64-byte signature\n* Total: 4+65+42+64=207WU\n\n#### Settlement (tapleaves)\n\n* 65-byte control block\n* 2-byte script\n* Total: 2+65+2=69WU\n\n#### Subsequent update (OP_IF)\n\n* 33-byte control block\n* 48-byte script\n* 32-byte hash\n* 64-byte signature\n* Total: 4+33+48+64=149WU\n\n#### Settlement (OP_IF)\n\n* 33-byte control block\n* 48-byte script\n* Total: 2+33+48=83WU\n[/details]\n\n## Conclusion?\n\nWhere a 32-byte hash can be used for settlement, there is a significant weight saving for Lightning Symmetry channels from overloading the taproot internal key with the settlement hash.\n\n### Edit: Added OP_IF variants\n\nThe APO-Symmetry OP_IF variant favors force closes that are not challenged significantly. It moderately reduces overall weight when a close is not challenged and significantly increases overall weight when it is challenged.\n\nLNHANCE-Symmetry already favors non-challenged closes significantly, and the OP_IF variant reduces that. It slightly increases overall weight when a close is not challenged, and significantly reduces overall weight when it is challenged.\n\nWhich of these variants might be preferred when building production Lightning Symmetry depends on the relative importance they give to unchallenged force close weight vs. the cost of challenge when necessary.\n\nEdit: not as great a savings when i properly include the ctv hash in the update witness stack. Sigh. OP_TEMPLATEHASH (or TXHASH) in tapscript only would improve the gains.\n[/details]",
  "actions_summary": [
    {
      "id": 2,
      "count": 1
    }
  ],
  "moderator": false,
  "admin": false,
  "staff": false,
  "user_id": 30,
  "hidden": false,
  "trust_level": 2,
  "deleted_at": null,
  "user_deleted": false,
  "edit_reason": null,
  "can_view_edit_history": true,
  "wiki": false,
  "reactions": [
    {
      "id": "open_mouth",
      "type": "emoji",
      "count": 1
    }
  ],
  "current_user_reaction": null,
  "reaction_users_count": 1,
  "current_user_used_main_reaction": false
}