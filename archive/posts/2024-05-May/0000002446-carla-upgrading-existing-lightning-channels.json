{
  "id": 2446,
  "name": "Carla Kirk-Cohen",
  "username": "carla",
  "avatar_template": "/user_avatar/delvingbitcoin.org/carla/{size}/119_2.png",
  "created_at": "2024-05-17T16:59:00.453Z",
  "cooked": "<p>I\u2019ve been trying to wrap my head around the various ways we could go about upgrading lightning\u2019s existing channels, specifically in the context of upgrading to use V3 channels to improve our resilience against pinning attacks. I hope that this is a decent overview of what\u2019s out there - and if not, three cheers for cunningham\u2019s law.</p>\n<p>V3 transactions are <a href=\"https://github.com/bitcoin/bitcoin/pull/29496\" rel=\"noopener nofollow ugc\">on their way to being standard</a> and now have <a href=\"https://github.com/bitcoin/bitcoin/pull/29306\" rel=\"noopener nofollow ugc\">sibling eviction</a>, which means that within the next year or so (\u2122\ufe0f) we\u2019ll be able to get some great benefits by upgrading to a subset of the commitment changes outlined <a href=\"https://delvingbitcoin.org/t/lightning-transactions-with-v3-and-ephemeral-anchors/418\">here</a>, specifically:</p>\n<ul>\n<li>V3 commitment transactions</li>\n<li>Single, shared key anchor</li>\n<li>Removing CSV-1 delay from outputs</li>\n</ul>\n<p>To do this, we\u2019ll need a way to update the commitment type for the existing channels in the network, which is what the remainder of this post will discuss.</p>\n<h4><a name=\"upgrading-ln-channels-1\" class=\"anchor\" href=\"#upgrading-ln-channels-1\"></a>Upgrading LN Channels</h4>\n<p>There are various components of lightning channels that we may want to update (as outlined in <a href=\"https://github.com/lightning/bolts/pull/1117/files#diff-5152eb82a6ba0426cccaf2929b3731109ff96210379322e008f20974253ba179R527\" rel=\"noopener nofollow ugc\">#1117</a>):</p>\n<ul>\n<li>Parameter update: we would like to update the constraints exchanged in channel <a href=\"https://github.com/lightning/bolts/blob/5f8fea8dc3c8c612167dd9645c4a21fe9de2f147/02-peer-protocol.md#the-open_channel-message\" rel=\"noopener nofollow ugc\">open</a>/<a href=\"https://github.com/lightning/bolts/blob/5f8fea8dc3c8c612167dd9645c4a21fe9de2f147/02-peer-protocol.md#the-accept_channel-message\" rel=\"noopener nofollow ugc\">accept</a>.</li>\n<li>Commitment update: we would like to change the format of our commitment transaction, to upgrade our channel_type.</li>\n<li>Funding output update: we would like spending our funding output, to change our channel capacity or output type.</li>\n</ul>\n<p>We already have a few commitment type updates that we know we\u2019ll want:</p>\n<ul>\n<li>Non-anchor/anchor \u2192 Zero fee anchor channels</li>\n<li>Anchor channels \u2192 Simple taproot channels</li>\n<li>Simple taproot channels \u2192 PTLC channels</li>\n</ul>\n<p>There are a few approaches that we could take to achieve these different update types, and some overlap between what can be achieved by each proposal - reductively summarized in this table (please DYOReading):</p>\n<div class=\"md-table\">\n<table>\n<thead>\n<tr>\n<th></th>\n<th>Parameter Update</th>\n<th>Commitment Update</th>\n<th>Funding Output Update</th>\n<th>Status</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Dynamic Commitments <a href=\"https://github.com/lightning/bolts/pull/1117\" rel=\"noopener nofollow ugc\">#1117</a></td>\n<td>\u2713</td>\n<td>\u2713</td>\n<td>Change output type</td>\n<td>Specified and recently updated</td>\n</tr>\n<tr>\n<td>Splice to Upgrade (idea)</td>\n<td>x</td>\n<td>\u2713</td>\n<td>\u2713</td>\n<td>Idea, dependent on <a href=\"https://github.com/lightning/bolts/pull/1160\" rel=\"noopener nofollow ugc\">#1160</a> (currently in interop), not specified (afaik)</td>\n</tr>\n<tr>\n<td>Upgrade on Re-Establish <a href=\"https://github.com/lightning/bolts/pull/868/files\" rel=\"noopener nofollow ugc\">#868</a></td>\n<td>x</td>\n<td>\u2713</td>\n<td>x</td>\n<td>Specified, no recent review/updates</td>\n</tr>\n</tbody>\n</table>\n</div><h5><a name=\"what-about-taproot-channels-2\" class=\"anchor\" href=\"#what-about-taproot-channels-2\"></a>What about Taproot Channels?</h5>\n<p>Notable in the dynamic commitments proposal is the desire to update the network to simple taproot channels (STCs) to enjoy cost and privacy benefits, and eventually upgrade the network to PTLCs. This upgrade doesn\u2019t cleanly fit into the above categorization because, as currently defined, an update to taproot channels requires updates to both our funding output and commitment. There is an in between state we could consider where we only update our commitment, but that seems like it\u2019ll get ugly to implement.</p>\n<p>The table that follows attempts to draw some comparisons of the various ways that we could go about upgrading our channel_type to STC. It also includes two \u201cbase\u201d cases - V0 channels with no upgrade (ie, today\u2019s channels) and \u201cnative\u201d taproot channels (that don\u2019t need any upgrading) to help contextualize these values.</p>\n<div class=\"md-table\">\n<table>\n<thead>\n<tr>\n<th>Upgrade type</th>\n<th>Upgrade Cost</th>\n<th>Coop Close Cost [<em>1</em>]</th>\n<th>Channel Identity</th>\n<th>New Features (eg PTLCs)</th>\n<th>On Chain Privacy [<em>4</em>]</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>[base-case] <br> V0 No Upgrade</td>\n<td>n/a: base case</td>\n<td>Spend P2WSH <br> <br> Inputs (2-of-2 P2WSH): <br> 96 vbytes <br><br> Outputs (P2WPKH x2): <br> 62 vbytes <br><br> = 158 vbytes</td>\n<td>n/a: no update</td>\n<td>n/a: base case</td>\n<td>funding_output identifiable as 2-of-2 on close</td>\n</tr>\n<tr>\n<td>Dynamic Commitments</td>\n<td>Kickoff transaction <br> <br> Input (2-of-2 P2WSH): <br> 96 vbytes <br><br> Output (P2TR x3): <br> 129 vbytes <br><br> = 225 vbytes</td>\n<td>Spend Kickoff transaction <br> <br> Inputs (1 P2TR): <br> 57.5 vbytes <br><br> Outputs (P2TR x2): <br> 86 vbytes <br><br> Claim Kickoff anchor [<em>3</em>]: <br> + 57.5 vbytes for input <br><br> = 201 vbytes</td>\n<td>Maintained until \u201ckickoff\u201d broadcast, which is likely only on channel close so full channel lifetime</td>\n<td>Suggestion in proposal to use a bit in channel_update to advertise.</td>\n<td>funding_output identifiable as 2-of-2 on kickoff tx <br><br> 1-in/3-out kickoff fingerprintable</td>\n</tr>\n<tr>\n<td>Splice to Upgrade</td>\n<td>Splice transaction <br> <br> Input (2-of-2 P2WSH) [<em>2</em>]: <br> 96 vbytes <br><br> Output (P2TR x1): <br> 43 vbytes <br><br> = 139 vbytes</td>\n<td>Spend Splice Transaction <br> <br> Inputs (1 P2TR): <br> 57.5 vbytes <br><br> Outputs (P2TR x2): <br> 86 vbytes <br><br> = 143.5 vbytes</td>\n<td>Maintained until splice confirmation + 12 blocks, then re-announced (new channel). <br><br> Blocked on taproot gossip.</td>\n<td>Channel is re-announced, will be able to announce new features (with gossip v1.75).</td>\n<td>funding_output identifiable as 2-of-2 on splice tx</td>\n</tr>\n<tr>\n<td>Update on Re-Establish <br><br> *(or other update mechanism with no on-chain update)</td>\n<td>n/a: no on-chain update</td>\n<td>Spend P2WSH <br> <br> Inputs (2-of-2 P2WSH): <br> 96 vbytes <br><br> Outputs (P2WPKH x2): <br> 62 vbytes <br><br> = 158 vbytes</td>\n<td>Maintained</td>\n<td>No re-announcement in specification, would need gossip change to announce new features.</td>\n<td>funding_output identifiable as 2-of-2 on close</td>\n</tr>\n<tr>\n<td>[base case] <br> Native Taproot Channel</td>\n<td>n/a: base case</td>\n<td>Spend P2TR funding <br> <br> Inputs (1 P2TR): <br> 57.5 vbytes <br><br> Outputs (2 P2TR): <br> 86 vbytes <br><br> = 143.5 vbytes</td>\n<td>n/a: no update</td>\n<td>n/a: base case</td>\n<td>P2TR 1-in-2-out is our anonymity set</td>\n</tr>\n</tbody>\n</table>\n</div><p>Takeaways that I arrive at:</p>\n<ul>\n<li>The privacy and cost benefits of upgrading legacy channels to taproot are dubious IMO, so the benefits are:\n<ul>\n<li>Forward progress of moving towards PTLCs (which still need specification)</li>\n<li>Actually using taproot channels (more production experience, more good)</li>\n</ul>\n</li>\n<li>We\u2019ll likely get taproot gossip (1.75) before we get near specifying PTLCs, so there isn\u2019t any particular rush to upgrade to STCs.</li>\n<li>We\u2019re going to have to introduce a way to advertise new features (like PTLCs) for upgraded channels regardless of the approach we take.</li>\n</ul>\n<h4><a name=\"eating-the-elephant-3\" class=\"anchor\" href=\"#eating-the-elephant-3\"></a>Eating the Elephant</h4>\n<p>Some <a href=\"https://github.com/lightning/bolts/pull/863#issuecomment-1965119165\" rel=\"noopener nofollow ugc\">discussion</a> on these various proposals has already taken place on the splicing PR, but I wanted to open this up to start a thread here so that we have a better place to discuss multiple proposals rather than spamming up one PR. I agree with <a class=\"mention\" href=\"/u/t-bast\">@t-bast</a> assessment <a href=\"https://github.com/lightning/bolts/pull/863#issuecomment-2051246665\" rel=\"noopener nofollow ugc\">here</a> that it seems most reasonable to have two different upgrade paths: one for when we need to spend our funding output, and one where we just upgrade the channel without on-chain updates.</p>\n<p>I think that it makes sense to start work on a parameter + commitment upgrade via dynamic commitments, independently of how we choose to go about upgrading to taproot channels. This gives us the ability to upgrade to <code>option_zero_fee_htlc_tx</code> anchor channels, and provides a commitment format upgrade mechanism that can be used to get us to V3 channels (once specified).</p>\n<h4><a name=\"appendix-for-table-4\" class=\"anchor\" href=\"#appendix-for-table-4\"></a>Appendix for Table</h4>\n<p>Assumptions and notes for comparison table:</p>\n<p>[1] both parties have non-dust balances for cooperative close</p>\n<p>[2] splice to upgrade will be \u201cempty\u201d (add no inputs), fixed to make this most comparable to kickoff tx</p>\n<p>[3] assuming that the kickoff tx\u2019s anchor isn\u2019t spendable in the close transaction, but that we do have batching available so we only need to account for the extra input</p>\n<p>[4] only considering on-chain heuristics when looking at privacy heuristics (not considering gossip identifying UTXOs as lightning channels, as that\u2019s the same for everything)</p>\n<p>* note that an update without a funding output spend could also be achieved with an update to the dynamic commitments proposal.</p>",
  "post_number": 1,
  "post_type": 1,
  "updated_at": "2024-05-17T17:04:07.932Z",
  "reply_count": 0,
  "reply_to_post_number": null,
  "quote_count": 0,
  "incoming_link_count": 9,
  "reads": 8,
  "readers_count": 7,
  "score": 46.6,
  "yours": false,
  "topic_id": 881,
  "topic_slug": "upgrading-existing-lightning-channels",
  "topic_title": "Upgrading Existing Lightning Channels",
  "topic_html_title": "Upgrading Existing Lightning Channels",
  "category_id": 7,
  "display_username": "Carla Kirk-Cohen",
  "primary_group_name": null,
  "flair_name": null,
  "flair_url": null,
  "flair_bg_color": null,
  "flair_color": null,
  "flair_group_id": null,
  "version": 2,
  "can_edit": false,
  "can_delete": false,
  "can_recover": false,
  "can_see_hidden_post": false,
  "can_wiki": false,
  "user_title": "",
  "bookmarked": false,
  "raw": "I\u2019ve been trying to wrap my head around the various ways we could go about upgrading lightning\u2019s existing channels, specifically in the context of upgrading to use V3 channels to improve our resilience against pinning attacks. I hope that this is a decent overview of what\u2019s out there - and if not, three cheers for cunningham\u2019s law.\n\nV3 transactions are [on their way to being standard](https://github.com/bitcoin/bitcoin/pull/29496) and now have [sibling eviction](https://github.com/bitcoin/bitcoin/pull/29306), which means that within the next year or so (\u2122\ufe0f) we\u2019ll be able to get some great benefits by upgrading to a subset of the commitment changes outlined [here](https://delvingbitcoin.org/t/lightning-transactions-with-v3-and-ephemeral-anchors/418), specifically:\n\n* V3 commitment transactions\n* Single, shared key anchor\n* Removing CSV-1 delay from outputs\n\nTo do this, we\u2019ll need a way to update the commitment type for the existing channels in the network, which is what the remainder of this post will discuss.\n\n#### Upgrading LN Channels\n\n\nThere are various components of lightning channels that we may want to update (as outlined in [#1117](https://github.com/lightning/bolts/pull/1117/files#diff-5152eb82a6ba0426cccaf2929b3731109ff96210379322e008f20974253ba179R527)):\n\n* Parameter update: we would like to update the constraints exchanged in channel [open](https://github.com/lightning/bolts/blob/5f8fea8dc3c8c612167dd9645c4a21fe9de2f147/02-peer-protocol.md#the-open_channel-message)/[accept](https://github.com/lightning/bolts/blob/5f8fea8dc3c8c612167dd9645c4a21fe9de2f147/02-peer-protocol.md#the-accept_channel-message).\n* Commitment update: we would like to change the format of our commitment transaction, to upgrade our channel_type.\n* Funding output update: we would like spending our funding output, to change our channel capacity or output type.\n\nWe already have a few commitment type updates that we know we\u2019ll want:\n\n* Non-anchor/anchor -> Zero fee anchor channels\n* Anchor channels -> Simple taproot channels\n* Simple taproot channels -> PTLC channels\n\nThere are a few approaches that we could take to achieve these different update types, and some overlap between what can be achieved by each proposal - reductively summarized in this table (please DYOReading):\n\n||Parameter Update|Commitment Update|Funding Output Update|Status|\n| --- | --- | --- | --- | --- |\n|Dynamic Commitments [#1117](https://github.com/lightning/bolts/pull/1117)|\u2713|\u2713|Change output type|Specified and recently updated|\n|Splice to Upgrade (idea)|x| \u2713|\u2713|Idea, dependent on [#1160](https://github.com/lightning/bolts/pull/1160) (currently in interop), not specified (afaik)|\n|Upgrade on Re-Establish [#868](https://github.com/lightning/bolts/pull/868/files)|x|\u2713|x|Specified, no recent review/updates|\n\n##### What about Taproot Channels?\n\nNotable in the dynamic commitments proposal is the desire to update the network to simple taproot channels (STCs) to enjoy cost and privacy benefits, and eventually upgrade the network to PTLCs. This upgrade doesn\u2019t cleanly fit into the above categorization because, as currently defined, an update to taproot channels requires updates to both our funding output and commitment. There is an in between state we could consider where we only update our commitment, but that seems like it\u2019ll get ugly to implement.\n\nThe table that follows attempts to draw some comparisons of the various ways that we could go about upgrading our channel_type to STC. It also includes two \u201cbase\u201d cases - V0 channels with no upgrade (ie, today\u2019s channels) and \u201cnative\u201d taproot channels (that don\u2019t need any upgrading) to help contextualize these values.\n\n| Upgrade type          | Upgrade Cost       | Coop Close Cost [*1*] | Channel Identity | New Features (eg PTLCs) | On Chain Privacy [*4*] |\n|-----------------------|--------------------|------------------------|------------------|--------------------------|-----------------------|\n| [base-case] <br> V0 No Upgrade | n/a: base case | Spend P2WSH <br> <br> Inputs (2-of-2 P2WSH): <br> 96 vbytes <br><br> Outputs (P2WPKH x2): <br> 62 vbytes <br><br> = 158 vbytes | n/a: no update | n/a: base case | funding_output identifiable as 2-of-2 on close |\n| Dynamic Commitments   | Kickoff transaction <br> <br> Input (2-of-2 P2WSH): <br> 96 vbytes <br><br> Output (P2TR x3): <br> 129 vbytes <br><br> = 225 vbytes | Spend Kickoff transaction <br> <br> Inputs (1 P2TR): <br> 57.5 vbytes <br><br> Outputs (P2TR x2): <br> 86 vbytes <br><br> Claim Kickoff anchor [*3*]: <br> + 57.5 vbytes for input <br><br> = 201 vbytes | Maintained until \u201ckickoff\u201d broadcast, which is likely only on channel close so full channel lifetime | Suggestion in proposal to use a bit in channel_update to advertise. | funding_output identifiable as 2-of-2 on kickoff tx <br><br> 1-in/3-out kickoff fingerprintable |\n| Splice to Upgrade     | Splice transaction <br> <br> Input (2-of-2 P2WSH) [*2*]: <br> 96 vbytes <br><br> Output (P2TR x1): <br> 43 vbytes <br><br> = 139 vbytes | Spend Splice Transaction <br> <br> Inputs (1 P2TR): <br> 57.5 vbytes <br><br> Outputs (P2TR x2): <br> 86 vbytes <br><br> = 143.5 vbytes | Maintained until splice confirmation + 12 blocks, then re-announced (new channel). <br><br> Blocked on taproot gossip. | Channel is re-announced, will be able to announce new features (with gossip v1.75). | funding_output identifiable as 2-of-2 on splice tx |\n| Update on Re-Establish <br><br> *(or other update mechanism with no on-chain update) | n/a: no on-chain update | Spend P2WSH <br> <br> Inputs (2-of-2 P2WSH): <br> 96 vbytes <br><br> Outputs (P2WPKH x2): <br> 62 vbytes <br><br> = 158 vbytes | Maintained | No re-announcement in specification, would need gossip change to announce new features. | funding_output identifiable as 2-of-2 on close |\n| [base case] <br> Native Taproot Channel | n/a: base case | Spend P2TR funding <br> <br> Inputs (1 P2TR): <br> 57.5 vbytes <br><br> Outputs (2 P2TR): <br> 86 vbytes <br><br> = 143.5 vbytes | n/a: no update | n/a: base case | P2TR 1-in-2-out is our anonymity set |\n\n\n\nTakeaways that I arrive at:\n\n* The privacy and cost benefits of upgrading legacy channels to taproot are dubious IMO, so the benefits are:\n  * Forward progress of moving towards PTLCs (which still need specification)\n  * Actually using taproot channels (more production experience, more good)\n* We\u2019ll likely get taproot gossip (1.75) before we get near specifying PTLCs, so there isn\u2019t any particular rush to upgrade to STCs.\n* We\u2019re going to have to introduce a way to advertise new features (like PTLCs) for upgraded channels regardless of the approach we take.\n\n#### Eating the Elephant\n\nSome [discussion](https://github.com/lightning/bolts/pull/863#issuecomment-1965119165) on these various proposals has already taken place on the splicing PR, but I wanted to open this up to start a thread here so that we have a better place to discuss multiple proposals rather than spamming up one PR. I agree with @t-bast assessment [here](https://github.com/lightning/bolts/pull/863#issuecomment-2051246665) that it seems most reasonable to have two different upgrade paths: one for when we need to spend our funding output, and one where we just upgrade the channel without on-chain updates.\n\nI think that it makes sense to start work on a parameter + commitment upgrade via dynamic commitments, independently of how we choose to go about upgrading to taproot channels. This gives us the ability to upgrade to `option_zero_fee_htlc_tx` anchor channels, and provides a commitment format upgrade mechanism that can be used to get us to V3 channels (once specified).\n\n#### Appendix for Table\n\nAssumptions and notes for comparison table:\n\n[1] both parties have non-dust balances for cooperative close\n\n[2] splice to upgrade will be \u201cempty\u201d (add no inputs), fixed to make this most comparable to kickoff tx\n\n[3] assuming that the kickoff tx\u2019s anchor isn\u2019t spendable in the close transaction, but that we do have batching available so we only need to account for the extra input\n\n[4] only considering on-chain heuristics when looking at privacy heuristics (not considering gossip identifying UTXOs as lightning channels, as that\u2019s the same for everything)\n\n\\* note that an update without a funding output spend could also be achieved with an update to the dynamic commitments proposal.",
  "actions_summary": [],
  "moderator": false,
  "admin": false,
  "staff": false,
  "user_id": 124,
  "hidden": false,
  "trust_level": 1,
  "deleted_at": null,
  "user_deleted": false,
  "edit_reason": "Github link was replaced with a permanent link",
  "can_view_edit_history": true,
  "wiki": false,
  "reactions": [],
  "current_user_reaction": null,
  "reaction_users_count": 0,
  "current_user_used_main_reaction": false
}