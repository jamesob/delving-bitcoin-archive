{
  "id": 2725,
  "name": "Rene Pickhardt",
  "username": "renepickhardt",
  "avatar_template": "/user_avatar/delvingbitcoin.org/renepickhardt/{size}/7_2.png",
  "created_at": "2024-06-17T18:21:35.341Z",
  "cooked": "<p>Dear fellow Lightning Network developers,</p>\n<p>as some of you are already aware (through out of band communication) I am currently developing and finalizing a paper with a mathematical theory of payment channel networks. For the paper I created a small example that shows how to apply the rather technical and abstract geometric concepts to describe the Lightning Network. I thought this standalone example / application might be of interest for you.</p>\n<p>The following is a summary of an ipython notebook from my <a href=\"https://github.com/renepickhardt/Lightning-Network-Limitations/blob/46e6fce28510be1db646dc8967ed2299e19243d8/likelihood-of-payment-possability/Likelihood%20of%20Payments.ipynb\" rel=\"noopener nofollow ugc\">Github reopository in which I develop the theory and research paper</a> (Caution: The current latex file of the paper in the repository is a very early / incomplete and wrong draft. I would not recomand to read it yet. I expect a much more complete and accurate version to be updated later this month):</p>\n<h2><a name=\"abstract-1\" class=\"anchor\" href=\"#abstract-1\"></a>Abstract</h2>\n<p>In <a href=\"https://arxiv.org/abs/2103.08576\" rel=\"noopener nofollow ugc\">prior research we have provided a method of estimating the liquidity in payment channels</a>. This was used to compute success probabilities for payments. The proposed model has several flaws:</p>\n<ol>\n<li>It assumes the liquidity distributions in channels are independent of each other</li>\n<li>it uses a uniform distribution to model the uncertainty</li>\n</ol>\n<p>The second issue is being addressed through the <a href=\"https://lightning.engineering/posts/2024-05-23-pathfinding-2/\" rel=\"noopener nofollow ugc\">introduction of bimodal models</a>. However <a href=\"https://github.com/renepickhardt/Lightning-Network-Limitations/blob/906b3a4d691cbfb30c2f385c6697b4fe2bb81676/Limits%20of%20two%20party%20channels/Geometric%20Argument%20for%20Bimodal%20Liquidity%20Distribution%20in%20Payment%20Channels%20of%20the%20Lightning%20Network.ipynb\" rel=\"noopener nofollow ugc\">we believe the observed bimodal distributions emerge due to the geometry of payment channel network</a>. This happens in particular if the first assumption is dropped.</p>\n<h2><a name=\"contribution-2\" class=\"anchor\" href=\"#contribution-2\"></a>Contribution</h2>\n<p>This notebook provides a tiny examples to demonstrate how one can compute the payment success rate between two peers on the lightning network for a payment amount even if no information about the liquidity distribution is availble. We do however assume that the sender owns more coins that he wishes to send (Though we could easily drop that assumption).</p>\n<p>For this we start from the assumption that all feasible wealth distributions (not channel states!) in the given topology are equally likely to occur. As payments are changes in the wealth distribution <strong>we just have to test for all feasible wealth distributions if the change induced by the payment is still a feasible wealth distribution</strong>. The fraction of payments for which this is possible is the expected success probability of a payment.</p>\n<h3><a name=\"math-formulation-3\" class=\"anchor\" href=\"#math-formulation-3\"></a>Math formulation</h3>\n<p>Let <span class=\"math\">w=(w_1,\\dots,w_n)</span> be a wealth vector. Furth let <span class=\"math\">b_1,\\dots,b_n \\in \\mathbb{Z}^n</span> be unit base vectors that span the space of feasible wealth distributions. Then a payment is the new wealth vector <span class=\"math\">w'</span> which can be computed via the following:</p>\n<p><span class=\"math\">w'= w -amt\\cdot b_{src} + amt\\cdot b_{dest}</span></p>\n<p>if <span class=\"math\">w'</span> is feasible then the payment was feasible.</p>\n<p><strong>Caution</strong> this assumes that all feasible wealth distributions are equally likely. This is neither the same as assuming that the liquidity in channels is uniformly distributed nor the same as assuming that the wealth is equally distributed. The reason is that the network topology makes many wealth distributions infeasible. Thus despite assuming uniformity among the feasible wealth distributions this assumption is hopefully close enough to match the reality of a skew power law distributed wealth.</p>\n<p><strong>Important</strong>: The probabilities for a payment to be feasible is not related to attempt probabilities! Instead the probabilties computed with this method estimate weather it is likely that with sufficient attempts a payment is feasible and thus eventually succesfully being deliverd.</p>\n<h2><a name=\"results-4\" class=\"anchor\" href=\"#results-4\"></a>Results</h2>\n<p>Take the following Network\n<div class=\"lightbox-wrapper\"><a class=\"lightbox\" href=\"https://delvingbitcoin.org/uploads/default/original/1X/3a563a1dc3fadb0c448f921c20d62bef8c0b5d09.png\" data-download-href=\"https://delvingbitcoin.org/uploads/default/3a563a1dc3fadb0c448f921c20d62bef8c0b5d09\" title=\"A mathematical theory of payment channels\"><img src=\"https://delvingbitcoin.org/uploads/default/original/1X/3a563a1dc3fadb0c448f921c20d62bef8c0b5d09.png\" alt=\"A mathematical theory of payment channels\" data-base62-sha1=\"8k4qTANUgedCZKwtMiKS5Yjaxol\" width=\"690\" height=\"388\" data-dominant-color=\"FCFCFC\"><div class=\"meta\"><svg class=\"fa d-icon d-icon-far-image svg-icon\" aria-hidden=\"true\"><use href=\"#far-image\"></use></svg><span class=\"filename\">A mathematical theory of payment channels</span><span class=\"informations\">960\u00d7540 8.96 KB</span><svg class=\"fa d-icon d-icon-discourse-expand svg-icon\" aria-hidden=\"true\"><use href=\"#discourse-expand\"></use></svg></div></a></div></p>\n<p>We get the blue curve that depicts how likely it is that a payment of a certain amount can be sent from any peer to any other peer. In comparison we depicted the likelihood of the min cost flow. Of course the min cost flow probability has to be lower as the payment could still be feasible while the min cost flow fails:</p>\n<p><img src=\"https://delvingbitcoin.org/uploads/default/original/1X/ca36065b1be697d2402c5165a49e7155700d11a9.png\" alt=\"comparisionWithMCF\" data-base62-sha1=\"sQQcc4NnL6pjwxEGaEQPqmVkfKp\" width=\"640\" height=\"480\"></p>\n<h3><a name=\"example-5\" class=\"anchor\" href=\"#example-5\"></a>Example</h3>\n<p>Let us look at the likelihood of node <code>0</code> being able to send <code>5</code> coins to node <code>1</code>.  Given our methodology the likelihood that this payment is feasible on this network is: <code>39.22%</code></p>\n<p>Using the methods of probabilistic pathfinding with independend and uniform liquidity distributions we see:</p>\n<pre><code class=\"lang-auto\">P1: s=0.00% (0)--- 3----&gt;(1)\n\nP2: s=21.87% (0)--- 7----&gt;(2)---11----&gt;(1)\n</code></pre>\n<p>This means of course node <code>0</code> cannot send <code>5</code> coins on <code>P1</code> to node <code>1</code> as the path has only one channel with capacity 3.</p>\n<p>The likelihood on the send path is <code>21.87%</code></p>\n<p>The minmum cost flow would however split the payment and attempt to send <code>coin</code> along <code>P1</code> and <code>4</code> coins along <code>P2</code>. This results in a <code>25%</code> chance to settle this MPP attempt.</p>\n<p>If on the other hand node <code>1</code> wanted to send <code>5</code> coins to node <code>2</code> then we get the following likelihoods:</p>\n<pre><code class=\"lang-auto\">5 coins from (1) to (2)\t\t expected success rate = 64.05% \t\t \nP1: s=58.33% (1)---11----&gt;(2)\nP2: s=0.00% (1)--- 3----&gt;(0)--- 7----&gt;(2)\nNot both P1 and P2 fail: 58.33%\nMCF: s=43.75% 4 to P1 and 1 to P2\n</code></pre>\n<p>The increase makes sense as node <code>1</code> and <code>2</code> have access to more liquidity and thus should be more likeli to be able to conduct a payment.</p>\n<h2><a name=\"conclusion-6\" class=\"anchor\" href=\"#conclusion-6\"></a>Conclusion</h2>\n<p>We can produce a likelihood that estimates how likely a payment is feasible on the lightning network. We have seen that it is not necessary to estimate the liquidity in channels in order to do so. In particular there are always feasible states from which the payment is not feasible. (for example the receiving node doesn\u2019t have sufficient inbound liquidity)</p>\n<p><strong>Thus Lightning Network payments cannot work in 100% of the time.</strong></p>\n<p>Also we have seen that optimally reliable payment flows always have a lower success probability than the probability that the payment is feasible. This is to be expected. However relying purely on flows and paths it seemed tricky to estimate the feasibility of a payment as one would have to simulate the payment loop.</p>\n<p>Of course extending this method to a larger network is a bit more work as testing feasibility and sampling feasible wealth distributions is a bit more tricky (but possible in polynomial time as will be explained in detail in the paper)</p>\n<p>I am curious about your thoughts, feedback or questions.</p>\n<p>with kind regards Rene Pickhardt</p>",
  "post_number": 1,
  "post_type": 1,
  "updated_at": "2024-06-17T18:27:44.834Z",
  "reply_count": 0,
  "reply_to_post_number": null,
  "quote_count": 0,
  "incoming_link_count": 13,
  "reads": 5,
  "readers_count": 4,
  "score": 66.0,
  "yours": false,
  "topic_id": 973,
  "topic_slug": "estimating-likelihood-for-lightning-payments-to-be-in-feasible",
  "topic_title": "Estimating Likelihood for Lightning Payments to be (in)feasible",
  "topic_html_title": "Estimating Likelihood for Lightning Payments to be (in)feasible",
  "category_id": 7,
  "display_username": "Rene Pickhardt",
  "primary_group_name": null,
  "flair_name": null,
  "flair_url": null,
  "flair_bg_color": null,
  "flair_color": null,
  "flair_group_id": null,
  "version": 3,
  "can_edit": false,
  "can_delete": false,
  "can_recover": false,
  "can_see_hidden_post": false,
  "can_wiki": false,
  "user_title": null,
  "bookmarked": false,
  "raw": "Dear fellow Lightning Network developers, \n\nas some of you are already aware (through out of band communication) I am currently developing and finalizing a paper with a mathematical theory of payment channel networks. For the paper I created a small example that shows how to apply the rather technical and abstract geometric concepts to describe the Lightning Network. I thought this standalone example / application might be of interest for you. \n\nThe following is a summary of an ipython notebook from my [Github reopository in which I develop the theory and research paper](https://github.com/renepickhardt/Lightning-Network-Limitations/blob/46e6fce28510be1db646dc8967ed2299e19243d8/likelihood-of-payment-possability/Likelihood%20of%20Payments.ipynb\n) (Caution: The current latex file of the paper in the repository is a very early / incomplete and wrong draft. I would not recomand to read it yet. I expect a much more complete and accurate version to be updated later this month):\n\n## Abstract \n\nIn [prior research we have provided a method of estimating the liquidity in payment channels](https://arxiv.org/abs/2103.08576). This was used to compute success probabilities for payments. The proposed model has several flaws:\n\n1. It assumes the liquidity distributions in channels are independent of each other\n2. it uses a uniform distribution to model the uncertainty\n\nThe second issue is being addressed through the [introduction of bimodal models](https://lightning.engineering/posts/2024-05-23-pathfinding-2/). However [we believe the observed bimodal distributions emerge due to the geometry of payment channel network](https://github.com/renepickhardt/Lightning-Network-Limitations/blob/906b3a4d691cbfb30c2f385c6697b4fe2bb81676/Limits%20of%20two%20party%20channels/Geometric%20Argument%20for%20Bimodal%20Liquidity%20Distribution%20in%20Payment%20Channels%20of%20the%20Lightning%20Network.ipynb). This happens in particular if the first assumption is dropped. \n\n## Contribution\nThis notebook provides a tiny examples to demonstrate how one can compute the payment success rate between two peers on the lightning network for a payment amount even if no information about the liquidity distribution is availble. We do however assume that the sender owns more coins that he wishes to send (Though we could easily drop that assumption).\n\nFor this we start from the assumption that all feasible wealth distributions (not channel states!) in the given topology are equally likely to occur. As payments are changes in the wealth distribution **we just have to test for all feasible wealth distributions if the change induced by the payment is still a feasible wealth distribution**. The fraction of payments for which this is possible is the expected success probability of a payment. \n\n### Math formulation\n\nLet $w=(w_1,\\dots,w_n)$ be a wealth vector. Furth let $b_1,\\dots,b_n \\in \\mathbb{Z}^n$ be unit base vectors that span the space of feasible wealth distributions. Then a payment is the new wealth vector $w'$ which can be computed via the following:\n\n$w'= w -amt\\cdot b_{src} + amt\\cdot b_{dest}$\n\nif $w'$ is feasible then the payment was feasible.\n\n\n**Caution** this assumes that all feasible wealth distributions are equally likely. This is neither the same as assuming that the liquidity in channels is uniformly distributed nor the same as assuming that the wealth is equally distributed. The reason is that the network topology makes many wealth distributions infeasible. Thus despite assuming uniformity among the feasible wealth distributions this assumption is hopefully close enough to match the reality of a skew power law distributed wealth.\n\n**Important**: The probabilities for a payment to be feasible is not related to attempt probabilities! Instead the probabilties computed with this method estimate weather it is likely that with sufficient attempts a payment is feasible and thus eventually succesfully being deliverd.\n \n## Results\n\nTake the following Network\n![A mathematical theory of payment channels|690x388](upload://8k4qTANUgedCZKwtMiKS5Yjaxol.png)\n\nWe get the blue curve that depicts how likely it is that a payment of a certain amount can be sent from any peer to any other peer. In comparison we depicted the likelihood of the min cost flow. Of course the min cost flow probability has to be lower as the payment could still be feasible while the min cost flow fails: \n  \n![comparisionWithMCF|640x480](upload://sQQcc4NnL6pjwxEGaEQPqmVkfKp.png)\n\n### Example\nLet us look at the likelihood of node `0` being able to send `5` coins to node `1`.  Given our methodology the likelihood that this payment is feasible on this network is: `39.22%`\n\nUsing the methods of probabilistic pathfinding with independend and uniform liquidity distributions we see:\n```\nP1: s=0.00% (0)--- 3---->(1)\n\nP2: s=21.87% (0)--- 7---->(2)---11---->(1)\n```\nThis means of course node `0` cannot send `5` coins on `P1` to node `1` as the path has only one channel with capacity 3. \n\nThe likelihood on the send path is `21.87%`\n\nThe minmum cost flow would however split the payment and attempt to send `coin` along `P1` and `4` coins along `P2`. This results in a `25%` chance to settle this MPP attempt. \n\nIf on the other hand node `1` wanted to send `5` coins to node `2` then we get the following likelihoods:\n\n```\n5 coins from (1) to (2)\t\t expected success rate = 64.05% \t\t \nP1: s=58.33% (1)---11---->(2)\nP2: s=0.00% (1)--- 3---->(0)--- 7---->(2)\nNot both P1 and P2 fail: 58.33%\nMCF: s=43.75% 4 to P1 and 1 to P2\n```\nThe increase makes sense as node `1` and `2` have access to more liquidity and thus should be more likeli to be able to conduct a payment. \n\n## Conclusion\n\nWe can produce a likelihood that estimates how likely a payment is feasible on the lightning network. We have seen that it is not necessary to estimate the liquidity in channels in order to do so. In particular there are always feasible states from which the payment is not feasible. (for example the receiving node doesn't have sufficient inbound liquidity)\n\n**Thus Lightning Network payments cannot work in 100% of the time.**\n\n\nAlso we have seen that optimally reliable payment flows always have a lower success probability than the probability that the payment is feasible. This is to be expected. However relying purely on flows and paths it seemed tricky to estimate the feasibility of a payment as one would have to simulate the payment loop. \n\nOf course extending this method to a larger network is a bit more work as testing feasibility and sampling feasible wealth distributions is a bit more tricky (but possible in polynomial time as will be explained in detail in the paper)\n\nI am curious about your thoughts, feedback or questions. \n\nwith kind regards Rene Pickhardt",
  "actions_summary": [],
  "moderator": false,
  "admin": false,
  "staff": false,
  "user_id": 8,
  "hidden": false,
  "trust_level": 2,
  "deleted_at": null,
  "user_deleted": false,
  "edit_reason": null,
  "can_view_edit_history": true,
  "wiki": false,
  "reactions": [],
  "current_user_reaction": null,
  "reaction_users_count": 0,
  "current_user_used_main_reaction": false
}