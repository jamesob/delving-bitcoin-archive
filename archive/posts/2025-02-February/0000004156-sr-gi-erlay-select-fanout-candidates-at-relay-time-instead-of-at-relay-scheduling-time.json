{
  "id": 4156,
  "name": "Sergi Delgado",
  "username": "sr-gi",
  "avatar_template": "/user_avatar/delvingbitcoin.org/sr-gi/{size}/117_2.png",
  "created_at": "2025-02-03T15:57:59.875Z",
  "cooked": "<p>This post is part of the Erlay implementation experiments. See <a href=\"https://delvingbitcoin.org/t/erlay-overview-and-current-approach/1415\">Erlay: Overview and current approach</a> for context.</p>\n<h1><a name=\"p-4156-thesis-1\" class=\"anchor\" href=\"#p-4156-thesis-1\"></a>Thesis</h1>\n<p>Fanout targets are selected on a transaction basis. That means, for each transaction to be relayed, a subset of our peers is selected for fanout, while the rest would be used for transaction reconciliation. The fanout candidate selection can be done at two stages of the transaction relay process:</p>\n<ul>\n<li>At relay schedule, when the transaction is received/created and it is queued for relay to transaction relaying peers</li>\n<li>At transaction relay, after the Poisson timer for a peer has gone off and the corresponding <code>INV</code> message is to be created</li>\n</ul>\n<p>Our current implementation follows the former, since it is easier to reason about transaction dependencies during transaction scheduling, however, at relay time it should be easier to adapt to fanout candidates already knowing about the target transaction, and potentially swap candidates so the desired fanout rate can be achieved. For a more extensive explanation of both approaches, check: <a href=\"https://delvingbitcoin.org/t/erlay-overview-and-current-approach/1415#p-4127-choosing-fanout-peers-at-relay-scheduling-time-4\">Choosing fanout peers at relay scheduling time</a> and <a href=\"https://delvingbitcoin.org/t/erlay-overview-and-current-approach/1415#p-4127-choosing-fanout-peers-at-transaction-relay-time-5\">Choosing fanout peers at transaction relay time</a>.</p>\n<h1><a name=\"p-4156-simulation-2\" class=\"anchor\" href=\"#p-4156-simulation-2\"></a>Simulation</h1>\n<p>To simulate the difference between both approaches, a new branch has been created in the <a href=\"https://delvingbitcoin.org/t/hyperion-a-discrete-time-network-event-simulator-for-bitcoin-core/1042\">simulator</a> where the decision-making is done at transaction relay time instead of at relay scheduling time. The new branch gets rid of the <code>delayed_set</code> for Erlay peers in their <code>TxReconciliationState</code>, and all transactions are kept in <code>to_be_announced</code> until relay time, where they would be picked for fanout or reconciliation based on <code>get_fanout_targets</code>. Since this process happens on a peer basis, fanout targets are now cached, so the selection is consistent for all peers of a given node for a given transaction.</p>\n<p>To simulate this we will use a randomly generated network containing 110000 nodes, 10000 reachable, 100000 unreachable with 8 outbounds per node, <strong>all of them implementing Erlay.</strong> The simulation can be run using the code at <a href=\"https://github.com/sr-gi/hyperion/commit/32f5af9b39a9387d7f745df7da16645e69457d9e\" class=\"inline-onebox\" rel=\"noopener nofollow ugc\">lib: Picks fanout peers at relay time instead of at scheduling time \u00b7 sr-gi/hyperion@32f5af9 \u00b7 GitHub</a>.</p>\n<h2><a name=\"p-4156-results-3\" class=\"anchor\" href=\"#p-4156-results-3\"></a>Results</h2>\n<p>Here are the results of running our simulation in our reference model, that is, a network of the aforementioned characteristics selecting fanout candidates <strong>at scheduling time</strong>:</p>\n<pre data-code-wrap=\"cmd\"><code class=\"lang-cmd\">2024-12-20T22:12:59.431Z INFO  [hyper_lib::simulator] Using user provided rng seed: 5831067508548421759\n2024-12-20T22:12:59.438Z INFO  [hyper_lib::network] Creating nodes (110000: 10000 reachable, 100000 unreachable)\n2024-12-20T22:12:59.568Z INFO  [hyperion] The simulation will be run 100 times and results will be averaged\n2024-12-20T22:17:42.069Z INFO  [hyper_lib] Transaction reached 90% of nodes in the network in 20.764025s\n2024-12-20T22:17:42.069Z INFO  [hyper_lib] Transaction reached all nodes in 28.108896s\n2024-12-20T22:17:42.069Z INFO  [hyper_lib] Reachable nodes sent/received 222.2216/369.73523 messages (715.59644/1069.915 bytes) (avg)\n2024-12-20T22:17:42.069Z INFO  [hyper_lib] Unreachable nodes sent/received 32.36946/17.618101 messages (94.462814/59.03094 bytes) (avg)\n</code></pre>\n<p>And the same simulation in our updated model, selecting fanout peers <strong>at relay time:</strong></p>\n<pre data-code-wrap=\"cmd\"><code class=\"lang-cmd\">2024-12-20T22:34:03.686Z INFO  [hyper_lib::simulator] Using user provided rng seed: 5831067508548421759\n2024-12-20T22:34:03.694Z INFO  [hyper_lib::network] Creating nodes (110000: 10000 reachable, 100000 unreachable)\n2024-12-20T22:34:03.826Z INFO  [hyperion] The simulation will be run 100 times and results will be averaged\n2024-12-20T22:39:01.915Z INFO  [hyper_lib] Transaction reached 90% of nodes in the network in 20.655256s\n2024-12-20T22:39:01.915Z INFO  [hyper_lib] Transaction reached all nodes in 28.008577s\n2024-12-20T22:39:01.915Z INFO  [hyper_lib] Reachable nodes sent/received 221.15518/367.86584 messages (715.5273/1068.999 bytes) (avg)\n2024-12-20T22:39:01.915Z INFO  [hyper_lib] Unreachable nodes sent/received 32.20926/17.538193 messages (94.39123/59.044044 bytes) (avg)\n</code></pre>\n<p>Finally, here are both simulations as a <code>csv</code> for easier comparison:</p>\n<pre data-code-wrap=\"csv\"><code class=\"lang-csv\">timestamp,percentile-target,percentile-time,full-propagation-time,r-sent-msgs,r-received-msgs,r-sent-bytes,r-received-bytes,u-sent-msgs,u-received-msgs,u-sent-bytes,u-received-bytes,r,u,n,erlay,seed\n1734733062,90,20764024832,28108896256,222.2216,369.73523,715.59644,1069.915,32.36946,17.618101,94.462814,59.03094,10000,100000,100,true,5831067508548421759\n1734734341,90,20655255552,28008577024,221.15518,367.86584,715.5273,1068.999,32.20926,17.538193,94.39123,59.044044,10000,100000,100,true,583106750854842175\n</code></pre>\n<p>We can see that there are no meaningful differences between the two simulations, which may sound surprising. To understand why this is the case, we can follow a similar approach as per our <a href=\"https://delvingbitcoin.org/t/erlay-filter-fanout-candidates-based-on-transaction-knowledge/1416\">filter fanout candidates based on transaction knowledge simulation</a>. This time we will modify the simulation slightly. Instead of just recording how many peers have announced a transaction to us by the time we need to select fanout candidates, we will be taking two samples: <strong>the first one will be taken at transaction relay scheduling</strong>, point at where our reference model selects fanout peers, and <strong>the second one will be taken at transaction relay time</strong>, when our current model selects them.</p>\n<p>This creates an output containing a tuple <code>(first_sample, second_sample, is_reachable)</code> for all nodes where first_sample \u2260 second_sample. To run this test, we can use the code at <a href=\"https://github.com/sr-gi/hyperion/commit/333b22f4b929449b86304da8bb9010fccafaf651\" class=\"inline-onebox\" rel=\"noopener nofollow ugc\">lib: Adds heard count and record it on relay scheduling and transacti\u2026 \u00b7 sr-gi/hyperion@333b22f \u00b7 GitHub</a>, a simulation without repetition will suffice here (<code>-n=1</code>). The resulting output looks as follows:</p>\n<pre data-code-wrap=\"cmd\"><code class=\"lang-cmd\">(1, 2, false)\n(1, 2, true)\n(1, 2, true)\n(1, 2, true)\n(1, 2, true)\n(1, 2, true)\n(1, 2, true)\n...\n(2, 3, true)\n(2, 3, true)\n(2, 4, true)\n(3, 5, true)\n(1, 2, true)\n</code></pre>\n<p>The most noticeable aspect of the simulation results is the number of entries in the output: only <strong>4824</strong> out of <strong>110000</strong> nodes showed a difference. In other words, <strong>approximately 4.38% of the nodes in our simulated network</strong> <sup class=\"footnote-ref\"><a href=\"#footnote-4156-1\" id=\"footnote-ref-4156-1\">[1]</a></sup>. From the sampled nodes, about 43% of them are unreachable, and almost 98% of those show an increase of a single peer between the two samples (going from a single peer, the one that shared the transaction with them, to two).</p>\n<h1><a name=\"p-4156-conclusion-4\" class=\"anchor\" href=\"#p-4156-conclusion-4\"></a>Conclusion</h1>\n<p>This simulation shows that <strong>there is no significant difference between selecting peers at scheduling time or relay time.</strong> It is worth noting that this is likely derived from using a full Erlay network, and <strong>results may vary if simulated in networks with partial support</strong>.</p>\n<p>We are currently simulating scenarios where <strong>the whole network is composed of Erlay peers</strong>, plus the amount of peers selected for fanout is rather small (1 outbound and 10% of inbounds). This means the expected number of received <code>INV</code> messages should be rather small.</p>\n<hr class=\"footnotes-sep\">\n\n<ol class=\"footnotes-list\">\n<li id=\"footnote-4156-1\" class=\"footnote-item\"><p>The exact value may vary between simulations, given the random nature of some of the involved processes, however, several runs with different seeds have yielded very similar results, obtaining samples of only ~4% of nodes in the network. <a href=\"#footnote-ref-4156-1\" class=\"footnote-backref\">\u21a9\ufe0e</a></p>\n</li>\n</ol>",
  "post_number": 1,
  "post_type": 1,
  "updated_at": "2025-02-03T15:57:59.875Z",
  "reply_count": 0,
  "reply_to_post_number": null,
  "quote_count": 0,
  "incoming_link_count": 0,
  "reads": 8,
  "readers_count": 7,
  "score": 1.6,
  "yours": false,
  "topic_id": 1418,
  "topic_slug": "erlay-select-fanout-candidates-at-relay-time-instead-of-at-relay-scheduling-time",
  "topic_title": "Erlay: Select fanout candidates at relay time instead of at relay scheduling time",
  "topic_html_title": "Erlay: Select fanout candidates at relay time instead of at relay scheduling time",
  "category_id": 7,
  "display_username": "Sergi Delgado",
  "primary_group_name": null,
  "flair_name": null,
  "flair_url": null,
  "flair_bg_color": null,
  "flair_color": null,
  "flair_group_id": null,
  "badges_granted": [],
  "version": 1,
  "can_edit": false,
  "can_delete": false,
  "can_recover": false,
  "can_see_hidden_post": false,
  "can_wiki": false,
  "user_title": null,
  "bookmarked": false,
  "raw": "This post is part of the Erlay implementation experiments. See [Erlay: Overview and current approach](https://delvingbitcoin.org/t/erlay-overview-and-current-approach/1415) for context.\n\n# Thesis\n\nFanout targets are selected on a transaction basis. That means, for each transaction to be relayed, a subset of our peers is selected for fanout, while the rest would be used for transaction reconciliation. The fanout candidate selection can be done at two stages of the transaction relay process:\n\n- At relay schedule, when the transaction is received/created and it is queued for relay to transaction relaying peers\n- At transaction relay, after the Poisson timer for a peer has gone off and the corresponding `INV` message is to be created\n\nOur current implementation follows the former, since it is easier to reason about transaction dependencies during transaction scheduling, however, at relay time it should be easier to adapt to fanout candidates already knowing about the target transaction, and potentially swap candidates so the desired fanout rate can be achieved. For a more extensive explanation of both approaches, check: [Choosing fanout peers at relay scheduling time](https://delvingbitcoin.org/t/erlay-overview-and-current-approach/1415#p-4127-choosing-fanout-peers-at-relay-scheduling-time-4) and [Choosing fanout peers at transaction relay time](https://delvingbitcoin.org/t/erlay-overview-and-current-approach/1415#p-4127-choosing-fanout-peers-at-transaction-relay-time-5).\n\n# Simulation\n\nTo simulate the difference between both approaches, a new branch has been created in the [simulator](https://delvingbitcoin.org/t/hyperion-a-discrete-time-network-event-simulator-for-bitcoin-core/1042) where the decision-making is done at transaction relay time instead of at relay scheduling time. The new branch gets rid of the `delayed_set` for Erlay peers in their `TxReconciliationState`, and all transactions are kept in `to_be_announced` until relay time, where they would be picked for fanout or reconciliation based on `get_fanout_targets`. Since this process happens on a peer basis, fanout targets are now cached, so the selection is consistent for all peers of a given node for a given transaction.\n\nTo simulate this we will use a randomly generated network containing 110000 nodes, 10000 reachable, 100000 unreachable with 8 outbounds per node, **all of them implementing Erlay.** The simulation can be run using the code at https://github.com/sr-gi/hyperion/commit/32f5af9b39a9387d7f745df7da16645e69457d9e.\n\n## Results\n\nHere are the results of running our simulation in our reference model, that is, a network of the aforementioned characteristics selecting fanout candidates **at scheduling time**:\n\n```cmd\n2024-12-20T22:12:59.431Z INFO  [hyper_lib::simulator] Using user provided rng seed: 5831067508548421759\n2024-12-20T22:12:59.438Z INFO  [hyper_lib::network] Creating nodes (110000: 10000 reachable, 100000 unreachable)\n2024-12-20T22:12:59.568Z INFO  [hyperion] The simulation will be run 100 times and results will be averaged\n2024-12-20T22:17:42.069Z INFO  [hyper_lib] Transaction reached 90% of nodes in the network in 20.764025s\n2024-12-20T22:17:42.069Z INFO  [hyper_lib] Transaction reached all nodes in 28.108896s\n2024-12-20T22:17:42.069Z INFO  [hyper_lib] Reachable nodes sent/received 222.2216/369.73523 messages (715.59644/1069.915 bytes) (avg)\n2024-12-20T22:17:42.069Z INFO  [hyper_lib] Unreachable nodes sent/received 32.36946/17.618101 messages (94.462814/59.03094 bytes) (avg)\n```\n\nAnd the same simulation in our updated model, selecting fanout peers **at relay time:**\n\n```cmd\n2024-12-20T22:34:03.686Z INFO  [hyper_lib::simulator] Using user provided rng seed: 5831067508548421759\n2024-12-20T22:34:03.694Z INFO  [hyper_lib::network] Creating nodes (110000: 10000 reachable, 100000 unreachable)\n2024-12-20T22:34:03.826Z INFO  [hyperion] The simulation will be run 100 times and results will be averaged\n2024-12-20T22:39:01.915Z INFO  [hyper_lib] Transaction reached 90% of nodes in the network in 20.655256s\n2024-12-20T22:39:01.915Z INFO  [hyper_lib] Transaction reached all nodes in 28.008577s\n2024-12-20T22:39:01.915Z INFO  [hyper_lib] Reachable nodes sent/received 221.15518/367.86584 messages (715.5273/1068.999 bytes) (avg)\n2024-12-20T22:39:01.915Z INFO  [hyper_lib] Unreachable nodes sent/received 32.20926/17.538193 messages (94.39123/59.044044 bytes) (avg)\n```\n\nFinally, here are both simulations as a `csv` for easier comparison:\n\n```csv\ntimestamp,percentile-target,percentile-time,full-propagation-time,r-sent-msgs,r-received-msgs,r-sent-bytes,r-received-bytes,u-sent-msgs,u-received-msgs,u-sent-bytes,u-received-bytes,r,u,n,erlay,seed\n1734733062,90,20764024832,28108896256,222.2216,369.73523,715.59644,1069.915,32.36946,17.618101,94.462814,59.03094,10000,100000,100,true,5831067508548421759\n1734734341,90,20655255552,28008577024,221.15518,367.86584,715.5273,1068.999,32.20926,17.538193,94.39123,59.044044,10000,100000,100,true,583106750854842175\n```\n\nWe can see that there are no meaningful differences between the two simulations, which may sound surprising. To understand why this is the case, we can follow a similar approach as per our [filter fanout candidates based on transaction knowledge simulation](https://delvingbitcoin.org/t/erlay-filter-fanout-candidates-based-on-transaction-knowledge/1416). This time we will modify the simulation slightly. Instead of just recording how many peers have announced a transaction to us by the time we need to select fanout candidates, we will be taking two samples: **the first one will be taken at transaction relay scheduling**, point at where our reference model selects fanout peers, and **the second one will be taken at transaction relay time**, when our current model selects them.\n\nThis creates an output containing a tuple `(first_sample, second_sample, is_reachable)` for all nodes where first_sample \u2260 second_sample. To run this test, we can use the code at https://github.com/sr-gi/hyperion/commit/333b22f4b929449b86304da8bb9010fccafaf651, a simulation without repetition will suffice here (`-n=1`). The resulting output looks as follows:\n\n```cmd\n(1, 2, false)\n(1, 2, true)\n(1, 2, true)\n(1, 2, true)\n(1, 2, true)\n(1, 2, true)\n(1, 2, true)\n...\n(2, 3, true)\n(2, 3, true)\n(2, 4, true)\n(3, 5, true)\n(1, 2, true)\n```\n\nThe most noticeable aspect of the simulation results is the number of entries in the output: only **4824** out of **110000** nodes showed a difference. In other words, **approximately 4.38% of the nodes in our simulated network** [^1]. From the sampled nodes, about 43% of them are unreachable, and almost 98% of those show an increase of a single peer between the two samples (going from a single peer, the one that shared the transaction with them, to two).\n\n# Conclusion\n\nThis simulation shows that **there is no significant difference between selecting peers at scheduling time or relay time.** It is worth noting that this is likely derived from using a full Erlay network, and **results may vary if simulated in networks with partial support**.\n\nWe are currently simulating scenarios where **the whole network is composed of Erlay peers**, plus the amount of peers selected for fanout is rather small (1 outbound and 10% of inbounds). This means the expected number of received `INV` messages should be rather small.\n\n[^1]: The exact value may vary between simulations, given the random nature of some of the involved processes, however, several runs with different seeds have yielded very similar results, obtaining samples of only ~4% of nodes in the network.",
  "actions_summary": [],
  "moderator": false,
  "admin": false,
  "staff": false,
  "user_id": 122,
  "hidden": false,
  "trust_level": 2,
  "deleted_at": null,
  "user_deleted": false,
  "edit_reason": null,
  "can_view_edit_history": true,
  "wiki": false,
  "reactions": [],
  "current_user_reaction": null,
  "reaction_users_count": 0,
  "current_user_used_main_reaction": false
}