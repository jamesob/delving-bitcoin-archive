{
  "id": 4187,
  "name": "Sergi Delgado",
  "username": "sr-gi",
  "avatar_template": "/user_avatar/delvingbitcoin.org/sr-gi/{size}/117_2.png",
  "created_at": "2025-02-05T20:48:13.842Z",
  "cooked": "<p>This post is part of the Erlay implementation experiments. See <a href=\"https://delvingbitcoin.org/t/erlay-overview-and-current-approach/1415\">Erlay: Overview and current approach</a> for context.</p>\n<h1><a name=\"p-4187-thesis-1\" class=\"anchor\" href=\"#p-4187-thesis-1\"></a>Thesis</h1>\n<p>For optimal network bandwidth utilization when relaying transactions, the fanout rate should be higher the earlier in the transaction propagation state, and lower the later. This is due to <strong>fanout being more efficient (and faster) than transaction reconciliation provided the receiving node doesn\u2019t know about the transaction.</strong> This means that, in a perfect world, we could start with a high fanout rate to reach a high portion of the network (with minimal redundancy), and slowly scale the fanout down to relay more on set reconciliation when the transaction has spread enough.</p>\n<p>Unfortunately, the receiver node does not possess precise knowledge of how far a transaction has propagated along the network. We have previously tried to use the number of announcements a node has received about a given transaction as a proxy for this. Still, it has turned out to work mostly for <strong>reachable</strong> nodes, but not as much for <strong>unreachable</strong> (see <a href=\"https://delvingbitcoin.org/t/erlay-filter-fanout-candidates-based-on-transaction-knowledge/1416/3\" class=\"inline-onebox\">Erlay: Filter fanout candidates based on transaction knowledge - #3 by sr-gi</a>).</p>\n<p>An alternative approach is checking under what method the transaction was received as part of the decision-making to propagate the transaction further. That is, have a fanout rate if the transaction was received via fanout, and a different one if the transaction was received via set reconciliation. Being fanout significantly faster than set reconciliation, it would be expected that the first nodes to learn about a given transaction would do so through fanout, <strong>so having a higher propagation rate if the transaction was received via fanout, and a smaller one if it was received via set reconciliation</strong> may be a good enough approximation to our ideal solution.</p>\n<h1><a name=\"p-4187-simulation-2\" class=\"anchor\" href=\"#p-4187-simulation-2\"></a>Simulation</h1>\n<p>To simulate this, we\u2019ll be using a patched version of <a href=\"https://delvingbitcoin.org/t/hyperion-a-discrete-time-network-event-simulator-for-bitcoin-core/1042\">the simulator</a> that will scale the fanout rate based on how a node received the target transaction. The code can be found at <a href=\"https://github.com/sr-gi/hyperion/commit/a0f11424dac30a2bebc22cd534f98a2d9de36cf8\" class=\"inline-onebox\" rel=\"noopener nofollow ugc\">multi: Scale the fanout rate based on how the transaction was received \u00b7 sr-gi/hyperion@a0f1142 \u00b7 GitHub</a>.</p>\n<p>The simulation will be built on the following two assumptions:</p>\n<ul>\n<li>The fanout rate when receiving a transaction via fanout needs to be higher, but not too high. This is to prevent too much redundancy, given some nodes will still be receiving the transaction via fanout even by the end of the transaction propagation.</li>\n<li>We can scale up the number of <strong>outbound</strong> connections to fanout to, but the number of <strong>inbounds must remain constant.</strong> This is to prevent malicious peers from knowing what fanout rate we used by simply establishing multiple connections to our node.</li>\n</ul>\n<p>To run the experiment we simply need to define the corresponding env variables representing the low and high fanout targets: <code>OUTBOUND_FANOUT_DESTINATIONS</code> and <code>OUTBOUND_FANOUT_DESTINATIONS_HIGH</code>. An example would be:</p>\n<pre data-code-wrap=\"bash\"><code class=\"lang-bash\">OUTBOUND_FANOUT_DESTINATIONS=1 OUTBOUND_FANOUT_DESTINATIONS_HIGH=4 cargo run --release --erlay -n 100\n</code></pre>\n<p>As with all our previous simulations, we will create a network of <strong>110000 nodes</strong>, <strong>10000 reachable, 100000 unreachable.</strong> In this case, we will run 3 different simulations, corresponding to <strong>8, 10, and 12</strong> outbound peers respectively, as we previously did for <a href=\"https://delvingbitcoin.org/t/erlay-find-acceptable-target-number-of-peers-to-fanout-to/1420\" class=\"inline-onebox\">Erlay: Find acceptable target number of peers to fanout to</a>. Every simulation will be run <strong>100</strong> times, with the same random network, picking a different source every time, and the results will be averaged.</p>\n<p>The results will be compared with our baseline (same network, no Erlay), as well as with the setting for the currently implemented approach: <strong>1 outbound and 10% of inbounds</strong>.</p>\n<h2><a name=\"p-4187-result-3\" class=\"anchor\" href=\"#p-4187-result-3\"></a>Result</h2>\n<p>We run simulations for the three following cases (on top of our reference points)<sup class=\"footnote-ref\"><a href=\"#footnote-4187-1\" id=\"footnote-ref-4187-1\">[1]</a></sup>:</p>\n<ul>\n<li>1/10% + 4/10%</li>\n<li>1/10% + 6/10%</li>\n<li>1/20% + 4/20%</li>\n</ul>\n<p>The leftmost side of the expression represents the fanout rate when receiving a transaction <strong>via reconciliation</strong>, whereas the rightmost accounts for receiving it <strong>via fanout</strong>. For instance, <code>a/b% + c/d%</code> means <code>a</code> outbound and <code>b%</code> of inbounds if received via reconciliation, <code>c</code> outbound and <code>d%</code> of inbounds if received via fanout.</p>\n<p>The most noticeable result is the reduction in transaction latency compared to <strong>1/10%</strong>. This is expected, as even in the most conservative approach (<strong>green line: 1/10% + 4/10%</strong>), the lowest rate already matches the reference, preventing any increase in propagation time. The improvements range from <strong>~18% speedup</strong> in the most conservative case to <strong>~24%</strong> in the other two cases.</p>\n<p><div class=\"lightbox-wrapper\"><a class=\"lightbox\" href=\"https://delvingbitcoin.org/uploads/default/original/2X/9/91fb85224e4385a38cd842e101bd9ae462e6454a.png\" data-download-href=\"https://delvingbitcoin.org/uploads/default/91fb85224e4385a38cd842e101bd9ae462e6454a\" title=\"Propagation time (90%)\"><img src=\"https://delvingbitcoin.org/uploads/default/original/2X/9/91fb85224e4385a38cd842e101bd9ae462e6454a.png\" alt=\"Propagation time (90%)\" data-base62-sha1=\"kPq6YfhqBDDxpeDXKqNoHLXDNhg\" width=\"684\" height=\"424\"><div class=\"meta\"><svg class=\"fa d-icon d-icon-far-image svg-icon\" aria-hidden=\"true\"><use href=\"#far-image\"></use></svg><span class=\"filename\">Propagation time (90%)</span><span class=\"informations\">684\u00d7424 23.2 KB</span><svg class=\"fa d-icon d-icon-discourse-expand svg-icon\" aria-hidden=\"true\"><use href=\"#discourse-expand\"></use></svg></div></a></div></p>\n<p>However, this doesn\u2019t provide much context on its own. As we previously saw when running our wide-range search experiment, Erlay presents a tradeoff between latency and bandwidth. So to evaluate these results, we should also check how bandwidth has been affected.</p>\n<p><div class=\"lightbox-wrapper\"><a class=\"lightbox\" href=\"https://delvingbitcoin.org/uploads/default/original/2X/3/3d0db01f5c2c6a77feac3e0f47eaae9107f8ffd7.png\" data-download-href=\"https://delvingbitcoin.org/uploads/default/3d0db01f5c2c6a77feac3e0f47eaae9107f8ffd7\" title=\"Data volume per tx (reachable nodes)\"><img src=\"https://delvingbitcoin.org/uploads/default/original/2X/3/3d0db01f5c2c6a77feac3e0f47eaae9107f8ffd7.png\" alt=\"Data volume per tx (reachable nodes)\" data-base62-sha1=\"8I6s1HD04w4uRLMcxXXLgAMn91J\" width=\"684\" height=\"424\"><div class=\"meta\"><svg class=\"fa d-icon d-icon-far-image svg-icon\" aria-hidden=\"true\"><use href=\"#far-image\"></use></svg><span class=\"filename\">Data volume per tx (reachable nodes)</span><span class=\"informations\">684\u00d7424 23.1 KB</span><svg class=\"fa d-icon d-icon-discourse-expand svg-icon\" aria-hidden=\"true\"><use href=\"#discourse-expand\"></use></svg></div></a></div></p>\n<p>For reachable nodes, the data volume per transaction has increased between ~6.5% (green line, 1/10% + 4/10%) to ~13% (purple line 1/20% + 4/20%).</p>\n<p><div class=\"lightbox-wrapper\"><a class=\"lightbox\" href=\"https://delvingbitcoin.org/uploads/default/original/2X/6/6a316e30d15d9f8440535f57d23d0692d84575cc.png\" data-download-href=\"https://delvingbitcoin.org/uploads/default/6a316e30d15d9f8440535f57d23d0692d84575cc\" title=\"Data volume per tx (unreachable nodes)\"><img src=\"https://delvingbitcoin.org/uploads/default/original/2X/6/6a316e30d15d9f8440535f57d23d0692d84575cc.png\" alt=\"Data volume per tx (unreachable nodes)\" data-base62-sha1=\"f9qvZOsfZ5O7twgwlgVZrATfasA\" width=\"684\" height=\"424\"><div class=\"meta\"><svg class=\"fa d-icon d-icon-far-image svg-icon\" aria-hidden=\"true\"><use href=\"#far-image\"></use></svg><span class=\"filename\">Data volume per tx (unreachable nodes)</span><span class=\"informations\">684\u00d7424 23.2 KB</span><svg class=\"fa d-icon d-icon-discourse-expand svg-icon\" aria-hidden=\"true\"><use href=\"#discourse-expand\"></use></svg></div></a></div></p>\n<p>For unreachable, the data volume has increased between ~4% to ~11%.</p>\n<p>Both for reachable and unreachable cases, the lower end of this range is the most compelling. It not only results in a smaller bandwidth increase but also achieves a higher relative speedup. Specifically, <strong>1/10% + 4/10%</strong> delivers an <strong>18% speedup</strong> with only a <strong>6.5% increase in bandwidth utilization</strong>. In contrast, <strong>1/20% + 4/20%</strong> reduces latency further (<strong>~25% faster</strong>) but comes at a higher cost\u2014<strong>double the bandwidth increase for reachable nodes</strong> and <strong>nearly 3\u00d7 for unreachable nodes</strong> compared to <strong>1/10% + 4/10%</strong>.</p>\n<p>You may have noticed an additional yellow line in the plots, representing <strong>4/10%</strong>. This serves as a reference to compare the impact of the variable approach against the fixed approach. The propagation times for <strong>4/10%</strong> are akin to <strong>1/10% + 4/10%</strong> (they are barely 3% faster), however, the bandwidth utilization is 13%-15% worse than <strong>1/10% + 4/10%</strong></p>\n<h1><a name=\"p-4187-conclusion-4\" class=\"anchor\" href=\"#p-4187-conclusion-4\"></a>Conclusion</h1>\n<p>Given the slower nature of the transaction reconciliation protocol, the method by which a node receives a transaction (fanout or reconciliation) serves as a strong indicator of how far the transaction has propagated. This insight can be used in the propagation decision-making to adjust the fanout rate: <strong>increasing it when the transaction is closer to the source</strong> and <strong>reducing it as it spreads further</strong>. By making the transaction quickly available to a big subset of nodes in the network, meaningful reconciliation becomes available sooner, at which point the fanout rate will be compensated down so set reconciliation can take care of fixing the remaining differences.</p>\n<p>A rather simple approach to this has shown to be useful, substantially reducing the propagation latency in one of the most bandwidth-conservative settings, while maintaining most of the bandwidth savings. Given these results, my opinion is that <strong>1/10% + 4/10% could be used as a more performant drop-in replacement</strong> of the current 1/10% setup.</p>\n<hr class=\"footnotes-sep\">\n\n<ol class=\"footnotes-list\">\n<li id=\"footnote-4187-1\" class=\"footnote-item\"><p>The data for the experiment, as well as all charts shown in this document, can be found at <a href=\"https://docs.google.com/spreadsheets/d/1t7bVL88FTx3vIE_gLeda0udfGps1ypTSyRhokh2yCIA/edit?usp=sharing\" class=\"inline-onebox\" rel=\"noopener nofollow ugc\">variable fanout experiment - Google Sheets</a> <a href=\"#footnote-ref-4187-1\" class=\"footnote-backref\">\u21a9\ufe0e</a></p>\n</li>\n</ol>",
  "post_number": 1,
  "post_type": 1,
  "updated_at": "2025-02-05T21:36:02.768Z",
  "reply_count": 0,
  "reply_to_post_number": null,
  "quote_count": 0,
  "incoming_link_count": 0,
  "reads": 8,
  "readers_count": 7,
  "score": 1.4,
  "yours": false,
  "topic_id": 1422,
  "topic_slug": "erlay-define-fanout-rate-based-on-the-transaction-reception-method",
  "topic_title": "Erlay: Define fanout rate based on the transaction reception method",
  "topic_html_title": "Erlay: Define fanout rate based on the transaction reception method",
  "category_id": 7,
  "display_username": "Sergi Delgado",
  "primary_group_name": null,
  "flair_name": null,
  "flair_url": null,
  "flair_bg_color": null,
  "flair_color": null,
  "flair_group_id": null,
  "badges_granted": [],
  "version": 2,
  "can_edit": false,
  "can_delete": false,
  "can_recover": false,
  "can_see_hidden_post": false,
  "can_wiki": false,
  "user_title": null,
  "bookmarked": false,
  "raw": "This post is part of the Erlay implementation experiments. See [Erlay: Overview and current approach](https://delvingbitcoin.org/t/erlay-overview-and-current-approach/1415) for context.\n\n# Thesis\n\nFor optimal network bandwidth utilization when relaying transactions, the fanout rate should be higher the earlier in the transaction propagation state, and lower the later. This is due to **fanout being more efficient (and faster) than transaction reconciliation provided the receiving node doesn\u2019t know about the transaction.** This means that, in a perfect world, we could start with a high fanout rate to reach a high portion of the network (with minimal redundancy), and slowly scale the fanout down to relay more on set reconciliation when the transaction has spread enough.\n\nUnfortunately, the receiver node does not possess precise knowledge of how far a transaction has propagated along the network. We have previously tried to use the number of announcements a node has received about a given transaction as a proxy for this. Still, it has turned out to work mostly for **reachable** nodes, but not as much for **unreachable** (see https://delvingbitcoin.org/t/erlay-filter-fanout-candidates-based-on-transaction-knowledge/1416/3).\n\nAn alternative approach is checking under what method the transaction was received as part of the decision-making to propagate the transaction further. That is, have a fanout rate if the transaction was received via fanout, and a different one if the transaction was received via set reconciliation. Being fanout significantly faster than set reconciliation, it would be expected that the first nodes to learn about a given transaction would do so through fanout, **so having a higher propagation rate if the transaction was received via fanout, and a smaller one if it was received via set reconciliation** may be a good enough approximation to our ideal solution.\n\n# Simulation\n\nTo simulate this, we\u2019ll be using a patched version of [the simulator](https://delvingbitcoin.org/t/hyperion-a-discrete-time-network-event-simulator-for-bitcoin-core/1042) that will scale the fanout rate based on how a node received the target transaction. The code can be found at https://github.com/sr-gi/hyperion/commit/a0f11424dac30a2bebc22cd534f98a2d9de36cf8.\n\nThe simulation will be built on the following two assumptions:\n\n- The fanout rate when receiving a transaction via fanout needs to be higher, but not too high. This is to prevent too much redundancy, given some nodes will still be receiving the transaction via fanout even by the end of the transaction propagation.\n- We can scale up the number of **outbound** connections to fanout to, but the number of **inbounds must remain constant.** This is to prevent malicious peers from knowing what fanout rate we used by simply establishing multiple connections to our node.\n\nTo run the experiment we simply need to define the corresponding env variables representing the low and high fanout targets: `OUTBOUND_FANOUT_DESTINATIONS` and `OUTBOUND_FANOUT_DESTINATIONS_HIGH`. An example would be:\n\n```bash\nOUTBOUND_FANOUT_DESTINATIONS=1 OUTBOUND_FANOUT_DESTINATIONS_HIGH=4 cargo run --release --erlay -n 100\n```\n\nAs with all our previous simulations, we will create a network of **110000 nodes**, **10000 reachable, 100000 unreachable.** In this case, we will run 3 different simulations, corresponding to **8, 10, and 12** outbound peers respectively, as we previously did for https://delvingbitcoin.org/t/erlay-find-acceptable-target-number-of-peers-to-fanout-to/1420. Every simulation will be run **100** times, with the same random network, picking a different source every time, and the results will be averaged.\n\nThe results will be compared with our baseline (same network, no Erlay), as well as with the setting for the currently implemented approach: **1 outbound and 10% of inbounds**.\n\n## Result\n\nWe run simulations for the three following cases (on top of our reference points)[^1]:\n\n- 1/10% + 4/10%\n- 1/10% + 6/10%\n- 1/20% + 4/20%\n\nThe leftmost side of the expression represents the fanout rate when receiving a transaction **via reconciliation**, whereas the rightmost accounts for receiving it **via fanout**. For instance, `a/b% + c/d%` means `a` outbound and `b%` of inbounds if received via reconciliation, `c` outbound and `d%` of inbounds if received via fanout.\n\nThe most noticeable result is the reduction in transaction latency compared to **1/10%**. This is expected, as even in the most conservative approach (**green line: 1/10% + 4/10%**), the lowest rate already matches the reference, preventing any increase in propagation time. The improvements range from **~18% speedup** in the most conservative case to **~24%** in the other two cases.\n\n![Propagation time (90%)|684x424](upload://kPq6YfhqBDDxpeDXKqNoHLXDNhg.png)\n\nHowever, this doesn\u2019t provide much context on its own. As we previously saw when running our wide-range search experiment, Erlay presents a tradeoff between latency and bandwidth. So to evaluate these results, we should also check how bandwidth has been affected. \n\n![Data volume per tx (reachable nodes)|684x424](upload://8I6s1HD04w4uRLMcxXXLgAMn91J.png)\n\nFor reachable nodes, the data volume per transaction has increased between ~6.5% (green line, 1/10% + 4/10%) to ~13% (purple line 1/20% + 4/20%).\n\n![Data volume per tx (unreachable nodes)|684x424](upload://f9qvZOsfZ5O7twgwlgVZrATfasA.png)\n\nFor unreachable, the data volume has increased between ~4% to ~11%.\n\nBoth for reachable and unreachable cases, the lower end of this range is the most compelling. It not only results in a smaller bandwidth increase but also achieves a higher relative speedup. Specifically, **1/10% + 4/10%** delivers an **18% speedup** with only a **6.5% increase in bandwidth utilization**. In contrast, **1/20% + 4/20%** reduces latency further (**~25% faster**) but comes at a higher cost\u2014**double the bandwidth increase for reachable nodes** and **nearly 3\u00d7 for unreachable nodes** compared to **1/10% + 4/10%**.\n\nYou may have noticed an additional yellow line in the plots, representing **4/10%**. This serves as a reference to compare the impact of the variable approach against the fixed approach. The propagation times for **4/10%** are akin to **1/10% + 4/10%** (they are barely 3% faster), however, the bandwidth utilization is 13%-15% worse than **1/10% + 4/10%** \n\n# Conclusion\n\nGiven the slower nature of the transaction reconciliation protocol, the method by which a node receives a transaction (fanout or reconciliation) serves as a strong indicator of how far the transaction has propagated. This insight can be used in the propagation decision-making to adjust the fanout rate: **increasing it when the transaction is closer to the source** and **reducing it as it spreads further**. By making the transaction quickly available to a big subset of nodes in the network, meaningful reconciliation becomes available sooner, at which point the fanout rate will be compensated down so set reconciliation can take care of fixing the remaining differences.\n\nA rather simple approach to this has shown to be useful, substantially reducing the propagation latency in one of the most bandwidth-conservative settings, while maintaining most of the bandwidth savings. Given these results, my opinion is that **1/10% + 4/10% could be used as a more performant drop-in replacement** of the current 1/10% setup.\n\n[^1]: The data for the experiment, as well as all charts shown in this document, can be found at https://docs.google.com/spreadsheets/d/1t7bVL88FTx3vIE_gLeda0udfGps1ypTSyRhokh2yCIA/edit?usp=sharing",
  "actions_summary": [],
  "moderator": false,
  "admin": false,
  "staff": false,
  "user_id": 122,
  "hidden": false,
  "trust_level": 2,
  "deleted_at": null,
  "user_deleted": false,
  "edit_reason": null,
  "can_view_edit_history": true,
  "wiki": false,
  "reactions": [],
  "current_user_reaction": null,
  "reaction_users_count": 0,
  "current_user_used_main_reaction": false
}