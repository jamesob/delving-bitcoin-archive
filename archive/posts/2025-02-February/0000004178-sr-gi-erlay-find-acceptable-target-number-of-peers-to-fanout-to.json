{
  "id": 4178,
  "name": "Sergi Delgado",
  "username": "sr-gi",
  "avatar_template": "/user_avatar/delvingbitcoin.org/sr-gi/{size}/117_2.png",
  "created_at": "2025-02-04T19:15:09.546Z",
  "cooked": "<p>This post is part of the Erlay implementation experiments. See <a href=\"https://delvingbitcoin.org/t/erlay-overview-and-current-approach/1415\">Erlay: Overview and current approach</a> for context.</p>\n<h1><a name=\"p-4178-thesis-1\" class=\"anchor\" href=\"#p-4178-thesis-1\"></a>Thesis</h1>\n<p>For Erlay to work efficiently, some degree of transaction fanout is necessary. This ensures that a sufficient number of peers receive the transaction quickly. The key reason for this is that fanout is more bandwidth-efficient <strong>if the receiving node has not already seen the transaction</strong>. However, if the node already knows the transaction, fanout becomes wasteful. Additionally, Erlay introduces some latency to the transaction exchange process.</p>\n<p>The ideal approach would be to fanout until a transaction has reached a sufficiently large portion of the network, then switch to reconciliation. However, this is impractical because a node does not know how widely a transaction has propagated at the time of reception.</p>\n<p>A more feasible strategy is to set a minimum fanout rate and adhere to it, allowing reconciliation to handle the rest. This ensures that a targeted percentage of the network receives the transaction through fanout, while reconciliation takes care of the rest.</p>\n<p>A viable approach is to target a minimum fanout rate and stick to it while leaving the rest to reconciliation. This way a target percentage of the network will receive the transaction via fanout, and the rest will use reconciliation for it <sup class=\"footnote-ref\"><a href=\"#footnote-4178-1\" id=\"footnote-ref-4178-1\">[1]</a></sup>.</p>\n<ul>\n<li>A <strong>higher fanout rate</strong> means the transaction reaches a larger subset of the network more quickly, but with lower bandwidth savings.</li>\n<li>A <strong>lower fanout rate</strong> saves more bandwidth but increases latency.</li>\n</ul>\n<h1><a name=\"p-4178-simulation-2\" class=\"anchor\" href=\"#p-4178-simulation-2\"></a>Simulation</h1>\n<p>To determine reasonable Erlay configurations, we can begin by simulating how a transaction propagates across the network using the current protocol. This will establish a baseline in terms of both data usage and propagation time. Once we have this baseline, we can run the same simulation with different Erlay configurations, each targeting different fanout levels. By analyzing the relationship between bandwidth saving and latency we can fine-tune our parameters to achieve an acceptable configuration.</p>\n<p>We will start by defining our baseline. For this, as in previous simulations, we are using a random network of <strong>110000 nodes</strong>, <strong>10000 reachable, 100000 unreachable.</strong> Given Erlay has the additional goal of allowing nodes to increase their peer count without incurring significant bandwidth costs, we will be simulating this for <strong>8, 10, and 12 outbound connections</strong> per node (to do this, we can simply specify the <code>--outbound</code> option in <a href=\"https://delvingbitcoin.org/t/hyperion-a-discrete-time-network-event-simulator-for-bitcoin-core/1042\">the simulator</a>).</p>\n<pre data-code-wrap=\"cmd\"><code class=\"lang-cmd\">cargo run --release -- -n 100 --erlay --seed 8482337119851113330 --outbound 8\ncargo run --release -- -n 100 --erlay --seed 8482337119851113330 --outbound 10\ncargo run --release -- -n 100 --erlay --seed 8482337119851113330 --outbound 12\n</code></pre>\n<p>We will compare the baseline with a wide variety of Erlay configurations for <code>OUTBOUND_FANOUT_DESTINATIONS</code> and <code>INBOUND_FANOUT_DESTINATIONS_FRACTION</code>. For outbounds, we will select values on the [0-8] range, whereas for inbounds, we will increase the count percentage-wise (in 10% increments) starting from 0.</p>\n<p>Given the scope of this experiment, running all the necessary simulations would take considerable time. To streamline the process, we have added a <code>multi-run</code> script to the simulator. This script automates a series of simulations, testing different ranges for <code>OUTBOUND_FANOUT_DESTINATIONS</code> and <code>INBOUND_FANOUT_DESTINATIONS_FRACTION</code>. The results are then stored in a CSV file for further analysis.</p>\n<p>We will be running instances of the script simultaneously (one for each <code>--outbound</code> configuration) and interleave the results afterward:</p>\n<pre data-code-wrap=\"cmd\"><code class=\"lang-cmd\">hyperion/multi-run.sh --outbounds=8 --seed=8482337119851113330 --out=result_8.csv\nhyperion/multi-run.sh --outbounds=10 --seed=8482337119851113330 --out=result_10.csv\nhyperion/multi-run.sh --outbounds=12 --seed=8482337119851113330 --out=result_12.csv\n</code></pre>\n<h1><a name=\"p-4178-results-3\" class=\"anchor\" href=\"#p-4178-results-3\"></a>Results</h1>\n<p>Since this is a wide-range experiment, the results are extensive and only meaningful when compared. Documenting every configuration in detail would make this report tedious to read. Instead, we will focus on three specific results to analyze how the charts change based on the selected number of peers. An interested reader can refer to <a href=\"https://docs.google.com/spreadsheets/d/1YGG3Lm6__xmKsd9HlmNuQOaw_Lg7rLwsBNcWYJsUsIw/edit?usp=sharing\" class=\"inline-onebox\" rel=\"noopener nofollow ugc\">fanout combinatorics sims - Google Sheets</a> to view the complete set of results. The interleaved data is located in columns <strong>A-Z</strong>, while the corresponding charts can be found further to the right in the document.</p>\n<h2><a name=\"p-4178-transaction-propagation-time-4\" class=\"anchor\" href=\"#p-4178-transaction-propagation-time-4\"></a>Transaction propagation time</h2>\n<p>The three following charts show the transaction propagation times to <strong>90%</strong> of nodes in the simulated network, for configurations of <strong>1 outbound/[0-100%] inbounds</strong>, <strong>4 outbounds/[0-100%] inbounds</strong> and <strong>7 outbounds/[0-100%] inbounds</strong> respectively.</p>\n<p><div class=\"lightbox-wrapper\"><a class=\"lightbox\" href=\"https://delvingbitcoin.org/uploads/default/original/2X/f/f3958de3462370b39580569a545da21795048cd3.png\" data-download-href=\"https://delvingbitcoin.org/uploads/default/f3958de3462370b39580569a545da21795048cd3\" title=\"Propagation time (90%)(fanout_out_1)\"><img src=\"https://delvingbitcoin.org/uploads/default/original/2X/f/f3958de3462370b39580569a545da21795048cd3.png\" alt=\"Propagation time (90%)(fanout_out_1)\" data-base62-sha1=\"yKQrw2MLaBeDae5Vdim4gzRFJPt\" width=\"684\" height=\"424\"><div class=\"meta\"><svg class=\"fa d-icon d-icon-far-image svg-icon\" aria-hidden=\"true\"><use href=\"#far-image\"></use></svg><span class=\"filename\">Propagation time (90%)(fanout_out_1)</span><span class=\"informations\">684\u00d7424 32.7 KB</span><svg class=\"fa d-icon d-icon-discourse-expand svg-icon\" aria-hidden=\"true\"><use href=\"#discourse-expand\"></use></svg></div></a></div>\n<div class=\"lightbox-wrapper\"><a class=\"lightbox\" href=\"https://delvingbitcoin.org/uploads/default/original/2X/a/a123e96554ad49236ebfe3a0159f96cea95f55ac.png\" data-download-href=\"https://delvingbitcoin.org/uploads/default/a123e96554ad49236ebfe3a0159f96cea95f55ac\" title=\"Propagation time (90%)(fanout_out_4)\"><img src=\"https://delvingbitcoin.org/uploads/default/original/2X/a/a123e96554ad49236ebfe3a0159f96cea95f55ac.png\" alt=\"Propagation time (90%)(fanout_out_4)\" data-base62-sha1=\"mZvOpYGZExURoWvYK1ziolE5xTu\" width=\"684\" height=\"424\"><div class=\"meta\"><svg class=\"fa d-icon d-icon-far-image svg-icon\" aria-hidden=\"true\"><use href=\"#far-image\"></use></svg><span class=\"filename\">Propagation time (90%)(fanout_out_4)</span><span class=\"informations\">684\u00d7424 33.1 KB</span><svg class=\"fa d-icon d-icon-discourse-expand svg-icon\" aria-hidden=\"true\"><use href=\"#discourse-expand\"></use></svg></div></a></div>\n<div class=\"lightbox-wrapper\"><a class=\"lightbox\" href=\"https://delvingbitcoin.org/uploads/default/original/2X/e/e11b79b67c30f5a81ec155bef06ce2590c7caa05.png\" data-download-href=\"https://delvingbitcoin.org/uploads/default/e11b79b67c30f5a81ec155bef06ce2590c7caa05\" title=\"Propagation time (90%) (fanout_out_7)\"><img src=\"https://delvingbitcoin.org/uploads/default/original/2X/e/e11b79b67c30f5a81ec155bef06ce2590c7caa05.png\" alt=\"Propagation time (90%) (fanout_out_7)\" data-base62-sha1=\"w7oioyCLYy6WgTkYzDac79lCGaN\" width=\"684\" height=\"424\"><div class=\"meta\"><svg class=\"fa d-icon d-icon-far-image svg-icon\" aria-hidden=\"true\"><use href=\"#far-image\"></use></svg><span class=\"filename\">Propagation time (90%) (fanout_out_7)</span><span class=\"informations\">684\u00d7424 32.9 KB</span><svg class=\"fa d-icon d-icon-discourse-expand svg-icon\" aria-hidden=\"true\"><use href=\"#discourse-expand\"></use></svg></div></a></div></p>\n<p>As it is expected, the transaction propagation times are reduced the more nodes are picked for fanout, given it is a faster propagation technique than set reconciliation. We can also observe that, independently of the configuration, the latency is reduced linearly when the node connectivity is increased (i.e. the number of outbound connections is increased).</p>\n<h2><a name=\"p-4178-data-volume-per-transaction-5\" class=\"anchor\" href=\"#p-4178-data-volume-per-transaction-5\"></a>Data volume per transaction</h2>\n<p>For the volume of data used per transaction per node (i.e., the total amount of data required to send and receive each transaction, including announcements, reconciliation, and other overhead) we observe that a lower fanout rate results in lower data usage. This outcome is expected, as relay under Erlay is designed to optimize bandwidth utilization more efficiently than fanout.</p>\n<p>Additionally, it is worth noting that when the number of inbound connections is lower, the bandwidth slope is less steep when the network connectivity is increased.</p>\n<h3><a name=\"p-4178-outbound_fanout_destinations1-inbound_fanout_destinations_fraction00-10-6\" class=\"anchor\" href=\"#p-4178-outbound_fanout_destinations1-inbound_fanout_destinations_fraction00-10-6\"></a><code>OUTBOUND_FANOUT_DESTINATIONS=1, INBOUND_FANOUT_DESTINATIONS_FRACTION=[0.0, 1.0]</code></h3>\n<p>When keeping the fanout rate low, we observe substantial bandwidth savings. The configuration suggested in the current Erlay approach (1/10%) achieves approximately <strong>35% savings</strong> compared to the baseline when using <strong>8 outbound connections</strong>. The efficiency improves further as connectivity increases: at <strong>12 outbound connections</strong>, the savings reach around <strong>45%</strong>.</p>\n<p><div class=\"lightbox-wrapper\"><a class=\"lightbox\" href=\"https://delvingbitcoin.org/uploads/default/original/2X/c/c3cd80bb20020bc25d4a6f0c8bd2d6a25f4a1dd3.png\" data-download-href=\"https://delvingbitcoin.org/uploads/default/c3cd80bb20020bc25d4a6f0c8bd2d6a25f4a1dd3\" title=\"Data volume per tx (reachable nodes) (fanout_out_1)\"><img src=\"https://delvingbitcoin.org/uploads/default/original/2X/c/c3cd80bb20020bc25d4a6f0c8bd2d6a25f4a1dd3.png\" alt=\"Data volume per tx (reachable nodes) (fanout_out_1)\" data-base62-sha1=\"rW9osK8Q2z6e5KaKmvucqFZJaZt\" width=\"684\" height=\"424\"><div class=\"meta\"><svg class=\"fa d-icon d-icon-far-image svg-icon\" aria-hidden=\"true\"><use href=\"#far-image\"></use></svg><span class=\"filename\">Data volume per tx (reachable nodes) (fanout_out_1)</span><span class=\"informations\">684\u00d7424 35.8 KB</span><svg class=\"fa d-icon d-icon-discourse-expand svg-icon\" aria-hidden=\"true\"><use href=\"#discourse-expand\"></use></svg></div></a></div>\n<div class=\"lightbox-wrapper\"><a class=\"lightbox\" href=\"https://delvingbitcoin.org/uploads/default/original/2X/f/fa4629d294b7606672b895d02cdb9a7215f4cab0.png\" data-download-href=\"https://delvingbitcoin.org/uploads/default/fa4629d294b7606672b895d02cdb9a7215f4cab0\" title=\"Data volume per tx (unreachable nodes) (fanout_out_1)\"><img src=\"https://delvingbitcoin.org/uploads/default/original/2X/f/fa4629d294b7606672b895d02cdb9a7215f4cab0.png\" alt=\"Data volume per tx (unreachable nodes) (fanout_out_1)\" data-base62-sha1=\"zI1GTOd0Bf9vQ9aDgPtK6Jk55vy\" width=\"684\" height=\"424\"><div class=\"meta\"><svg class=\"fa d-icon d-icon-far-image svg-icon\" aria-hidden=\"true\"><use href=\"#far-image\"></use></svg><span class=\"filename\">Data volume per tx (unreachable nodes) (fanout_out_1)</span><span class=\"informations\">684\u00d7424 36.3 KB</span><svg class=\"fa d-icon d-icon-discourse-expand svg-icon\" aria-hidden=\"true\"><use href=\"#discourse-expand\"></use></svg></div></a></div></p>\n<h3><a name=\"p-4178-outbound_fanout_destinations4-inbound_fanout_destinations_fraction00-10-7\" class=\"anchor\" href=\"#p-4178-outbound_fanout_destinations4-inbound_fanout_destinations_fraction00-10-7\"></a><code>OUTBOUND_FANOUT_DESTINATIONS=4, INBOUND_FANOUT_DESTINATIONS_FRACTION=[0.0, 1.0]</code></h3>\n<p>Increasing the outbound fanout rate show to reduce the potential savings, as this affects all types of nodes in the network (both reachable and unreachable). The savings are still significant, as long as we select a small enough number of inbounds to fanout to. For instance, the <strong>4/10%</strong> configuration achieves approximately <strong>21% savings</strong> compared to the baseline when using <strong>8 outbounds</strong>, and about <strong>28%</strong> when increasing the node\u2019s connectivity to 12.</p>\n<p><div class=\"lightbox-wrapper\"><a class=\"lightbox\" href=\"https://delvingbitcoin.org/uploads/default/original/2X/d/da0a1ef211b6a06f32f04e09d656fbcb0269ef67.png\" data-download-href=\"https://delvingbitcoin.org/uploads/default/da0a1ef211b6a06f32f04e09d656fbcb0269ef67\" title=\"Data volume per tx (reachable nodes) (fanout_out_4)\"><img src=\"https://delvingbitcoin.org/uploads/default/original/2X/d/da0a1ef211b6a06f32f04e09d656fbcb0269ef67.png\" alt=\"Data volume per tx (reachable nodes) (fanout_out_4)\" data-base62-sha1=\"v6RLTht0YXvyzJbMBKrx2w4WGSX\" width=\"684\" height=\"424\"><div class=\"meta\"><svg class=\"fa d-icon d-icon-far-image svg-icon\" aria-hidden=\"true\"><use href=\"#far-image\"></use></svg><span class=\"filename\">Data volume per tx (reachable nodes) (fanout_out_4)</span><span class=\"informations\">684\u00d7424 35.7 KB</span><svg class=\"fa d-icon d-icon-discourse-expand svg-icon\" aria-hidden=\"true\"><use href=\"#discourse-expand\"></use></svg></div></a></div>\n<div class=\"lightbox-wrapper\"><a class=\"lightbox\" href=\"https://delvingbitcoin.org/uploads/default/original/2X/b/ba55211c675da63a34f335b09c7bc5c05afc54d4.png\" data-download-href=\"https://delvingbitcoin.org/uploads/default/ba55211c675da63a34f335b09c7bc5c05afc54d4\" title=\"Data volume per tx (unreachable nodes)(fanout_out_4)\"><img src=\"https://delvingbitcoin.org/uploads/default/original/2X/b/ba55211c675da63a34f335b09c7bc5c05afc54d4.png\" alt=\"Data volume per tx (unreachable nodes)(fanout_out_4)\" data-base62-sha1=\"qAnci9U8iVX2qXpCrO6r7Po1xB2\" width=\"684\" height=\"424\"><div class=\"meta\"><svg class=\"fa d-icon d-icon-far-image svg-icon\" aria-hidden=\"true\"><use href=\"#far-image\"></use></svg><span class=\"filename\">Data volume per tx (unreachable nodes)(fanout_out_4)</span><span class=\"informations\">684\u00d7424 36 KB</span><svg class=\"fa d-icon d-icon-discourse-expand svg-icon\" aria-hidden=\"true\"><use href=\"#discourse-expand\"></use></svg></div></a></div></p>\n<h3><a name=\"p-4178-outbound_fanout_destinations7-inbound_fanout_destinations_fraction00-10-8\" class=\"anchor\" href=\"#p-4178-outbound_fanout_destinations7-inbound_fanout_destinations_fraction00-10-8\"></a><code>OUTBOUND_FANOUT_DESTINATIONS=7, INBOUND_FANOUT_DESTINATIONS_FRACTION=[0.0, 1.0]</code></h3>\n<p>Finally, we can see how heavily increasing the fanout rate leads to the saving becoming negligible with the current 8 outbound peers configuration, and really small even if increasing the connectivity: <strong>less than 10% for the 12 outbound peers configuration.</strong></p>\n<p><div class=\"lightbox-wrapper\"><a class=\"lightbox\" href=\"https://delvingbitcoin.org/uploads/default/original/2X/9/97bb3673047b7f20f94f6440c3eb77e4bde5272e.png\" data-download-href=\"https://delvingbitcoin.org/uploads/default/97bb3673047b7f20f94f6440c3eb77e4bde5272e\" title=\"Data volume per tx (reachable nodes) (fanout_out_7)\"><img src=\"https://delvingbitcoin.org/uploads/default/original/2X/9/97bb3673047b7f20f94f6440c3eb77e4bde5272e.png\" alt=\"Data volume per tx (reachable nodes) (fanout_out_7)\" data-base62-sha1=\"lEhcmqeOVxJUg1KQE8QsPqpfU2W\" width=\"684\" height=\"424\"><div class=\"meta\"><svg class=\"fa d-icon d-icon-far-image svg-icon\" aria-hidden=\"true\"><use href=\"#far-image\"></use></svg><span class=\"filename\">Data volume per tx (reachable nodes) (fanout_out_7)</span><span class=\"informations\">684\u00d7424 34.5 KB</span><svg class=\"fa d-icon d-icon-discourse-expand svg-icon\" aria-hidden=\"true\"><use href=\"#discourse-expand\"></use></svg></div></a></div>\n<div class=\"lightbox-wrapper\"><a class=\"lightbox\" href=\"https://delvingbitcoin.org/uploads/default/original/2X/1/137eceb05cd43b73d9ba4db2f47ec0265bf8768c.png\" data-download-href=\"https://delvingbitcoin.org/uploads/default/137eceb05cd43b73d9ba4db2f47ec0265bf8768c\" title=\"Data volume per tx (unreachable nodes) (fanout_out_7)\"><img src=\"https://delvingbitcoin.org/uploads/default/original/2X/1/137eceb05cd43b73d9ba4db2f47ec0265bf8768c.png\" alt=\"Data volume per tx (unreachable nodes) (fanout_out_7)\" data-base62-sha1=\"2MsKQ7pnHoogNdMypjbu7IjM3LK\" width=\"684\" height=\"424\"><div class=\"meta\"><svg class=\"fa d-icon d-icon-far-image svg-icon\" aria-hidden=\"true\"><use href=\"#far-image\"></use></svg><span class=\"filename\">Data volume per tx (unreachable nodes) (fanout_out_7)</span><span class=\"informations\">684\u00d7424 34.6 KB</span><svg class=\"fa d-icon d-icon-discourse-expand svg-icon\" aria-hidden=\"true\"><use href=\"#discourse-expand\"></use></svg></div></a></div></p>\n<h2><a name=\"p-4178-bandwidth-vs-latency-9\" class=\"anchor\" href=\"#p-4178-bandwidth-vs-latency-9\"></a>Bandwidth vs Latency</h2>\n<p>Examining bandwidth and latency improvements in isolation wouldn\u2019t be meaningful, as there is a clear tradeoff between the two, as outlined in our thesis.</p>\n<p>Focusing on the <strong>1/10%</strong> configuration (the approach implemented in the current Erlay design) we observe that while bandwidth savings are substantial, the propagation time increases significantly, by approximately <strong>2.4\u00d7</strong>. The <strong>4/10%</strong> configuration reduces this propagation delay to <strong>2\u00d7</strong>, but at the cost of around <strong>40% less bandwidth savings</strong>.</p>\n<h1><a name=\"p-4178-conclusion-10\" class=\"anchor\" href=\"#p-4178-conclusion-10\"></a>Conclusion</h1>\n<p>Our experiments show how there is a clear tradeoff between bandwidth and latency when implementing Erlay. When using a constant fanout rate, the potential bandwidth saving will be dependent on what propagation latency is acceptable, so the configuration parameters may be dependent on that.</p>\n<p>Alternative approaches, such as a variable fanout rate based on transaction propagation knowledge or heuristic-based optimizations, may yield better results. However, our findings provide a useful reference for understanding the relationship between latency and bandwidth across a wide range of configurations. Additionally, these results give us a baseline to compare to when designing alternative approaches.</p>\n<hr class=\"footnotes-sep\">\n\n<ol class=\"footnotes-list\">\n<li id=\"footnote-4178-1\" class=\"footnote-item\"><p>In a partially deployed Erlay network, the fanout rate will be higher since regular nodes will only relay using fanout <a href=\"#footnote-ref-4178-1\" class=\"footnote-backref\">\u21a9\ufe0e</a></p>\n</li>\n</ol>",
  "post_number": 1,
  "post_type": 1,
  "updated_at": "2025-02-04T19:21:59.372Z",
  "reply_count": 0,
  "reply_to_post_number": null,
  "quote_count": 0,
  "incoming_link_count": 1,
  "reads": 11,
  "readers_count": 10,
  "score": 7.2,
  "yours": false,
  "topic_id": 1420,
  "topic_slug": "erlay-find-acceptable-target-number-of-peers-to-fanout-to",
  "topic_title": "Erlay: Find acceptable target number of peers to fanout to",
  "topic_html_title": "Erlay: Find acceptable target number of peers to fanout to",
  "category_id": 7,
  "display_username": "Sergi Delgado",
  "primary_group_name": null,
  "flair_name": null,
  "flair_url": null,
  "flair_bg_color": null,
  "flair_color": null,
  "flair_group_id": null,
  "badges_granted": [],
  "version": 2,
  "can_edit": false,
  "can_delete": false,
  "can_recover": false,
  "can_see_hidden_post": false,
  "can_wiki": false,
  "user_title": null,
  "bookmarked": false,
  "raw": "This post is part of the Erlay implementation experiments. See [Erlay: Overview and current approach](https://delvingbitcoin.org/t/erlay-overview-and-current-approach/1415) for context.\n\n# Thesis\n\nFor Erlay to work efficiently, some degree of transaction fanout is necessary. This ensures that a sufficient number of peers receive the transaction quickly. The key reason for this is that fanout is more bandwidth-efficient **if the receiving node has not already seen the transaction**. However, if the node already knows the transaction, fanout becomes wasteful. Additionally, Erlay introduces some latency to the transaction exchange process.\n\nThe ideal approach would be to fanout until a transaction has reached a sufficiently large portion of the network, then switch to reconciliation. However, this is impractical because a node does not know how widely a transaction has propagated at the time of reception.\n\nA more feasible strategy is to set a minimum fanout rate and adhere to it, allowing reconciliation to handle the rest. This ensures that a targeted percentage of the network receives the transaction through fanout, while reconciliation takes care of the rest.\n\nA viable approach is to target a minimum fanout rate and stick to it while leaving the rest to reconciliation. This way a target percentage of the network will receive the transaction via fanout, and the rest will use reconciliation for it [^1]. \n\n- A **higher fanout rate** means the transaction reaches a larger subset of the network more quickly, but with lower bandwidth savings.\n- A **lower fanout rate** saves more bandwidth but increases latency.\n\n# Simulation\n\nTo determine reasonable Erlay configurations, we can begin by simulating how a transaction propagates across the network using the current protocol. This will establish a baseline in terms of both data usage and propagation time. Once we have this baseline, we can run the same simulation with different Erlay configurations, each targeting different fanout levels. By analyzing the relationship between bandwidth saving and latency we can fine-tune our parameters to achieve an acceptable configuration.\n\nWe will start by defining our baseline. For this, as in previous simulations, we are using a random network of **110000 nodes**, **10000 reachable, 100000 unreachable.** Given Erlay has the additional goal of allowing nodes to increase their peer count without incurring significant bandwidth costs, we will be simulating this for **8, 10, and 12 outbound connections** per node (to do this, we can simply specify the `--outbound` option in [the simulator](https://delvingbitcoin.org/t/hyperion-a-discrete-time-network-event-simulator-for-bitcoin-core/1042)).\n\n```cmd\ncargo run --release -- -n 100 --erlay --seed 8482337119851113330 --outbound 8\ncargo run --release -- -n 100 --erlay --seed 8482337119851113330 --outbound 10\ncargo run --release -- -n 100 --erlay --seed 8482337119851113330 --outbound 12\n```\n\nWe will compare the baseline with a wide variety of Erlay configurations for `OUTBOUND_FANOUT_DESTINATIONS` and `INBOUND_FANOUT_DESTINATIONS_FRACTION`. For outbounds, we will select values on the [0-8] range, whereas for inbounds, we will increase the count percentage-wise (in 10% increments) starting from 0. \n\nGiven the scope of this experiment, running all the necessary simulations would take considerable time. To streamline the process, we have added a `multi-run` script to the simulator. This script automates a series of simulations, testing different ranges for `OUTBOUND_FANOUT_DESTINATIONS` and `INBOUND_FANOUT_DESTINATIONS_FRACTION`. The results are then stored in a CSV file for further analysis.\n\nWe will be running instances of the script simultaneously (one for each `--outbound` configuration) and interleave the results afterward:\n\n```cmd\nhyperion/multi-run.sh --outbounds=8 --seed=8482337119851113330 --out=result_8.csv\nhyperion/multi-run.sh --outbounds=10 --seed=8482337119851113330 --out=result_10.csv\nhyperion/multi-run.sh --outbounds=12 --seed=8482337119851113330 --out=result_12.csv\n```\n\n# Results\n\nSince this is a wide-range experiment, the results are extensive and only meaningful when compared. Documenting every configuration in detail would make this report tedious to read. Instead, we will focus on three specific results to analyze how the charts change based on the selected number of peers. An interested reader can refer to https://docs.google.com/spreadsheets/d/1YGG3Lm6__xmKsd9HlmNuQOaw_Lg7rLwsBNcWYJsUsIw/edit?usp=sharing to view the complete set of results. The interleaved data is located in columns **A-Z**, while the corresponding charts can be found further to the right in the document.\n\n## Transaction propagation time\n\nThe three following charts show the transaction propagation times to **90%** of nodes in the simulated network, for configurations of **1 outbound/[0-100%] inbounds**, **4 outbounds/[0-100%] inbounds** and **7 outbounds/[0-100%] inbounds** respectively.\n\n![Propagation time (90%)(fanout_out_1)|684x424](upload://yKQrw2MLaBeDae5Vdim4gzRFJPt.png)\n![Propagation time (90%)(fanout_out_4)|684x424](upload://mZvOpYGZExURoWvYK1ziolE5xTu.png)\n![Propagation time (90%) (fanout_out_7)|684x424](upload://w7oioyCLYy6WgTkYzDac79lCGaN.png)\n\nAs it is expected, the transaction propagation times are reduced the more nodes are picked for fanout, given it is a faster propagation technique than set reconciliation. We can also observe that, independently of the configuration, the latency is reduced linearly when the node connectivity is increased (i.e. the number of outbound connections is increased).\n\n## Data volume per transaction\n\nFor the volume of data used per transaction per node (i.e., the total amount of data required to send and receive each transaction, including announcements, reconciliation, and other overhead) we observe that a lower fanout rate results in lower data usage. This outcome is expected, as relay under Erlay is designed to optimize bandwidth utilization more efficiently than fanout.\n\nAdditionally, it is worth noting that when the number of inbound connections is lower, the bandwidth slope is less steep when the network connectivity is increased.\n\n###  `OUTBOUND_FANOUT_DESTINATIONS=1, INBOUND_FANOUT_DESTINATIONS_FRACTION=[0.0, 1.0]`\n\nWhen keeping the fanout rate low, we observe substantial bandwidth savings. The configuration suggested in the current Erlay approach (1/10%) achieves approximately **35% savings** compared to the baseline when using **8 outbound connections**. The efficiency improves further as connectivity increases: at **12 outbound connections**, the savings reach around **45%**.\n\n![Data volume per tx (reachable nodes) (fanout_out_1)|684x424](upload://rW9osK8Q2z6e5KaKmvucqFZJaZt.png)\n![Data volume per tx (unreachable nodes) (fanout_out_1)|684x424](upload://zI1GTOd0Bf9vQ9aDgPtK6Jk55vy.png)\n\n### `OUTBOUND_FANOUT_DESTINATIONS=4, INBOUND_FANOUT_DESTINATIONS_FRACTION=[0.0, 1.0]`\n\nIncreasing the outbound fanout rate show to reduce the potential savings, as this affects all types of nodes in the network (both reachable and unreachable). The savings are still significant, as long as we select a small enough number of inbounds to fanout to. For instance, the **4/10%** configuration achieves approximately **21% savings** compared to the baseline when using **8 outbounds**, and about **28%** when increasing the node's connectivity to 12.\n\n![Data volume per tx (reachable nodes) (fanout_out_4)|684x424](upload://v6RLTht0YXvyzJbMBKrx2w4WGSX.png)\n![Data volume per tx (unreachable nodes)(fanout_out_4)|684x424](upload://qAnci9U8iVX2qXpCrO6r7Po1xB2.png)\n\n### `OUTBOUND_FANOUT_DESTINATIONS=7, INBOUND_FANOUT_DESTINATIONS_FRACTION=[0.0, 1.0]`\n\nFinally, we can see how heavily increasing the fanout rate leads to the saving becoming negligible with the current 8 outbound peers configuration, and really small even if increasing the connectivity: **less than 10% for the 12 outbound peers configuration.**\n\n![Data volume per tx (reachable nodes) (fanout_out_7)|684x424](upload://lEhcmqeOVxJUg1KQE8QsPqpfU2W.png)\n![Data volume per tx (unreachable nodes) (fanout_out_7)|684x424](upload://2MsKQ7pnHoogNdMypjbu7IjM3LK.png)\n\n## Bandwidth vs Latency\n\nExamining bandwidth and latency improvements in isolation wouldn\u2019t be meaningful, as there is a clear tradeoff between the two, as outlined in our thesis.\n\nFocusing on the **1/10%** configuration (the approach implemented in the current Erlay design) we observe that while bandwidth savings are substantial, the propagation time increases significantly, by approximately **2.4\u00d7**. The **4/10%** configuration reduces this propagation delay to **2\u00d7**, but at the cost of around **40% less bandwidth savings**.\n\n# Conclusion\n\nOur experiments show how there is a clear tradeoff between bandwidth and latency when implementing Erlay. When using a constant fanout rate, the potential bandwidth saving will be dependent on what propagation latency is acceptable, so the configuration parameters may be dependent on that. \n\nAlternative approaches, such as a variable fanout rate based on transaction propagation knowledge or heuristic-based optimizations, may yield better results. However, our findings provide a useful reference for understanding the relationship between latency and bandwidth across a wide range of configurations. Additionally, these results give us a baseline to compare to when designing alternative approaches.\n\n\n\n[^1]: In a partially deployed Erlay network, the fanout rate will be higher since regular nodes will only relay using fanout",
  "actions_summary": [],
  "moderator": false,
  "admin": false,
  "staff": false,
  "user_id": 122,
  "hidden": false,
  "trust_level": 2,
  "deleted_at": null,
  "user_deleted": false,
  "edit_reason": null,
  "can_view_edit_history": true,
  "wiki": false,
  "reactions": [],
  "current_user_reaction": null,
  "reaction_users_count": 0,
  "current_user_used_main_reaction": false
}