{
  "id": 4412,
  "name": "Antoine Riard",
  "username": "ariard",
  "avatar_template": "/letter_avatar_proxy/v4/letter/a/c67d28/{size}.png",
  "created_at": "2025-03-04T19:59:03.208Z",
  "cooked": "<aside class=\"quote no-group\" data-username=\"morehouse\" data-post=\"1\" data-topic=\"1493\">\n<div class=\"title\">\n<div class=\"quote-controls\"></div>\n<img loading=\"lazy\" alt=\"\" width=\"24\" height=\"24\" src=\"https://delvingbitcoin.org/letter_avatar_proxy/v4/letter/m/df705f/48.png\" class=\"avatar\"> morehouse:</div>\n<blockquote>\n<pre><code class=\"lang-auto\">## HTLC Output Handling: Remote Commitment, Local Offers\n\n### Requirements\n\nA local node:\n  - for any committed HTLC that does NOT have an output in this commitment transaction:\n    - once the commitment transaction has reached reasonable depth:\n      - MUST fail the corresponding incoming HTLC (if any).\n</code></pre>\n</blockquote>\n</aside>\n<p>While the on-chain logic of a LN state machine is notoriously hard to implement correctly and BOLT5 is infamously known to <strong>not</strong> be exhaustive, there is one remark to be made on the proposed specification patch.</p>\n<p>If I\u2019m understanding correctly, the new requirement would apply to the situation where a local node has offered an HTLC output, said output included in a remote commitment transaction. If this <em>offered</em> HTLC is not included in the latest commitment transaction, it is proposed to fail the corresponding <em>received</em> HTLC on the incoming pair of commitment transactions.</p>\n<p>If my memory is correct, this new mechanism has been already discussed in the past with few LN maintainers and devs in considering some other class of attacks. However, implementing this mechanism comes with the effect that now a LN node force-closes of the incoming channel, even if there is an <em>economic disproportion</em> between the HTLC at risk and the on-chain fee cost to force-close the channel. There is no guarantee on the <em>interactivity</em> of the backward peer. E.g the HTLC might be worth 1000 sats and the force-close absolute fee cost might be 10_000 sats. As far as I remember, there was no convergence among the LN maintainers of each implementation at the time, what should be the best in this situation and if the fall-back shouldn\u2019t be an <em>implementation policy</em> or a <em>node settings</em> detail.</p>\n<p>That it can be still worthy to have a description in BOLT5 of what can be a correct behavior, that I don\u2019t disagree.</p>",
  "post_number": 2,
  "post_type": 1,
  "updated_at": "2025-03-04T19:59:03.208Z",
  "reply_count": 0,
  "reply_to_post_number": null,
  "quote_count": 1,
  "incoming_link_count": 0,
  "reads": 4,
  "readers_count": 3,
  "score": 0.8,
  "yours": false,
  "topic_id": 1493,
  "topic_slug": "disclosure-lnd-excessive-failback-exploit",
  "topic_title": "Disclosure: LND Excessive Failback Exploit",
  "topic_html_title": "Disclosure: LND Excessive Failback Exploit",
  "category_id": 8,
  "display_username": "Antoine Riard",
  "primary_group_name": null,
  "flair_name": null,
  "flair_url": null,
  "flair_bg_color": null,
  "flair_color": null,
  "flair_group_id": null,
  "badges_granted": [],
  "version": 1,
  "can_edit": false,
  "can_delete": false,
  "can_recover": false,
  "can_see_hidden_post": false,
  "can_wiki": false,
  "user_title": null,
  "bookmarked": false,
  "raw": "[quote=\"morehouse, post:1, topic:1493\"]\n```\n## HTLC Output Handling: Remote Commitment, Local Offers\n\n### Requirements\n\nA local node:\n  - for any committed HTLC that does NOT have an output in this commitment transaction:\n    - once the commitment transaction has reached reasonable depth:\n      - MUST fail the corresponding incoming HTLC (if any).\n```\n[/quote]\n\nWhile the on-chain logic of a LN state machine is notoriously hard to implement correctly and BOLT5 is infamously known to **not** be exhaustive, there is one remark to be made on the proposed specification patch.\n\nIf I\u2019m understanding correctly, the new requirement would apply to the situation where a local node has offered an HTLC output, said output included in a remote commitment transaction. If this *offered* HTLC is not included in the latest commitment transaction, it is proposed to fail the corresponding *received* HTLC on the incoming pair of commitment transactions.\n\nIf my memory is correct, this new mechanism has been already discussed in the past with few LN maintainers and devs in considering some other class of attacks. However, implementing this mechanism comes with the effect that now a LN node force-closes of the incoming channel, even if there is an *economic disproportion* between the HTLC at risk and the on-chain fee cost to force-close the channel. There is no guarantee on the *interactivity* of the backward peer. E.g the HTLC might be worth 1000 sats and the force-close absolute fee cost might be 10_000 sats. As far as I remember, there was no convergence among the LN maintainers of each implementation at the time, what should be the best in this situation and if the fall-back shouldn\u2019t be an *implementation policy* or a *node settings* detail.\n\nThat it can be still worthy to have a description in BOLT5 of what can be a correct behavior, that I don\u2019t disagree.",
  "actions_summary": [],
  "moderator": false,
  "admin": false,
  "staff": false,
  "user_id": 5,
  "hidden": false,
  "trust_level": 3,
  "deleted_at": null,
  "user_deleted": false,
  "edit_reason": null,
  "can_view_edit_history": true,
  "wiki": false,
  "reactions": [],
  "current_user_reaction": null,
  "reaction_users_count": 0,
  "current_user_used_main_reaction": false
}