{
  "id": 4415,
  "name": "Matt Morehouse",
  "username": "morehouse",
  "avatar_template": "/letter_avatar_proxy/v4/letter/m/df705f/{size}.png",
  "created_at": "2025-03-05T19:53:02.250Z",
  "cooked": "<aside class=\"quote no-group\" data-username=\"ariard\" data-post=\"2\" data-topic=\"1493\">\n<div class=\"title\">\n<div class=\"quote-controls\"></div>\n<img loading=\"lazy\" alt=\"\" width=\"24\" height=\"24\" src=\"https://delvingbitcoin.org/letter_avatar_proxy/v4/letter/a/c67d28/48.png\" class=\"avatar\"> ariard:</div>\n<blockquote>\n<p>While the on-chain logic of a LN state machine is notoriously hard to implement correctly and BOLT5 is infamously known to <strong>not</strong> be exhaustive</p>\n</blockquote>\n</aside>\n<p>Oof.  This really needs to be fixed.</p>\n<aside class=\"quote no-group\">\n<blockquote>\n<p>If I\u2019m understanding correctly, the new requirement would apply to the situation where a local node has offered an HTLC output, said output included in a remote commitment transaction. If this <em>offered</em> HTLC is not included in the latest commitment transaction, it is proposed to fail the corresponding <em>received</em> HTLC on the incoming pair of commitment transactions.</p>\n</blockquote>\n</aside>\n<p>My <a href=\"https://github.com/lightning/bolts/pull/1233\" rel=\"noopener nofollow ugc\">proposed spec change</a> is to require that nodes should <em>not</em> fail back HTLCs for which a preimage is known.</p>\n<aside class=\"quote no-group\">\n<blockquote>\n<p>If my memory is correct, this new mechanism has been already discussed in the past with few LN maintainers and devs in considering some other class of attacks. However, implementing this mechanism comes with the effect that now a LN node force-closes of the incoming channel, even if there is an <em>economic disproportion</em> between the HTLC at risk and the on-chain fee cost to force-close the channel. There is no guarantee on the <em>interactivity</em> of the backward peer. E.g the HTLC might be worth 1000 sats and the force-close absolute fee cost might be 10_000 sats. As far as I remember, there was no convergence among the LN maintainers of each implementation at the time, what should be the best in this situation and if the fall-back shouldn\u2019t be an <em>implementation policy</em> or a <em>node settings</em> detail.</p>\n</blockquote>\n</aside>\n<p>That is an orthogonal problem.  The decision of whether to claim an HTLC on chain or not (because it would be uneconomical) is independent of the decision to fail back <em>off-chain</em>.</p>",
  "post_number": 3,
  "post_type": 1,
  "updated_at": "2025-03-05T19:53:02.250Z",
  "reply_count": 0,
  "reply_to_post_number": 2,
  "quote_count": 1,
  "incoming_link_count": 0,
  "reads": 4,
  "readers_count": 3,
  "score": 0.6,
  "yours": false,
  "topic_id": 1493,
  "topic_slug": "disclosure-lnd-excessive-failback-exploit",
  "topic_title": "Disclosure: LND Excessive Failback Exploit",
  "topic_html_title": "Disclosure: LND Excessive Failback Exploit",
  "category_id": 8,
  "display_username": "Matt Morehouse",
  "primary_group_name": null,
  "flair_name": null,
  "flair_url": null,
  "flair_bg_color": null,
  "flair_color": null,
  "flair_group_id": null,
  "badges_granted": [],
  "version": 1,
  "can_edit": false,
  "can_delete": false,
  "can_recover": false,
  "can_see_hidden_post": false,
  "can_wiki": false,
  "user_title": null,
  "bookmarked": false,
  "raw": "[quote=\"ariard, post:2, topic:1493\"]\nWhile the on-chain logic of a LN state machine is notoriously hard to implement correctly and BOLT5 is infamously known to **not** be exhaustive\n[/quote]\n\nOof.  This really needs to be fixed.\n\n[quote]\nIf I\u2019m understanding correctly, the new requirement would apply to the situation where a local node has offered an HTLC output, said output included in a remote commitment transaction. If this *offered* HTLC is not included in the latest commitment transaction, it is proposed to fail the corresponding *received* HTLC on the incoming pair of commitment transactions.\n[/quote]\n\nMy [proposed spec change](https://github.com/lightning/bolts/pull/1233) is to require that nodes should *not* fail back HTLCs for which a preimage is known.\n\n[quote]\nIf my memory is correct, this new mechanism has been already discussed in the past with few LN maintainers and devs in considering some other class of attacks. However, implementing this mechanism comes with the effect that now a LN node force-closes of the incoming channel, even if there is an *economic disproportion* between the HTLC at risk and the on-chain fee cost to force-close the channel. There is no guarantee on the *interactivity* of the backward peer. E.g the HTLC might be worth 1000 sats and the force-close absolute fee cost might be 10_000 sats. As far as I remember, there was no convergence among the LN maintainers of each implementation at the time, what should be the best in this situation and if the fall-back shouldn\u2019t be an *implementation policy* or a *node settings* detail.\n[/quote]\n\nThat is an orthogonal problem.  The decision of whether to claim an HTLC on chain or not (because it would be uneconomical) is independent of the decision to fail back *off-chain*.",
  "actions_summary": [],
  "moderator": false,
  "admin": false,
  "staff": false,
  "user_id": 47,
  "hidden": false,
  "trust_level": 2,
  "deleted_at": null,
  "user_deleted": false,
  "edit_reason": null,
  "can_view_edit_history": true,
  "wiki": false,
  "reactions": [],
  "current_user_reaction": null,
  "reaction_users_count": 0,
  "current_user_used_main_reaction": false
}