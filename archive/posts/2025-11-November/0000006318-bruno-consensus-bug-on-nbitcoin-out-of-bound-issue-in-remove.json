{
  "id": 6318,
  "name": "Bruno Garcia",
  "username": "bruno",
  "avatar_template": "/user_avatar/delvingbitcoin.org/bruno/{size}/60_2.png",
  "created_at": "2025-11-24T19:03:42.502Z",
  "cooked": "<p>We recently integrated <code>NBitcoin</code> into the <code>script_eval</code> target of bitcoinfuzz.\nThis target performs <em>differential fuzzing</em> of Bitcoin script evaluation logic by comparing the behavior of EvalScript (or equivalent) implementations across different projects.\nBefore adding NBitcoin, this target was already fuzzing Bitcoin Core and btcd.</p>\n<p>Shortly after starting the fuzzing campaign \u2014 thanks to an already good corpus \u2014 we encountered a crash with the following script:</p>\n<pre><code class=\"lang-auto\">Hex: 000360670000005b770100000000005b770100000000000008777760779f00000877776077\nAsm: 0 26464 0 0 11 OP_NIP 0 0 0 0 0 11 OP_NIP 0 0 0 0 0 0 777760779f000008 OP_NIP OP_NIP 16 OP_NIP\n</code></pre>\n<p>When debugging the run output, we observed that NBitcoin returned <strong>false</strong> while Bitcoin Core returned <strong>true</strong>. Since this represented a clear consensus discrepancy, we manually reviewed the script to verify whether it was valid. The analysis confirmed that the script is valid, meaning that Bitcoin Core\u2019s behavior is correct \u2014 and that the discrepancy originated from a bug in NBitcoin.</p>\n<p>Initially, this was surprising, since the only opcode in the script is <code>OP_NIP</code>, which removes the second item from the top of the stack \u2014 a relatively simple operation.</p>\n<p>NBitcoin\u2019s implementation of this opcode is shown below:</p>\n<pre data-code-wrap=\"csharp\"><code class=\"lang-csharp\">case OpcodeType.OP_NIP:\n{\n    // (x1 x2 -- x2)\n    if (_stack.Count &lt; 2)\n        return SetError(ScriptError.InvalidStackOperation);\n\n    _stack.Remove(-2);\n    break;\n}\n</code></pre>\n<p>To better understand the issue, we created a test case and stepped through <code>EvalScript</code>.\nDuring execution, an <code>IndexOutOfRangeException</code> was thrown when processing the third <code>OP_NIP</code>.</p>\n<p>Further investigation revealed the following:</p>\n<blockquote>\n<p>When the underlying array is at full capacity (e.g., 16 elements), and _stack.Remove(-2) is called, the Remove operation must delete the item at index 14 and shift the subsequent elements down. During this shift, the implementation may attempt to access _array[16], which does not exist, leading to the IndexOutOfRangeException.</p>\n</blockquote>\n<p>Interestingly, this bug was only discovered through differential fuzzing, because the discrepancy in return values between <code>Bitcoin Core</code> and <code>NBitcoin</code> highlighted the problem.\nSince the exception occurs within a try/catch block (preventing a full crash), fuzzing by itself might not catch it.</p>\n<p>Timeline:</p>\n<ul>\n<li>2025-10-23 - Bruno Garcia reports the issue to Nicolas Dorier</li>\n<li>2025-10-23 - Nicolas Dorier confirmed the issue</li>\n<li>2025-10-23 - Nicolas Dorier opens <a href=\"https://github.com/MetacoSA/NBitcoin/pull/1288\">#1288</a> to fix it</li>\n<li>2025-10-23 - NBitcoin 9.0.3 is released</li>\n</ul>\n<p><em>Note: There is no known node implementation using NBitcoin, so there is no risk of chain split. That\u2019s why we\u2019re making it public.</em></p>",
  "post_number": 1,
  "post_type": 1,
  "posts_count": 1,
  "updated_at": "2025-11-24T19:03:42.502Z",
  "reply_count": 0,
  "reply_to_post_number": null,
  "quote_count": 0,
  "incoming_link_count": 251,
  "reads": 45,
  "readers_count": 44,
  "score": 1504.0,
  "yours": false,
  "topic_id": 2120,
  "topic_slug": "consensus-bug-on-nbitcoin-out-of-bound-issue-in-remove",
  "topic_title": "Consensus bug on NBitcoin: out-of-bound issue in `Remove()`",
  "topic_html_title": "Consensus bug on NBitcoin: out-of-bound issue in `Remove()`",
  "category_id": 8,
  "display_username": "Bruno Garcia",
  "primary_group_name": null,
  "flair_name": null,
  "flair_url": null,
  "flair_bg_color": null,
  "flair_color": null,
  "flair_group_id": null,
  "badges_granted": [],
  "version": 1,
  "can_edit": false,
  "can_delete": false,
  "can_recover": false,
  "can_see_hidden_post": false,
  "can_wiki": false,
  "user_title": null,
  "bookmarked": false,
  "raw": "We recently integrated `NBitcoin` into the `script_eval` target of bitcoinfuzz.\nThis target performs *differential fuzzing* of Bitcoin script evaluation logic by comparing the behavior of EvalScript (or equivalent) implementations across different projects.\nBefore adding NBitcoin, this target was already fuzzing Bitcoin Core and btcd.\n\nShortly after starting the fuzzing campaign \u2014 thanks to an already good corpus \u2014 we encountered a crash with the following script:\n\n```\nHex: 000360670000005b770100000000005b770100000000000008777760779f00000877776077\nAsm: 0 26464 0 0 11 OP_NIP 0 0 0 0 0 11 OP_NIP 0 0 0 0 0 0 777760779f000008 OP_NIP OP_NIP 16 OP_NIP\n```\n\nWhen debugging the run output, we observed that NBitcoin returned **false** while Bitcoin Core returned **true**. Since this represented a clear consensus discrepancy, we manually reviewed the script to verify whether it was valid. The analysis confirmed that the script is valid, meaning that Bitcoin Core\u2019s behavior is correct \u2014 and that the discrepancy originated from a bug in NBitcoin.\n\nInitially, this was surprising, since the only opcode in the script is `OP_NIP`, which removes the second item from the top of the stack \u2014 a relatively simple operation.\n\nNBitcoin\u2019s implementation of this opcode is shown below:\n\n```csharp\ncase OpcodeType.OP_NIP:\n{\n    // (x1 x2 -- x2)\n    if (_stack.Count < 2)\n        return SetError(ScriptError.InvalidStackOperation);\n\n    _stack.Remove(-2);\n    break;\n}\n```\n\nTo better understand the issue, we created a test case and stepped through `EvalScript`.\nDuring execution, an `IndexOutOfRangeException` was thrown when processing the third `OP_NIP`.\n\nFurther investigation revealed the following:\n\n> When the underlying array is at full capacity (e.g., 16 elements), and \\_stack.Remove(-2) is called, the Remove operation must delete the item at index 14 and shift the subsequent elements down. During this shift, the implementation may attempt to access \\_array\\[16\\], which does not exist, leading to the IndexOutOfRangeException.\n\nInterestingly, this bug was only discovered through differential fuzzing, because the discrepancy in return values between `Bitcoin Core` and `NBitcoin` highlighted the problem.\nSince the exception occurs within a try/catch block (preventing a full crash), fuzzing by itself might not catch it.\n\nTimeline:\n\n* 2025-10-23 - Bruno Garcia reports the issue to Nicolas Dorier\n* 2025-10-23 - Nicolas Dorier confirmed the issue\n* 2025-10-23 - Nicolas Dorier opens [#1288](https://github.com/MetacoSA/NBitcoin/pull/1288) to fix it\n* 2025-10-23 - NBitcoin 9.0.3 is released\n\n*Note: There is no known node implementation using NBitcoin, so there is no risk of chain split. That's why we're making it public.*",
  "actions_summary": [
    {
      "id": 2,
      "count": 14
    }
  ],
  "moderator": false,
  "admin": false,
  "staff": false,
  "user_id": 72,
  "hidden": false,
  "trust_level": 3,
  "deleted_at": null,
  "user_deleted": false,
  "edit_reason": null,
  "can_view_edit_history": true,
  "wiki": false,
  "excerpt": "We recently integrated NBitcoin into the script_eval target of bitcoinfuzz.\nThis target performs differential fuzzing of Bitcoin script evaluation logic by comparing the behavior of EvalScript (or equivalent) implementations across different projects.\nBefore adding NBitcoin, this target was already &hellip;",
  "truncated": true,
  "post_url": "/t/consensus-bug-on-nbitcoin-out-of-bound-issue-in-remove/2120/1",
  "reactions": [
    {
      "id": "+1",
      "type": "emoji",
      "count": 10
    },
    {
      "id": "rocket",
      "type": "emoji",
      "count": 3
    },
    {
      "id": "heart",
      "type": "emoji",
      "count": 1
    }
  ],
  "current_user_reaction": null,
  "reaction_users_count": 14,
  "current_user_used_main_reaction": false,
  "can_accept_answer": false,
  "can_unaccept_answer": false,
  "accepted_answer": false,
  "topic_accepted_answer": null,
  "can_vote": false
}