{
  "id": 6247,
  "name": "Jonathan Harvey-Buschel",
  "username": "jonhbit",
  "avatar_template": "/user_avatar/delvingbitcoin.org/jonhbit/{size}/1661_2.png",
  "created_at": "2025-11-14T21:48:21.505Z",
  "cooked": "<p>A related subject is how we could switch the LN P2P network from message flooding to something closer to the design outlined in the Erlay paper and BIP. Some observations:</p>\n<ul>\n<li>\n<p>Latency / propagation delay is much less important for LN gossip; implementations will allow slightly outdated fees to apply to their channel, for example.</p>\n</li>\n<li>\n<p>Gossip messages are signed by the sender, and are intended to be public. So the propagation method does not need to conceal information about the sender\u2019s position nor connections in the LN P2P graph.</p>\n</li>\n</ul>\n<p>There has been some existing work on this subject:</p>\n<p><a href=\"https://endothermic.dev/p/magical-minisketch\" rel=\"noopener nofollow ugc\">https://endothermic.dev/p/magical-minisketch</a></p>\n<h3><a name=\"p-6247-adapting-minisketch-to-ln-gossip-1\" class=\"anchor\" href=\"#p-6247-adapting-minisketch-to-ln-gossip-1\"></a>Adapting Minisketch to LN Gossip</h3>\n<p>A key detail is how to map gossip messages to Minisketch set elements. This mapping should be collision-resistant, and ideally the elements are short, since reconciliation time is quadratic wrt. element length.</p>\n<p>In the Erlay design, collisions are avoided by generating a salt for each peer connection, and using that and the TXID as input to a fast non-cryptographic collision-resistant hash like SipHash. This means that the total amount of hashing operations needed scales with the number of peer connections, but having a shorter (32-bit) set element greatly reduces the compute needed for set construction and reconciliation.</p>\n<p>Alternatively, set elements could be computed from a channel\u2019s short channel ID (64 bits), plus the block height included in the gossip message. However, there are some issues with this approach.</p>\n<p>One is that the components of a short channel ID (channel open block height, transaction index, and output index) don\u2019t have a lot of entropy. For example, in a full block, one could have ~36000 1-in 1-out P2TR TXs of 111 vB, or 1 TX with 1 input and 93020 outputs with weight ~3999900 vB. In either case, the entropy of the TX + output index is only ~17 bits. Mixing in block heights does not add much to the total entropy, since a message can only use a block height from the last two weeks (~2016 possible values, 11 bits of entropy).</p>\n<p>In addition, we would need a different mapping for node_announcement messages.</p>\n<p>Given that LN nodes already store some per-peer state on connection (re)establishment, I\u2019m in favor of borrowing the Erlay approach and using a per-peer salt + a hash like SipHash to generate short Minisketch set elements for each gossip message.</p>\n<h3><a name=\"p-6247-gossip-v15-message-format-2\" class=\"anchor\" href=\"#p-6247-gossip-v15-message-format-2\"></a>Gossip v1.5 message format</h3>\n<p>Another detail is that the gossip 1.5 proposal allows for optional fields in gossip messages, which is not possible with current gossip messages:</p>\n<p><a href=\"https://github.com/lightning/bolts/pull/1059\" rel=\"noopener nofollow ugc\">https://github.com/lightning/bolts/pull/1059</a></p>\n<p>However, I think peers can decide which fields to send to their peer based on their announced feature bits.</p>\n<h3><a name=\"p-6247-other-considerations-3\" class=\"anchor\" href=\"#p-6247-other-considerations-3\"></a>Other considerations</h3>\n<p>Compared to the Erlay design, I don\u2019t think LN implementations would need to perform any message flooding at all. Combining limited flooding and set reconciliation is useful for reducing total propagation delay, but the LN gossip propagation delay is so large that it could be maintained through set reconciliation alone. This should greatly simplify implementation complexity as well.</p>\n<p>With respect to implementation, one problem would be different nodes filtering messages with different policies. This would lead to persistent set differences, which would waste bandwidth and, in the worst case, cause reconciliations to fail. I suspect that these filtering policies are either legacy behavior, or adaptions to quirks in existing gossip behavior, and could largely be removed if we move to set reconciliation.</p>\n<h3><a name=\"p-6247-future-work-4\" class=\"anchor\" href=\"#p-6247-future-work-4\"></a>Future Work</h3>\n<p>In parallel to the gossip monitoring work, I\u2019d like to get feedback from LN implementers on which designs could work for them. Is the per-peer state a significant drawback or source of complexity? Would there be an issue with more frequent (every 30 seconds?) set reconciliation and gossip message handling? Are there other issues that haven\u2019t been considered?</p>\n<p>I\u2019ll update this thread if/when I have a more concrete proposal or draft BIP.</p>",
  "post_number": 2,
  "post_type": 1,
  "posts_count": 2,
  "updated_at": "2025-11-14T21:48:21.505Z",
  "reply_count": 0,
  "reply_to_post_number": null,
  "quote_count": 0,
  "incoming_link_count": 1,
  "reads": 16,
  "readers_count": 15,
  "score": 8.0,
  "yours": false,
  "topic_id": 2105,
  "topic_slug": "gossip-observer-new-project-to-monitor-the-lightning-p2p-network",
  "topic_title": "Gossip Observer: New project to monitor the Lightning P2P network",
  "topic_html_title": "Gossip Observer: New project to monitor the Lightning P2P network",
  "category_id": 7,
  "display_username": "Jonathan Harvey-Buschel",
  "primary_group_name": null,
  "flair_name": null,
  "flair_url": null,
  "flair_bg_color": null,
  "flair_color": null,
  "flair_group_id": null,
  "badges_granted": [],
  "version": 1,
  "can_edit": false,
  "can_delete": false,
  "can_recover": false,
  "can_see_hidden_post": false,
  "can_wiki": false,
  "user_title": null,
  "bookmarked": false,
  "raw": "A related subject is how we could switch the LN P2P network from message flooding to something closer to the design outlined in the Erlay paper and BIP. Some observations:\n\n- Latency / propagation delay is much less important for LN gossip; implementations will allow slightly outdated fees to apply to their channel, for example.\n\n- Gossip messages are signed by the sender, and are intended to be public. So the propagation method does not need to conceal information about the sender's position nor connections in the LN P2P graph.\n\nThere has been some existing work on this subject:\n\n<https://endothermic.dev/p/magical-minisketch>\n\n### Adapting Minisketch to LN Gossip\n\nA key detail is how to map gossip messages to Minisketch set elements. This mapping should be collision-resistant, and ideally the elements are short, since reconciliation time is quadratic wrt. element length.\n\nIn the Erlay design, collisions are avoided by generating a salt for each peer connection, and using that and the TXID as input to a fast non-cryptographic collision-resistant hash like SipHash. This means that the total amount of hashing operations needed scales with the number of peer connections, but having a shorter (32-bit) set element greatly reduces the compute needed for set construction and reconciliation.\n\nAlternatively, set elements could be computed from a channel's short channel ID (64 bits), plus the block height included in the gossip message. However, there are some issues with this approach.\n\nOne is that the components of a short channel ID (channel open block height, transaction index, and output index) don't have a lot of entropy. For example, in a full block, one could have ~36000 1-in 1-out P2TR TXs of 111 vB, or 1 TX with 1 input and 93020 outputs with weight ~3999900 vB. In either case, the entropy of the TX + output index is only ~17 bits. Mixing in block heights does not add much to the total entropy, since a message can only use a block height from the last two weeks (~2016 possible values, 11 bits of entropy).\n\nIn addition, we would need a different mapping for node_announcement messages.\n\nGiven that LN nodes already store some per-peer state on connection (re)establishment, I'm in favor of borrowing the Erlay approach and using a per-peer salt + a hash like SipHash to generate short Minisketch set elements for each gossip message.\n\n### Gossip v1.5 message format\n\nAnother detail is that the gossip 1.5 proposal allows for optional fields in gossip messages, which is not possible with current gossip messages:\n\n<https://github.com/lightning/bolts/pull/1059>\n\nHowever, I think peers can decide which fields to send to their peer based on their announced feature bits.\n\n### Other considerations\n\nCompared to the Erlay design, I don't think LN implementations would need to perform any message flooding at all. Combining limited flooding and set reconciliation is useful for reducing total propagation delay, but the LN gossip propagation delay is so large that it could be maintained through set reconciliation alone. This should greatly simplify implementation complexity as well.\n\nWith respect to implementation, one problem would be different nodes filtering messages with different policies. This would lead to persistent set differences, which would waste bandwidth and, in the worst case, cause reconciliations to fail. I suspect that these filtering policies are either legacy behavior, or adaptions to quirks in existing gossip behavior, and could largely be removed if we move to set reconciliation.\n\n### Future Work\n\nIn parallel to the gossip monitoring work, I'd like to get feedback from LN implementers on which designs could work for them. Is the per-peer state a significant drawback or source of complexity? Would there be an issue with more frequent (every 30 seconds?) set reconciliation and gossip message handling? Are there other issues that haven't been considered?\n\nI'll update this thread if/when I have a more concrete proposal or draft BIP.",
  "actions_summary": [],
  "moderator": false,
  "admin": false,
  "staff": false,
  "user_id": 982,
  "hidden": false,
  "trust_level": 1,
  "deleted_at": null,
  "user_deleted": false,
  "edit_reason": null,
  "can_view_edit_history": true,
  "wiki": false,
  "excerpt": "A related subject is how we could switch the LN P2P network from message flooding to something closer to the design outlined in the Erlay paper and BIP. Some observations: \n\n\nLatency / propagation delay is much less important for LN gossip; implementations will allow slightly outdated fees to apply &hellip;",
  "truncated": true,
  "post_url": "/t/gossip-observer-new-project-to-monitor-the-lightning-p2p-network/2105/2",
  "reactions": [],
  "current_user_reaction": null,
  "reaction_users_count": 0,
  "current_user_used_main_reaction": false,
  "can_accept_answer": false,
  "can_unaccept_answer": false,
  "accepted_answer": false,
  "topic_accepted_answer": null
}