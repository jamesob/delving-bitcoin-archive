{
  "id": 6312,
  "name": "Rusty Russell",
  "username": "rustyrussell",
  "avatar_template": "/user_avatar/delvingbitcoin.org/rustyrussell/{size}/154_2.png",
  "created_at": "2025-11-22T22:47:53.795Z",
  "cooked": "<p>Sorry to join the conversation late, and I haven\u2019t worked on this for years so my memory could be stale, but here\u2019s a brain dump of our conclusions.</p>\n<ol>\n<li>Short channel ids have a lot of bits to squeeze. Ultimate would be to refer to outputs by their index in the blockchain (i.e. the 123456th output), but you can easily use fewer than 64 bits for blocknum/txnum/outnum.</li>\n<li>You maintain three minisketches. We tried a single, but it costs encoding bits, complexity and hits the O(N^2) harder.</li>\n<li>Channel minisketch is just the scids. Importantly, you send your blockheight with the sketch, because that informs the failure case.</li>\n<li>Channel update minisketch is compacted scid + direction bit + height. Note that height takes 10 or 11 bits, IIRC, since you don\u2019t send expired ones. You can only reliably decode this once you have reconciled the channels sketch.</li>\n<li>Node announce sketch is uses the same encoding, using the oldest channel attached to the node as its key. Again this assumes you reconciled the channels sketch first.</li>\n</ol>\n<p>If you cannot encode an scid compactly, just send it as a series of  \u201craw\" entries. IIRC creating such an scid requires an exceptional number of txs in a block or exceptional output count.</p>\n<p>With this scheme, you simply send the sketches every 60 seconds (like now), and your peer sends you what you\u2019re missing.</p>\n<p>Note that you can truncate the set you send if you want to save bandwidth, but really the cost is in the set maintenance, so maybe this is silly. My memory is that minisketch is <em>fast</em> in practice though, even if you keep a 64k (8k element) set which is our max message size anyway.</p>\n<p>If reconstruction fails, there are several things you can do:</p>\n<ol>\n<li>If block height differs, ignore. Time will sort it. Maybe include block hash here?</li>\n<li>Enlarge your own set (or, send more of your set). If this allows your peer to reconstruct, it will learn that you cannot reconstruct, and it knows to send its largest set if it wasn\u2019t already.</li>\n<li>Wait for other peers. You might close the gap.</li>\n<li>Existing gossip queries for recent changes (assuming a pile of old changes haven\u2019t suddenly appeared).  You know if you need announcements, updates or node anns.</li>\n<li>Query for everything.</li>\n</ol>\n<p>Oh, we added a \u201ctotal entries\" counter to each message, which gives a clue as well: if your peer has far fewer entries, it\u2019s a cry for help <img src=\"https://delvingbitcoin.org/images/emoji/twitter/slight_smile.png?v=14\" title=\":slight_smile:\" class=\"emoji\" alt=\":slight_smile:\" loading=\"lazy\" width=\"20\" height=\"20\"></p>",
  "post_number": 7,
  "post_type": 1,
  "posts_count": 7,
  "updated_at": "2025-11-22T22:48:46.117Z",
  "reply_count": 0,
  "reply_to_post_number": 6,
  "quote_count": 0,
  "incoming_link_count": 0,
  "reads": 1,
  "readers_count": 0,
  "score": 0.2,
  "yours": false,
  "topic_id": 2105,
  "topic_slug": "gossip-observer-new-project-to-monitor-the-lightning-p2p-network",
  "topic_title": "Gossip Observer: New project to monitor the Lightning P2P network",
  "topic_html_title": "Gossip Observer: New project to monitor the Lightning P2P network",
  "category_id": 7,
  "display_username": "Rusty Russell",
  "primary_group_name": null,
  "flair_name": null,
  "flair_url": null,
  "flair_bg_color": null,
  "flair_color": null,
  "flair_group_id": null,
  "badges_granted": [],
  "version": 1,
  "can_edit": false,
  "can_delete": false,
  "can_recover": false,
  "can_see_hidden_post": false,
  "can_wiki": false,
  "user_title": null,
  "reply_to_user": {
    "id": 982,
    "username": "jonhbit",
    "name": "Jonathan Harvey-Buschel",
    "avatar_template": "/user_avatar/delvingbitcoin.org/jonhbit/{size}/1661_2.png"
  },
  "bookmarked": false,
  "raw": "Sorry to join the conversation late, and I haven\u2019t worked on this for years so my memory could be stale, but here\u2019s a brain dump of our conclusions.\n\n1. Short channel ids have a lot of bits to squeeze. Ultimate would be to refer to outputs by their index in the blockchain (i.e. the 123456th output), but you can easily use fewer than 64 bits for blocknum/txnum/outnum.\n2. You maintain three minisketches. We tried a single, but it costs encoding bits, complexity and hits the O(N^2) harder.\n3. Channel minisketch is just the scids. Importantly, you send your blockheight with the sketch, because that informs the failure case.\n4. Channel update minisketch is compacted scid + direction bit + height. Note that height takes 10 or 11 bits, IIRC, since you don\u2019t send expired ones. You can only reliably decode this once you have reconciled the channels sketch.\n5. Node announce sketch is uses the same encoding, using the oldest channel attached to the node as its key. Again this assumes you reconciled the channels sketch first.\n\nIf you cannot encode an scid compactly, just send it as a series of  \u201craw\" entries. IIRC creating such an scid requires an exceptional number of txs in a block or exceptional output count.\n\nWith this scheme, you simply send the sketches every 60 seconds (like now), and your peer sends you what you\u2019re missing.\n\nNote that you can truncate the set you send if you want to save bandwidth, but really the cost is in the set maintenance, so maybe this is silly. My memory is that minisketch is *fast* in practice though, even if you keep a 64k (8k element) set which is our max message size anyway.\n\nIf reconstruction fails, there are several things you can do:\n\n1. If block height differs, ignore. Time will sort it. Maybe include block hash here?\n2. Enlarge your own set (or, send more of your set). If this allows your peer to reconstruct, it will learn that you cannot reconstruct, and it knows to send its largest set if it wasn\u2019t already.\n3. Wait for other peers. You might close the gap.\n4. Existing gossip queries for recent changes (assuming a pile of old changes haven\u2019t suddenly appeared).  You know if you need announcements, updates or node anns.\n5. Query for everything.\n\nOh, we added a \u201ctotal entries\" counter to each message, which gives a clue as well: if your peer has far fewer entries, it\u2019s a cry for help :slight_smile:",
  "actions_summary": [],
  "moderator": false,
  "admin": false,
  "staff": false,
  "user_id": 137,
  "hidden": false,
  "trust_level": 2,
  "deleted_at": null,
  "user_deleted": false,
  "edit_reason": null,
  "can_view_edit_history": true,
  "wiki": false,
  "excerpt": "Sorry to join the conversation late, and I haven\u2019t worked on this for years so my memory could be stale, but here\u2019s a brain dump of our conclusions. \n\nShort channel ids have a lot of bits to squeeze. Ultimate would be to refer to outputs by their index in the blockchain (i.e. the 123456th output), b&hellip;",
  "truncated": true,
  "post_url": "/t/gossip-observer-new-project-to-monitor-the-lightning-p2p-network/2105/7",
  "reactions": [],
  "current_user_reaction": null,
  "reaction_users_count": 0,
  "current_user_used_main_reaction": false,
  "can_accept_answer": false,
  "can_unaccept_answer": false,
  "accepted_answer": false,
  "topic_accepted_answer": null
}